@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

@{
    var selectedReport = @ViewBag.ReportHeader;
}
<style>

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<div class="text-center" id="reportTitle" style="font-size: 20px">Telephone Switch</div>

<div class="sticky-header bg-white p-2 shadow-sm z-3" >
    <div class="d-flex align-items-center gap-3 p-2" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">

    <!-- Room No -->
    <div class="d-flex align-items-center">
        <label for="roomNo" class="me-2 mb-0">Room No</label>
        <input type="text" id="roomNo" class="form-control form-control-sm" style="width: 100px;" />
    </div>

    <!-- Vacant -->
    <div class="form-check ms-3">
        <input class="form-check-input" type="checkbox" id="vacant" />
        <label class="form-check-label" for="vacant">Vacant</label>
    </div>

    <!-- Occupied -->
    <div class="form-check ms-3">
        <input class="form-check-input" type="checkbox" id="occupied" />
        <label class="form-check-label" for="occupied">Occupied</label>
    </div>


    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnOn" class="mui-button button-report-view">On</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnOff" class="mui-button button-report-view">Off</button>
       
    </div>
    </div>

</div>
<div class="mui-card" >
   <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div id="gridContainer"></div>

    </div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    let typingTimer;
    const typingDelay = 500; // ms
    $(document).ready(function () {
       

        loadTelephoneSwitch();
        $("#vacant, #occupied").change(function () {
        loadTelephoneSwitch();

    });
     $("#roomNo").on("input", function () {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            loadTelephoneSwitch();
        }, typingDelay);
    });
    });

    function loadTelephoneSwitch() {

        let foStatus = 2; // default all
        const isVacant = $("#vacant").is(":checked");
        const isOccupied = $("#occupied").is(":checked");

        if (isVacant && !isOccupied) foStatus = 0;
        else if (!isVacant && isOccupied) foStatus = 1;
        else if (isVacant && isOccupied) foStatus = 2;

        $("#loadingSpinner").show();

        $.ajax({
            url: '/FrontDesk/TelephoneSwitchSearch',
            type: 'GET',
          
            data: {
                roomNo: $("#roomNo").val(),
                foStatus: foStatus
            },
            success: function (result) {
                console.log(result); 
                initializeRevenueByGrid(result);
                $("#loadingSpinner").hide();
            },
            error: function () {
                alert("Không thể tải báo cáo.");
                $("#loadingSpinner").hide();
            }
        });
    }
        // Bắt sự kiện click nút On
        $("#btnOn").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");
        const row = grid.getSelectedRowsData()[0];
        if (!row) {
            showToast("Warning","Please select a room first before turning it On.",true);
            return;
        }
        updateTelephoneSwitch(row, "On");
    });

    $("#btnOff").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");
        const row = grid.getSelectedRowsData()[0];
        if (!row) {
            showToast("Warning","Please select a room first before turning it Off.",true);
            return;
        }
        updateTelephoneSwitch(row, "Off");
    });

    function updateTelephoneSwitch(row, newValue) {
        $.ajax({
            url: "/FrontDesk/UpdateTelephoneSwitch",
            type: "POST",
            data: JSON.stringify({
                roomNo: row.roomNo,
                guestName: row.guestName,
                oldValue: row.foStatus,   // giá trị cũ
                newValue: newValue        // On hoặc Off
            }),
            contentType: "application/json; charset=utf-8",
            success: function (res) {
                if (res.success) {
                    showToast("Success","Update successfully!",true);
                    loadTelephoneSwitch(); // reload lại grid
                } else {
                    showToast("Error","Update failed!");
                }
            },
            error: function () {
                showToast("Error","Update failed due to an error.");
            }
        });
    }

    function initializeRevenueByGrid(result) {
        const columnWidth = 234;
        
            $("#gridContainer").dxDataGrid({
                dataSource: result,
                height: 500,
                width: "100%",
                columnAutoWidth: false,
                allowColumnResizing: true,
                columnResizingMode: "widget",
                columns: [
                    { dataField: "roomNo", caption: "Room No", width: "15%" },
                    { dataField: "guestName", caption: "Guest Name", width: "25%" },
                    { dataField: "foStatus", caption: "FO Status", width: "15%" },
                    { dataField: "code", caption: "Room Type", width: "15%" },
                    { dataField: "checkInDate", caption: "Check In Date", width: "15%" },
                    { dataField: "checkOutDate", caption: "Check Out Date", width: "15%" },
                    { dataField: "newValue", caption: "Status", width: "15%" }
                ],
                paging: { pageSize: 25 },
                scrolling: { useNative: true, showScrollbar: "always" },
                pager: {
                    visible: true,
                    allowedPageSizes: [25, 50, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },
                    selection: {
                    mode: "single",
                    showCheckBoxesMode: "none",
                    selectByClick: true   // thêm dòng này
                },
                filterRow: { visible: true, applyFilter: "auto" },
                headerFilter: { visible: true },
                showBorders: true,
                onRowPrepared: function (e) {
                    if (e.rowType === "data" && e.data && e.data.cssClass) {
                        $(e.rowElement).addClass(e.data.cssClass);
                    }
                },
                onSelectionChanged: function (e) {
     

                $("#btnOn").prop("disabled", true);
                $("#btnOff").prop("disabled", true);

                if (e.selectedRowsData.length === 0) {
                console.log("Chưa chọn phòng nào!");
                return; 
                    }
                         
                    const row = e.selectedRowsData[0];

                    console.log("Row data:", row);
                    console.log("foStatus raw:", row.foStatus, " | type:", typeof row.foStatus);

                    const foStatus = row.foStatus;

                    console.log("foStatus after Number():", foStatus);

                    if (foStatus === "Vacant") {
                        // Vacant -> chỉ Off
                        $("#btnOn").prop("disabled", true);
                        $("#btnOff").prop("disabled", false);
                    } else if (foStatus === "Occuppied") {
                        // Occupied -> On + Off
                        $("#btnOn").prop("disabled", false);
                        $("#btnOff").prop("disabled", false);
                    } else {
                        // case khác
                        $("#btnOn").prop("disabled", true);
                        $("#btnOff").prop("disabled", true);
                    }              
                }
            

      });
        
    }





</script>
