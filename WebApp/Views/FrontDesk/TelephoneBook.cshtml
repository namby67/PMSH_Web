@using DevExpress.XtraReports.UI


@{
    var selectedReport = @ViewBag.ReportHeader;

    var categories = ViewBag.TelephoneBookCategoryList;
}
<style>

 

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

 
    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

   

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }


    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

</style>

<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Telephone Book</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
<div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
    <div class="d-flex flex-column ">

            <div class="d-flex align-items-center me-3">

             <label class ="me-2 mb-0">Category:</label>
                <select id="categoryFilter" class="form-control form-control-sm w-auto">
            @foreach (var c in categories)
            {
                <option value="@c.ID">@c.Name</option>
            }
        </select>
        </div>
    </div>
            <div class="d-flex align-items-center me-3">
             <label class="me-2 mb-0">Telephone Search:</label>
            <input type="text" id="phoneSearch" class="form-control form-control-sm" style="width: 180px;" />
    </div>
      
</div>
    <div class="">
        <button  id="btnView" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i> View</button>
        <button  id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button  id="btnUpdate" class="mui-button mui-button-edit"><i class="fa-solid fa-pen"></i> Edit</button>
        <button   id="btnDelete" class="mui-button mui-button-new"><i class="fa-solid fa-trash"></i> Delete</button>
        <button   id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>

    </div>
</div>
<div class="mui-card">
    @*   <div style="font-size: 20px;" class="mt-1" id="reportTitle"></div> *@
    <div id="gridWrapper" class="gridContainer mt-2" style="max-height: 500px;">
        <div class="gridContainer" id="gridContainer"></div>
    </div>
</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
<div class="sticky-header ms-1 me-1 mt-1">
        <label id="remarkInput" class="form-control mt-2">Remark</label>
        <label id="webInput" class="form-control mt-2">Web Address</label>
</div>
</div>

<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>

<!-- Modal -->
<div class="modal fade" id="telephonePopup" tabindex="-1" aria-labelledby="popupLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="popupLabel">Telephone Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="popupForm">
                    <div class="row d-flex align-items-center">
                        <div class="col-md-6 ">
                            <label>Category</label>
                            <select id="popupCategory" class="form-control">
                                <option value="">-- Select One --</option>
                                @foreach (var c in ViewBag.TelephoneBookCategoryList)
                                {
                                    <option value="@c.ID">@c.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Name</label>
                            <input type="text" id="popupName" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label>Telephone</label>
                            <input type="text" id="popupPhone" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label>Address</label>
                            <input type="text" id="popupAddress" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label>Remarks</label>
                            <input type="text" id="popupRemark" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label>Web Link</label>
                            <input type="text" id="popupWeb" class="form-control" value="http://www." />
                        </div>
                        <div class="col-md-6">
                            <label>Color:</label>
                            <input type="color" class="d-flex align-items-center" name="color" id="popupColor" value="#ff0000" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSavePopup" ><i class="fa-solid fa-floppy-disk"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    const VN_PHONE_REGEX = /^((0|\+84)(3|5|7|8|9)[0-9]{8}|0\d{2,3}\d{7,8})$/;

    function isValidVietnamPhone(phone) {
        return VN_PHONE_REGEX.test(phone);
    }
    $(document).ready(function () {
        loadTelephoneGrid([]);
           
    });
        $(document).on("click", "#btnNew", function () {
        $("#popupForm")[0].reset(); // reset form
        $("#telephonePopup").modal("show");
    });

       // Khi bấm nút Update
    $("#btnUpdate").click(function () {

        const grid = $("#gridContainer").dxDataGrid("instance");
        const selected = grid.getSelectedRowsData();

        if (selected.length === 0) {
            alert("Vui lòng chọn 1 đối tượng để cập nhật.");
            return;
        }

        let row = selected[0];

        // Gọi API để lấy chi tiết theo ID
        $.get("/FrontDesk/GetTelephoneById", { id: row.id }, function (data) {
            if (data) {
                $("#popupCategory").val(data.telephoneBookCategoryID);
                $("#popupName").val(data.name);
                $("#popupPhone").val(data.telephone);
                $("#popupAddress").val(data.address);
                $("#popupRemark").val(data.remark);
                $("#popupWeb").val(data.webAddress);
                $("#popupColor").val("#" + (data.color.toString(16).padStart(6, "0")));

                // Lưu tạm id để khi Save biết update
                $("#popupForm").data("edit-id", data.id);

                $("#telephonePopup").modal("show");
            }
        });
    });

    // Khi Save
    $("#btnSavePopup").click(function () {
        const phone = $("#popupPhone").val();

        if (!isValidVietnamPhone(phone)) {
            alert("❌ Số điện thoại không hợp lệ!");
            return;
        }
        let editId = $("#popupForm").data("edit-id");

        let postData = {
            name: $("#popupName").val(),
            telephone: phone,
            address: $("#popupAddress").val(),
            remark: $("#popupRemark").val(),
            webAddress: $("#popupWeb").val(),
            categoryId: $("#popupCategory").val(),
            color: parseInt($("#popupColor").val().replace("#", ""), 16)
        };

        if (editId) {
            // Update
            postData.id = editId;
            $.post("/FrontDesk/UpdateTelephoneBook", postData, function (res) {
                if (res.success) {
                    alert("Cập nhật thành công!");
                    $("#telephonePopup").modal("hide");
                    $("#btnView").click();
                } else {
                    alert("Lỗi: " + res.message);
                }
            });
        } else {
            // Insert
            $.post("/FrontDesk/InsertTelephoneBook", postData, function (res) {
                if (res.success) {
                    alert("Thêm thành công!");
                    $("#telephonePopup").modal("hide");
                    $("#btnView").click();
                } else {
                    alert("Lỗi: " + res.message);
                }
            });
        }
    });
        $("#btnDelete").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");
        const selected = grid.getSelectedRowsData();

        if (selected.length === 0) {
            alert("Vui lòng chọn 1 dòng để xóa.");
            return;
        }

        let row = selected[0];

        if (confirm("Bạn có chắc chắn muốn xóa: " + row.name + " ?")) {
            $.post("/FrontDesk/DeleteTelephoneBook", { id: row.id }, function (res) {
                if (res.success) {
                    alert("Xóa thành công!");
                    $("#btnView").click(); // reload lại grid
                } else {
                    alert("Lỗi: " + res.message);
                }
            });
        }
    });


     $(document).off("click", "#btnView").on("click", "#btnView", function () {
         $("#loadingSpinner").show();

            $.ajax({
                url: '/FrontDesk/GetTelephoneBook',
                type: 'GET',
                data: {
                    categoryId: $("#categoryFilter").val(),
                    phoneSearch: $("#phoneSearch").val()
                },
                success: function (data) {
                    console.log(data);
                    loadTelephoneGrid(data);
                    $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không thể tải dữ liệu");
                    $("#loadingSpinner").hide();
                }
            });
        });
        function loadTelephoneGrid(data) {

        $("#gridContainer").dxDataGrid({
                dataSource: data,
                keyExpr: "id", 
                height: 400,
                allowColumnResizing: true,
                selection: { mode: "single" },
                columns: [
                { dataField: "name", caption: "Name" },
                { dataField: "telephone", caption: "Telephone" },
                { dataField: "address", caption: "Address" },
                { dataField: "remark", caption: "Remark" }
                ],
            scrolling: {
            mode: "standard", // Không dùng virtual để footer hiển thị đúng
            showScrollbar: "always",
            scrollByContent: true
        },
        paging: {
            pageSize: 20
        },
        pager: {
            visible: true,
            allowedPageSizes: [20, 40, 'all'],
            showPageSizeSelector: true,
            showInfo: true,
            showNavigationButtons: true
        },
            filterRow: {
        visible: true,
        applyFilter: "auto"
    },
        showBorders: true
    });
    }
       $("#btnExportExcel").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");   // 🔥 khai báo grid

        const workbook = new ExcelJS.Workbook();
        const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === Dòng 1: Tên công ty (merge theo 4 cột) ===
        worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:D1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === Dòng 2: Ngày giờ xuất (bên phải) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', exportDate]);
        worksheet.mergeCells('D2:D2');  // cột D thôi
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === Dòng 3–4: trống
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
        const reportRow = worksheet.addRow(['Telephone Directory']);
        worksheet.mergeCells('A5:D5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === Dòng 6: trống
        worksheet.addRow([]);

        // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 }
        }).then(function () {
            // Footer (sau cùng)
            const lastRow = worksheet.lastRow.number + 2;
            worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = "Telephone Directory.xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });
</script>
