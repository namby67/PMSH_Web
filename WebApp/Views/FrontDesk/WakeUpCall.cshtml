@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var zoneList = ViewBag.ZoneList;
    var roomList = ViewBag.RoomList;
    var roomClassList = ViewBag.RoomClassList;
}
<style>
    .wake-container {
        display: flex;
        gap: 30px;
        justify-content: center;
        margin: 20px 0;
/*         background: white; */
    }

    .group-box {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 5px;
        min-width: 200px;
        background: white;
    }

    .radio-inline {
        margin-bottom: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
    }

    .form-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .form-row label {
            width: 80px;
            text-align: right;
        }


    .browse-btn {
        width: 30px;
        height: 25px;
        padding: 0;
        margin-left: 5px;
    }

    .btn-row {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    .btn-delete, .btn-close {
        padding: 6px 20px;
        border: 1px solid #aaa;
        border-radius: 3px;
        background: #f5f5f5;
        cursor: pointer;
    }

        .btn-delete:hover {
            background: #fdd;
            border-color: red;
        }

        .btn-close:hover {
            background: #ddd;
        }

    .hidden-important {
        display: none !important;
    }

    .show-important {
        display: flex !important;
    }

    .show-important1 {
        display: block !important;
    }

    #popupviewGrid {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        padding: 20px;
        border-radius: 0; /* full màn không cần bo góc */
        z-index: 1000;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        overflow-y: auto; /* bật scroll dọc nếu nội dung vượt quá */
    }

    .ellipsis-icon {
       
        margin-left: 10px;
    }
</style>
<div class="text-center" id="reportTitle" style="font-size: 20px">Wake Up Call</div>

<div class="wake-container">
    <!-- Left Group -->
    <div class="group-box">
        <label><input type="radio" name="wake" value="set" id="rdoSet" checked> Set Wake Up Call</label><br />
        <label><input type="radio" name="wake" value="cancel" id="rdoCancle"> Cancel Wake Up Call</label><br />
        <label><input type="radio" name="wake" value="view" id="rdoView" > View Wake Up Calls</label>
    </div>

    <!-- Right Group -->
    <div class="group-box" id="setWakeup">
        <div class="radio-inline">
            <label><input type="radio" name="call" id="rdoDate" value="date" checked> Date </label>
            <label><input type="radio" name="call" id="rdoDaily" value="daily" > Daily</label>
        </div>

        <div class="form-group">
            <!-- Room -->
            <div class="d-flex align-items-center me-3 mb-2" id="roomnoGroup">
                <label class="me-2 mb-1 mt-1">Room No(s):</label>
                <input type="text" id="roomno" name="roomno" class="form-control form-control-sm w-auto" />
                <i id="listRoom" class="fas fa-ellipsis-h ellipsis-icon" style="cursor:pointer;"></i>
            </div>

            <div class="d-flex align-items-center me-3 mb-2" id="scheduleGroup">
                <label id="scheduleLabel" class="me-2 mb-1 mt-1">Schedule:</label>
                <input type="text" id="roomnoCancel" name="roomnoCancel" class="form-control form-control-sm w-auto" />
                <i id="cancleRoom" class="fas fa-ellipsis-h ellipsis-icon" style="cursor:pointer;"></i>
            </div>



            <!-- Chỉ hiện khi chọn Date -->
            <div id="dateSection">
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="me-2 mb-0">Date:</label>
                    <input type="date" id="singleDate" name="singleDate" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="me-2 mb-0">Time:</label>
                    <input type="time" id="timeDate" value="07:00" class="form-control form-control-sm w-auto" />
                </div>
            </div>

            <!-- Chỉ hiện khi chọn Daily -->
            <div id="dailySection">
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="me-2 mb-0">From Date:</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="me-2 mb-0">Time:</label>
                    <input type="time" id="timeDaily" value="07:00" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="me-2 mb-0">To Date:</label>
                    <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>
    </div>

    <div class="group-box" id="viewWakeupcall">
        

        <div class="form-group">
            <!-- Room -->
            <div class="d-flex align-items-center me-3 mb-2" >
                <label class="me-2 mb-1 mt-1">Name:</label>
                <input type="text" id="nameView" name="nameView" class="form-control form-control-sm w-auto" />
               
            </div>
            <div class="d-flex align-items-center me-3 mb-2" >
                <label  class="me-2 mb-1 mt-1">Group:</label>
                <input type="text" id="groupName" name="groupName" class="form-control form-control-sm w-auto" />
               
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Room:</label>
                <select id="roomview" name="roomview" class="tomselect-custom" multiple>
                    @foreach (var item in roomList)
                    {
                        <option value="@item.RoomNo">@item.RoomNo</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">From Date:</label>
                <input type="date" id="fromDateview" name="fromDateview" class="form-control form-control-sm w-auto" />
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Time:</label>
                <input type="time" id="timeDailyview" value="07:00" class="form-control form-control-sm w-auto" />
                <input type="radio" name="timeView" id="rdoTimeView">
            </div>

            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">To Date:</label>
                <input type="date" id="toDateview" name="toDateview" class="form-control form-control-sm w-auto" />
            </div>
            <div class="d-flex align-items-center me-3">
                <label class="me-2 mb-1 mt-1">Room Class:</label>
                <select id="roomClass" name="roomClass" class="form-control form-control-sm" style="width: 100px">
                    <option value="">--All--</option>
                    @foreach (var item in roomClassList)
                    {
                        <option value="@item.ID">@item.Code</option>
                    }
                </select>
            </div>        
        </div>
    </div>
</div>

<div class="btn-row">
    <button style="border-radius: 4px;  margin-right: 6px;" id="btnCancelwakeup" class="mui-button mui-button-cancel" type="button"><i class="fa-solid fa-trash"></i> Delete</button>
    <button style="border-radius: 4px;  margin-right: 6px;" id="btnSetwakeup" class="mui-button mui-button-card" type="button"><i class="fa-solid fa-gear"></i> Set</button>
    <button style="border-radius: 4px;  margin-right: 6px;" id="btnViewwakeup" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-eye"></i> View</button>
    <button style="border-radius: 4px;  margin-right: 6px;" id="btnCheckAll" class="mui-button mui-button-close" type="button"> <i class="fa-solid fa-xmark me-1"></i> Close</button>
    
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>

<div id="popupLogGrid" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px;">

    <div class="d-flex justify-content-start mb-3 gap-2">
        <h5 class="mb-0">Wake Up Call Find Room</h5>
       
    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnSearch" class="mui-button mui-button-new"><i class="fa-solid fa-magnifying-glass"></i>Search</button>
        <button style="border-radius: 4px;  margin-right: 6px" id="btnOke" class="mui-button mui-button-edit"><i class="fa-solid fa-thumbs-up"></i>Ok</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCheckAll" class="mui-button mui-button-advance" type="button"> <i class="fa-solid fa-check-double"></i> Select All</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCheckone" class="mui-button mui-button-advance" type="button"> <i class="fa-solid fa-check-double"></i> Select</button>
        <button onclick="$('#popupLogGrid').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="container mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">

            <div class="d-flex align-items-center me-3 mb-2">
                <label class ="me-2 mb-0">Room No:</label>
                <input id="roomNoset" type="text" class="form-control form-control-sm" placeholder="">
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Zone:</label>
                <select id="zone" name="zone" class="tomselect-custom"  multiple>
                    @foreach (var item in zoneList)
                    {
                        <option value="@item.Code">@item.Code</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class ="me-2 mb-0">
                    Reservation Holder:</label>
                <input id="reservationHolder" type="text" class="form-control form-control-sm" placeholder="">
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Confirm No :</label>
                <input id="confirmNo" type="text" class="form-control form-control-sm" placeholder="">
            </div>
        </div>
    </div>

    <div id="logGridContainer" class="gridContainer mt-2"></div>
</div>

<div id="popupcancleGrid" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 400px;">

    <div class="d-flex justify-content-start mb-3 gap-2">
        <h5 class="mb-0">Wake Up Call Deleting</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px" id="btnOke" class="mui-button mui-button-edit"><i class="fa-solid fa-thumbs-up"></i>Ok</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCheckAllcalcel" class="mui-button mui-button-advance" type="button"> <i class="fa-solid fa-check-double"></i> Select All</button>
        <button onclick="$('#popupcancleGrid').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="container mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">

       
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">
                    Search for Name:
                </label>
                <input id="searchforName" type="text" class="form-control form-control-sm" placeholder="">
            </div>
           
        </div>
    </div>

    <div id="logcancelContainer" class="gridContainer mt-2"></div>
</div>


<div id="popupviewGrid">

    <div class="d-flex justify-content-start mb-3 gap-2">
        <h5 class="mb-0">View Wake Up Call</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">

        <button id="btnExportExcel" class="mui-button mui-button-export" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button onclick="$('#popupviewGrid').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>


    <div class="row" style="height: calc(100% - 120px);">
        <div id="logviewContainer" class="gridContainer col-10 border p-2 overflow-auto">
            <!-- nội dung list -->
        </div>
        <div id="logviewdetailContainer" class="gridContainer col-2 border p-2 overflow-auto">
            <!-- chi tiết -->
        </div>
    </div>

</div>

<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>

<script>
    $(document).ready(function () {
        initializeTomSelects();
         var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
        console.log(businessDateStr);
        // Lấy phần ngày tháng năm
        var dateOnly = businessDateStr.split(' ')[0]; // '8/29/2024'
        var dateParts = dateOnly.split('/'); // ['8', '29', '2024']

        // Parse đúng thứ tự: new Date(year, monthIndex, day)
            parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

        // Gán vào input type="date"
          $('#singleDate').val(formatDate(parsedBusinessDate));
        $('#fromDate').val(formatDate(parsedBusinessDate));
            $('#toDate').val(formatDate(parsedBusinessDate));
              $('#fromDateview').val(formatDate(parsedBusinessDate));
            $('#toDateview').val(formatDate(parsedBusinessDate));
                        $("#viewWakeupcall").hide();
           function toggleSection() {
                // Reset class
                $("#dateSection, #dailySection, #roomnoGroup, #scheduleGroup")
                    .removeClass("show-important hidden-important show-important1");

                // check call (Date / Daily)
                if ($("#rdoDate").is(":checked")) {
                    $("#dateSection").addClass("show-important");
                    $("#dailySection").addClass("hidden-important");
                } else {
                    $("#dateSection").addClass("hidden-important");
                    $("#dailySection").addClass("show-important1");
                }

                // check wake (Set / Cancel / View)
                if ($("#rdoSet").is(":checked")) {
                        $("#setWakeup").show();
                    $("#viewWakeupcall").hide();
                    $("#roomnoGroup").addClass("show-important");
                    $("#scheduleGroup").addClass("hidden-important");

                    // đổi label radio về mặc định
                    $("#rdoDate").closest("label").contents().last()[0].nodeValue = " Date";
                    $("#rdoDaily").closest("label").contents().last()[0].nodeValue = " Daily";

                    // if ($("#rdoDaily").is(":checked")) {
                    //     $("#scheduleGroup").removeClass("hidden-important").addClass("show-important");
                    //     $("#scheduleLabel").text("Room:");
                    // } else {
                    //     $("#scheduleLabel").text("Schedule:");
                    // }

                        $("#dateSection :input, #dailySection :input").prop("readonly", false);
                        // Ẩn/hiện nút
                    $("#btnSetwakeup").show();   // Delete ẩn
                    $("#btnCancelwakeup").hide(); // Set hiện
                           $("#btnViewwakeup").hide();   // Delete ẩn
           

                } else if ($("#rdoCancle").is(":checked")) {
                      $("#setWakeup").show();
                    $("#viewWakeupcall").hide();
                    $("#roomnoGroup").addClass("hidden-important");
                    $("#scheduleGroup").addClass("show-important");
                    $("#scheduleLabel").text("Schedule:");

                    // đổi text radio
                    $("#rdoDate").closest("label").contents().last()[0].nodeValue = " Special Call";
                    $("#rdoDaily").closest("label").contents().last()[0].nodeValue = " All Call";

                    if ($("#rdoDaily").is(":checked")) {
                        $("#scheduleGroup").removeClass("hidden-important").addClass("show-important");
                        $("#scheduleLabel").text("Room:");
                    } else {
                        $("#scheduleLabel").text("Schedule:");
                    }
                           $("#dateSection :input, #dailySection :input").prop("readonly", true);
                                        // Ẩn/hiện nút
                    $("#btnSetwakeup").hide();    // Delete hiện
                    $("#btnCancelwakeup").show(); // Set ẩn
                      $("#btnViewwakeup").hide();   // Delete ẩn
                } 
                else if ($("#rdoView").is(":checked")) {
                    $("#setWakeup").hide();
                    $("#viewWakeupcall").show();

                    $("#roomnoGroup, #scheduleGroup").addClass("hidden-important");

                    // đổi label radio về mặc định
                    $("#rdoDate").closest("label").contents().last()[0].nodeValue = " Date";
                    $("#rdoDaily").closest("label").contents().last()[0].nodeValue = " Daily";
                                   $("#btnSetwakeup").hide();    // Delete hiện
                    $("#btnCancelwakeup").hide(); // Set ẩn
                      $("#btnViewwakeup").show();   // Delete ẩn
                }else {
                    // View mode
                    $("#roomnoGroup, #scheduleGroup").addClass("hidden-important");

                    // đổi label radio về mặc định
                    $("#rdoDate").closest("label").contents().last()[0].nodeValue = " Date";
                    $("#rdoDaily").closest("label").contents().last()[0].nodeValue = " Daily";
                  }
                }

                // Gọi khi load
                toggleSection();

                // Bắt sự kiện
                $("input[name='call']").change(toggleSection);
                $("input[name='wake']").change(toggleSection);

            $("#rdoTimeView").on("click", function () {
                if ($(this).data("waschecked")) {
                    $(this).prop("checked", false);
                    $(this).data("waschecked", false);
                } else {
                    $("input[name='timeView']").data("waschecked", false); // reset các radio khác
                    $(this).data("waschecked", true);
                }
            });


    });

      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }
    function initializeTomSelects() {
             const selectors = ["#zone,#roomview"];

             for (const id of selectors) {
                 const el = document.querySelector(id);
                 if (!el) continue;

                 if (el.tomselect) el.tomselect.destroy();

                 const ts = new TomSelect(el, {
                     plugins: ['remove_button'],
                     create: false,
                     maxItems: null,
                     allowEmptyOption: true,
                     placeholder: '',
                     persist: false,
                     render: {
                         option: function (data, escape) {
                             return `<div>${escape(data.text)}</div>`;
                         }
                     }
                 });

             }
         }

    $(document).off("click", "#btnSetwakeup").on("click", "#btnSetwakeup", function () {

            let checkedRadio = $("input[name='call']:checked");
            let callType = checkedRadio.val();   // "date" hoặc "daily"

            $("#loadingSpinner").show();

             let requestData = {
                callType: callType,
                singleDate: $("#singleDate").val(),
                timeDate: $("#timeDate").val(),
                toDate: $("#toDate").val(),
                fromDate: $("#fromDate").val(),
                timeDaily: $("#timeDaily").val(),
                selectedRows: selectedRowsData  ,
                userID: localStorage.getItem("userID")
            };

            $.ajax({
                url: '/FrontDesk/SetWakeUpCall',
                type: 'POST',
                  contentType: "application/json",
                data: JSON.stringify(requestData),
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                        if (result.success) {
                        showToast('Success', result.message, true);   // true: thành công
                    } else {
                        showToast('Error', result.message, false);    // false: thất bại
                    }
                    $("#loadingSpinner").hide();
                },  
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });

          $(document).off("click", "#btnCancelwakeup").on("click", "#btnCancelwakeup", function () {
               let checkedRadio = $("input[name='call']:checked");
            let callType = checkedRadio.val();   // "date" hoặc "daily"

            // Thông báo khác nhau theo callType
            let confirmMessage = callType === "date"
                ? "Are you sure to delete?"
                : "Are you sure to delete all wake up call schedule in those rooms?";

            let confirmDelete = confirm(confirmMessage);
            if (!confirmDelete) {
                return; // Nếu chọn Cancel thì thoát
            }

            $("#loadingSpinner").show();

             let requestData = {
                callType: callType,
                singleDate: $("#singleDate").val(),
                timeDate: $("#timeDate").val(),
                toDate: $("#toDate").val(),
                fromDate: $("#fromDate").val(),
                timeDaily: $("#timeDaily").val(),
                selectedRows: selectedRowsData  ,
                userID: localStorage.getItem("userID")
            };

            $.ajax({
                url: '/FrontDesk/CancelWakeUpCall',
                type: 'POST',
                  contentType: "application/json",
                data: JSON.stringify(requestData),
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                        if (result.success) {
                        showToast('Success', result.message, true);   // true: thành công
                    } else {
                        showToast('Error', result.message, false);    // false: thất bại
                    }
                    $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });

         $(document).off("click", "#btnViewwakeup").on("click", "#btnViewwakeup", function () {

          

            $("#loadingSpinner").show();

            $.ajax({
                url: '/FrontDesk/ViewWakeUpCall',
                type: 'GET',
                  contentType: "application/json",
                data: {
                        name: $("#nameView").val(),
                        group: $("#groupName").val(),
                        roomview: $("#roomview").val().join(","),
                        fromDateview: $("#fromDateview").val(),
                        timeDailyview: $("#rdoTimeView").is(":checked") ? $("#timeDailyview").val() : null,
                        toDateview: $("#toDateview").val(),
                          roomClass: $("#roomClass").val(),
                    },
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                          initializeViewWakeUpCallGrid(result);
                              $("#popupviewGrid").show();
                                $('#overlay').fadeIn(200);
                            $('#popupviewGrid').fadeIn(200);
                    $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });

         $('#btnClosePopup, #overlay').click(function () {
                $('#popupLogGrid').fadeOut(200);
                $('#overlay').fadeOut(200);
                $('#popupcancleGrid').fadeOut(200);
                       $('#popupviewGrid').fadeOut(200);
            });

    $(document).off("click", "#listRoom, #btnSearch").on("click", "#listRoom, #btnSearch", function () {
        $.ajax({
            url: '/FrontDesk/WakeUpCallFindRoom',
            type: 'GET',
            data: {
                roomNoset: $("#roomNoset").val(),
                reservationHolder: $("#reservationHolder").val(),
                zone: $("#zone").val().join(","),
                confirmNo: $("#confirmNo").val(),
            },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
            },
            success: function (result) {
                console.log(result);
                    if (result !== null && result !== undefined && result.length > 0) {
                    initializeWakeUpCallFindRoomGrid(result);
                    $("#popupLogGrid").show();
                        $('#overlay').fadeIn(200);
                    $('#popupLogGrid').fadeIn(200);
                } else {
                    console.error("Dữ liệu trả về không hợp lệ:", result);
                    alert("Dữ liệu không đúng định dạng hoặc rỗng!");
                }

            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi tải dữ liệu chi tiết:", error);
            }
        });
    });

     $(document).off("click", "#cancleRoom").on("click", "#cancleRoom", function () {
           var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
        console.log(businessDateStr);

        var dateOnly = businessDateStr.split(' ')[0];
        var dateParts = dateOnly.split('/'); 


            parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

                       let checkedRadio = $("input[name='call']:checked");
            let callType = checkedRadio.val();   // "date" hoặc "daily"


        $.ajax({
            url: '/FrontDesk/WakeUpCallSearch',
            type: 'GET',
            data: {
                  currentDate: formatDate(parsedBusinessDate),
                  searchforName: $("#searchforName").val(),
                  isSpecial: $("#rdoDate").is(":checked") ? 1 : 0
            },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
            },
            success: function (result) {
                console.log(result);
                    if (result !== null && result !== undefined && result.length > 0) {
                    initializeWakeUpCallSearchGrid(result,callType);
                    $("#popupcancleGrid").show();
                        $('#overlay').fadeIn(200);
                    $('#popupcancleGrid').fadeIn(200);
                } else {
                    console.error("Dữ liệu trả về không hợp lệ:", result);
                    alert("Dữ liệu không đúng định dạng hoặc rỗng!");
                }

            },
            error: function (xhr, status, error) {
                console.error("Lỗi khi tải dữ liệu chi tiết:", error);
            }
        });
    });

    let selectedRowsData = []; // lưu danh sách các dòng được chọn
    let logGrid;
    let isAllSelected = false;
    function initializeWakeUpCallFindRoomGrid(data) {
        const columnWidth = 120;
        logGrid = $("#logGridContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                { dataField: "id", caption: "ID", visible: false },
                { dataField: "room", caption: "Room", width: 100 },
                { dataField: "confirmNo", caption: "Confirm no", width: columnWidth },
                { dataField: "name", caption: "Name", width: 180 },
                { dataField: "shareRoom", caption: "Share Room", width: columnWidth },
                { dataField: "arrDate", caption: "Arr date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "depDate", caption: "Dep date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "reservationHolder", caption: "Reservation holder", width: 180 }
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            showBorders: true,

            // bắt sự kiện khi select/deselect
            onSelectionChanged: function (e) {
                selectedRowsData = e.selectedRowsData;
                console.log("Các dòng được chọn:", selectedRowsData);
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
           logGrid = $("#logGridContainer").dxDataGrid("instance");
    }

      function initializeViewWakeUpCallGrid(data) {
        const columnWidth = 120;
        logGrid = $("#logviewContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: true,
             height: 700,
            columns: [
                { dataField: "id", caption: "ID", visible: false },
                { dataField: "shareRoom", caption: "ShareRoom", visible: false },
                { dataField: "status", caption: "Status", width: columnWidth },
                { dataField: "confirmationNo", caption: "Conf. no", width: columnWidth },
                { dataField: "roomNo", caption: "RoomNo", width: columnWidth },
                { dataField: "guestName", caption: "Guest Name", width: columnWidth },
                { dataField: "arrDate", caption: "Arr date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "depDate", caption: "Dep date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "wudate", caption: "WU Date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "wutime", caption: "WU Time", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "createdDate", caption: "Created Date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "updatedDate", caption: "Updated Date", dataType: "date", format: "yyyy-MM-dd", width: columnWidth },
                { dataField: "userCancel", caption: "User Cancel", width: columnWidth },
                { dataField: "userSetup", caption: "User Setup", width: columnWidth },
                { dataField: "", caption: "Remarks", width: columnWidth },
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: {
                mode: "single"   // chỉ chọn được 1 dòng
            },
            showBorders: true,

            // bắt sự kiện khi select/deselect
            onRowClick: function (e) {
                const rowData = e.data;
                 $.ajax({
                        url: '/FrontDesk/ViewWakeUpCallAccount',
                        type: 'GET',
                        data: {
                             
                              roomID: rowData.id,
                              shareRoom: rowData.shareRoom
                        },
                        headers: {
                            "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                        },
                        success: function (result) {
                            console.log(result);
                     
                                initializeViewWakeUpCallAccountGrid(result);
                           

                        },
                        error: function (xhr, status, error) {
                            console.error("Lỗi khi tải dữ liệu chi tiết:", error);
                        }
                    });
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
           logGrid = $("#logviewContainer").dxDataGrid("instance");
    }

       function initializeViewWakeUpCallAccountGrid(data) {
        const columnWidth = 120;
        logGrid = $("#logviewdetailContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                
                { dataField: "account", caption: "Account", width: 100 },

           
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
         
            showBorders: true,

            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
        
    }
       function initializeWakeUpCallSearchGrid(data,callType) {
        const columnWidth = 120;
        logGrid = $("#logcancelContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                   { dataField: "id", caption: "ID", visible: false },
                { dataField: "roomID", caption: "RoomID", visible: false },
                { dataField: "room", caption: "Room", width: 100 },
                
                { dataField: "name", caption: "Name", width: 180 },
                { dataField: "dateTime", caption: "Date/Time", width: 180 ,visible: callType === "date" },
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            showBorders: true,

            // bắt sự kiện khi select/deselect
            onSelectionChanged: function (e) {
                selectedRowsData = e.selectedRowsData;
                console.log("Các dòng được chọn:", selectedRowsData);
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
           logGrid = $("#logcancelContainer").dxDataGrid("instance");
    }


     $(document).off("click", "#btnCheckAll,#btnCheckAllcalcel").on("click", "#btnCheckAll,#btnCheckAllcalcel", function () {
        if (!logGrid) return;

        if (!isAllSelected) {
            logGrid.selectAll(); // chọn hết
            isAllSelected = true;

            // đổi text & icon
            $(this).html('<i class="fa-solid fa-xmark"></i> Unselect All');
        } else {
            logGrid.clearSelection(); // bỏ chọn hết
            isAllSelected = false;

            // đổi lại text & icon ban đầu
            $(this).html('<i class="fa-solid fa-check-double"></i> Select All');
        }
    });

    $(document).on("click", "#btnCheckone", function () {
        if (logGrid) {
            let visibleRows = logGrid.getVisibleRows().map(r => r.key);
            logGrid.selectRows(visibleRows, true); // ✅ chọn tất cả dòng đang hiển thị (theo filter/paging)
        }
    });
        $(document).off("click", "#btnOke").on("click", "#btnOke", function () {
        if (selectedRowsData.length === 0) {
            alert("Vui lòng chọn ít nhất 1 phòng!");
            return;
        }

        // Lấy danh sách room
        let rooms = selectedRowsData.map(x => x.room); // chú ý: dataField trong grid phải là "room"

        // Ghép lại thành chuỗi cách nhau bằng dấu ,
        $("#roomno").val(rooms.join(", "));

         $("#roomnoCancel").val(rooms.join(", "));  

         $('#popupLogGrid').fadeOut(200);
          $('#popupcancleGrid').fadeOut(200);
                $('#overlay').fadeOut(200);
    });
     $("#btnExportExcel").click(function () {
               const grid = $("#logviewContainer").dxDataGrid("instance"); var selectedReport2 = 'View Wake Up Call';
        var selectedReport = 'View Wake Up Call';
        if (!selectedReport) {
            alert("Vui lòng chọn báo cáo trước khi xuất Excel.");
            return;
        }

                     const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === Tạo header công ty (dòng 1) ===
       worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:E1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === Dòng 2: Thời gian xuất (phải) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', '', ' ' + exportDate]);
        worksheet.mergeCells('E2:H2');
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === Dòng 3–4: Trống
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === Dòng 5: Tên báo cáo ở giữa ===
        const reportRow = worksheet.addRow(['', '', selectedReport]);
        worksheet.mergeCells('C5:F5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === Dòng 6: Trống trước khi xuất dữ liệu
        worksheet.addRow([]);

        // === Export dữ liệu từ DevExtreme (bắt đầu từ dòng 7)
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 } // dữ liệu bắt đầu từ dòng 7
        }).then(function () {
            // Footer
            const lastRow = worksheet.lastRow.number + 2;

            worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = selectedReport + ".xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });
</script>