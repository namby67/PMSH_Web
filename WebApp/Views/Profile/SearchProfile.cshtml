@{
    ViewData["Title"] = "Search Profile";
}

@* <link href="~/css/pages/reservation.css" rel="stylesheet" asp-append-version="true" /> *@
<style>
    .note-textarea {
        height: 160px;
    }

    .ts-wrapper .ts-control {
        margin: 0 0 0 -8px !important;
        padding: 0px 0px 0px 5px !important;
    }

    .nav-link {
        color: #027C75 !important;
    }

    /* Ensure modals scroll correctly */
    .gridContainer {
        min-height: 200px;
    }

    .mui-card {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1) !important;
    }
</style>
<div id="loadingSpinner"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>

<div class="mt-1">
    <div class="header" style="justify-content:center;border:none">
        <h3 id="content-title">Search Profile</h3>
    </div>
    <div class="functions-pane mb-2 row">
        <div class=" col-md-10">
            <button class="mui-button mui-button-new" onclick="getAllProfiles();">Search</button>

            <button class="mui-button mui-button-new" onclick="editProfile('NEW');">New</button>
            <button class="mui-button mui-button-new" onclick="editProfile('EDIT');">Edit</button>
            <button class="mui-button mui-button-new" onclick="clearSearchForm();">Clear</button>
            <button class="mui-button mui-button-new" onclick="openModalOption();">Option</button>
            <button class="mui-button mui-button-new" onclick="openModalFuture();">Future</button>
            <button class="mui-button mui-button-new"
                onclick="window.location.href='@Url.Action("Index", "Home")'">Close</button>
        </div>
    </div>
    <div class="container ms-1">
        <!-- HÀNG 1: Select và Checkbox -->
        <div class="row g-3">
            <!-- View By -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtType" class="col-form-label me-2 text-end" style="width: 100px;">View By</label>
                <select id="txtType" class=" flex-grow-1">
                    <option value="2">Travel Agent</option>
                    <option value="1">Company</option>
                    <option value="3">Source</option>
                    <option value="0">Individual</option>
                    <option value="4">Group</option>
                    <option value="5">Contact</option>
                    <option value="" selected>View by All</option>
                </select>
            </div>

            <!-- City -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtCity" class="col-form-label me-2 text-end" style="width: 100px;">City</label>
                <select id="txtCity" class=" flex-grow-1"></select>
            </div>

            <!-- Area -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtArea" class="col-form-label me-2 text-end" style="width: 100px;">Area</label>
                <select id="txtArea" class=" flex-grow-1" disabled>
                    <option value="value">PMSh The Arena</option>
                </select>
            </div>

            <!-- Checkbox -->
            <div class="col-md-3 d-flex align-items-center">
                <div class="form-check ms-4">
                    <label class="col-form-label me-2 text-end" for="txtShowSaleInCharge">Show Sale In Charge</label>
                    <input type="checkbox" id="txtShowSaleInCharge" checked>
                </div>
            </div>
        </div>

        <!-- HÀNG 2: Input text -->
        <div class="row g-3">
            <!-- Name -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtAccount" class="col-form-label me-2 text-end" style="width: 100px;">Name</label>
                <input type="text" id="txtAccount" class="form-control flex-grow-1">
            </div>

            <!-- Keyword -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtKeyword" class="col-form-label me-2 text-end" style="width: 100px;">Keyword</label>
                <input type="text" id="txtKeyword" class="form-control flex-grow-1">
            </div>

            <!-- First Name -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtFirstName" class="col-form-label me-2 text-end" style="width: 100px;">First Name</label>
                <input type="text" id="txtFirstName" class="form-control flex-grow-1">
            </div>

            <!-- Code -->
            <div class="col-md-3 d-flex align-items-center">
                <label for="txtCode" class="col-form-label me-2 text-end" style="width: 100px;">Code</label>
                <input type="text" id="txtCode" class="form-control flex-grow-1">
            </div>
        </div>
    </div>

    <div class="mui-card mt-2">
        <div id="gridContainer" class="gridContainer"></div>

    </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel2" aria-hidden="true"
    id="modelReservation">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileTypeModalLabel">Reservation New</h5>

            </div>
            <div class="modal-body">
                <div style="height:1px;background-color:#ececec" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"
                    onclick="$('#modelReservation').modal('hide');">
                    Close
                </button>
                <button type="button" class="btn btn-primary" style="background-color:#01579b">Save changes</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalOption" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: 1px solid #bcbcbc">
            <div class="modal-header">
                <h5 class="modal-title">Profile Options</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeModalOption();"></button>
            </div>

            <div class="modal-body">
                <div class="toolbar-menu mt-2 row" id="functionAndOption">

                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openModalChanges();">Changes</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="deleteProfile();">Delete</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openModalFuture();">Future</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="GetProfileHistory();">History</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openModalMembership();">Memberships</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openConfirmRoomUnAssign();">Merge</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openConfirmRoomUnAssign();">Neg.Rates</a>
                    <a href="#" class="font-semibold col-md-4 mb-1" onclick="openConfirmRoomUnAssign();">Profile
                        Update</a>
                    <a href="#" class="font-semibold col-md-4 mb-1"
                        onclick="openConfirmRoomUnAssign();">Relationships</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade modal-xl" id="modalHistory" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="">
                    <button class="mui-button mui-button-new" id="attach" onclick="AttachAccompanying();">
                        Attach</button>
                    <button class="mui-button mui-button-new" id="detach" onclick="detach()">Detach</button>
                    <button class="mui-button mui-button-new" id="detach"
                        onclick="openModalViewProfile()">Profile</button>

                    <button class="mui-button mui-button-new" data-bs-dismiss="modal"> Close</button>
                </div>


                <div class="mui-card mt-2">
                    <div id="gridContainerHistory" class="mt-2 gridContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("Options/Membership")
@await Html.PartialAsync("Options/Changes")
@await Html.PartialAsync("Options/Future")
@await Html.PartialAsync("~/Views/Profile/NewProfileModal/_ProfileIndividual.cshtml")
@await Html.PartialAsync("~/Views/Profile/NewProfileModal/_ProfileCompany.cshtml")
@await Html.PartialAsync("~/Views/Profile/NewProfileModal/_ProfileGroup.cshtml")
@await Html.PartialAsync("~/Views/Profile/NewProfileModal/_ProfileContact.cshtml")

<script>
    document.querySelectorAll('.profile-modal').forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
            closeFormProfile();
        });
    });
    function closeFormProfile() {
        resetForm();
        applyValidationErrors([], "#profile_individual");
        applyValidationErrors([], "#profile_com_ta_source");
        applyValidationErrors([], "#profile_group");
        applyValidationErrors([], "#profile_contact");
    }
    $(document).ready(async function () {
        getAllCity();
        getAllProfiles();
        getAllLanguage2();
        getAllTitle2();
        getAllNationality2();
        getAllCountry2();
        getAllState2();
        getAllCity2();
        getAllVIP2();
        getAllOwner2();
        getAllTerritory2();
        getCompanyType2();
        getCurrency2();
        getMarketType2();
        getPersonInCharge2();
    });
    function openModalOption() {
        $('#modalOption').modal('show');
    }
    function closeModalOption() {
        $('#modalOption').modal('hide');
    }
    function getAllCity() {
        $.ajax({
            url: '/Profile/GetAllCity',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {

                if (result.length > 0) {
                    $('#txtCity').empty();
                    var html = `<option value=''>Select city</option>`;
                    for (var i = 0; i < result.length; i++) {
                        html += `<option value='${result[i].name}'>${result[i].code} - ${result[i].name}</option>`
                    }
                    $('#txtCity').append(html);
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải chi tiết danh sách danh mục dịch vụ hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllProfiles() {
        $("#loadingSpinner").show(); // 👉 Show spinner

        $.ajax({
            url: '/Profile/GetAllProfiles',
            type: 'get',
            dataType: 'json',
            data: {
                code: $('#txtCode').val(),
                account: $('#txtAccount').val(),
                firstName: $('#txtFirstName').val(),
                keyWord: $('#txtKeyword').val(),
                city: $('#txtCity').val(),
                type: $('#txtType').val(),
                showSaleInCharge: $("#txtShowSaleInCharge").is(":checked"),
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                listProfiles = result;
                console.log(result);
                initializeDataGrid(result);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải chi tiết danh sách danh mục dịch vụ hoặc bạn không có quyền tải");
                }
            },
            complete: function () {
                $("#loadingSpinner").hide(); // 👉 Hide spinner sau khi hoàn tất
            }
        });
    }
    function clearSearchForm() {

        /* ========================= */
        /* Clear input text */
        /* ========================= */
        $('#txtAccount').val('');
        $('#txtKeyword').val('');
        $('#txtFirstName').val('');
        $('#txtCode').val('');

        /* ========================= */
        /* Clear select */
        /* ========================= */
        $('#txtType').val('');      // View by All
        $('#txtCity').val(null);

        /* Nếu dùng TomSelect */
        if ($('#txtCity')[0]?.tomselect) {
            $('#txtCity')[0].tomselect.clear();
        }

        /* ========================= */
        /* Optional: reload grid */
        /* ========================= */
        // getAllProfiles();
    }

    var profileID = 0;

    var profileType = 0;
    var profileName = "";
    function initializeDataGrid(data) {
        var columnWidth = 150;
        var typeValue = $("#txtType").val();

        // 👉 Khai báo cột Tax Code riêng
        var taxCodeColumn = {
            dataField: "taxCode",
            caption: "Tax Code",
            width: columnWidth - 30
        };

        // 👉 Khởi tạo mảng columns ban đầu
        var columns = [
            { dataField: "id", caption: "ID", width: columnWidth - 80, visible: false },
            { dataField: "code", caption: "Code", width: columnWidth - 50 },
            {
                dataField: "vip",
                caption: "Vip",
                width: columnWidth - 80,
                visible: typeValue != "1"
            },
            { dataField: "account", caption: "Account", width: columnWidth * 2 },
        ];

        // 👉 Nếu type = 1 → Tax Code đứng vị trí thứ 3
        if (typeValue === "1") {
            columns.push(taxCodeColumn);
        }

        // 👉 Các cột còn lại
        columns = columns.concat([

            {
                dataField: "dateOfBirth",
                caption: "DateOfBirth",
                width: columnWidth,
                dataType: "date",
                format: "dd/MM/yyyy",
                visible: typeValue != "1",
                calculateCellValue: function (data) {
                    if (!data.dateOfBirth) return null;

                    // value: "22.12.2025"
                    const parts = data.dateOfBirth.split(".");
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            },

            { dataField: "passPort", caption: "PassPort", width: columnWidth, visible: typeValue != "1" },
            { dataField: "identityCard", caption: "IdentityCard", width: columnWidth, visible: typeValue != "1" },


            { dataField: "city", caption: "City", width: columnWidth },
            { dataField: "nationality", caption: "Nat", width: columnWidth - 60 },
            { dataField: "address", caption: "Address", width: columnWidth + 50 },
            { dataField: "handPhone", caption: "HandPhone", width: columnWidth },
            { dataField: "telephone", caption: "Telephone", width: columnWidth },
            { dataField: "email", caption: "Email", width: columnWidth },
            { dataField: "website", caption: "Website", width: columnWidth }
        ]);

        // 👉 Nếu type ≠ 1 → Tax Code giữ vị trí cũ (sau Website)
        if (typeValue !== "1") {
            columns.push(taxCodeColumn);
        }

        columns = columns.concat([

            { dataField: "fullAccount", caption: "Company", width: columnWidth },
            { dataField: "homeAddress", caption: "Business Address", width: columnWidth + 30 },

            { dataField: "arNo", caption: "ARNo", width: columnWidth, visible: typeValue == "1" },
            { dataField: "postalCode", caption: "Postal Code", width: columnWidth },
            { dataField: "keyword", caption: "Keyword", width: columnWidth },
            { dataField: "acctContact", caption: "Acct.Contact", width: columnWidth, visible: typeValue == "1" },
            { dataField: "description", caption: "Description", width: columnWidth },

            { dataField: "returnGuest", caption: "Return", width: columnWidth - 60, visible: typeValue != "1" },
            { dataField: "stayNo", caption: "Stay No", width: columnWidth - 60, visible: typeValue != "1" },

            {
                dataField: "personInChargeID",
                caption: "Sale In Charge",
                width: columnWidth,
                lookup: {
                    dataSource: saleInChargeData,
                    valueExpr: "id",
                    displayExpr: function (item) {
                        return item ? item.name : "";
                    }
                }
            }
        ]);

        // 👉 Init grid
        $("#gridContainer").dxDataGrid({
            dataSource: data,
            columns: columns,
            allowColumnResizing: true,
            paging: { pageSize: 15 },
            scrolling: { rowRenderingMode: 'virtual' },
            pager: {
                visible: true,
                allowedPageSizes: [15, 20, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "none"
            },
            showBorders: false,
            onRowClick: function (e) {
                profileID = e.data.id;
                profileType = e.data.type;
                profileName = e.data.account;
            }
        });
    }

    $('#txtFullNameIndividual').on('blur', function () {
        var input = $(this).val().trim();

        if (input === '') return;

        $.ajax({
            url: '/Profile/FullNameChange',
            type: 'POST',
            dataType: 'json',
            crossDomain: false,
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": $('input[name="__RequestVerificationToken"]').val()
            },
            data: {
                fullName: input
            },
            success: function (res) {
                console.log(res);
                if (res && res.success) {

                    // Full name đã chuẩn hóa
                    if (res.FullName) {
                        $('#txtFullNameIndividual').val(res.fullName);
                    }

                    // Các field khác (nếu có)
                    if ($('#txtFirstNameIndividual').length)
                        $('#txtFirstNameIndividual').val(res.firstName);

                    if ($('#txtMiddleNameIndividual').length)
                        $('#txtMiddleNameIndividual').val(res.middleName);

                    if ($('#txtLastNameIndividual').length)
                        $('#txtLastNameIndividual').val(res.lastName);

                    if ($('#txtSalutationIndividual').length)
                        $('#txtSalutationIndividual').val(res.salutation);


                    // Title (nếu có dropdown)
                    if (res.titleID) {
                        let selectTitle = $('#txtTitleIndividual')[0].tomselect;
                        selectTitle.setValue(res.titleID);
                    }
                }
            },
            error: function (xhr) {
                console.error('FullNameChange API error', xhr);
            }
        });
    });

    function reserveProfile() {
        $('#modelReservation').modal('show');
    }


    function editProfile(mode) {
        var grid = $("#gridContainer").dxDataGrid("instance");
        var selectedRowsData = grid.getSelectedRowsData();
        console.log(mode);
        if (mode === 'NEW') {

            resetForm();          // clear toàn bộ form
            if ($('#txtType').val() == 1 || $('#txtType').val() === '') {
                $('#modalProfileIndividual').modal('show');
                $('#btnView').hide();
                $('#changeTypeIN').hide();
            } else if ($('#txtType').val() == 4) {
                $('#modalProfileGroup').modal('show');
                $('#changeTypeGR').hide();
            } else if ($('#txtType').val() == 5) {
                $('#modalProfileContact').modal('show');
                $('#changeTypeCON').hide();
            }
            else {
                $('#modalProfileCompany').modal('show');
                $('#changeTypeCOM').hide();
            }


            selectedRowsData = null;
            return;
        }

        if (mode === 'EDIT') {
            if (selectedRowsData.length < 1) {
                showToast("Warning", "Please choose 1 profile to edit", false);
                return;
            }
            $("#profileTypeModalLabel").text("Edit  Profile");
            $.ajax({
                url: '/Profile/GetProfileByID',
                type: 'get',
                dataType: 'json',
                crossDomain: false,
                headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                data: {
                    id: selectedRowsData[0].id
                },
                success: function (result) {
                    console.log(result);
                    if (result.code != 0) {
                        showToast("Error", result.msg, false);
                        return;
                    }
                    else {
                        if (result.profile.type == 0) {
                            $("#txtCodeIndividual").val(result.profile.code);
                            $("#txtFullNameIndividual").val(result.profile.account);
                            $("#txtLastNameIndividual").val(result.profile.lastName);
                            $("#txtFirstNameIndividual").val(result.profile.firstname);
                            $("#txtMiddleNameIndividual").val(result.profile.middleName);
                            // $("#txtCityIndividual").val(result.profile.city);
                            $("#txtReasonIndividual").val(result.profile.vipReason);
                            let selectCity = $('#txtCityIndividual')[0].tomselect;
                            selectCity.setValue(result.profile.city);

                            let selectLanguage = $('#txtLanguageIndividual')[0].tomselect;
                            selectLanguage.setValue(result.profile.languageID);
                            let selectTitle = $('#txtTitleIndividual')[0].tomselect;
                            selectTitle.setValue(result.profile.titleID);
                            let selectNationality = $('#txtNationalityIndividual')[0].tomselect;
                            selectNationality.setValue(result.profile.nationalityID);
                            let selectCountry = $('#txtCountryIndividual')[0].tomselect;
                            selectCountry.setValue(result.profile.countryID);
                            $("#txtPostalIndividual").val(result.profile.postalCode);
                            $("#txtReligionIndividual").val(result.profile.religion);
                            $("#txtNationIndividual").val(result.profile.nation);
                            let selectState = $('#txtStateIndividual')[0].tomselect;
                            selectState.setValue(result.profile.stateID);
                            $("#txtPurposeIndividual").val(result.profile.purposeOfStay);
                            $("#txtAddressIndividual").val(result.profile.address);
                            $("#txtSalutationIndividual").val(result.profile.salutation);
                            let selectVIP = $('#txtVIPIndividual')[0].tomselect;
                            selectVIP.setValue(result.profile.vipid);
                            //$("#ReasonIndividual").val(result.profile.vipReason);
                            $("#txtPrefRoomIndividual").val(result.profile.prefRoom);
                            $("#txtOtherIndividual").val(result.profile.other);
                            $("#txtPassportIndividual").val(result.profile.passPort);
                            $("#txtCardIndividual").val(result.profile.identityCard);
                            $("#txtDobIndividual").val(formatDateForInputISO(result.profile.dateOfBirth));
                            if (result.profile.active) {
                                $("#txtActiveIndividual").prop("checked", true);
                            } else {
                                $("#txtActiveIndividual").prop("checked", false);
                            }
                            if (result.profile.contact) {
                                $("#txtContactIndividual").prop("checked", true);
                            } else {
                                $("#txtContactIndividual").prop("checked", false);
                            }
                            $("#txtKeywordIndividual").val(result.profile.keyword);
                            $("#txtCompanyIndividual").val(result.profile.fullAccount);
                            $("#txtCompany2Individual").val(result.profile.company);
                            $("#txtAddressIndividual").val(result.profile.address);
                            $("#txtTaxIndividual").val(result.profile.taxCode);
                            $("#txtBusAddressIndividual").val(result.profile.homeAddress);
                            $("#txtTelephoneIndividual").val(result.profile.telephone);
                            $("#txtHandPhoneIndividual").val(result.profile.handPhone);
                            $("#txtFaxIndividual").val(result.profile.fax);
                            $("#txtEmailIndividual").val(result.profile.email);
                            $("#txtWebsiteIndividual").val(result.profile.website);
                            $("#txtBusinessTitleIndividual").val(result.profile.businessTitle);
                            if (result.profile.isBlackList) {
                                $("#txtBlackListIndividual").prop("checked", true);
                            } else {
                                $("#txtBlackListIndividual").prop("checked", false);
                            }
                            $("#blackListIndividual").val(result.profile.blackListReason);
                            $("#txtNoteIndividual").val(result.profile.description);
                            $('#modalProfileIndividual').modal('show');
                            $('#changeTypeIN').hide();
                        }
                        else if (result.profile.type == 1 || result.profile.type == 2 || result.profile.type == 3) {
                            $("#txtCodeCOM").val(result.profile.code);
                            //$("#txtCityCOM").val(result.profile.city);
                            $("#txtAccountCOM").val(result.profile.account);
                            $("#txtAddressCOM").val(result.profile.address);
                            // $("#txtCountryCOM").val(result.profile.countryID);
                            // $("#txtCityCOM").val(result.profile.city);
                            let selectCountryCOM = $('#txtCountryCOM')[0].tomselect;
                            selectCountryCOM.setValue(result.profile.countryID);

                            let selectCityCOM = $('#txtCityCOM')[0].tomselect;
                            selectCityCOM.setValue(result.profile.city);


                            let selectStateCOM = $('#txtStateCOM')[0].tomselect;
                            selectStateCOM.setValue(result.profile.stateID);

                            let selectOwnerCOM = $('#txtOwnerCOM')[0].tomselect;
                            selectOwnerCOM.setValue(result.profile.ownerID);

                            let selectTerritoryCOM = $('#txtTerritoryCOM')[0].tomselect;
                            selectTerritoryCOM.setValue(result.profile.territoryID);

                            let selectCompanyTypeCOM = $('#txtCompanyTypeCOM')[0].tomselect;
                            selectCompanyTypeCOM.setValue(result.profile.memberType);

                            let selectCurrencyCOM = $('#txtCurrencyCOM')[0].tomselect;
                            selectCurrencyCOM.setValue(result.profile.currencyID);

                            let selectMarketCOM = $('#txtMarketCOM')[0].tomselect;
                            selectMarketCOM.setValue(result.profile.marketID);

                            let selectSaleInChargeCOM = $('#txtSaleInChargeCOM')[0].tomselect;
                            selectSaleInChargeCOM.setValue(result.profile.personInChargeID);

                            $("#txtPostalCOM").val(result.profile.postalCode);
                            // $("#txtStateCOM").val(result.profilestateID);
                            $("#txtCompanyCOM").val(result.profile.fullAccount);
                            $("#txtTaxCOM").val(result.profile.taxCode);
                            $("#txtBusAddressCOM").val(result.profile.homeAddress);
                            $("#txtContractName").val(result.profile.acctContact);
                            $("#txtTelephoneCOM").val(result.profile.telephone);
                            $("#txtContactNameCOM").val(result.profile.acctContact);
                            $("#txtEmailCOM").val(result.profile.email);
                            $("#txtWebsiteCOM").val(result.profile.website);
                            $("#txtHandPhoneCOM").val(result.profile.handPhone);
                            $("#txtCompany2COM").val(result.profile.company);
                            $("#txtBusTitleCOM").val(result.profile.businessTitle);
                            //    $("#txtOwnerCOM").val(result.profile.ownerID);
                            // $("#txtTerritoryCOM").val(result.profile.territoryID);
                            $("#txtKeywordCOM").val(result.profile.keyword);
                            // $("#txtCompanyTypeCOM").val(0);
                            $("#txtARCOM").val(result.profile.arNo);
                            //$("#txtCurrencyCOM").val(result.profile.currencyID);
                            // $("#txtSaleInChargeCOM").val(result.profile.personInChargeID);
                            //  $("#txtMarketCOM").val(result.profile.marketID);
                            if (result.profile.active === true) {
                                $("#txtActiveCOM").prop("checked", true);
                            } else {
                                $("#txtActiveCOM").prop("checked", false);
                            }

                            if (result.profile.isBlackList === true) {
                                $("#txtBlackListCOM").prop("checked", true);
                            } else {
                                $("#txtBlackListCOM").prop("checked", false);
                            }
                            //$("#txtBlackListCOM").is(":checked");
                            $("#blackListCOM").val(result.profile.blackListReason);
                            console.log(result.profile.description);
                            $("#txtNoteCOM").val(result.profile.description);
                            $('#modalProfileCompany').modal('show');
                            $('#changeTypeCOM').hide();
                        }
                        else if (result.profile.type == 4) {
                            $("#txtCodeGroup").val(result.profile.code);
                            //$("#txtCityCOM").val(result.profile.city);
                            $("#txtGroupName").val(result.profile.account);
                            $("#txtAddressGroup").val(result.profile.address);
                            // $("#txtCountryCOM").val(result.profile.countryID);
                            // $("#txtCityCOM").val(result.profile.city);
                            let selectCountryGroup = $('#txtCountryGroup')[0].tomselect;
                            selectCountryGroup.setValue(result.profile.countryID);


                            $("#txtCityGroup").val(result.profile.city)


                            let selectStateGroup = $('#txtStateGroup')[0].tomselect;
                            selectStateGroup.setValue(result.profile.stateID);

                            let selectLanguageGroup = $('#txtLanguageGroup')[0].tomselect;
                            selectLanguageGroup.setValue(result.profile.languageID);

                            let selectCurrencyGroup = $('#txtCurrencyGroup')[0].tomselect;
                            selectCurrencyGroup.setValue(result.profile.currencyID);


                            $("#txtPostalGroup").val(result.profile.postalCode);
                            $("#txtFax").val(result.profile.fax);
                            $("#txtHomeAddressGroup").val(result.profile.homeAddress);
                            $("#txtContractNameGroup").val(result.profile.acctContact);
                            $("#txtTelephoneGroup").val(result.profile.telephone);
                            $("#txtEmailGroup").val(result.profile.email);
                            $("#txtWebsiteGroup").val(result.profile.website);
                            $("#txtHandPhoneGroup").val(result.profile.handPhone);
                            $("#txtCityGroup").val(result.profile.city);
                            $("#txtVipReasonGroup").val(result.profile.vipReason);

                            let selectVIP = $('#txtVIPGroup')[0].tomselect;
                            selectVIP.setValue(result.profile.vipid);
                            // $("#txtCompanyTypeCOM").val(0);
                            $("#txtAcctContact").val(result.profile.acctContact);
                            // $("#txtSaleInChargeCOM").val(result.profile.personInChargeID);
                            //  $("#txtMarketCOM").val(result.profile.marketID);
                            if (result.profile.history === true) {
                                $("#txtHistoryGroup").prop("checked", true);
                            } else {
                                $("#txtHistoryGroup").prop("checked", false);
                            }

                            //$("#txtBlackListCOM").is(":checked");

                            $("#txtNotesGroup").val(result.profile.description);
                            $('#modalProfileGroup').modal('show');
                            $('#changeTypeGR').hide();
                        }
                        else {

                        }
                    }
                },
                error: function (xhr, statusText, err) {

                }
            });
        }
    }

    function deleteProfile() {

        if (!profileID || profileID <= 0) {
            showToast("Error", "Invalid profile.", false)
            return;
        }

        if (!confirm("Are you sure you want to delete this profile?")) {
            return;
        }

        $.ajax({
            url: '/Profile/DeleteProfile',
            type: 'POST',
            data: {
                profileID: profileID
            },
            success: function (res) {
                if (res.success) {
                    showToast("Success", res.message, true);
                }
                else {
                    showToast("Error", res.message, false)
                }
            },
            error: function (err) {
                if (err.responseJSON && err.responseJSON.message) {
                    showToast("Error", err.responseJSON.message, false);
                } else {
                    showToast("Error", "Delete failed.", false);
                }
            }
        });
    }


    function resetForm() {


        const individualInputs = [
            "#txtCodeIndividual", "#txtFullNameIndividual",
            "#txtLastNameIndividual", "#txtFirstNameIndividual",
            "#txtMiddleNameIndividual", "#txtReasonIndividual",
            "#txtPostalIndividual", "#txtReligionIndividual",
            "#txtNationIndividual", "#txtPurposeIndividual",
            "#txtAddressIndividual", "#txtSalutationIndividual",
            "#txtPrefRoomIndividual", "#txtOtherIndividual",
            "#txtPassportIndividual", "#txtCardIndividual",
            "#txtDobIndividual", "#txtKeywordIndividual",
            "#txtCompanyIndividual", "#txtCompany2Individual",
            "#txtTaxIndividual", "#txtBusAddressIndividual",
            "#txtTelephoneIndividual", "#txtHandPhoneIndividual",
            "#txtFaxIndividual", "#txtEmailIndividual",
            "#txtWebsiteIndividual", "#txtBusinessTitleIndividual",
            "#blackListIndividual", "#txtNoteIndividual"
        ];

        individualInputs.forEach(id => {
            if ($(id).length) {
                $(id).val("");
            }
        });

        const individualCheckboxes = [
            "#txtActiveIndividual", "#txtContactIndividual",
            "#txtBlackListIndividual"
        ];

        individualCheckboxes.forEach(id => {
            if ($(id).length) {
                $(id).prop("checked", false);
            }
        });

        const individualTomSelects = [
            "#txtCityIndividual", "#txtLanguageIndividual",
            "#txtTitleIndividual", "#txtNationalityIndividual",
            "#txtCountryIndividual", "#txtStateIndividual",
            "#txtVIPIndividual"
        ];

        individualTomSelects.forEach(id => {
            if ($(id).length && $(id)[0].tomselect) {
                $(id)[0].tomselect.clear();
            }
        });

        /* ===================== */
        /* COMPANY (TYPE = 1–3)  */
        /* ===================== */

        const companyInputs = [
            "#txtCodeCOM", "#txtAccountCOM", "#txtAddressCOM",
            "#txtPostalCOM", "#txtCompanyCOM", "#txtTaxCOM",
            "#txtBusAddressCOM", "#txtContractName",
            "#txtContactNameCOM", "#txtTelephoneCOM",
            "#txtEmailCOM", "#txtWebsiteCOM",
            "#txtHandPhoneCOM", "#txtCompany2COM",
            "#txtBusTitleCOM", "#txtKeywordCOM",
            "#txtARCOM", "#blackListCOM", "#txtNoteCOM"
        ];

        companyInputs.forEach(id => {
            if ($(id).length) {
                $(id).val("");
            }
        });

        const companyCheckboxes = [
            "#txtActiveCOM", "#txtBlackListCOM"
        ];

        companyCheckboxes.forEach(id => {
            if ($(id).length) {
                $(id).prop("checked", false);
            }
        });

        const companyTomSelects = [
            "#txtCountryCOM", "#txtCityCOM", "#txtStateCOM",
            "#txtOwnerCOM", "#txtTerritoryCOM", "#txtCompanyTypeCOM",
            "#txtCurrencyCOM", "#txtMarketCOM", "#txtSaleInChargeCOM"
        ];

        companyTomSelects.forEach(id => {
            if ($(id).length && $(id)[0].tomselect) {
                $(id)[0].tomselect.clear();
            }
        });

        /* ===================== */
        /* Group (TYPE = 4)  */
        /* ===================== */
        const groupInputs = [
            "#txtCodeGroup", "#txtGroupName", "#txtAddressGroup",
            "#txtHomeAddressGroup", "#txtCityGroup", "#txtPostalGroup",
            "#txtTelephoneGroup", "#txtContractNameGroup",
            "#txtEmailGroup", "#txtWebsiteGroup",
            "#txtHandPhoneGroup", "#txtAcctContact", "#txtFax",
            "#txtCurrencyGroup", "#txtAccountGroup",
            "#txtVipGroup", "#txtVipReasonGroup",
            "#txtNotesGroup"
        ];

        groupInputs.forEach(id => {
            if ($(id).length) {
                $(id).val("");
            }
        });

        const groupCheckboxes = [
            "#txtHistoryGroup"
        ];

        groupCheckboxes.forEach(id => {
            if ($(id).length) {
                $(id).prop("checked", false);
            }
        });

        const groupTomSelects = [
            "#txtLanguageGroup", "#txtCountryGroup", "#txtStateGroup",
            "#txtCurrencyGroup", "#txtAccountGroup", "#txtVipGroup"
        ];

        groupTomSelects.forEach(id => {
            if ($(id).length && $(id)[0].tomselect) {
                $(id)[0].tomselect.clear();
            }
        });
    }



    function getAllLanguage2() {
        $.ajax({
            url: '/Profile/GetAllLanguage',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtLanguageIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa danh sách options cũ
                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    select.setValue('0'); // Chọn option mặc định

                    let select2 = $('#txtLanguageGroup')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa danh sách options cũ

                    result.forEach(item => {
                        select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách ngôn ngữ hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllTitle2() {
        $.ajax({
            url: '/Profile/GetAllTitle',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtTitleIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    select.setValue('0'); // Chọn giá trị mặc định
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllNationality2() {
        $.ajax({
            url: '/Profile/GetAllNationality',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtNationalityIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    select.setValue('0'); // Chọn giá trị mặc định
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllCountry2() {
        $.ajax({
            url: '/Profile/GetAllCountry',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtCountryIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ
                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    let select2 = $('#txtCountryCOM')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    let select3 = $('#txtCountryGroup')[0].tomselect; // Lấy instance của TomSelect
                    select3.clear(); // Xóa giá trị hiện tại
                    select3.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select3.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllState2() {
        $.ajax({
            url: '/Profile/GetAllState',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                console.log(result);
                if (result.length > 0) {
                    let select = $('#txtStateIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        // select.addOption({ value: item.id, text: `${item.StateName} - ${item.name}` });
                        select.addOption({ value: item.id, text: `${item.stateName}` });
                    });


                    let select2 = $('#txtStateCOM')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ
                    result.forEach(item => {
                        //  select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                        select2.addOption({ value: item.id, text: `${item.stateName}` });
                    });


                    let select3 = $('#txtStateGroup')[0].tomselect; // Lấy instance của TomSelect
                    select3.clear(); // Xóa giá trị hiện tại
                    select3.clearOptions(); // Xóa tất cả option cũ
                    result.forEach(item => {
                        //  select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                        select3.addOption({ value: item.id, text: `${item.stateName}` });
                    });
                }
                else {
                    let select = $('#txtStateIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    let select2 = $('#txtStateCOM')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ

                    let select3 = $('#txtStateGroup')[0].tomselect; // Lấy instance của TomSelect
                    select3.clear(); // Xóa giá trị hiện tại
                    select3.clearOptions(); // Xóa tất cả option cũ
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllCity2() {
        $.ajax({
            url: '/Profile/GetAllCity',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtCityIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.code, text: `${item.code} - ${item.name}` });
                    });

                    let select2 = $('#txtCityCOM')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select2.addOption({ value: item.code, text: `${item.code} - ${item.name}` });
                    });


                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllVIP2() {
        $.ajax({
            url: '/Profile/GetAllVIP',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtVIPIndividual')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                    @* select.on('change', function (value) {
                        if (!value || value === '0') {
                            $('#txtReasonIndividual').val('');
                            return;
                        }

                        // Lấy option đang chọn
                        let option = select.options[value];

                        if (option) {
                            // option.text = "CODE - NAME"
                            // Nếu chỉ muốn lấy NAME
                            let name = option.text.split(' - ').slice(1).join(' - ');

                            $('#txtReasonIndividual').val(name);
                        }
                    }); *@

                        let select2 = $('#txtVIPGroup')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllOwner2() {
        $.ajax({
            url: '/Profile/GetAllOwner',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtOwnerCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });


                    //  let select2 = $('#txtOwnerContact')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ

                    // result.forEach(item => {
                    //     select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    // });

                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getAllTerritory2() {
        $.ajax({
            url: '/Profile/GetAllTerritory',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtTerritoryCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });


                    // let select2 = $('#txtTerritoryContact')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ

                    // result.forEach(item => {
                    //     select2.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    // });

                }
                else {
                    let select = $('#txtTerritoryCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    //  let select2 = $('#txtTerritoryContact')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getCompanyType2() {
        $.ajax({
            url: '/Profile/GetAllCompanyType',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtCompanyTypeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });

                }
                else {
                    let select = $('#txtCompanyTypeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function getCurrency2() {
        $.ajax({
            url: '/Profile/GetAllCurrency',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtCurrencyCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.description}` });
                    });



                    // let select2 = $('#txtCurrencyGroup')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ

                    // result.forEach(item => {
                    //     select2.addOption({ value: item.id, text: `${item.description}` });
                    // });

                    let select2 = $('#txtCurrencyGroup')[0].tomselect; // Lấy instance của TomSelect
                    select2.clear(); // Xóa giá trị hiện tại
                    select2.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select2.addOption({ value: item.id, text: `${item.description}` });
                    });
                }
                else {
                    let select = $('#txtCurrencyCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    let select2 = $('#txtCurrencyGroup')[0].tomselect; // lấy instance của tomselect
                    select2.clear(); // xóa giá trị hiện tại
                    select2.clearoptions(); // xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    var saleInChargeData = [];
    function getPersonInCharge2() {
        $.ajax({
            url: '/Administration/PersonInChargeData',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                console.log(result);
                if (result.length > 0) {
                    saleInChargeData = result || [];
                    let select = $('#txtSaleInChargeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.code} - ${item.name}` });
                    });



                    // let select2 = $('#txtCurrencyGroup')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ

                    // result.forEach(item => {
                    //     select2.addOption({ value: item.id, text: `${item.description}` });
                    // });

                }
                else {
                    let select = $('#txtSaleInChargeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    // let select2 = $('#txtCurrencyGroup')[0].tomselect; // Lấy instance của TomSelect
                    // select2.clear(); // Xóa giá trị hiện tại
                    // select2.clearOptions(); // Xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }

    function getMarketType2() {
        $.ajax({
            url: '/Profile/GetMarketType',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtMarketTypeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.description}` });
                    });

                }
                else {
                    let select = $('#txtMarketTypeCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    $('#txtMarketTypeCOM').on('change', function () {

        getMarket2();
    });
    function getMarket2() {
        $.ajax({
            url: '/Profile/GetMarketByFK',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: { marketTypeID: $('#txtMarketTypeCOM').val() },
            success: function (result) {
                if (result.length > 0) {
                    let select = $('#txtMarketCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ

                    result.forEach(item => {
                        select.addOption({ value: item.id, text: `${item.description}` });
                    });

                }
                else {
                    let select = $('#txtMarketCOM')[0].tomselect; // Lấy instance của TomSelect
                    select.clear(); // Xóa giá trị hiện tại
                    select.clearOptions(); // Xóa tất cả option cũ
                }

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    informBox(TOAST_STATUS.DANGER, "Lỗi tải danh sách tiêu đề hoặc bạn không có quyền tải");
                }
            }
        });
    }
    function saveProfile() {
        var formData = new FormData();
        var grid = $("#gridContainer").dxDataGrid("instance");
        var txtType = Number($('#txtType').val());
        var selectedRowsData = grid.getSelectedRowsData();
        if (txtType === "" || txtType === "0") {
            formData.append('ID', selectedRowsData[0]?.id);
            formData.append('CodeIndividual', $("#txtCodeIndividual").val());
            formData.append('AccountIndividual', $("#txtFullNameIndividual").val());
            formData.append('LastNameIndivdual', $("#txtLastNameIndividual").val());
            formData.append('FirstNameIndividual', $("#txtFirstNameIndividual").val());
            formData.append('MiddleNameIndividual', $("#txtMiddleNameIndividual").val());
            formData.append('LanguageIndividual', $("#txtLanguageIndividual").val());
            formData.append('TitleIndividual', $("#txtTitleIndividual").val());
            formData.append('NationalityIndividual', $("#txtNationalityIndividual").val());
            formData.append('CountryIndividual', $("#txtCountryIndividual").val());
            formData.append('CityIndividual', $("#txtCityIndividual").val());
            formData.append('PostalIndividual', $("#txtPostalIndividual").val());
            formData.append('ReligionIndividual', $("#txtReligionIndividual").val());
            formData.append('NationIndividual', $("#txtNationIndividual").val());
            formData.append('StateIndividual', $("#txtStateIndividual").val());
            formData.append('PurposeIndividual', $("#txtPurposeIndividual").val());
            formData.append('AddressIndividual', $("#txtAddressIndividual").val());
            formData.append('SalutationIndividual', $("#txtSalutationIndividual").val());
            formData.append('VIPIndividual', $("#txtVIPIndividual").val());
            formData.append('ReasonIndividual', $("#txtReasonIndividual").val());
            formData.append('PrefRoomIndividual', $("#txtPrefRoomIndividual").val());
            formData.append('OtherIndividual', $("#txtOtherIndividual").val());
            formData.append('PassportIndividual', $("#txtPassportIndividual").val());
            formData.append('CardIndividual', $("#txtCardIndividual").val());
            formData.append('DobIndividual', $("#txtDobIndividual").val());
            formData.append('ActiveIndividual', $("#txtActiveIndividual").is(":checked"));
            formData.append('ContactIndividual', $("#txtContactIndividual").is(":checked"));
            formData.append('KeywordIndividual', $("#txtKeywordIndividual").val());
            //  formData.append('CompanyIndividual', $("#txtCompanyIndividual").val());
            formData.append('FullAccount', $("#txtCompanyIndividual").val());
            formData.append('TaxIndividual', $("#txtTaxIndividual").val());
            formData.append('BusAddressIndividual', $("#txtBusAddressIndividual").val());
            formData.append('TelephoneIndividual', $("#txtTelephoneIndividual").val());
            formData.append('HandPhoneIndividual', $("#txtHandPhoneIndividual").val());
            formData.append('FaxIndividual', $("#txtFaxIndividual").val());
            formData.append('EmailIndividual', $("#txtEmailIndividual").val());
            formData.append('WebsiteIndividual', $("#txtWebsiteIndividual").val());
            formData.append('Company2Individual', $("#txtCompany2Individual").val());
            formData.append('BusinessTitleIndividual', $("#txtBusinessTitleIndividual").val());
            formData.append('BlackListIndividual', $("#txtBlackListIndividual").is(":checked"));
            formData.append('BlackListReasonIndividual', $("#blackListIndividual").val());
            formData.append('NoteIndividual', $("#txtNoteIndividual").val());
            formData.append('Type', txtType);
        }
        else if (txtType === 2 || txtType === 3 || txtType === 1) {
            formData.append('ID', selectedRowsData[0]?.id);
            formData.append('CodeCOM', $("#txtCodeCOM").val());
            formData.append('AccountCOM', $("#txtAccountCOM").val());
            formData.append('CountryCOM', $("#txtCountryCOM").val());
            formData.append('CityCOM', $("#txtCityCOM").val());
            formData.append('PostalCOM', $("#txtPostalCOM").val());

            formData.append('StateCOM', $("#txtStateCOM").val());

            formData.append('AddressCOM', $("#txtAddressCOM").val());

            formData.append('ActiveCOM', $("#txtActiveCOM").is(":checked"));
            formData.append('KeywordCOM', $("#txtKeywordCOM").val());
            //  formData.append('CompanyIndividual', $("#txtCompanyIndividual").val());
            formData.append('FullAccount', $("#txtCompanyCOM").val());
            formData.append('TaxCOM', $("#txtTaxCOM").val());
            formData.append('BusAddressCOM', $("#txtBusAddressCOM").val());
            formData.append('TelephoneCOM', $("#txtTelephoneCOM").val());
            formData.append('HandPhoneCOM', $("#txtHandPhoneCOM").val());
            formData.append('ContractName', $("#txtContractName").val());
            formData.append('EmailCOM', $("#txtEmailCOM").val());
            formData.append('WebsiteCOM', $("#txtWebsiteCOM").val());
            formData.append('Company2COM', $("#txtCompany2COM").val());
            formData.append('BusTitleCOM', $("#txtBusTitleCOM").val());
            formData.append('BlackListCOMchecked', $("#txtBlackListCOM").is(":checked"));
            formData.append('BlackListCOM', $("#blackListCOM").val());
            formData.append('NoteCOM', $("#txtNoteCOM").val());
            formData.append('OwnerCOM', $("#txtOwnerCOM").val());
            formData.append('TerritoryCOM', $("#txtTerritoryCOM").val());
            formData.append('CompanyTypeCOM', $("#txtCompanyTypeCOM").val());
            formData.append('ARCOM', $("#txtARCOM").val());
            formData.append('CurrencyCOM', $("#txtCurrencyCOM").val());
            formData.append('SaleInChargeCOM', $("#txtSaleInChargeCOM").val());
            formData.append('MarketCOM', $("#txtMarketCOM").val());

            formData.append('Type', txtType);
        }
        else if (txtType === 4) {
            formData.append('ID', selectedRowsData[0]?.id);
            formData.append('CodeGroup', $("#txtCodeGroup").val());
            formData.append('GroupName', $("#txtGroupName").val());
            formData.append('LanguageGroup', $("#txtLanguageGroup").val());
            formData.append('AddressGroup', $("#txtAddressGroup").val());
            formData.append('HomeAddressGroup', $("#txtHomeAddressGroup").val());

            formData.append('CityGroup', $("#txtCityGroup").val());

            formData.append('PostalGroup', $("#txtPostalGroup").val());
            formData.append('CountryGroup', $("#txtCountryGroup").val());
            //  formData.append('CompanyIndividual', $("#txtCompanyIndividual").val());
            formData.append('StateGroup', $("#txtStateGroup").val());
            formData.append('TelephoneGroup', $("#txtTelephoneGroup").val());
            formData.append('ContractNameGroup', $("#txtContractNameGroup").val());
            formData.append('EmailGroup', $("#txtEmailGroup").val());
            formData.append('WebsiteGroup', $("#txtWebsiteGroup").val());
            formData.append('HandPhoneGroup', $("#txtHandPhoneGroup").val());
            formData.append('AcctContact', $("#txtAcctContact").val());
            formData.append('CurrGroup', $("#txtCurrencyGroup").val());
            formData.append('VipReasonGroup', $("#txtVipReasonGroup").val());
            formData.append('HistoryGroup', $("#txtHistoryGroup").is(":checked"));
            formData.append('VipGroup', $("#txtVipGroup").val());
            formData.append('NotesGroup', $("#txtNotesGroup").val());
            formData.append('Fax', $("#txtFax").val());
            formData.append('Type', txtType);
        }
        $.ajax({
            url: '/Profile/SaveProfile',
            type: 'POST',
            processData: false,
            contentType: false,
            // headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: formData,
            success: function (res) {
                if (res.success) {
                    closeFormProfile();
                    getAllProfiles();
                    resetForm();
                    showToast("Success", res.message, true);
                    var form = res.type;
                    if (form == 0) applyValidationErrors([], "#profile_individual");
                    else if (form == 1 || form == 2 || form == 3) applyValidationErrors([], "#profile_com_ta_source");
                    else if (form == 4) applyValidationErrors([], "#profile_group");
                    else applyValidationErrors([], "#profile_contact");
                } else {
                    var form = res.type;
                    if (form == 0) applyValidationErrors(res.errors, "#profile_individual");
                    else if (form == 1 || form == 2 || form == 3) applyValidationErrors(res.errors, "#profile_com_ta_source");
                    else if (form == 4) applyValidationErrors(res.errors, "#profile_group");
                    else applyValidationErrors(res.errors, "#profile_contact");
                    showToast("Error", res.message, false)
                }

            },
            error: function (xhr, statusText, err) {

            }
        });
    }

    function ReservationProfile() {
        var grid = $("#gridContainer").dxDataGrid("instance");
        var selectedRowsData = grid.getSelectedRowsData();
        if (selectedRowsData.length < 1) {
            informBox(TOAST_STATUS.DANGER, "Please choose 1 profile to reservation");
            return;
        }
        $.ajax({
            url: '/Profile/GetProfileByID',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: {
                id: selectedRowsData[0].id
            },
            success: function (result) {
                if (result.code != 0) {
                    informBox(TOAST_STATUS.DANGER, result.msg);
                    return;
                }
                else {
                    console.log('click');
                    $('#modelReservation').modal('show');
                }
            },
            error: function (xhr, statusText, err) {

            }
        });
    }


    function GetProfileHistory() {
        if (profileID == 0) {
            showToast("Error", "Please chooe at least 1 profile", false);
            return;
        }
        $.ajax({
            url: '/Profile/SearchProfileHistory',
            type: 'get',
            dataType: 'json',
            data: {
                profileID: profileID
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                $('#modalHistory').modal('show');
                initializeDataGridHistory(result);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            },

        });
    }

    function initializeDataGridHistory(data) {
        const columnWidth = 150;

        const columns = [
            { dataField: 'ConfirmationNo', caption: 'Conf.No', visible: true, width: columnWidth },
            { dataField: 'CRSNo', caption: 'CRSNo', visible: true, width: columnWidth },
            { dataField: 'ArrivalDate', caption: 'ArrivalDate', visible: true, width: columnWidth, dataType: "date", format: "dd/MM/yyyy" },
            { dataField: 'DepartureDate', caption: 'DepartureDate', visible: true, width: columnWidth, dataType: "date", format: "dd/MM/yyyy" },
            { dataField: 'RoomNo', caption: 'Room', visible: true, width: columnWidth },
            { dataField: 'RoomType', caption: 'Room Type', visible: true, width: columnWidth },
            { dataField: 'Rate', caption: 'Rate', visible: true, width: columnWidth },
            { dataField: 'CurrencyID', caption: 'Currency', visible: true, width: columnWidth },
            { dataField: 'RateCode', caption: 'Rate Code', visible: true, width: columnWidth },
            { dataField: 'NoOfAdult', caption: 'A', visible: true, width: columnWidth },
            { dataField: 'NoOfChild', caption: 'C', visible: true, width: columnWidth },
            { dataField: 'NoOfChild1', caption: 'C1', visible: true, width: columnWidth },
            { dataField: 'NoOfChild2', caption: 'C2', visible: true, width: columnWidth },
            { dataField: 'LastName', caption: 'Guest Name', visible: true, width: columnWidth },
            { dataField: 'BusinessBlockCode', caption: 'Block', visible: true, width: columnWidth },
            { dataField: 'MarketCode', caption: 'Market', visible: true, width: columnWidth },
            { dataField: 'SourceCode', caption: 'Source', visible: true, width: columnWidth },
            { dataField: 'ReservationHolder', caption: 'Reservation Holder', visible: true, width: columnWidth },
            { dataField: 'Status', caption: 'Status', visible: true, width: columnWidth },
            { dataField: 'TotalRevenue', caption: 'Total Rev', visible: true, width: columnWidth },
            { dataField: 'RoomRevenue', caption: 'Room Rev', visible: true, width: columnWidth },
            { dataField: 'FBRevenue', caption: 'F&B Rev', visible: true, width: columnWidth },
            { dataField: 'ExtraRevenue', caption: 'Extra Rev', visible: true, width: columnWidth },
            { dataField: 'NonRevenue', caption: 'Non Rev', visible: true, width: columnWidth },
            { dataField: 'UserInsert', caption: 'Created By', visible: true, width: columnWidth },
            { dataField: 'CreateDate', caption: 'Created On', visible: true, width: columnWidth },
            { dataField: 'UserUpdate', caption: 'Updated By', visible: true, width: columnWidth },
            { dataField: 'UpdateDate', caption: 'Update On', visible: true, width: columnWidth },


        ];
        $("#gridContainerHistory").dxDataGrid({

            dataSource: data,
            allowColumnResizing: true,  // Dữ liệu từ server

            paging: { pageSize: 15 },
            scrolling: {
                rowRenderingMode: 'virtual',
            },
            allowColumnResizing: true,
            columnAutoWidth: true,
            pager: {
                visible: true,
                allowedPageSizes: [15, 20, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true,
            },

            selection: {
                mode: "multiple",
                showCheckBoxesMode: "none"
            },
            columns: columns,

            showBorders: false,
            onRowClick: function (e) {
                console.log("ID được click:", e.data.id);
            }

        });
    }
</script>
