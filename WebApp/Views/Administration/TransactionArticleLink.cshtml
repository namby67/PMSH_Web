<!-- DevExtreme ASP.NET Data -->
<script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.aspnet.data.js"></script>
<link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">

<style>
    select.is-invalid+.invalid-feedback {
        display: block;
        color: #dc3545;
    }

    .ts-control.is-invalid {
        border-color: #dc3545;
    }

    .ts-wrapper {
        padding-left: 10px;
    }

    .ts-control {
        min-height: 38px;
        border-radius: 0.375rem;
        border: 1px solid #225d97;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        max-height: 85px;
        overflow-y: auto;
    }

    .ts-wrapper.focus .ts-control {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        outline: 0;
    }

    .ts-wrapper.is-invalid .ts-control {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .ts-wrapper.multi .ts-control>div {
        margin: 3px 3px 3px 0;
    }

    .ts-control::-webkit-scrollbar {
        width: 6px;
    }

    .ts-control::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .ts-control::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .ts-control::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .ts-dropdown {
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(0, 0, 0, .15);
        z-index: 1056;
    }

    .tomselect-custom .ts-control {
        padding-right: 2.5rem !important;
    }

    .tomselect-custom .clear-button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.2rem;
        color: #adb5bd;
        font-weight: bold;
        z-index: 10;
        transition: color 0.2s;
        line-height: 1;
    }

    .tomselect-custom .clear-button:hover {
        color: #dc3545;
    }
</style>

<div class="text-center" id="reportTitle" style="font-size: 20px">Transaction Article Link </div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Transaction Code:</label>
            <input type="text" class="form-control form-control-sm w-auto" id="transCode" />
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Transaction Description:</label>
            <input type="text" class="form-control form-control-sm w-auto" id="transDes" />
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Article Code:</label>
            <input type="text" class="form-control form-control-sm w-auto" id="articleCode" />
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Article Description:</label>
            <input type="text" class="form-control form-control-sm w-auto" id="articleDes" />
        </div>
    </div>

    <div class="">
        <button id="btnView" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button id="btnNew" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-plus"></i>
            New</button>
        <button id="btnEdit" class="mui-button mui-button-edit " type="button"> <i class="fa-solid fa-pen"></i>
            Edit</button>
        <button id="btnDelete" class="mui-button button-report-delete" type="button"> <i
                class="fa-solid fa-trash-can"></i> Delete</button>
    </div>
</div>

<div class="mui-card">
    <div id="gridTransactionArticleLink" class="gridContainer"></div>
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog custom-modal-width">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalLabel">New Item</h5>
                </div>
                <div class="modal-body">
                    <div class="modal-footer justify-content-start">
                        <button type="button" id="btnSaveNew" class="mui-button mui-button-save">
                            <i class="fa-solid fa-floppy-disk"></i> Save
                        </button>
                        <button type="button" id="btnClosePopup" data-bs-dismiss="modal"
                            class="mui-button mui-button-close">
                            <i class="fa-solid fa-xmark"></i> Close
                        </button>
                        <button type="button" id="btnRefreshPopup" class="mui-button mui-button-close">
                            <i class="fa-solid fa-arrows-rotate"></i> Refresh
                        </button>
                    </div>
                    <div id="itemForm">
                        <input type="hidden" id="modalItemId" name="id" value="0" />
                        <div class="row g-3">
                            <div style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                                <div class="form-group-new-reservation col-md-10">
                                    <label>Transaction Code <span style="color:red">*</span></label>
                                    <select id="transactionListSelect" class="tomselect-custom" multiple
                                        name="selectedTransactions">
                                        @foreach (dynamic u in ViewBag.TransactionList)
                                        {
                                            <option value="@u.Code">@u.Code - @u.Description</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="form-group-new-reservation col-md-10 ">
                                    <label>Article Code <span style="color:red">*</span></label>
                                    <select class="tomselect-custom" id="articleCodeSelect" multiple
                                        name="selectedArticles">
                                        @foreach (dynamic u in ViewBag.ArticleList)
                                        {
                                            <option value="@u.Code">@u.Code - @u.Description</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="itemModalEdit" tabindex="-1" aria-labelledby="itemModalEditLabel" aria-hidden="true">
        <div class="modal-dialog custom-modal-width">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalEditLabel">Edit Item</h5>
                </div>
                <div class="modal-body">
                    <div class="modal-footer justify-content-start">
                        <button type="button" id="btnSaveEdit" class="mui-button mui-button-save">
                            <i class="fa-solid fa-floppy-disk"></i> Save
                        </button>
                        <button type="button" id="btnClosePopup" data-bs-dismiss="modal"
                            class="mui-button mui-button-close">
                            <i class="fa-solid fa-xmark"></i> Close
                        </button>
                    </div>
                    <div id="itemFormEdit">
                        <input type="hidden" id="modalItemId" name="id" value="0" />
                        <div class="row g-3">
                            <input type="hidden" id="ID" name="ID" />
                            <div style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                                <div class="form-group-new-reservation col-md-10">
                                    <label>Transaction Code <span style="color:red">*</span></label>
                                    <select id="transactionEdit" class="tomselect-custom" name="editTransactions">
                                        @foreach (dynamic u in ViewBag.TransactionList)
                                        {
                                            <option value="@u.Code">@u.Code - @u.Description</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="form-group-new-reservation col-md-10 ">
                                    <label>Article Code <span style="color:red">*</span></label>
                                    <select class="tomselect-custom" id="articleEdit" name="editArticles">
                                        @foreach (dynamic u in ViewBag.ArticleList)
                                        {
                                            <option value="@u.Code">@u.Code - @u.Description</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    $(document).ready(function () {
        initializeTomSelects();
    });

    let tomSelected = {};
    function initializeTomSelects() {
        const selectors = ["#articleCodeSelect", "#transactionListSelect"];

        selectors.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) {
                if (el.tomselect) {
                    el.tomselect.destroy();
                }

                tomSelected[selector] = new TomSelect(el, {
                    plugins: {
                        'remove_button': { title: 'B·ªè ch·ªçn m·ª•c n√†y' },
                        'dropdown_input': {},
                        'clear_button': { title: 'X√≥a t·∫•t c·∫£' }
                    },
                    create: false,
                    maxItems: null,
                    valueField: 'code',
                    labelField: 'text',
                    searchField: ['code'],
                    placeholder: 'Enter or select options...',
                    render: {
                        option: function (data, escape) {
                            return '<div class="p-2">' + escape(data.text) + '</div>';
                        },
                        item: function (data, escape) {
                            return '<div title="' + escape(data.text) + '">' + escape(data.code) + '</div>';
                        }
                    },
                    onChange: function (value) {
                        // Khi c√≥ gi√° tr·ªã ƒë∆∞·ª£c ch·ªçn ‚Üí t·ª± ƒë·ªông b·ªè l·ªói
                        if (value && value.length > 0) {
                            const $select = $(this.input); // <select> g·ªëc
                            const $wrapper = $select.next('.ts-wrapper');
                            const $feedback = $select.siblings('.invalid-feedback');

                            $select.removeClass('is-invalid');
                            $wrapper.removeClass('is-invalid');
                            $feedback.hide().text('');
                        }
                    },
                });
            } else {
                console.warn(`‚ö† Kh√¥ng t√¨m th·∫•y element v·ªõi selector: ${selector}`);
            }
        });
    }
    // === H√ÄM M·ªöI: ƒê·ªìng b·ªô l·ªói t·ª´ <select> g·ªëc sang TomSelect wrapper ===
    function syncTomSelectValidation(errors = null) {

        $("#itemModal select").each(function (index) {
            const $select = $(this);
            const $wrapper = $select.next(".ts-wrapper");
            const $feedback = $select.siblings(".invalid-feedback");
            if ($select.hasClass("is-invalid")) {
                $wrapper.addClass("is-invalid");

                // üî• BACKUP: N·∫øu text v·∫´n r·ªóng ‚Üí g√°n t·ª´ errors param
                if (!$feedback.text().trim() && errors) {
                    const fieldName = $select.attr("name");
                    const fieldError = errors.find(err => err.field === fieldName);
                    if (fieldError) {
                        $feedback.text(fieldError.message).show();
                    }
                } else {
                    $feedback.show();
                }

            } else {
                $wrapper.removeClass("is-invalid");
                $feedback.hide().text('');
            }
        });
    }


    $("#transCode, #transDes, #articleCode, #articleDes").on("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            $("#btnView").click();
        }
    });

    var grid;
    var selectedRowData = null;

    $(function () {
        $("#gridTransactionArticleLink").dxDataGrid({
            dataSource: DevExpress.data.AspNet.createStore({
                loadUrl: "/Administration/Transaction/GetAllTransactionArticleLink",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.data.transCode = $("#transCode").val();
                    ajaxOptions.data.transDes = $("#transDes").val();
                    ajaxOptions.data.articleCode = $("#articleCode").val();
                    ajaxOptions.data.articleDes = $("#articleDes").val();
                }
            }),
            onInitialized: function (e) {
                grid = e.component;
            },
            remoteOperations: { filtering: true, sorting: true, paging: true, grouping: true },
            showBorders: true,
            paging: { pageSize: 20 },
            groupPanel: { visible: true },
            columns: [
                { dataField: "id", caption: "ID", allowGrouping: false, visible: false },
                { dataField: "infor", caption: "Infor", allowGrouping: false, width: "6%" },
                { dataField: "transactionCode", caption: "Transaction Code", width: "6%" },
                { dataField: "transactionDescription", caption: "Transaction Description", allowGrouping: false },
                { dataField: "articleCode", caption: "Article Code", width: "6%" },
                { dataField: "articleDescription", caption: "Article Description", allowGrouping: false },
            ],
            grouping: { autoExpandAll: true },
            summary: {
                groupItems: [{ column: 'id', summaryType: 'count' }]
            },
            height: 500,
            onToolbarPreparing: function (e) {
                e.toolbarOptions.items.unshift({
                    location: "before",
                    widget: "dxButton",
                    options: {
                        icon: "refresh",
                        onClick: function () { e.component.refresh(); }
                    }
                });
            },
            onRowClick: function (e) {
                selectedRowData = e.data;
                console.log("Clicked row data:", selectedRowData);
            },
            selection: {
                mode: "single"
            },
        });
    });

    $("#btnView").on("click", function () {
        grid.refresh();
    });

    $("#btnNew").click(function () {
        // Clear c√°c TomSelect
        if (tomSelected["#articleCodeSelect"]) tomSelected["#articleCodeSelect"].clear();
        if (tomSelected["#transactionListSelect"]) tomSelected["#transactionListSelect"].clear();

        // Reset l·ªói c≈©
        applyValidationErrors([], "#itemModal");
        syncTomSelectValidation();

        $("#itemModal").modal("show");
    });
    $("#btnEdit").click(function () {
        if (!selectedRowData) {
            showToast("Error", "Please select 1 row to update.", false);
            return;
        }
        
        $("#ID").val(selectedRowData.id);

        $("#transactionEdit").val(selectedRowData.transactionCode)
        $("#articleEdit").val(selectedRowData.articleCode)
        // Reset l·ªói c≈©
        applyValidationErrors([], "#itemModalEdit");

        $("#itemModalEdit").modal("show");
    });

    $(document).off("click", "#btnSaveNew").on("click", "#btnSaveNew", function () {
        $("#loadingSpinnerRateCode").show();

        const selectedArticles = tomSelected["#articleCodeSelect"]?.items || [];
        const selectedTransactions = tomSelected["#transactionListSelect"]?.items || [];

        const dto = {
            SelectedArticles: selectedArticles,
            SelectedTransactions: selectedTransactions
        };

        $.ajax({
            url: '/Administration/Transaction/InsertTAL',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function (response) {
                $("#loadingSpinnerRateCode").hide();

                if (response.success) {
                    showToast("Success", "Number of links created: " + response.data.count, true);
                    tomSelected["#articleCodeSelect"].clear();
                    tomSelected["#transactionListSelect"].clear();
                    $("#itemModal").modal("hide");
                } else {
                    console.log("‚ùå Validation errors:", response.errors);

                    // G·ªçi applyValidationErrors (g√°n class + text ch√≠nh)
                    applyValidationErrors(response.errors, "#itemModal");

                    // G·ªçi sync 1 l·∫ßn cu·ªëi (ƒë·ªìng b·ªô wrapper + backup text)
                    syncTomSelectValidation(response.errors);  // üî• Truy·ªÅn errors v√†o ƒë√¢y
                }
            },
            error: function (xhr, status, error) {
                $("#loadingSpinnerRateCode").hide();
                if (Array.isArray(xhr.responseJSON?.errors)) {
                    xhr.responseJSON.errors.forEach((err, index) => {
                        setTimeout(() => showToast("Error", err, false), index * 1000);
                    });
                } else {
                    showToast("Error", error, false);
                }
            }
        });
    });
    $("#btnRefreshPopup").on("click", function () {
        $("#btnNew").trigger("click");
    });

    // =======================
    // UPDATE
    // =======================
    $(document).off("click", "#btnSaveEdit").on("click", "#btnSaveEdit", function () {
        $("#loadingSpinnerRateCode").show();

        const data = {
            ID: parseInt($("#ID").val()) || 0,

            TransactionEdit: $("#transactionEdit").val()?.trim() || "",

            ArticleEdit: $("#articleEdit").val()?.trim() || "",
        }

        $.ajax({
            url: '/Administration/Transaction/UpdateTAL',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                $("#loadingSpinnerRateCode").hide();

                if (response.success) {
                    showToast("Success", "Update success ID: " + response.data.id, true);
                    $("#itemModalEdit").modal("hide");
                } else {
                    if (Array.isArray(response.errors)) {
                        applyValidationErrors(response.errors, "#itemModalEdit");
                    } else {
                        showToast("Error", response.errors || "Unknown error", false);
                    }
                }

            },
            error: function (xhr, status, error) {
                $("#loadingSpinnerRateCode").hide();
                const response = xhr.responseJSON;
                if (Array.isArray(response?.errors)) {
                    response.errors.forEach((err, index) => {
                        setTimeout(() => {
                            showToast("Error", err.message || err, false);
                        }, index * 800);
                    });
                    return;
                }
                if (response?.message) {
                    showToast("Error", response.message, false);
                    return;
                }
                showToast("Error", error || "Unknown error", false);
            }

        });
    });

    $("#btnDelete").on("click", function () {
        showToast("Error", "No information available regarding the dependent table. The functionality has not yet been implemented.")
    });

</script>
