@using DevExpress.XtraReports.UI

@{
    dynamic? listRateCode = @ViewBag.RateCodeList;
    dynamic? listRateCate = @ViewBag.RateCateList;
    dynamic? listRoomType = @ViewBag.RoomTypeList;
    dynamic? listTransaction = @ViewBag.TransactionList;
    dynamic? listPackage = @ViewBag.PackageList;
}

@*style*@
<style>
    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }

    .dx-datagrid .dx-data-row td {
        font-size: 11px !important;
        padding: 6px 8px !important;
        text-align: center !important;
    }

    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default,
    .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    .filter_wrapper {
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

    .button_wrapper .fa-solid {
        margin-right: 5px;
    }

    .selected {
        background-color: #4CAF50;
        color: white;
    }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px;
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px;
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;

    }

    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        /* 2 cột bằng nhau */
        grid-template-rows: auto auto;
        /* 2 hàng */
        gap: 20px;
        /* khoảng cách giữa các bảng */
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
    }

    /* bảng hàng 1 trái */
    .grid-left {
        grid-column: 1;
        /* cột 1 */
        background: #fff;
        padding: 15px;
    }

    /* bảng hàng 1 phải */
    .grid-top-right {
        grid-column: 2;
        /* cột 2 */
    }

    /* bảng hàng 2 chiếm 2 cột */
    .grid-bottom {
        grid-column: 1 / span 2;
        /* trải rộng 2 cột */

    }
</style>

<div class="text-center" id="reportTitle" style="font-size: 20px">Rate Code Detail</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex align-items-center me-2 gap-2" style="padding:8px">
        <label class="me-2 mb-0">Rate Code:</label>

        <select id="code" class="form-control form-control-sm w-auto">
            <option value="0">-- Rate Code --</option>
            @foreach (dynamic u in ViewBag.RateCodeList)
            {
                <option value="@u.RateCode">@u.RateCode \ @u.Descripton</option>
            }
        </select>
        <label class="me-2 mb-0">Rate Category:</label>
        <select id="category" class="form-control form-control-sm w-auto">
            <option value="0">-- Select Rate Category --</option>
            @foreach (dynamic u in ViewBag.RateCateList)
            {
                <option value="@u.Code">@u.Code \ @u.Name</option>
            }
        </select>
        <label class="me-2 mb-0">Choose type of date:</label>
    </div>
</div>
<div>
    <button id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i> View</button>
    <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
    <button id="btnUpdate" class="mui-button mui-button-edit"><i class="fa-solid fa-pen"></i> Edit</button>
    <button id="btnDelete" class="mui-button button-report-delete"><i class="fa-solid fa-trash-can"></i>
        Delete</button>
    <button id="btnExportExcel" class="mui-button mui-button-export" type="button"><i
            class="fa-solid fa-file-excel"></i> Excel</button>
</div>
</div>
<div class="mui-card">
    <div class="grid-container"><!-- Left Grid: Rate Codes -->
        <div class="grid-left">
            <div class="grid-title">Rate Codes</div>
            <div class="grid-content gridContainer" id="gridRateCodes"></div>
        </div>

        <!-- Top Right Grid: Rate Details Grouped -->
        <div class="grid-top-right">
            <div class="grid-title">Rate Details Grouped</div>
            <div class="grid-content gridContainer" id="gridRateDetailsGrouped"></div>
        </div>

        <!-- Bottom Right Grid: Details -->
        <div class="grid-bottom grid-details">
            <div class="grid-title">Details</div>
            <div class=" grid-content gridContainer" id="gridDetails"></div>
        </div>
    </div>
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>

@*Popup Detail*@
<div id="popupDetail" style="display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 10px; z-index: 1050; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px; max-width: 700px; 
            max-height: 700px; overflow-y: auto;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0" id="popupTitle">Rate Code Detail</h5>
        <button id="btnClosePopup" onclick="closePopup()" class="btn btn-sm btn-outline-secondary"
            style="border-radius: 4px;">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button id="btnSave" class="btn btn-primary btn-sm" type="button">
            <i class="fa-solid fa-floppy-disk me-1"></i> Save
        </button>
        <button id="btnSaveClose" class="btn btn-outline-primary btn-sm" type="button">
            <i class="fa-solid fa-check me-1"></i> Save and Close
        </button>
    </div>

    <!-- Form Body -->
    <div class="sticky-header bg-white p-2 shadow-sm rounded">
        <input type="hidden" id="modalDetailId" name="id" value="0" />

        <div class="d-flex flex-wrap gap-4">
            <!-- Column 1 -->
            <div class="flex-fill">
                <h6 class="mb-2">Basic Information</h6>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtRateCode" class="me-2 mb-0" style="width: 120px;">Rate Code:</label>
                    <input type="text" id="txtRateCode" name="rateCode" class="form-control form-control-sm flex-fill"
                        disabled />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="selRoomType" class="me-2 mb-0" style="width: 120px;">Room Type:</label>
                    <select id="selRoomType" name="roomTypeID" class="form-control form-control-sm flex-fill">
                        <option value="">--Select--</option>
                        @if (listRoomType != null)
                        {
                            @foreach (dynamic u in listRoomType)
                            {
                                <option value="@u.ID">@u.Code</option>
                            }
                        }
                    </select>
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtBeginDate" class="me-2 mb-0" style="width: 120px;">Begin Date:</label>
                    <input type="date" id="txtBeginDate" name="beginDate"
                        class="form-control form-control-sm flex-fill" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtEndDate" class="me-2 mb-0" style="width: 120px;">End Date:</label>
                    <input type="date" id="txtEndDate" name="endDate" class="form-control form-control-sm flex-fill" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="selTransaction" class="me-2 mb-0" style="width: 120px;">Transaction:</label>
                    <select id="selTransaction" name="transactionID" class="form-control form-control-sm flex-fill">
                        <option value="">--Select--</option>
                        @if (listTransaction != null)
                        {
                            @foreach (dynamic u in listTransaction)
                            {
                                <option value="@u.ID">@u.Code</option>
                            }
                        }
                    </select>
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="selPackage" class="me-2 mb-0" style="width: 120px;">Package:</label>
                    <select id="selPackage" name="packageID" class="form-control form-control-sm flex-fill">
                        <option value="">--Select--</option>
                        @if (listPackage != null)
                        {
                            @foreach (dynamic u in listPackage)
                            {
                                <option value="@u.ID">@u.Code</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <!-- Column 2 -->
            <div class="flex-fill">
                <h6 class="mb-2">Rate Information</h6>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtCurrency" class="me-2 mb-0" style="width: 120px;">Currency:</label>
                    <input type="text" id="txtCurrency" name="currency" class="form-control form-control-sm flex-fill"
                        placeholder="VND" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtMinLOS" class="me-2 mb-0" style="width: 120px;">Min LOS:</label>
                    <input type="number" id="txtMinLOS" name="minLOS" class="form-control form-control-sm flex-fill"
                        min="0" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtMaxLOS" class="me-2 mb-0" style="width: 120px;">Max LOS:</label>
                    <input type="number" id="txtMaxLOS" name="maxLOS" class="form-control form-control-sm flex-fill"
                        min="0" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtAmount" class="me-2 mb-0" style="width: 120px;">Amount:</label>
                    <input type="number" id="txtAmount" name="amount" class="form-control form-control-sm flex-fill"
                        step="0.01" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtPercentage" class="me-2 mb-0" style="width: 120px;">Percentage:</label>
                    <input type="number" id="txtPercentage" name="percentage"
                        class="form-control form-control-sm flex-fill" step="0.01" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="txtDescription" class="me-2 mb-0" style="width: 120px;">Description:</label>
                    <input type="text" id="txtDescription" name="description"
                        class="form-control form-control-sm flex-fill" />
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkActive" name="active" value="1">
                    <label class="form-check-label" for="chkActive">Active</label>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loadingSpinner"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    // Sample data for testing
    var sampleRateCodes = [
        { id: 1, code: "RC001", description: "Standard Rate" },
        { id: 2, code: "RC002", description: "Premium Rate" },
        { id: 3, code: "RC003", description: "Budget Rate" }
    ];

    var sampleRateDetails = [
        {
            id: 1, rateCode: "RC001", roomType: "Single", transaction: "Sale", package: "Standard",
            beginDate: "2025-01-01", endDate: "2025-12-31", currency: "VND",
            minLOS: 1, maxLOS: 7, amount: 500000, percentage: 0, description: "Standard single room",
            roomTypeID: 1, transactionID: 1, packageID: 1, active: true
        },
        {
            id: 2, rateCode: "RC001", roomType: "Double", transaction: "Sale", package: "Standard",
            beginDate: "2025-01-01", endDate: "2025-12-31", currency: "VND",
            minLOS: 1, maxLOS: 7, amount: 750000, percentage: 0, description: "Standard double room",
            roomTypeID: 2, transactionID: 1, packageID: 1, active: true
        },
        {
            id: 3, rateCode: "RC002", roomType: "Single", transaction: "Sale", package: "Premium",
            beginDate: "2025-01-01", endDate: "2025-12-31", currency: "VND",
            minLOS: 1, maxLOS: 30, amount: 750000, percentage: 10, description: "Premium single room",
            roomTypeID: 1, transactionID: 1, packageID: 2, active: true
        },
        {
            id: 4, rateCode: "RC002", roomType: "Suite", transaction: "Sale", package: "Premium",
            beginDate: "2025-01-01", endDate: "2025-12-31", currency: "VND",
            minLOS: 1, maxLOS: 30, amount: 1500000, percentage: 15, description: "Premium suite",
            roomTypeID: 3, transactionID: 1, packageID: 2, active: true
        },
        {
            id: 5, rateCode: "RC003", roomType: "Single", transaction: "Sale", package: "Budget",
            beginDate: "2025-01-01", endDate: "2025-12-31", currency: "VND",
            minLOS: 3, maxLOS: 30, amount: 300000, percentage: 5, description: "Budget single room",
            roomTypeID: 1, transactionID: 1, packageID: 3, active: true
        }
    ];

    $(document).ready(function () {
        $("#btnPrint").trigger("click");
    });

    function closePopup() {
        $("#popupDetail").hide();
        clearForm();
    }

    function clearForm() {
        $("#modalDetailId").val("0");
        $("#txtRateCode").val("");
        $("#selRoomType").val("");
        $("#txtBeginDate").val("");
        $("#txtEndDate").val("");
        $("#selTransaction").val("");
        $("#selPackage").val("");
        $("#txtCurrency").val("VND");
        $("#txtMinLOS").val("");
        $("#txtMaxLOS").val("");
        $("#txtAmount").val("");
        $("#txtPercentage").val("");
        $("#txtDescription").val("");
        $("#chkActive").prop("checked", false);
    }

    var selectedRowData = null;
    var selectedRateCode = null;

    $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $("#loadingSpinner").show();
        // Using sample data for testing
        console.log("Loading sample data...", sampleRateDetails);
        initializeGrids(sampleRateCodes, sampleRateDetails);
        $("#loadingSpinner").hide();
    });

    function initializeGrids(rateCodes, rateDetails) {
        // Left Grid: Rate Codes
        $("#gridRateCodes").dxDataGrid({
            dataSource: rateCodes,
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            filterRow: { visible: true },
            columns: [
                { dataField: "id", caption: "ID", width: 80, visible: false },
                { dataField: "rateCode", caption: "Rate Code", width: "100" },
                { dataField: "rateCategory", caption: "Rate Category", width: "130" },
                { dataField: "beginDate", caption: "Begin Date", width: "130" },
                { dataField: "endDate", caption: "End Date", width: "130" }
            ],
            scrolling: { mode: "standard" },
            paging: { pageSize: 20 },
            onSelectionChanged: function (e) {
                if (e.selectedRowsData.length > 0) {
                    selectedRateCode = e.selectedRowsData[0];
                    console.log("Selected Rate Code:", selectedRateCode);
                    // Update grouped grid
                    updateGroupedDetails(selectedRateCode.code, rateDetails);
                }
            }
        });

        // Top Right Grid: Rate Details Grouped
        $("#gridRateDetailsGrouped").dxDataGrid({
            dataSource: rateDetails,
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },

            columns: [
                { dataField: "code", caption: "Code", width: "80px" },
                { dataField: "roomType", caption: "Room Type", width: "100px" },
                { dataField: "transaction", caption: "Transaction", width: "100px" },
                { dataField: "package", caption: "Package", width: "100px" },
                { dataField: "beginDate", caption: "Begin Date", width: "130" },
                { dataField: "endDate", caption: "End Date", width: "130" },
                { dataField: "curr", caption: "Curr.", width: "100px" }
            ],
            scrolling: { mode: "standard" },
            paging: { pageSize: 10 },
            onSelectionChanged: function (e) {
                if (e.selectedRowsData.length > 0) {
                    selectedRowData = e.selectedRowsData[0];
                    console.log("Selected Detail:", selectedRowData);
                    // Update bottom details grid
                    updateDetailsGrid(selectedRowData, rateDetails);
                }
            }
        });

        // Bottom Grid: Details
        $("#gridDetails").dxDataGrid({
            dataSource: [],
            showBorders: true,
            columns: [
                { dataField: "code", caption: "Code", width: "100px", dataType: "string" },
                { dataField: "roomType", caption: "Room Type", width: "120px" },
                { dataField: "date", caption: "Date", width: "100px", dataType: "date", format: "dd/mm/yyyy" },
                { dataField: "transaction", caption: "Transaction", width: "120px" },
                { dataField: "currency", caption: "Curr.", width: "70px" },
                { dataField: "a1Net", caption: "A1 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a2Net", caption: "A2 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a3Net", caption: "A3 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a4Net", caption: "A4 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a5Net", caption: "A5 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a6Net", caption: "A6 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a7Net", caption: "A7 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a8Net", caption: "A8 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a9Net", caption: "A9 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a10Net", caption: "A10 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a11Net", caption: "A11 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a12Net", caption: "A12 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a13Net", caption: "A13 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a14Net", caption: "A14 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "a15Net", caption: "A15 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "c1Net", caption: "C1 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "c2Net", caption: "C2 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "c3Net", caption: "C3 Net", width: "100px", format: "#,##0", dataType: "number", },
                { dataField: "aldulExtra", caption: "Aldul Extra", width: "100px", format: "#,##0", dataType: "number", },
            ],
            scrolling: { mode: "standard" }
        });
    }

    function updateGroupedDetails(rateCode, allDetails) {
        var grouped = allDetails.filter(d => d.rateCode === rateCode);
        var gridInstance = $("#gridRateDetailsGrouped").dxDataGrid("instance");
        gridInstance.option("dataSource", grouped);
    }

    function updateDetailsGrid(selectedDetail, allDetails) {
        var details = allDetails.filter(d =>
            d.rateCode === selectedDetail.rateCode &&
            d.roomType === selectedDetail.roomType &&
            d.transaction === selectedDetail.transaction &&
            d.package === selectedDetail.package
        );
        var gridInstance = $("#gridDetails").dxDataGrid("instance");
        gridInstance.option("dataSource", details);
    }

    $(document).off("click", "#btnNew").on("click", "#btnNew", function () {
        clearForm();
        $("#popupTitle").text("New Rate Code Detail");
        $("#txtRateCode").prop("disabled", false);
        $("#popupDetail").show();
    });

    $(document).off("click", "#btnUpdate").on("click", "#btnUpdate", function () {
        if (!selectedRowData) {
            showToast('Error', 'Please select a row to edit.', false);
            return;
        }

        let id = selectedRowData.id;

        $.ajax({
            url: '/Administration/RateCode/GetRateCodeDetailByID',
            type: 'GET',
            data: { id: id },
            success: function (res) {
                if (!res.success) {
                    showToast('Error', res.message || 'Failed to load data', false);
                    return;
                }

                let data = res.data;
                $("#modalDetailId").val(data.id);
                $("#popupTitle").text("Edit Rate Code Detail");

                $("#txtRateCode").val(data.rateCode).prop("disabled", true);
                $("#selRoomType").val(data.roomTypeID || "");
                $("#txtBeginDate").val(data.beginDate ? data.beginDate.split('T')[0] : "");
                $("#txtEndDate").val(data.endDate ? data.endDate.split('T')[0] : "");
                $("#selTransaction").val(data.transactionID || "");
                $("#selPackage").val(data.packageID || "");
                $("#txtCurrency").val(data.currency || "VND");
                $("#txtMinLOS").val(data.minLOS || "");
                $("#txtMaxLOS").val(data.maxLOS || "");
                $("#txtAmount").val(data.amount || "");
                $("#txtPercentage").val(data.percentage || "");
                $("#txtDescription").val(data.description || "");
                $("#chkActive").prop("checked", data.active === true);

                $("#popupDetail").show();
            },
            error: function () {
                showToast('Error', 'Failed to load data.', false);
            }
        });
    });

    $(document).off("click", "#btnDelete").on("click", "#btnDelete", function () {
        if (!selectedRowData) {
            showToast('Error', 'Please select a row to delete.', false);
            return;
        }

        if (!confirm("Are you sure you want to delete this record?")) {
            return;
        }

        $("#loadingSpinner").show();
        $.ajax({
            url: '/Administration/RateCode/DeleteRateCodeDetail',
            type: 'POST',
            data: { id: selectedRowData.id },
            traditional: true,
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                $("#loadingSpinner").hide();
                if (result.success) {
                    $("#btnPrint").trigger("click");
                    showToast('Success', result.message || 'Deleted successfully', true);
                } else {
                    showToast('Error', result.message || 'Delete failed', false);
                }
            },
            error: function () {
                $("#loadingSpinner").hide();
                showToast('Error', 'Unable to delete record', false);
            }
        });
    });

    $(document).off("click", "#btnExportExcel").on("click", "#btnExportExcel", function () {
        if (!selectedRowData || !selectedRowData.id) {
            showToast('Error', 'Please select a row to export.', false);
            return;
        }

        window.location.href = '/Administration/RateCode/ExportRateCodeDetail?id=' + selectedRowData.id;
    });

    function saveDetail(closeAfter) {
        var data = {
            id: parseInt($("#modalDetailId").val()) || 0,
            rateCode: $("#txtRateCode").val(),
            roomTypeID: parseInt($("#selRoomType").val()) || 0,
            beginDate: $("#txtBeginDate").val(),
            endDate: $("#txtEndDate").val(),
            transactionID: parseInt($("#selTransaction").val()) || 0,
            packageID: parseInt($("#selPackage").val()) || 0,
            currency: $("#txtCurrency").val(),
            minLOS: parseInt($("#txtMinLOS").val()) || 0,
            maxLOS: parseInt($("#txtMaxLOS").val()) || 0,
            amount: parseFloat($("#txtAmount").val()) || 0,
            percentage: parseFloat($("#txtPercentage").val()) || 0,
            description: $("#txtDescription").val(),
            active: $("#chkActive").is(":checked"),
            userID: parseInt(localStorage.getItem("userID")) || 0
        };

        // Validation
        if (!data.rateCode) {
            showToast('Error', 'Rate Code is required', false);
            return;
        }
        if (!data.beginDate) {
            showToast('Error', 'Begin Date is required', false);
            return;
        }
        if (!data.endDate) {
            showToast('Error', 'End Date is required', false);
            return;
        }

        $("#loadingSpinner").show();

        $.ajax({
            url: "/Administration/RateCode/SaveRateCodeDetail",
            type: "POST",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            data: $.param(data),
            success: function (res) {
                $("#loadingSpinner").hide();
                if (res.success) {
                    showToast('Success', res.message || 'Saved successfully', true);
                    if (closeAfter) {
                        closePopup();
                    }
                    $("#btnPrint").trigger("click");
                } else {
                    showToast('Error', res.message || 'Validation failed', false);
                }
            },
            error: function (xhr, status, error) {
                $("#loadingSpinner").hide();
                if (Array.isArray(xhr.responseJSON?.errors)) {
                    xhr.responseJSON.errors.forEach((err, index) => {
                        setTimeout(() => {
                            showToast("Error", err, false);
                        }, index * 800);
                    });
                } else {
                    showToast('Error', 'An error occurred while saving', false);
                }
            }
        });
    }

    $(document).off("click", "#btnSave").on("click", "#btnSave", function () {
        saveDetail(false);
    });

    $(document).off("click", "#btnSaveClose").on("click", "#btnSaveClose", function () {
        saveDetail(true);
    });
</script>
