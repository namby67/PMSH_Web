@using DevExpress.XtraReports.UI

@{
    var selectedReport = @ViewBag.ReportHeader;
}

<div class="text-center" id="reportTitle" style="font-size: 20px">Rate Category</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1"
        style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;width: fit-content;">

        <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
            <div class="d-flex align-items-center me-2">

                <div class="d-flex align-items-center me-4">
                    <label for="tracetime" class="me-2 mb-0">Code:</label>
                    <input type="text" id="codeInput" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-4">
                    <label for="tracetime" class="me-2 mb-0">Name:</label>
                    <input type="text" id="nameInput" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-3">
                    <div class="form-check d-flex align-items-center gap-2">
                        <span class="status-color-box color-clean-uncheck"></span>
                        <input class="form-check-input" type="checkbox" id="chkShowInactive" name="chkShowInactive">
                        <label class="form-check-label mb-0" for="chkShowInactive">Show Inactive</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <button id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i> View</button>
        <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnUpdate" class="mui-button mui-button-edit"> <i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="mui-button button-report-delete"> <i class="fa-solid fa-trash-can"></i>
            Delete</button>
        <button id="btnExportExcel" class="mui-button mui-button-export" type="button"> <i
                class="fa-solid fa-file-excel"></i> Excel</button>
    </div>
</div>
<div class="mui-card">
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>
@*Pháº§n popup*@
<!-- Popup New / Update Rate Category -->
<div class="modal fade" id="popupNewRateCategory" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title">Rate Category</h5>
            </div>

            <!-- Footer -->
            <div class="modal-footer justify-content-start">
                <button type="button" id="btnOkAuto" class="mui-button mui-button-save">
                    <i class="fa-solid fa-floppy-disk"></i> Save
                </button>
                <button type="button" id="btnClosePopup" data-bs-dismiss="modal" class="mui-button mui-button-close">
                    <i class="fa-solid fa-xmark"></i> Close
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="rateCategoryForm">
                    <div class="container-fluid border rounded p-2">

                        <input type="hidden" id="idRateCategory" value="0" />

                        <!-- Code + Inactive -->
                        <div class="row mb-1 align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0">Code</label>
                                <input type="text" id="codeClass" class="form-control form-control-sm" name="code" />
                                <div class="invalid-feedback"></div>

                            </div>

                            <div class="col-auto d-flex align-items-center">
                                <input type="checkbox" id="inactive" class="form-check-input me-2" name="ckActive" />
                                <label class="form-check-label text-danger mb-0">
                                    Inactive
                                </label>
                                <div class="invalid-feedback"></div>

                            </div>
                        </div>

                        <!-- Name -->
                        <div class="row mb-1">
                            <div class="col">
                                <label class="form-label">Name</label>
                                <input type="text" id="nameClass" class="form-control" name="name" />
                                <div class="invalid-feedback"></div>

                            </div>
                        </div>

                        <!-- Description -->
                        <div class="row mb-1">
                            <div class="col">
                                <label class="form-label">Description</label>
                                <textarea id="descriptionaccty" class="form-control" name="description"
                                    rows="3"></textarea>
                                <div class="invalid-feedback"></div>

                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div id="loadingSpinner"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    $(document).ready(function () {
        $("#btnPrint").trigger("click");

        $("#chkShowInactive").on("change", function () {
            $("#btnPrint").trigger("click");
        });
    });

    // =======================
    // CLEAR FORM
    // =======================
    function clearRateCategoryForm() {
        $("#idRateCategory").val(0);
        $("#codeClass").val("");
        $("#nameClass").val("");
        $("#descriptionaccty").val("");
        $("#inactive").prop("checked", false);
    }

    // =======================
    // SEARCH
    // =======================
    $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $("#loadingSpinner").show();

        $.ajax({
            url: "/Administration/RateCode/GetAllRateCategory",
            type: "GET",
            data: {
                code: $("#codeInput").val(),
                name: $("#nameInput").val(),
                inactive: $("#chkShowInactive").is(":checked") ? 1 : 0
            },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val()
            },
            success: function (result) {
                const data = result.data || [];
                initializeRateCategoryGrid(data);

                if (data.length === 0) {
                    showToast("Warning", "No records found.", false);
                }
                $("#loadingSpinner").hide();
            },
            error: function () {
                showToast("Error", "Unable to load data.", false);
                $("#loadingSpinner").hide();
            }
        });
    });

    // =======================
    // GRID
    // =======================
    var selectedRowData = null;

    function initializeRateCategoryGrid(data) {
        $("#gridContainer").dxDataGrid({
            dataSource: data,
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            width: "100%",
            filterRow: { visible: true },
            columns: [
                { dataField: "id", visible: false },
                { dataField: "code", caption: "Code", width: "10%" },
                { dataField: "name", caption: "Name", width: "15%" },
                { dataField: "description", caption: "Description", width: "40%" },
                { dataField: "createdBy", caption: "Created By", width: 120 },
                {
                    dataField: "inactive",
                    caption: "Inactive",
                    width: 120,
                    cellTemplate: function (container, options) {
                        $("<div>").dxCheckBox({
                            value: options.value == 1,
                            readOnly: true
                        }).appendTo(container);
                    }
                },
                { dataField: "createdDate", dataType: "date", format: "dd/MM/yyyy", width: 150 },
                { dataField: "updatedBy", caption: "Updated By", width: 120 },
                { dataField: "updatedDate", dataType: "date", format: "dd/MM/yyyy", width: 150 }
            ],
            onRowClick: function (e) {
                selectedRowData = e.data;
            }
        });
    }

    // =======================
    // NEW
    // =======================
    $("#btnNew").on("click", function () {
        clearRateCategoryForm();
        applyValidationErrors([], "#popupNewRateCategory");

        $("#popupNewRateCategory").modal("show");
    });

    // =======================
    // UPDATE
    // =======================
    $(document).off("click", "#btnUpdate").on("click", "#btnUpdate", function () {
        if (!selectedRowData) {
            showToast("Error", "Please select 1 row to update.", false);
            return;
        }
        applyValidationErrors([], "#popupNewRateCategory");

        $("#idRateCategory").val(selectedRowData.id);
        $("#codeClass").val(selectedRowData.code);
        $("#nameClass").val(selectedRowData.name);
        $("#descriptionaccty").val(selectedRowData.description);
        $("#inactive").prop("checked", selectedRowData.inactive == 1);

        $("#popupNewRateCategory").modal("show");
    });

    // =======================
    // SAVE
    // =======================
    $(document).off("click", "#btnOkAuto").on("click", "#btnOkAuto", function () {
        $("#loadingSpinner").show();

        $.ajax({
            url: "/Administration/RateCode/RateCategorySave",
            type: "POST",
            data: {
                idRateCategory: $("#idRateCategory").val(),
                codeClass: $("#codeClass").val(),
                nameClass: $("#nameClass").val(),
                descriptionaccty: $("#descriptionaccty").val(),
                inactive: $("#inactive").is(":checked") ? 1 : 0,
                user: localStorage.getItem("Loginname")
            },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val()
            },
            success: function (result) {
                if (result.success) {
                    showToast("Success", result.message, true);
                    $("#popupNewRateCategory").modal("hide");
                    $("#btnPrint").trigger("click");
                } else {
                    applyValidationErrors(result.errors, "#rateCategoryForm");
                }
                $("#loadingSpinner").hide();
            },
            error: function (xhr) {
                showToast("Error", xhr.responseJSON?.message || "Save failed.", false);
                $("#loadingSpinner").hide();
            }
        });
    });

    // =======================
    // DELETE
    // =======================
    $(document).off("click", "#btnDelete").on("click", "#btnDelete", function () {
        if (!selectedRowData) {
            showToast("Error", "Please select 1 row to delete.", false);
            return;
        }

        if (!confirm("Are you sure you want to delete this record?")) return;

        $.ajax({
            url: "/Administration/RateCode/RateCategoryDelete",
            type: "POST",
            data: { id: selectedRowData.id },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val()
            },
            success: function (result) {
                if (result.success) {
                    showToast("Success", result.message, true);
                    $("#btnPrint").trigger("click");
                } else {
                    showToast("Error", result.message, false);
                }
            }
        });
    });
</script>
