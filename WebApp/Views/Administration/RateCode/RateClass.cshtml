@using DevExpress.XtraReports.UI

@{
    var selectedReport = @ViewBag.ReportHeader;
}

@*style*@
<style>
    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }

    .dx-datagrid .dx-data-row td {
        font-size: 11px !important;
        padding: 6px 8px !important;
        text-align: center !important;
    }



    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default,
    .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }


    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

    .button_wrapper .fa-solid {
        margin-right: 5px;
    }

    .selected {
        background-color: #4CAF50;
        /* M√†u xanh */
        color: white;
    }



    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }


    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important;
        /* d√∫ng 12?px */
        height: calc(1.1em + .2rem + 2px);
        /* gi? c√πng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px;
        /* ho?c t√πy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px;
        /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }
</style>


<div class="text-center" id="reportTitle" style="font-size: 20px">Rate Class</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div>
        <button id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i> View</button>
        <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnUpdate" class="mui-button mui-button-edit"> <i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="mui-button button-report-delete"> <i class="fa-solid fa-trash-can"></i>
            Delete</button>
        <button id="btnExportExcel" class="mui-button mui-button-export" type="button"> <i
                class="fa-solid fa-file-excel"></i> Excel</button>
        <div class="form-check" style="display: inline-block; margin-left: 20px;">
            <input class="form-check-input" type="checkbox" id="chkShowInactive" name="showInactive" value="1">
            <label class="form-check-label" for="chkShowInactive" style="margin-bottom: 0;">
                Show Inactive
            </label>
        </div>
    </div>
</div>
<div class="mui-card">
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>
@*Ph·∫ßn popup*@
<div id="popupNewRateClass" style="display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 10px; z-index: 1050; 
            box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 400px; max-width: 500px; 
            max-height: 600px; overflow-y: auto;">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Rate Class</h5>
        <button id="btnClosePopup" onclick="$('#popupNewRateClass').hide()" class="btn btn-sm btn-outline-secondary"
            style="border-radius: 4px;">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <!-- Buttons -->
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button id="btnOkAuto" class="btn btn-primary btn-sm" type="button">
            <i class="fa-solid fa-floppy-disk me-1"></i> Save and Cancel
        </button>
    </div>

    <!-- Form Body -->
    <div class="sticky-header bg-white p-2 shadow-sm rounded">
        <div class="d-flex flex-wrap gap-4">

            <!-- Info Column -->
            <div class="flex-fill">
                <h6 class="mb-2">Info</h6>
                <input type="hidden" id="idRateClass" name="idRateClass" />

                <div class="mb-2 d-flex align-items-center">
                    <label for="codeClass" class="me-2 mb-0" style="width: 80px;">Code:</label>
                    <input type="text" id="codeClass" name="codeClass" class="form-control form-control-sm flex-fill" />
                </div>

                <div class="mb-2 d-flex align-items-center">
                    <label for="descriptionaccty" class="me-2 mb-0" style="width: 80px;">Description:</label>
                    <input type="text" id="descriptionaccty" name="descriptionaccty"
                        class="form-control form-control-sm flex-fill" />
                </div>
            </div>

            <!-- Action Column -->
            <div class="flex-fill">
                <h6 class="mb-2">Action</h6>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="inactive" name="includeOptions" value="1"
                        checked>
                    <label class="form-check-label" for="Inactive">inactive</label>
                </div>

            </div>

        </div>
    </div>
</div>

<div id="loadingSpinner"
    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    $(document).ready(function () {
        $("#btnPrint").trigger("click");

        // Reload grid when checkbox changes
        $("#chkShowInactive").on("change", function () {
            $("#btnPrint").trigger("click");
        });
    });
    // X√≥a gi√° tr·ªã c·ªßa input text/number
    function clearRateClassForm() {
        // X√≥a gi√° tr·ªã c·ªßa input text/number
        $("#idRateClass").val("");
        $("#codeClass").val("");
        $("#descriptionaccty").val("");
        // B·ªè check checkbox
        $("#inactive").prop("checked", false);
    }

    // Call API l·∫•y data
    $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $("#loadingSpinner").show();
        var inactive = $("#chkShowInactive").is(":checked") ? 1 : 0;
        $.ajax({
            url: "/Administration/RateCode/GetAllRateClass",
            type: "GET",
            data: { inactive: inactive },
            traditional: true,
            crossDomain: false,
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": jQuery(
                    "input[name='__RequestVerificationToken']"
                ).val(),
            },
            success: function (result) {
                // $("#reportViewerContainer").html(result);
                // $("#loadingSpinner").hide();
                console.log(result);
                initializeAccountTypeGrid(result);
                $("#loadingSpinner").hide();
            },
            error: function () {
                alert("Kh√¥ng th·ªÉ t·∫£i b√°o c√°o.");
                $("#loadingSpinner").hide();
            },
        });
    });


    var selectedRowData = null;
    function initializeAccountTypeGrid(data) {
        $("#gridContainer").dxDataGrid({
            dataSource: data,
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            filterRow: { visible: true },
            columns: [
                { dataField: "id", caption: "ID", width: 80, visible: false },
                { dataField: "code", caption: "Code", dataType: "number", format: { type: "fixedPoint", precision: 0 }, width: 130 },
                { dataField: "description", caption: "Description", width: 200 },
                { dataField: "createdBy", caption: "CreatedBy", width: 120 },
                {
                    dataField: "inactive",
                    caption: "Inactive",
                    width: 120,
                    cellTemplate: function (container, options) {
                        // √©p ki·ªÉu: 1 = true, 0 = false
                        let checked = options.value == 1;
                        $("<div>")
                            .dxCheckBox({
                                value: checked,
                                readOnly: true
                            })
                            .css("transform", "scale(0.8)") // thu nh·ªè checkbox
                            .appendTo(container);
                    },
                },
                { dataField: "createdDate", caption: "Created Date", dataType: "date", format: "dd/MM/yyyy HH:mm", width: 160 },
                { dataField: "updatedBy", caption: "UpdatedBy", width: 120 },
                { dataField: "updatedDate", caption: "Updated Date", dataType: "date", format: "dd/MM/yyyy HH:mm", width: 160 },],
            scrolling: {
                mode: "standard", // Kh√¥ng d√πng virtual ƒë·ªÉ footer hi·ªÉn th·ªã ƒë√∫ng
                showScrollbar: "always",
                scrollByContent: true
            },
            paging: {
                pageSize: 50
            },
            pager: {
                visible: true,
                allowedPageSizes: [50, 100, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            // üî• Quan tr·ªçng: g√°n selectedRowData khi click ch·ªçn
            onRowClick: function (e) {
                selectedRowData = e.data; // üî• l·∫•y data c·ªßa row v·ª´a click
                console.log("Selected Row (RowClick):", selectedRowData);
            }
        });
    }

    //M·ªü popup
    $("#btnNew").on("click", function () {
        $('#overlay').fadeIn(200);
        $('#popupNewRateClass').fadeIn(200);
        $("#idRateClass").val(0);
        clearRateClassForm();
    });
    $('#btnClosePopup, #overlay').click(function () {
        $('#popupNewRateClass').fadeOut(200);
        $('#overlay').fadeOut(200);
    });


    $(document).off("click", "#btnDelete").on("click", "#btnDelete", function () {
        if (!selectedRowData) {
            showToast('Error', 'Please select 1 row to delete.', false);
            return;
        }

        if (!confirm("Are you sure you want to delete this record?")) {
            return; // N·∫øu ch·ªçn Cancel th√¨ d·ª´ng
        }

        $.ajax({
            url: '/Administration/RateCode/RateClassDelete',
            type: 'POST',
            data: {
                id: selectedRowData.id
            },
            traditional: true,
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (result.success) {
                    showToast('Success', result.message, true);
                    $("#btnPrint").trigger("click");
                } else {
                    showToast('Error',result.message, false);
                }
            },
            error: function () {
                alert("Kh√¥ng th·ªÉ t·∫£i b√°o c√°o.");
                $("#loadingSpinner").hide();
            }
        });


    });

    $(document).off("click", "#btnUpdate").on("click", "#btnUpdate", function () {
        if (!selectedRowData) {
            showToast('Error', 'Please select 1 row to Updated.', false);
            return;
        }
        // G√°n gi√° tr·ªã t·ª´ row v√†o form
        $("#idRateClass").val(selectedRowData.id);
        $("#codeClass").val(selectedRowData.code);
        $("#descriptionaccty").val(selectedRowData.description);
        // Include Payment (checkbox)
        if (selectedRowData.inactive == 1) {
            $("#inactive").prop("checked", true);
        } else {
            $("#inactive").prop("checked", false);
        }

        // Hi·ªÉn th·ªã popup
        $('#overlay').fadeIn(200);
        $('#popupNewRateClass').fadeIn(200);
    });


    $(document).off("click", "#btnOkAuto").on("click", "#btnOkAuto", function () {
        try {
            // Hi·ªÉn th·ªã loading spinner
            $("#loadingSpinner").show();
            // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i l√™n server
            var dataToSend = {
                code: $("#codeClass").val().trim(),
                description: $("#descriptionaccty").val().trim(),
                inactive: $("#inactive").is(":checked") ? 1 : 0,
                id: $("#idRateClass").val() || 0,
                user: localStorage.getItem("Loginname")
            };
            console.log("Data to send:", dataToSend);

            $.ajax({
                url: '/Administration/RateCode/RateClassSave',
                type: 'POST',
                data: dataToSend,
                traditional: true,
                crossDomain: false,
                headers: { "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    try {
                        if (result.success) {
                            showToast('Success', result.message, true);
                            clearRateClassForm();
                            $('#popupNewRateClass').fadeOut(200);
                            $('#overlay').fadeOut(200);
                            $("#btnPrint").trigger("click");
                        } else {
                            if (result.message) {
                                showToast('Error', result.message, false);
                            }
                            if (Array.isArray(result.errors)) {
                                result.errors.forEach(err => {
                                    showToast('Error', err, false);
                                });
                            }
                        }
                    } catch (innerErr) {
                        console.error("Error processing AJAX success response:", innerErr);
                    } finally {
                        $("#loadingSpinner").hide();
                    }
                },
                error: function (xhr, status, error) {
                    let msg = xhr.responseJSON?.message || "Unable to save record.";
                    showToast("Error", msg, false);
                    // N·∫øu c√≥ m·∫£ng errors th√¨ hi·ªÉn th·ªã t·ª´ng c√°i
                    if (Array.isArray(xhr.responseJSON?.errors)) {
                        xhr.responseJSON.errors.forEach(err => {
                            showToast("Error", err, false);
                        });
                    }
                    $("#loadingSpinner").hide();
                }
            });
        } catch (err) {
            console.error("Error in click handler:", err);
            $("#loadingSpinner").hide();
        }
    });


    $("#btnExportExcel").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");   // üî• khai b√°o grid

        const workbook = new ExcelJS.Workbook();
        const companyName = localStorage.getItem("CompanyName") || "T√™n c√¥ng ty ch∆∞a x√°c ƒë·ªãnh";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === D√≤ng 1: T√™n c√¥ng ty (merge theo 4 c·ªôt) ===
        worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:D1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === D√≤ng 2: Ng√†y gi·ªù xu·∫•t (b√™n ph·∫£i) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', exportDate]);
        worksheet.mergeCells('D2:D2');  // c·ªôt D th√¥i
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === D√≤ng 3‚Äì4: tr·ªëng
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === D√≤ng 5: Ti√™u ƒë·ªÅ b√°o c√°o (·ªü gi·ªØa) ===
        const reportRow = worksheet.addRow(['Telephone Directory']);
        worksheet.mergeCells('A5:D5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === D√≤ng 6: tr·ªëng
        worksheet.addRow([]);

        // === Xu·∫•t d·ªØ li·ªáu grid b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 7 ===
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 }
        }).then(function () {
            // Footer (sau c√πng)
            const lastRow = worksheet.lastRow.number + 2;
            worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = "Rate Class.xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });



</script>
