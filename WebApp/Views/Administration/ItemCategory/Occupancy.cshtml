@{
    //
}
<style>
    .form-locked {
        pointer-events: none; /* khóa toàn bộ click */
        opacity: 0.6; /* làm mờ */
    }

    .form-unlocked {
        pointer-events: auto;
        opacity: 1;
    }
    /* CSS để khi hover vào hàng đã tô màu, màu không bị đè bởi màu hover mặc định (tùy chọn) */
    .dx-datagrid-rowsview .dx-row.dx-data-row:hover:not(.dx-selection) > td {
        filter: brightness(95%);
    }
</style>
<div class="header">
    <h3 id="content-title">Occupancy Config</h3>
</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div id="formContainer" class="d-flex align-items-center gap-3 p-2 formLocked" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
        <div class="row g-2 w-100 align-items-start">

            <div class="col-lg-1 col-md-2">
                <label class="form-label mb-1" style="font-size: 12px;">Type:</label>
                <input type="text"
                       id="typeInput"
                       class="form-control form-control-sm"
                       value="Hotel"
                       disabled>
            </div>

            <div class="col-lg-1 col-md-2">
                <label for="occLevel" class="form-label mb-1" style="font-size: 12px;">Occ. Level:</label>
                <input type="text" id="occLevelInput" name="occLevel"
                       class="form-control form-control-sm">
                <div class="invalid-feedback" id="occLevelError"></div>
            </div>

            <div class="col-lg-2 col-md-3">
                <label class="form-label mb-1 fw-bold" style="font-size: 12px;">Color:</label>
                <div class="input-group input-group-sm">
                    <input type="text" id="colorDisplay"
                           class="form-control"
                           placeholder="None"
                           style="min-width: 50px;"
                           readonly />
                    <span class="input-group-text p-0">
                        <input type="color" id="colorPicker"
                               class="form-control form-control-color border-0"
                               style="width: 30px; height: 30px; padding: 0; cursor: pointer;">
                    </span>
                    <button class="btn btn-outline-danger px-2" type="button" id="btnClearColor">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="col-lg-2 col-md-3">
                <label class="form-label mb-1" style="font-size: 12px;">Title:</label>
                <input type="text" id="titleInput" class="form-control form-control-sm">
            </div>

            <div class="col-lg-2 col-md-4">
                <label class="form-label mb-1" style="font-size: 12px;">Email:</label>
                <input type="email" id="emailInput" class="form-control form-control-sm">
            </div>

            <div class="col-lg-4 col-md-12">
                <label class="form-label mb-1" style="font-size: 12px;">Description:</label>
                <textarea id="descriptionInput" class="form-control form-control-sm"></textarea>
            </div>

            <input type="hidden" id="id" name="id" value="0" />
        </div>
    </div>
    <div class="mt-2">
        <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnUpdate" class="mui-button mui-button-edit"> <i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="mui-button mui-button-delete"> <i class="fa-solid fa-trash-can"></i> Delete</button>
        <button id="btnSave" class="mui-button mui-button-save d-none"><i class="fa-solid fa-check"></i> Save</button>
        <button id="btnCancel" class="mui-button mui-button-cancel d-none"><i class="fa-solid fa-xmark"></i> Cancel</button>
    </div>

</div>
<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>
<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
    var selectedRowData = null;

    $(document).ready(function () {
        reloadGrid();

            $("#formContainer").on("input change", "input, select, textarea", function () {
        if ($(this).hasClass("is-invalid")) {
            $(this).removeClass("is-invalid");
            $(this).next(".invalid-feedback").text("");
        }
    });
        lockForm();
    });

    function lockForm() {
        $("#formContainer").removeClass("form-unlocked").addClass("form-locked");
    }

    function unlockForm() {
        $("#formContainer").removeClass("form-locked").addClass("form-unlocked");
    }

    function hexToArgbInt(hex) {
        hex = hex.replace("#", "");
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        const a = 255;
        return (a << 24) | (r << 16) | (g << 8) | b;
    }

    // Helper: Convert ARGB Int → Hex String
    function argbIntToHex(argb) {
        let unsigned = argb >>> 0;
        let r = (unsigned >> 16) & 0xFF;
        let g = (unsigned >> 8) & 0xFF;
        let b = unsigned & 0xFF;
        return "#" +
            r.toString(16).padStart(2, '0') +
            g.toString(16).padStart(2, '0') +
            b.toString(16).padStart(2, '0');
    }

    // Helper: Tính độ sáng màu để chọn màu chữ (Đen/Trắng) cho dễ đọc
    function getContrastColor(hexColor) {
        const r = parseInt(hexColor.substr(1, 2), 16);
        const g = parseInt(hexColor.substr(3, 2), 16);
        const b = parseInt(hexColor.substr(5, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }

    // Color Picker
    $("#colorPicker").on("input", function() {
        $("#colorDisplay").val(hexToArgbInt($(this).val()));
    });

    $("#btnClearColor").on("click", function() {
        $("#colorDisplay").val("");
        $("#colorPicker").val("#ffffff");
    });

    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 450,
            width: "100%",
            columnAutoWidth: false,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            hoverStateEnabled: true,
            columns: [
            {
                caption: "STT",
                width: "5%",
                alignment: "right",
                cellTemplate: function (container, options) {
                    const grid = options.component;
                    const pageIndex = grid.pageIndex();
                    const pageSize = grid.pageSize();
                    const stt = pageIndex * pageSize + options.rowIndex + 1;
                    container.text(stt);
                }
            },
            { dataField: "id", caption: "ID", visible: false },
            { dataField: "type", caption: "Type", width: "10%" },
            { dataField: "occupancylevel", caption: "Occ. Level", width: "8%"},
            { dataField: "title", caption: "Title", width: "12%" },
            { dataField: "email", caption: "Email", width: "15%" },
            { dataField: "description", caption: "Description", width: "20%" },
            { dataField: "color", caption: "Color", visible: false },
            { dataField: "createBy", caption: "CreateBy", width: "5%" },
            { dataField: "createDate", caption: "CreateDate", dataType: "date", format: "dd/MM/yyyy", width: "10%" },
            { dataField: "updateBy", caption: "UpdateBy", width: "5%" },
            { dataField: "updateDate", caption: "UpdateDate", dataType: "date", format: "dd/MM/yyyy", width: "10%" },
            ],

            onRowPrepared: function(e) {
                if (e.rowType === "data" && e.data.color) {
                    const colorHex = argbIntToHex(e.data.color);
                    e.rowElement.css("background-color", colorHex);
                    const textColor = getContrastColor(colorHex);
                    e.rowElement.css("color", textColor);
                }
            },

            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            scrolling: { mode: "standard", showScrollbar: "always" },

            onSelectionChanged: function(e){
                  selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
            }
        });
    }

    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetOccupancy",
            type: 'GET',
            success: function(data){
                loadGrid(data);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Không thể tải dữ liệu");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }

    @*JS handle button new edit*@
        function switchToEditMode() {
        $("#btnNew, #btnUpdate, #btnDelete").addClass("d-none");
        $("#btnSave, #btnCancel").removeClass("d-none");
        unlockForm();
    }

    function switchToNormalMode() {
        $("#btnNew, #btnUpdate, #btnDelete").removeClass("d-none");
        $("#btnSave, #btnCancel").addClass("d-none");
        $("#content-title").text("Occupancy Config");
        lockForm();
    }

    // --- NÚT NEW ---
    $("#btnNew").click(function () {
        $("#id").val("0");
        $("#content-title").text("Add Occupancy Config");
        switchToEditMode();
        clearForm();
    });

    // --- NÚT EDIT ---
    $("#btnUpdate").click(function () {
        if (!selectedRowData) {
            showToast("Warning", "Select 1 row to edit please.", false);
            return;
        }

        switchToEditMode();
         $("#content-title").text("Edit Occupancy Config");
        // fill dữ liệu vào form
        $("#occLevelInput").val(selectedRowData.occupancylevel);
        $("#titleInput").val(selectedRowData.title);
        $("#emailInput").val(selectedRowData.email);
        $("#descriptionInput").val(selectedRowData.description);
        $("#id").val(selectedRowData.id);

        if (selectedRowData.color) {
            const hex = argbIntToHex(selectedRowData.color);
            $("#colorPicker").val(hex);
            $("#colorDisplay").val(selectedRowData.color);
        } else {
            $("#colorPicker").val("#ffffff");
            $("#colorDisplay").val("");
        }

    });

    // --- NÚT CANCEL ---
    $("#btnCancel").click(function () {
        $(".form-control").removeClass("is-invalid is-valid");
        $("#content-title").text("Occupancy Config");
        clearForm();
        switchToNormalMode();
    });

    // --- NÚT SAVE ---
    $("#btnSave").click(function(){
        applyValidationErrors([], "#formContainer");
       
        const id = parseInt($("#id").val()) || 0;
            let loginName = (localStorage.getItem("Loginname") || "").trim()
            .replace(/^"(.*)"$/, '$1');
            const model = {
                id: id,
                type: 0, // Hotel
                occupancylevel: parseFloat($("#occLevelInput").val()) || 0,
                title: $("#titleInput").val(),
                email: $("#emailInput").val(),
                description: $("#descriptionInput").val(),
                color: $("#colorDisplay").val(),
                createBy: loginName,
                updateBy: loginName,
            };
            let url = "/Administration/OccupancySave";
            $.ajax({
               url: url,
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify(model),
              traditional: true,
              crossDomain: false,
              headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
              success: function (res) {
                  if (res.success) {
                    showToast("Success", res.message, true);
                    reloadGrid();
                    $("#btnCancel").trigger("click");
                } else {
                    if (res.errors && res.errors.length > 0) {
                    applyValidationErrors(res.errors, "#formContainer");
                    showToast("Warning", "Please check input fields.", false);
                    } else {
                        showToast("Error", res.message, false);
                    }
                }
              },
              error: function (xhr, status, error) {
                  $("#loadingSpinnerRateCode").hide();
                      showToast("Error",error.message, false);
              }
          });
    });

    function clearForm() {
        $("#occLevelInput").val("");
        $("#titleInput").val("");
        $("#emailInput").val("");
        $("#descriptionInput").val("");

        // Reset color
        $("#colorPicker").val("#ffffff");
        $("#colorDisplay").val("");
    }

    function argbIntToHex(argb) {
        let unsigned = argb >>> 0; // convert int âm → unsigned 32-bit

        let r = (unsigned >> 16) & 0xFF;
        let g = (unsigned >> 8) & 0xFF;
        let b = unsigned & 0xFF;

        return "#" +
            r.toString(16).padStart(2, '0') +
            g.toString(16).padStart(2, '0') +
            b.toString(16).padStart(2, '0');
    }

    $("#btnDelete").click(function () {
           if (!selectedRowData || selectedRowData.id === 0) {
               showToast('Warning', "Select one row to delete, please!", true);

               return;
           }
           if (!confirm("Are you sure you want to delete this record?")) {
                return;
            }
           $.ajax({
               url: `/Administration/OccupancyDelete/`+ selectedRowData.id,
               type: "POST",
               traditional: true,
               crossDomain: false,
               headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
               success: function(result){
                    if(result.success){
                        reloadGrid();
                        showToast("Success","Delete Successfully!",true);
                        $("#btnCancel").trigger("click");
                    } else {
                        showToast("Error",result.message,false);
                    }
               },
               error: function(){
                    showToast("Error","Delete failed!",false);
                    $("#loadingSpinnerRateCode").hide();
               },
           });
    });

</script>
