@{
    //
}
<style>
    /* CSS để khi hover vào hàng đã tô màu, màu không bị đè bởi màu hover mặc định (tùy chọn) */
    .dx-datagrid-rowsview .dx-row.dx-data-row:hover:not(.dx-selection) > td {
        filter: brightness(95%);
    }
</style>

<div class="text-center" style="font-size: 20px">Occupancy Config</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="mt-2">
        <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnUpdate" class="mui-button mui-button-edit"> <i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="mui-button mui-button-delete"> <i class="fa-solid fa-trash-can"></i> Delete</button>
    </div>

</div>
<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>
<!-- Modal Popup for New Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">New Item</h5>
            </div>
            <div class="modal-footer justify-content-start">
                <button type="button" id="btnSave" class="mui-button mui-button-save"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                <button type="button" data-bs-dismiss="modal" class="mui-button mui-button-close"><i class="fa-solid fa-xmark"></i> Close</button>
            </div>
            <div class="modal-body">

                <form id="formContainer">
                    <div class="container-fluid">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-1" style="font-size: 12px;">Type:</label>
                                <input type="text" id="typeInput" class="form-control form-control-sm bg-light" value="Hotel" disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="occLevelInput" class="form-label fw-bold mb-1" style="font-size: 12px;">Occ. Level:</label>
                                <input type="number" id="occLevelInput" name="occLevel" class="form-control form-control-sm" placeholder="0.00">
                                <div class="invalid-feedback" id="occLevelError"></div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-1" style="font-size: 12px;">Title:</label>
                                <input type="text" id="titleInput" class="form-control form-control-sm" placeholder="Enter title">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-1" style="font-size: 12px;">Color Selection:</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="colorDisplay" class="form-control" placeholder="Color Value" readonly />
                                    <span class="input-group-text p-0">
                                        <input type="color" id="colorPicker" class="form-control form-control-color border-0" style="width: 35px; height: 30px; padding: 0; cursor: pointer;">
                                    </span>
                                    <button class="btn btn-outline-danger" type="button" id="btnClearColor">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold mb-1" style="font-size: 12px;">Notification Email:</label>
                                <input type="email" id="emailInput" class="form-control form-control-sm" placeholder="example@domain.com">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-12">
                                <label class="form-label fw-bold mb-1" style="font-size: 12px;">Description:</label>
                                <textarea id="descriptionInput" class="form-control form-control-sm" rows="4" style="height:100px" placeholder="Enter description..."></textarea>
                            </div>
                        </div>

                        <input type="hidden" id="id" name="id" value="0" />
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
    var selectedRowData = null;

    $(document).ready(function () {
        reloadGrid();

        $("#formContainer").on("input change", "input, select, textarea", function () {
            if ($(this).hasClass("is-invalid")) {
                $(this).removeClass("is-invalid");
                $(this).next(".invalid-feedback").text("");
            }
        });
        $('#itemModal').on('hidden.bs.modal', function () {
             applyValidationErrors([], "#formContainer");
        });
    });

    function hexToArgbInt(hex) {
        hex = hex.replace("#", "");
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        const a = 255;
        return (a << 24) | (r << 16) | (g << 8) | b;
    }

    // Helper: Convert ARGB Int → Hex String
    function argbIntToHex(argb) {
        let unsigned = argb >>> 0;
        let r = (unsigned >> 16) & 0xFF;
        let g = (unsigned >> 8) & 0xFF;
        let b = unsigned & 0xFF;
        return "#" +
            r.toString(16).padStart(2, '0') +
            g.toString(16).padStart(2, '0') +
            b.toString(16).padStart(2, '0');
    }

    // Helper: Tính độ sáng màu để chọn màu chữ (Đen/Trắng) cho dễ đọc
    function getContrastColor(hexColor) {
        const r = parseInt(hexColor.substr(1, 2), 16);
        const g = parseInt(hexColor.substr(3, 2), 16);
        const b = parseInt(hexColor.substr(5, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }

    // Color Picker
    $("#colorPicker").on("input", function() {
        $("#colorDisplay").val(hexToArgbInt($(this).val()));
    });

    $("#btnClearColor").on("click", function() {
        $("#colorDisplay").val("");
        $("#colorPicker").val("#ffffff");
    });

    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: false,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            hoverStateEnabled: true,
            columns: [
            {
                caption: "STT",
                width: "5%",
                alignment: "right",
                cellTemplate: function (container, options) {
                    const grid = options.component;
                    const pageIndex = grid.pageIndex();
                    const pageSize = grid.pageSize();
                    const stt = pageIndex * pageSize + options.rowIndex + 1;
                    container.text(stt);
                }
            },
            { dataField: "id", caption: "ID", visible: false },
            { dataField: "type", caption: "Type", width: "10%" },
            { dataField: "occupancylevel", caption: "Occ. Level", width: "8%"},
            { dataField: "title", caption: "Title", width: "12%" },
            { dataField: "email", caption: "Email", width: "15%" },
            { dataField: "description", caption: "Description", width: "20%" },
            { dataField: "color", caption: "Color", visible: false },
            { dataField: "createBy", caption: "CreateBy", width: "5%" },
            { dataField: "createDate", caption: "CreateDate", dataType: "date", format: "dd/MM/yyyy", width: "10%" },
            { dataField: "updateBy", caption: "UpdateBy", width: "5%" },
            { dataField: "updateDate", caption: "UpdateDate", dataType: "date", format: "dd/MM/yyyy", width: "10%" },
            ],

            onRowPrepared: function(e) {
                if (e.rowType === "data" && e.data.color) {
                    const colorHex = argbIntToHex(e.data.color);
                    e.rowElement.css("background-color", colorHex);
                    const textColor = getContrastColor(colorHex);
                    e.rowElement.css("color", textColor);
                }
            },

            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            scrolling: { mode: "standard", showScrollbar: "always" },

            onSelectionChanged: function(e){
                  selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
            }
        });
    }

    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetOccupancy",
            type: 'GET',
            success: function(data){
                loadGrid(data);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Unable to load data");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }

    // --- NÚT NEW ---
    $("#btnNew").click(function () {
        $("#formContainer")[0].reset();
        $("#id").val("0");
        $("#itemModalLabel").text("Add Occupancy");
        $("#itemModal").modal("show");
        clearForm();
    });

    // --- NÚT Update ---
    $("#btnUpdate").click(function () {
        if (!selectedRowData) {
            showToast("Warning", "Select one row to edit please.", false);
            return;
        }
        $("#itemModal").modal("show");
        $("#occLevelInput").val(selectedRowData.occupancylevel);
        $("#titleInput").val(selectedRowData.title);
        $("#emailInput").val(selectedRowData.email);
        $("#descriptionInput").val(selectedRowData.description);
        $("#id").val(selectedRowData.id);
        $("#itemModalLabel").text("Edit Occupancy Config");
        if (selectedRowData.color) {
            const hex = argbIntToHex(selectedRowData.color);
            $("#colorPicker").val(hex);
            $("#colorDisplay").val(selectedRowData.color);
        } else {
            $("#colorPicker").val("#ffffff");
            $("#colorDisplay").val("");
        }

    });

    // --- NÚT SAVE ---
    $("#btnSave").click(function(){

        const id = parseInt($("#id").val()) || 0;
            let loginName = (localStorage.getItem("Loginname") || "").trim()
            .replace(/^"(.*)"$/, '$1');
            const model = {
                id: id,
                type: 0, // Hotel
                occupancylevel: parseFloat($("#occLevelInput").val()) || 0,
                title: $("#titleInput").val(),
                email: $("#emailInput").val(),
                description: $("#descriptionInput").val(),
                color: $("#colorDisplay").val(),
                createBy: loginName,
                updateBy: loginName,
            };
            let url = "/Administration/OccupancySave";
            $.ajax({
               url: url,
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify(model),
              traditional: true,
              crossDomain: false,
              headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
              success: function (res) {
                  if (res.success) {
                    showToast("Success", res.message, true);
                    $("#itemModal").modal("hide");
                    clearForm();
                    reloadGrid();
                } else {
                    if (res.errors && res.errors.length > 0) {
                        applyValidationErrors(res.errors, "#formContainer");
                        let generalError = res.errors.find(x => x.field === "general");
                        let toastMessage = generalError ? generalError.message : "Please check input fields.";

                        showToast("Warning", toastMessage, false);
                    } else {
                        showToast("Error", res.message || "Save failed", false);
                    }
                }
              },
              error: function (xhr, status, error) {
                  $("#loadingSpinnerRateCode").hide();
                      showToast("Error",error.message, false);
              }
          });
    });

    function clearForm() {
        $("#occLevelInput").val("");
        $("#titleInput").val("");
        $("#emailInput").val("");
        $("#descriptionInput").val("");

        // Reset color
        $("#colorPicker").val("#ffffff");
        $("#colorDisplay").val("");
    }

    function argbIntToHex(argb) {
        let unsigned = argb >>> 0; // convert int âm → unsigned 32-bit

        let r = (unsigned >> 16) & 0xFF;
        let g = (unsigned >> 8) & 0xFF;
        let b = unsigned & 0xFF;

        return "#" +
            r.toString(16).padStart(2, '0') +
            g.toString(16).padStart(2, '0') +
            b.toString(16).padStart(2, '0');
    }

    $("#btnDelete").click(function () {
           if (!selectedRowData || selectedRowData.id === 0) {
               showToast('Warning', "Select one row to delete, please!", true);

               return;
           }
           if (!confirm("Are you sure you want to delete this record?")) {
                return;
            }
           $.ajax({
               url: `/Administration/OccupancyDelete/`+ selectedRowData.id,
               type: "POST",
               traditional: true,
               crossDomain: false,
               headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
               success: function(result){
                    if(result.success){
                        reloadGrid();
                        showToast("Success","Delete Successfully!",true);
                        $("#btnCancel").trigger("click");
                    } else {
                        showToast("Error",result.message,false);
                    }
               },
               error: function(){
                    showToast("Error","Delete failed!",false);
                    $("#loadingSpinnerRateCode").hide();
               },
           });
    });

</script>
