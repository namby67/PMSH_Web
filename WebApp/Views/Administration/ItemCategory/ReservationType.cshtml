@{
    //
}

<style>
    .form-locked {
        pointer-events: none;
        opacity: 0.6;
        background-color: #f9f9f9;
    }

    .form-unlocked {
        pointer-events: auto;
        opacity: 1;
        background-color: #fff;
    }

</style>

<div class="header">
    <h3 id="content-title">Reservation Type</h3>
</div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div id="formContainer" class="p-3 form-locked" style="border: 1px solid #ccc; border-radius: 6px; background-color: #f8f9fa;">
        <div class="row g-2 align-items-start flex-nowrap overflow-auto py-1" ">

            <div class="col-auto">
                <label for="code" class="col-form-label fw-bold text-nowrap" style="font-size: 13px;">Res. Type</label>
            </div>
            <div class="col-auto">
                <input type="text" id="code" name="code" class="form-control form-control-sm" style="width: 200px;" placeholder="Code.." />
                <div class="invalid-feedback"></div>
            </div>

            <div class="col-auto ms-2">
                <label for="name" class="col-form-label fw-bold" style="font-size: 13px;">Desc.</label>
            </div>
            <div class="col-auto">
                <input type="text" id="name" name="name" class="form-control form-control-sm" style="width: 230px;" placeholder="Description..." />
                <div class="invalid-feedback"></div>
            </div>

            <div class="col-auto ms-2">
                <label for="seq" class="col-form-label fw-bold" style="font-size: 13px;">Seq.</label>
            </div>
            <div class="col-auto">
                <input type="number" id="seq" name="seq" min="0" max="999" value="0" class="form-control form-control-sm text-center p-1" style="width: 50px;" />
                <div class="invalid-feedback"></div>
            </div>

            <div class="col-auto">
                <div class="vr h-100 mx-2 text-secondary"></div>
            </div>

            <div class="col-auto d-flex align-items-center gap-3 flex-wrap">
                <div class="form-check mb-0">
                    <input type="checkbox" id="inactive" name="inactive" class="form-check-input" />
                    <label for="inactive" class="form-check-label text-danger fw-bold" style="font-size: 12px;">Inactive</label>
                </div>
            </div>

            <div class="col-auto d-flex align-items-center me-3 flex-wrap">
                <div class="form-check mb-0">
                    <input type="checkbox" id="deduct" name="deduct" class="form-check-input me-2" />
                    <label for="deduct" class="form-check-label text-danger mb-0">Deduct</label>
                </div>
            </div>
            <div class="col-auto d-flex align-items-center me-3 flex-wrap">
                <div class="form-check mb-0">
                    <input type="checkbox" id="arrivalTimeRequired" name="arrivalTimeRequired" class="form-check-input me-2" />
                    <label for="arrivalTimeRequired" class="form-check-label text-danger mb-0">Arrival Time Required</label>
                </div>
            </div>
            <div class="col-auto d-flex align-items-center me-3 flex-wrap">
                <div class="form-check mb-0">
                    <input type="checkbox" id="creditCardRequired" name="creditCardRequired" class="form-check-input me-2" />
                    <label for="creditCardRequired" class="form-check-label text-danger mb-0">Credit Card Required</label>
                </div>
            </div>
            <div class="col-auto d-flex align-items-center me-3 flex-wrap">
                <div class="form-check mb-0">
                    <input type="checkbox" id="depositRequired" name="depositRequired" class="form-check-input me-2" />
                    <label for="depositRequired" class="form-check-label text-danger mb-0">Deposit Required</label>
                </div>
            </div>
            <input type="hidden" id="id" name="id" value="0" />
        </div>
    </div>
    <div class="mt-2">
        <button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnUpdate" class="mui-button mui-button-edit"><i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="mui-button mui-button-delete"><i class="fa-solid fa-trash-can"></i> Delete</button>
        <button id="btnSave" class="mui-button mui-button-save d-none"><i class="fa-solid fa-check"></i> Save</button>
        <button id="btnCancel" class="mui-button mui-button-cancel d-none"><i class="fa-solid fa-xmark"></i> Cancel</button>
    </div>
</div>

<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
    var selectedRowData = null;

    $(document).ready(function () {
        $("#formContainer").on("input change", "input, select, textarea", function () {
            if ($(this).hasClass("is-invalid")) {
                $(this).removeClass("is-invalid");
                $(this).next(".invalid-feedback").text("");
            }
        });
        reloadGrid();
        lockForm();
    });

    function lockForm() {
        $("#formContainer").addClass("form-locked").removeClass("form-unlocked");
        $("#formContainer").find("input, select, checkbox").prop("disabled", true);
    }

    function unlockForm() {
        $("#formContainer").removeClass("form-locked").addClass("form-unlocked");
        $("#formContainer").find("input, select, checkbox").prop("disabled", false);
    }

    function editMember(data) {
        $("#id").val(data.id);
        $("#code").val(data.code);
        $("#name").val(data.name);
        $("#seq").val(data.sequence);
        $("#inactive").prop("checked", data.inactive);
        $("#deduct").prop("checked", data.deduct);
        $("#arrivalTimeRequired").prop("checked", data.arrivalTimeRequired);
        $("#creditCardRequired").prop("checked", data.creditCardRequired);
        $("#depositRequired").prop("checked", data.depositRequired);
    }

    function loadGrid(data) {
        const dataSource = data || [];
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: dataSource,
            height: 500,
            width: "100%",
            columnAutoWidth: false,
            allowColumnResizing: true,
            selection: { mode: "single" },
            hoverStateEnabled: true,
            columns: [
                { dataField: "code", caption: "Res.Type", width: "10%" },
                { dataField: "name", caption: "Description", width: "30%" },
                { dataField: "sequence", caption: "Seq.", width: "10%"},
                { dataField: "deduct", caption: "Ded.Inv", width: "10%", dataType: "boolean", alignment: "center" },
                { dataField: "arrivalTimeRequired", caption: "Arr.Time", width: "10%", dataType: "boolean", alignment: "center" },
                { dataField: "creditCardRequired", caption: "CC", width: "10%", dataType: "boolean", alignment: "center" },
                { dataField: "depositRequired", caption: "Deposit", width: "10%", dataType: "boolean", alignment: "center" },
                { dataField: "inactive", caption: "Inactive", width: "10%", dataType: "boolean", alignment: "center" },
            ],
            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: { showPageSizeSelector: true, visible:true, allowedPageSizes: [20, 50, 'all'], showInfo: true,showNavigationButtons: true },
            onSelectionChanged: function (e) {
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
            }
        });
    }

    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetReservationType",
            type: "GET",
            dataType: "json",
            cache: false,
            success: function (data) {
                loadGrid(data);
            },
            error: function (xhr, status, error) {
                showToast("Error", "Load data failed", false);
            },
            complete: function () {
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }

    // 4. Button Handlers
    function switchToEditMode() {
        $("#btnNew, #btnUpdate, #btnDelete").addClass("d-none");
        $("#btnSave, #btnCancel").removeClass("d-none");
        unlockForm();
    }

    function switchToNormalMode() {
        $("#btnNew, #btnUpdate, #btnDelete").removeClass("d-none");
        $("#btnSave, #btnCancel").addClass("d-none");
        lockForm();
    }

    function clearForm() {
        const $form = $("#formContainer");
        $form.find("input[type='text'], input[type='textarea']").val("");
        $("#seq").val(0);
        $form.find("input[type='checkbox']").prop("checked", false);
        $form.find("select").prop("selectedIndex", 0);
        applyValidationErrors([], "#formContainer");
        $form.find("[data-bs-toggle='tooltip']").tooltip("dispose");
    }

    // --- NEW ---
    $("#btnNew").click(function () {
        clearForm();
        switchToEditMode();
        $("#content-title").text("New Reservation Type");
    });

    // --- EDIT ---
    $("#btnUpdate").click(function () {
        if (!selectedRowData) {
            showToast("Warning", "Please select a row to edit.", false);
            return;
        }
        switchToEditMode();
        $("#content-title").text("Edit Reservation Type");

        editMember(selectedRowData);
    });

    // --- CANCEL ---
    $("#btnCancel").click(function () {
        $("#content-title").text("Reservation Type");
        clearForm();
        switchToNormalMode();
    });

    // --- SAVE ---
    $("#btnSave").click(function () {
        applyValidationErrors([], "#formContainer");

        const id = parseInt($("#id").val()) || 0;
        let loginName = (localStorage.getItem("Loginname") || "").trim()
            .replace(/^"(.*)"$/, '$1');
        const loginUser = parseInt(localStorage.getItem("userID")) || 0;
        const model = {
            id: id,
            code: $("#code").val().trim(),
            name: $("#name").val().trim(),
            sequence: parseInt($("#seq").val()) || 0,
            inactive: $("#inactive").prop("checked"),
            deduct: $("#deduct").prop("checked"),
            arrivalTimeRequired: $("#arrivalTimeRequired").prop("checked"),
            creditCardRequired: $("#creditCardRequired").prop("checked"),
            depositRequired: $("#depositRequired").prop("checked"),
            userInsertID: loginUser,
            userUpdateID: loginUser,
        };

        $.ajax({
            url: "/Administration/ReservationTypeSave",
            type: "POST",
            cache: false,
            contentType: "application/json",
            data: JSON.stringify(model),
            success: function (res) {
                if (res.success) {
                    showToast("Success", res.message, true);
                    reloadGrid();
                    $("#btnCancel").trigger("click");
                } else {
                    if (res.errors && res.errors.length > 0) {
                        applyValidationErrors(res.errors, "#formContainer");
                        showToast("Warning", "Please check input fields.", false);
                    } else {
                        showToast("Error", res.message || "Save failed", false);
                    }
                }
            },
            error: function (err) {
                showToast("Error", "Save failed", false);
            }
        });
    });

    // --- DELETE ---
    $("#btnDelete").click(function () {
        if (!selectedRowData) {
            showToast("Warning", "Select a row to delete.", false);
            return;
        }
        if (!confirm("Are you sure you want to delete this template?")) return;

        $.ajax({
            url: `/Administration/ReservationTypeDelete/` + selectedRowData.id,
            type: "POST",
            success: function (res) {
                if (res.success) {  
                    showToast("Success", "Deleted successfully", true);
                    reloadGrid();
                    $("#btnCancel").trigger("click");
                } else {
                    showToast("Error", res.message, false);
                }
            }
        });
    });
</script>
