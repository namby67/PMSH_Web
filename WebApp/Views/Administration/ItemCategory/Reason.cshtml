@{
    //
}
<div class="header">
    <h3 id="content-title">Reason</h3>
</div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex align-items-center gap-3 p-2"
         style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
        <div class="d-flex flex-column ">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-4">
                    <label for="tracetime" class="me-2 mb-0">Code:</label>
                    <input type="text" id="codeInput"
                           class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-4">
                    <label for="tracetime" class="me-2 mb-0">Name:</label>
                    <input type="text" id="nameInput" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-3">
                    <div class="form-check d-flex align-items-center gap-2">
                        <span class="status-color-box color-clean-uncheck"></span>
                        <input class="form-check-input" type="checkbox" id="chkshowInactive" name="chkshowInactive">
                        <label class="form-check-label mb-0" for="chkshowInactive">Show Inactive</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-2">
        <button id="btnView" class="submit-button-clear-reservation"><i class="fa-solid fa-eye"></i> View</button>
        <button id="btnNew" class="submit-button-clear-reservation"><i class="fa-solid fa-plus"></i> New</button>
        <button id="btnEdit" class="submit-button-clear-reservation"> <i class="fa-solid fa-pen"></i> Edit</button>
        <button id="btnDelete" class="submit-button-clear-reservation"> <i class="fa-solid fa-trash-can"></i> Delete</button>
        <button id="btnExportExcel" class="submit-button-clear-reservation" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
    </div>
</div>

<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>
<!-- Modal Popup for New Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">New Item</h5>
            </div>
            <div class="modal-footer justify-content-start">
                <button type="button" id="btnSaveItem" class="submit-button-clear-reservation"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                <button type="button" data-bs-dismiss="modal" class="submit-button-clear-reservation"><i class="fa-solid fa-xmark"></i> Close</button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="container-fluid" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
                        <div class="row mb-1 align-items-center">
                            <div class="col-auto">
                                <label for="txtcode" class="form-label mb-0">Code</label>
                                <input type="text" id="txtcode" name="txtcode" class="form-control form-control-sm" />
                            </div>
                            <div class="col-auto d-flex align-items-center">
                                <input type="checkbox" id="inactive" name="inactive" class="form-check-input me-2" />
                                <label for="inactive" class="form-check-label text-danger mb-0">Inactive</label>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col">
                                <label for="txtname" class="form-label">Name</label>
                                <input type="text" id="txtname" name="txtname" class="form-control" />
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col">
                                <label for="txtdescription" class="form-label">Description</label>
                                <textarea id="txtdescription" name="txtdescription" class="form-control" rows="4"
                                          style="background-color:#ffffe6; height:100px"></textarea>
                            </div>
                        </div>
                        <input type="hidden" id="id" name="id" value="0" />
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
    var selectedRowData = null;

    $(document).ready(function () {
        $("#btnView").trigger("click");

    });

    $("#btnNew").click(function () {
        $("#itemForm")[0].reset();
        $("#id").val("0");
        $("#itemModalLabel").text("Add Reason");
        $("#itemModal").modal("show");
    });

    $("#btnSaveItem").click(function () {
        const id = parseInt($("#id").val()) || 0;
        let loginName = (localStorage.getItem("Loginname") || "")
            .trim()
            .replace(/^"(.*)"$/, '$1');
        const loginUser = parseInt(localStorage.getItem("userID")) || 0;
        const model = {
              ID: id,
              Code: $("#txtcode").val(),
              Name: $("#txtname").val(),
              Description: $("#txtdescription").val(),
              Inactive: $("#inactive").prop("checked"),
              CreatedBy: loginName,
              UpdatedBy: loginName,
              UserInsertID: loginUser,
              UserUpdateID: loginUser
        };

        $.ajax({
            url: "/Administration/ReasonSave",
            type: "POST",
            contentType: "application/json",
            cache: false,
            data: JSON.stringify(model),
            traditional: true,
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (res) {
                if (res.success) {
                    showToast("Success", res.message, true);
                    $("#itemModal").modal("hide");
                    $("#btnView").trigger("click");
                } else {
                    $("#itemModal").modal("hide");
                    showToast("Error", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                showToast("Error", "Request error!", false);
                $("#itemModal").modal("hide");
            }
        });
    });

    function editMember(data) {
        $("#id").val(data.id);
        $("#txtcode").val(data.code);
        $("#txtname").val(data.name);
        $("#txtdescription").val(data.description);
        $("#inactive").prop("checked", data.inactive);

        $("#itemModalLabel").text("Update Reason");
        $("#itemModal").modal("show");
    }

    $("#btnEdit").on("click", function () {
        if (!selectedRowData) {
            showToast("Warning","Please select a row first!", true);
            return;
        }
        editMember(selectedRowData);
    });

    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            hoverStateEnabled: true,
            columns: [
                { dataField: "id", visible: false },
                { dataField: "code", caption: "Code", width: "10%"  },
                { dataField: "name", caption: "Name", width: "20%"  },
                { dataField: "description", caption: "Description", width: "30%"  },
                { dataField: "inactive", caption: "Inactive", width: "6%"  },
                { dataField: "createdBy", caption: "Created By", width: "8%"  },
                { dataField: "createdDate", caption: "Created Date", dataType: "date", width: "9%"  },
                { dataField: "updatedBy", caption: "Updated By", width: "8%"  },
                { dataField: "updatedDate", caption: "Updated Date", dataType: "date", width: "9%"  },
            ],
            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            scrolling: { mode: "standard", showScrollbar: "always" },
              onSelectionChanged: function(e){
                  selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
            }
        });
    }

    $(document).off("click", "#btnView").on("click", "#btnView", function () {
          $("#loadingSpinnerRateCode").show();
          $.ajax({
              url: "/Administration/GetReason",
              type: "GET",
              cache: false,
              data: {
                 code: $("#codeInput").val(),
                 name: $("#nameInput").val(),
                 inactive: $("#chkshowInactive").prop("checked") ? 1 : 0
              },
              traditional: true,
              crossDomain: false,
              headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
              success: function(data){
                  loadGrid(data);
                  $("#loadingSpinnerRateCode").hide();
              },
              error: function(xhr, status, error){
                 showToast("Error", "Unable to load data", false);
                 $("#loadingSpinnerRateCode").hide();
              }
             });
    });
    $("#btnDelete").click(function () {
           if (!selectedRowData || selectedRowData.id === 0) {
               showToast('Warning', "Select 1 row, please!", true);

               return;
           }
           if (!confirm("Are you sure you want to delete this record? This action cannot be undone.")) {
                return;
            }
           $.ajax({
               url: `/Administration/DeleteReason/`+ selectedRowData.id,
               type: "POST",
               traditional: true,
               crossDomain: false,
               headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
               success: function(result){
                    if(result.success){
                        $("#btnView").trigger("click");
                        showToast("Success","Delete Successfully!",true);
                    } else {
                        showToast("Error",result.message,false);
                    }
               },
               error: function(){
                   console.log("delete "+ selectedRowData.id);
                    showToast("Error","Delete failed!" ,false);
                    $("#loadingSpinner").hide();
               },
           });
       });

    $("#btnExportExcel").click(function () {
        const grid = $("#gridContainerRateCode").dxDataGrid("instance");

        const workbook = new ExcelJS.Workbook();
        const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === Dòng 1: Tên công ty (merge theo 4 cột) ===
        worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:D1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === Dòng 2: Ngày giờ xuất (bên phải) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', exportDate]);
        worksheet.mergeCells('D2:D2');  // cột D thôi
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === Dòng 3–4: trống
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
        const reportRow = worksheet.addRow(['Reason']);
        worksheet.mergeCells('A5:D5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === Dòng 6: trống
        worksheet.addRow([]);

        // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 }
        }).then(function () {
            // Footer (sau cùng)
            const lastRow = worksheet.lastRow.number + 2;
            worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = "Reason.xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });

</script>
