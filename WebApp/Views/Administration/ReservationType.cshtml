@using DevExpress.XtraReports.UI

@{
    //
}
<div class="header">
    <h3 id="content-title">
        Property Type

    </h3>
</div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex align-items-center gap-3 p-2" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
        <form id="itemForm">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label for="code" class="me-2 mb-0">Reservation Type</label>
                    <input type="text" id="code" name="code" class="form-control form-control-sm" style="width: 100px;" />
                </div>
                <div class="d-flex align-items-center me-3">
                    <label for="name" class="me-2 mb-0">Description</label>
                    <input type="text" id="name" name="name" class="form-control form-control-sm" style="width: 300px;" />
                </div>
                <div class="d-flex align-items-center me-3">
                    <label for="seq" class="me-2 mb-0">Sequence</label>
                    <input type="number" id="seq" name="seq" min="0" max="999" value="0" runat="server" class="form-control form-control-sm" style="width: 80px;" />
                </div>
                <div class="col-auto d-flex align-items-center me-3">
                    <input type="checkbox" id="inactive" name="inactive" class="form-check-input me-2" />
                    <label for="inactive" class="form-check-label text-danger mb-0">Inactive</label>
                </div>
                <div class="col-auto d-flex align-items-center me-3">
                    <input type="checkbox" id="deduct" name="deduct" class="form-check-input me-2" />
                    <label for="deduct" class="form-check-label text-danger mb-0">Deduct</label>
                </div>
                <div class="col-auto d-flex align-items-center me-3">
                    <input type="checkbox" id="arrivalTimeRequired" name="arrivalTimeRequired" class="form-check-input me-2" />
                    <label for="arrivalTimeRequired" class="form-check-label text-danger mb-0">Arrival Time Required</label>
                </div>
                <div class="col-auto d-flex align-items-center me-3">
                    <input type="checkbox" id="creditCardRequired" name="creditCardRequired" class="form-check-input me-2" />
                    <label for="creditCardRequired" class="form-check-label text-danger mb-0">Credit Card Required</label>
                </div>
                <div class="col-auto d-flex align-items-center me-3">
                    <input type="checkbox" id="depositRequired" name="depositRequired" class="form-check-input me-2" />
                    <label for="depositRequired" class="form-check-label text-danger mb-0">Deposit Required</label>
                </div>
                <input type="hidden" id="id" name="id" value="0" />
            </div>

        </form>
    </div>
    <div class=" mt-1">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #28a745;" id="btnNew" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #007bff;" id="btnEdit" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Edit</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #007bff;" id="btnSaveItem" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Save</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545;" id="btnDelete" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Delete</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545;" id="btnCancel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Cancel</button>

    </div>
</div>

<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>
<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
       let selectedRowData = null;

        $(document).ready(function () {
         reloadGrid();
     });

        $("#btnView").on("click", function() {
        reloadGrid();
        });

        $("#btnNew").click(function () {
        $("#itemForm")[0].reset();
        $("#id").val("0");

        $("#btnEdit").hide();
        $("#btnDelete").hide();
        $("#btnCancel").show();
        $("#btnSaveItem").show();
    });


                $("#btnSaveItem").click(function () {
        const formData = $("#itemForm").serialize();
         console.log("FormData:", formData);
        let url = "/Administration/InsertReservationType";
        if ($("#id").val() && $("#id").val() !== "0") {
            url = "/Administration/UpdateReservationType"; // nếu có id thì update
        }

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (res) {
                if (res.success) {
                   showToast("Success", (url.includes("Update") ? "Update success" : "Insert success"), true);
                   $("#itemForm").trigger("reset");
                   $("#id").val("0");
                   $("#btnEdit").show();
                   $("#btnDelete").show();
                   $("#btnCancel").hide();
                   $("#btnSaveItem").hide();
                   $("#btnNew").show();
                   reloadGrid();
                } else {
                    showToast("Failed", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                showToast("Error", "Request error!", false);
            }
        });
    });
        function editMember(data) {
        $("#id").val(data.id);
        $("#code").val(data.code);
        $("#name").val(data.name);
        $("#seq").val(data.sequence);
        $("#inactive").prop("checked", data.inactive);
        $("#deduct").prop("checked", data.deduct);
        $("#arrivalTimeRequired").prop("checked", data.arrivalTimeRequired);
        $("#creditCardRequired").prop("checked", data.creditCardRequired);
        $("#depositRequired").prop("checked", data.depositRequired);

    }


           $("#btnEdit").on("click", function () {
        if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

        // Gọi hàm ánh xạ dữ liệu vào form
        editMember(selectedRowData);

        $("#btnNew").hide();
        $("#btnDelete").hide();
        $("#btnCancel").show();
        $("#btnSaveItem").show();
    });

     $("#btnCancel").click(function () {
        $("#itemForm")[0].reset();
        $("#id").val("0");

        $("#btnEdit").show();
        $("#btnDelete").show();
        $("#btnCancel").hide();
        $("#btnSaveItem").hide();
        $("#btnNew").show();
    });




    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
             columns: [
                        { dataField: "code", caption: "Res.Type" },
                        { dataField: "name", caption: "Description" },
                        { dataField: "deduct", caption: "Ded.Inv" },
                        { dataField: "arrivalTimeRequired", caption: "Arr.Time" },
                        { dataField: "creditCardRequired", caption: "CC" },
                        { dataField: "depositRequired", caption: "Deposit" },
                        { dataField: "inactive", caption: "Inactive" },
                        { dataField: "sequence", caption: "Seq." },
                    ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
            onSelectionChanged: function(e){
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }

    // Reload grid với filter từ form
    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetReservationType",
            type: 'GET',
            data: {
                code: $("#code").val(),
                description: $("#description").val(),
                sequence: $("#seq").val(),
            },
            success: function(data){
                console.log(data);
                loadGrid(data);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Không thể tải dữ liệu");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }


     $("#btnDelete").on("click", function () {
         if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

                Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'swal-small'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                deleteSelectedItem();
            }
        });

    });

            function deleteSelectedItem() {
        $.ajax({
            url: "/Administration/DeleteReservationType",
            type: "POST",
            data: { id: selectedRowData.id }, // gửi dạng form-data
            success: function (res) {
                if (res.code === 0) {
                    showToast("Success", "Deleted successfully!", true);
                    reloadGrid();
                    selectedRowData = null;
                } else {
                    showToast("Error", res.msg || "Delete failed!", false);
                }
            },
            error: function (xhr) {
                console.error("Delete error:", xhr.responseText);
                showToast("Error", "Delete error!", false);
            }
        });
    }

</script>