@using DevExpress.XtraReports.UI

@{
	//
}

<div class="text-center" id="reportTitle" style="font-size: 20px">Rate Category</div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
	<div class="d-flex align-items-center gap-3 p-2" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
		<div class="d-flex flex-column ">

			<div class="d-flex align-items-center">
				<div class="d-flex align-items-center me-4">
					<label for="tracetime" class="me-2 mb-0">Code:</label>
					<input type="text" id="codeInput"
						   class="form-control form-control-sm w-auto" />
				</div>
				<div class="d-flex align-items-center me-4">
					<label for="tracetime" class="me-2 mb-0">Name:</label>
					<input type="text" id="nameInput" class="form-control form-control-sm w-auto" />
				</div>

				<div class="d-flex align-items-center me-3">
					<div class="form-check d-flex align-items-center gap-2">
						<span class="status-color-box color-clean-uncheck"></span>
						<input class="form-check-input" type="checkbox" id="chkshowInactive" name="chkshowInactive">
						<label class="form-check-label mb-0" for="chkshowInactive">Show Inactive</label>
					</div>
				</div>

			</div>
		</div>
	</div>
	<div class="mt-2">
		<button id="btnSearch" class="mui-button button-report-view"><i class="fa-solid fa-eye"></i> View</button>
		<button id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
		<button id="btnUpdate" class="mui-button mui-button-edit"> <i class="fa-solid fa-pen"></i> Edit</button>
		<button id="btnDelete" class="mui-button button-report-delete"> <i class="fa-solid fa-trash-can"></i> Delete</button>
		<button id="btnExportExcel" class="mui-button mui-button-export" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
	</div>

</div>
<div class="mui-card">
	<div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<!-- Modal Popup for New Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-md">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="itemModalLabel">New/Edit Item</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-footer justify-content-start">
				<button type="button" id="btnSaveItem" class="mui-button mui-button-export">
					<i class="fa-solid fa-floppy-disk"></i> Save
				</button>
			</div>
			<div class="modal-body">
				<form id="itemForm">
					<div class="container-fluid" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">

						<div class="row mb-1 align-items-center">
							<div class="col-auto">
								<label for="txtcode" class="form-label mb-0">Code</label>
								<input type="text" id="txtcode" name="txtcode" class="form-control form-control-sm" />
							</div>
							<div class="col-auto d-flex align-items-center">
								<input type="checkbox" id="inactive" name="inactive" class="form-check-input me-2" />
								<label for="inactive" class="form-check-label text-danger mb-0">Inactive</label>
							</div>
						</div>

						<div class="row mb-1">
							<div class="col">
								<label for="txtname" class="form-label">Name</label>
								<input type="text" id="txtname" name="txtname" class="form-control" />
							</div>
						</div>

						<div class="row mb-1">
							<div class="col">
								<label for="txtdescription" class="form-label">Description</label>
								<textarea id="txtdescription" name="txtdescription" class="form-control" rows="4" style="background-color:#ffffe6"></textarea>
							</div>
						</div>
						<input type="hidden" id="id" name="id" value="0" />
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
	<i class="fa-solid fa-spinner fa-spin"></i>
</div>

<script>
	 $(document).ready(function () {
		 $("#btnSearch").trigger("click");
	 });
	   var selectedRowData = null;
	  $("#btnNew").click(function () {
		   $("#itemForm")[0].reset();
		   $("#id").val("0");
		   $("#itemModalLabel").text("Add Rate Category");
		   $("#itemModal").modal("show");
	  });

	 function getData(data){
		  $("#gridContainer").dxDataGrid({
			  dataSource: data,
			  showBorders: true,
			  selection: { mode: "single" },
			  paging: { pageSize: 20 },
			  height: 500,
			  width: "100%",
			  pager: {
				  visible: true,
				  showPageSizeSelector: true,
				  allowedPageSizes: [20, 50, 100],
				  showInfo: true,
				  showNavigationButtons:true
			  },
			  filterRow: { visible: true },
			  columns: [
						 { dataField: "code", caption: "Code" , width: 200 },
						 { dataField: "name", caption: "Name" , width: 200},
						 { dataField: "description", caption: "Description", width: 150 },
						 { dataField: "inactive", caption: "Inactive", width: 80,
							  cellTemplate: function(container, options) {
								   let checked = (options.value === true || options.value === "True");
								  $("<div>")
									  .dxCheckBox({
										  value: checked,
										  readOnly: true
									  })
									  .css("transform", "scale(0.8)")
									  .appendTo(container);
							  }
						 },
						 { dataField: "createdBy", caption: "Created By", width: 120 },
						 { dataField: "createdDate", caption: "Created Date", dataType: "date", format: "dd/MM/yyyy HH:mm", width: 160 },
						 { dataField: "updatedBy", caption: "Updated By", width: 120 },
						 { dataField: "updatedDate", caption: "Updated Date", dataType: "date", format: "dd/MM/yyyy HH:mm", width: 160 },
					 ],
			  scrolling: {
					  mode: "standard",
					  showScrollbar: "always",
					  scrollByContent: true
				  },
			   onSelectionChanged: function(e){
				  selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
				  console.log("Selected Row:", selectedRowData);
			  }
		 });
	 }

	   $(document).off("click", "#btnSearch").on("click", "#btnSearch", function () {
		  $("#loadingSpinner").show();
		  $.ajax({
			  url: "/Administration/GetRateCategory/",
			  type: "GET",
			  data: {
				 code: $("#codeInput").val(),
				 name: $("#nameInput").val(),
				 inactive: $("#chkshowInactive").prop("checked") ? 1 : 0,
			  },
			  traditional: true,
				   crossDomain: false,
					 headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
			  success: function(data){
				  getData(data);
				  $("#loadingSpinner").hide();
			  },
			  error: function(xhr, status, error){
				 alert("Không thể tải dữ liệu");
				 $("#loadingSpinner").hide();
			  }
		});
	});

	 $("#btnSaveItem").click(function () {
		  const id = parseInt($("#id").val()) || 0;
		  let loginName = (localStorage.getItem("Loginname") || "")
			.trim()
			.replace(/^"(.*)"$/, '$1'); 

		  const loginUser = parseInt(localStorage.getItem("userID")) || 0;

		  const url = "/Administration/RateCategorySave";
		  const model = {
			  ID: id,
			  Code: $("#txtcode").val(),
			  Name: $("#txtname").val(),
			  Description: $("#txtdescription").val(),
			  Inactive: $("#inactive").prop("checked"),
			  CreatedBy: loginName,
			  UpdatedBy: loginName,
			  UserInsertID: loginUser,
			  UserUpdateID: loginUser
		  };

		  $("#loadingSpinner").show();

		  $.ajax({
			  url: url,
			  type: "POST",
			  contentType: "application/json",
			  data: JSON.stringify(model),
			  headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
			  success: function (response) {
				  $("#loadingSpinner").hide();
				  if (response.success) {
					   showToast("Success",response.message, true);
					  $("#itemModal").modal("hide");
					  $("#btnSearch").trigger("click");
				  } else {
					   showToast("Error",response.message, false);
				  }
			  },
			  error: function (xhr, status, error) {
				  $("#loadingSpinner").hide();
					  showToast("Error",error.message, false);
			  }
		  });
	  });
		function editItem(data) {
		  $("#id").val(data.id);
		  $("#txtcode").val(data.code);
		  $("#txtname").val(data.name);
		  $("#txtdescription").val(data.description);
		  $("#inactive").prop("checked", data.inactive);
		  $("#itemModal").modal("show");
	  }
	  $("#btnUpdate").click(function () {
			if (!selectedRowData || selectedRowData.id === 0) {
			  showToast('Warning', "Select 1 row, please!", true);
			  return;
		  }
		   $("#itemModalLabel").text("Edit Rate Category");
			console.log(" selectRow "+selectedRowData.id);
		   editItem(selectedRowData);
	  });

	   $("#btnDelete").click(function () {
		   if (!selectedRowData || selectedRowData.id === 0) {
			   showToast('Warning', "Select 1 row, please!", true);

			   return;
		   }
		   if (!confirm("Are you sure you want to delete this record?")) {
				return; 
			}
		   $.ajax({
			   url: `/Administration/RateCategoryDelete/`+ selectedRowData.id,
			   type: "POST",
			   traditional: true,
			   crossDomain: false,
			   headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
			   success: function(result){
					if(result.success){
						$("#btnSearch").trigger("click");
						showToast("Success","Delete Successfully!",true);
					} else {
						showToast("Error",result.message,false);
					}
			   },
			   error: function(){
					showToast("Error","Delete failed!",false);
					$("#loadingSpinner").hide();
			   },
		   });
	   });

	  $("#btnExportExcel").click(function () {
		 const grid = $("#gridContainer").dxDataGrid("instance");

		 const workbook = new ExcelJS.Workbook();
		 const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
		 const worksheet = workbook.addWorksheet("Sheet 1");

		 // === Dòng 1: Tên công ty (merge theo 4 cột) ===
		 worksheet.addRow([companyName]);
		 worksheet.mergeCells('A1:D1');
		 worksheet.getRow(1).font = { bold: true };
		 worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

		 // === Dòng 2: Ngày giờ xuất (bên phải) ===
		 const now = new Date();
		 const exportDate = now.toLocaleString("vi-VN");
		 worksheet.addRow(['', '', '', exportDate]);
		 worksheet.mergeCells('D2:D2');  // cột D thôi
		 worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

		 // === Dòng 3–4: trống
		 worksheet.addRow([]);
		 worksheet.addRow([]);

		 // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
		 const reportRow = worksheet.addRow(['Reason']);
		 worksheet.mergeCells('A5:D5');
		 reportRow.font = { bold: true, size: 14 };
		 reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

		 // === Dòng 6: trống
		 worksheet.addRow([]);

		 // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
		 DevExpress.excelExporter.exportDataGrid({
			 component: grid,
			 worksheet: worksheet,
			 autoFilterEnabled: true,
			 topLeftCell: { row: 7, column: 1 }
		 }).then(function () {
			 // Footer (sau cùng)
			 const lastRow = worksheet.lastRow.number + 2;
			 worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
			 worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
			 worksheet.getCell(`A${lastRow}`).font = { italic: true };

			 // Ghi file
			 let fileName = "RateCategory.xlsx";
			 workbook.xlsx.writeBuffer().then(function (buffer) {
				 saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
			 });
		 });
		 });

</script>
