@using DevExpress.XtraReports.UI

@{
    //
}
<div class="header">
    <h3 id="content-title">
        Property Permission

    </h3>
</div>


<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex align-items-center gap-3 p-2" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">

        <div class="d-flex align-items-center">
            <label class="">User:</label>
            <select id="user" name="user" class="tomselect-custom" style="width: 300px;" multiple>

                @foreach (var sg in ViewBag.UsersList)
                {
                    <option value="@sg.ID" data-code="@sg.LoginName">@sg.LoginName - @sg.FirstName</option>
                }
            </select>
        </div>

    </div>
    <div class=" mt-1">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #28a745;" id="btnNew" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> New</button>
        @* <button style="border-radius: 4px;  margin-right: 6px;background-color: #007bff;" id="btnEdit" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Edit</button> *@
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545;" id="btnDelete" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Delete</button>
        @* <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button> *@

    </div>
</div>

<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>

<!-- Modal Popup for New Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form id="itemForm">
                    <div class="container-fluid" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">

                        <div class="row mb-1">
                            <div class="col">
                                <label class="">User:</label>
                                <select id="chooseuser" name="chooseuser" class="tomselect-custom" style="width: 446px;" multiple>

                                    @foreach (var sg in ViewBag.UsersList)
                                    {
                                        <option value="@sg.ID" data-code="@sg.LoginName">@sg.LoginName - @sg.FirstName</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="row mb-1">
                            <div class="col">
                                <label class="">Property Type:</label>
                                <select id="propertyType" name="propertyType" class="tomselect-custom" style="width: 446px;" multiple>

                                    @foreach (var sg in ViewBag.PropertyList)
                                    {
                                        <option value="@sg.ID" data-code="@sg.PropertyCode">@sg.PropertyCode - @sg.PropertyName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <input type="hidden" id="id" name="id" value="0" />
                    </div>
                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnSaveItem" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
       let selectedRowData = null;

         $(document).ready(function () {

         initializeTomSelects();
         reloadGrid();

         });
          function initializeTomSelects() {
        const selectors = ["#user", "#propertyType","#chooseuser"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            // Nếu đã khởi tạo rồi thì destroy
            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }


        $("#btnView").on("click", function() {
        reloadGrid();
        });

    $("#btnNew").click(function () {
        $("#itemForm")[0].reset();
        $("#id").val("0");   // reset về 0 để phân biệt Insert

        // reset TomSelect chooseuser
        if (document.querySelector("#chooseuser").tomselect) {
            document.querySelector("#chooseuser").tomselect.clear();
        }

        // reset TomSelect propertyType
        if (document.querySelector("#propertyType").tomselect) {
            document.querySelector("#propertyType").tomselect.clear();
        }

        $("#itemModal").modal("show");
    });


                $("#btnSaveItem").click(function () {
        const formData = $("#itemForm").serialize();
         console.log("FormData:", formData);
        let url = "/Administration/InsertPropertyPermission";
        if ($("#id").val() && $("#id").val() !== "0") {
            url = "/Administration/UpdatePropertyPermission"; // nếu có id thì update
        }

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (res) {
                if (res.success) {
                    showToast("Success", (url.includes("Update") ? "Update success" : "Insert success"), true);
                    $("#itemModal").modal("hide");
                    reloadGrid();
                } else {
                    showToast("Failed", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                showToast("Error", "Request error!", false);
            }
        });
    });
            function editMember(data) {
        $("#id").val(data.id);

        // Gán cho PropertyType
        if (document.querySelector("#propertyType").tomselect) {
            let ts = document.querySelector("#propertyType").tomselect;
            ts.clear(); // xóa trước
            ts.addItem(data.propertyID); // thêm ID
        }

        // Gán cho ChooseUser
        if (document.querySelector("#chooseuser").tomselect) {
            let ts = document.querySelector("#chooseuser").tomselect;
            ts.clear();
            ts.addItem(data.userID);
        }

        // Hiển thị modal
        $("#itemModal").modal("show");
    }



           $("#btnEdit").on("click", function () {
        if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

        // Gọi hàm ánh xạ dữ liệu vào form
        editMember(selectedRowData);
    });



        function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                { dataField: "loginName", caption: "Login name", groupIndex: 0 }, // group theo loginName
                { dataField: "propertyCode", caption: "PropertyCode" },
                { dataField: "propertyName", caption: "PropertyName" }
            ],
            grouping: {
                autoExpandAll: true // mở sẵn group
            },

            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            scrolling: { mode: "standard", showScrollbar: "always", scrollByContent: true },
            onSelectionChanged: function (e) {
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }


    // Reload grid với filter từ form
    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetPropertyPermission",
            type: 'GET',
            data: {
                userID: $("#user").val().join(",")
            },
            success: function(data){
                console.log(data);
                loadGrid(data);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Không thể tải dữ liệu");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }


     $("#btnDelete").on("click", function () {
         if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

                Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'swal-small'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                deleteSelectedItem();
            }
        });

    });

            function deleteSelectedItem() {
        $.ajax({
            url: "/Administration/DeletePropertyPermission",
            type: "POST",
            data: { id: selectedRowData.id }, // gửi dạng form-data
            success: function (res) {
                if (res.code === 0) {
                    showToast("Success", "Deleted successfully!", true);
                    reloadGrid();
                    selectedRowData = null;
                } else {
                    showToast("Error", res.msg || "Delete failed!", false);
                }
            },
            error: function (xhr) {
                console.error("Delete error:", xhr.responseText);
                showToast("Error", "Delete error!", false);
            }
        });
    }
    // $("#btnExportExcel").click(function () {
    //     const grid = $("#gridContainerRateCode").dxDataGrid("instance");   🔥 khai báo grid

    //     const workbook = new ExcelJS.Workbook();
    //     const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
    //     const worksheet = workbook.addWorksheet("Sheet 1");

    //     === Dòng 1: Tên công ty (merge theo 4 cột) ===
    //     worksheet.addRow([companyName]);
    //     worksheet.mergeCells('A1:D1');
    //     worksheet.getRow(1).font = { bold: true };
    //     worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

    //     === Dòng 2: Ngày giờ xuất (bên phải) ===
    //     const now = new Date();
    //     const exportDate = now.toLocaleString("vi-VN");
    //     worksheet.addRow(['', '', '', exportDate]);
    //     worksheet.mergeCells('D2:D2');  cột D thôi
    //     worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

    //     === Dòng 3–4: trống
    //     worksheet.addRow([]);
    //     worksheet.addRow([]);

    //     === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
    //     const reportRow = worksheet.addRow(['City']);
    //     worksheet.mergeCells('A5:D5');
    //     reportRow.font = { bold: true, size: 14 };
    //     reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

    //     === Dòng 6: trống
    //     worksheet.addRow([]);

    //     === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
    //     DevExpress.excelExporter.exportDataGrid({
    //         component: grid,
    //         worksheet: worksheet,
    //         autoFilterEnabled: true,
    //         topLeftCell: { row: 7, column: 1 }
    //     }).then(function () {
    //         Footer (sau cùng)
    //         const lastRow = worksheet.lastRow.number + 2;
    //         worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
    //         worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
    //         worksheet.getCell(`A${lastRow}`).font = { italic: true };

    //         Ghi file
    //         let fileName = "City.xlsx";
    //         workbook.xlsx.writeBuffer().then(function (buffer) {
    //             saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
    //         });
    //     });
    // });

</script>