
@{
    // Kiểm tra xem có biến `media` nào được dùng không
}


<div class="text-center" style="font-size: 20px">Config Status Color</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex align-items-center gap-3 p-2">
        <form id="itemForm">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label for="name" class="me-2 mb-0">Name</label>
                    <input type="text" id="name" name="name" class="form-control form-control-sm"
                           style="width: 200px;" disabled />
                </div>
            </div>
            <label for="bgColor" class="me-2 mb-0">Color</label>
            <input type="color" id="bgColor" value="#00ffff" />
            <input type="hidden" name="bgColor" id="backgroundColor" />
            <label for="fontColor" class="me-2 mb-0">Font Color</label>
            <input type="color" id="fontColor" value="#ff0000" />
            <input type="hidden" name="fontColor" id="fontColorHidden" />

            <input type="hidden" id="id" name="id" value="0" />

        </form>
    </div>
    <div class="mt-2">
        <button id="btnSaveItem" class="mui-button mui-button-save"><i class="fa-solid fa-save"></i> Save</button>
    </div>
</div>


<div class="mui-card">
    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
</div>
            
<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
    let selectedRowData = null;

    $(document).ready(function () {
        reloadGrid();
    });
    function hexToArgb(hex) {
        let r = parseInt(hex.substr(1, 2), 16);
        let g = parseInt(hex.substr(3, 2), 16);
        let b = parseInt(hex.substr(5, 2), 16);

        let argb = (255 << 24) | (r << 16) | (g << 8) | b;
        if (argb > 0x7FFFFFFF) {
            argb = argb - 0x100000000; // ép về signed int
        }
        return argb;
    }

    document.getElementById("bgColor").addEventListener("input", function () {
        let argb = hexToArgb(this.value);
    });

    document.getElementById("fontColor").addEventListener("input", function () {
        let argb = hexToArgb(this.value);
    });

    $("#btnSaveItem").click(function () {
        // Gán giá trị color vào hidden trước khi serialize
        $("#backgroundColor").val(hexToArgb($("#bgColor").val()));
        $("#fontColorHidden").val(hexToArgb($("#fontColor").val()));

        const formData = $("#itemForm").serialize();
        if (!selectedRowData) {
            showToast("Warning","Select one row to edit please", false);
            return;
        }

        if (selectedRowData) {
            url = "/Administration/UpdateConfigStatusColor";
        }

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (res) {
                if (res.success) {
                    showToast("Success", url.includes("Update") ? "Update success" : "Insert success", true);
                    $("#itemForm").trigger("reset");
                    selectedRowData = null;

                    reloadGrid();
                } else {
                    showToast("Failed", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                console.error("Save error:", xhr.responseText);
                showToast("Error", "Request error!", false);
            }
        });
    });


    function argbToHex(argb) {
        if (argb < 0) {
            argb = 0xFFFFFFFF + argb + 1; // ép về unsigned
        }
        let r = (argb >> 16) & 0xFF;
        let g = (argb >> 8) & 0xFF;
        let b = argb & 0xFF;

        return "#" + [r, g, b].map(x => x.toString(16).padStart(2, "0")).join("");
    }

    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                {
                    dataField: "statusName", caption: "Status Name",

                    cellTemplate: function (container, options) {
                        $("<div>")
                            .text(options.data.statusName)
                            .css({
                                "background-color": options.data.colorHex || "#fff",
                                "color": options.data.fontHex || "#000",
                                "padding": "3px 8px",
                                "border-radius": "4px",
                                "display": "inline-block"
                            })
                            .appendTo(container);
                    }
                },
                {
                    dataField: "description", caption: "Description",
                    cellTemplate: function (container, options) {
                        $("<div>")
                            .text(options.data.description)
                            .css({
                                "background-color": options.data.colorHex || "#fff",
                                "color": options.data.fontHex || "#000",
                                "padding": "3px 8px",
                                "border-radius": "4px",
                                "display": "inline-block"
                            })
                            .appendTo(container);
                    }
                },

            ],
            filterRow: { visible: true, applyFilter: "auto" },
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            scrolling: { mode: "standard", showScrollbar: "always", scrollByContent: true },
            onSelectionChanged: function (e) {
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);

                if (selectedRowData) {
                    // Màu nền
                    if (selectedRowData.colorHex) {
                        $("#bgColor").val(selectedRowData.colorHex);
                        $("#backgroundColor").val(selectedRowData.colorName); // giữ lại giá trị int gốc để submit

                    }

                    // Màu chữ
                    if (selectedRowData.fontHex) {
                        $("#fontColor").val(selectedRowData.fontHex);
                        $("#fontColorHidden").val(selectedRowData.fontColorName); // giữ lại int gốc
                    }
                    if (selectedRowData.statusName) {
                        $("#name").val(selectedRowData.statusName);

                    }
                    if (selectedRowData.id) {
                        $("#id").val(selectedRowData.id);

                    }
                }
            }

        });
    }
    function parseColorData(data) {
        return data.map(item => {
            let newItem = { ...item };

            if (item.colorName !== undefined && item.colorName !== null) {
                newItem.colorHex = argbToHex(parseInt(item.colorName));
            }

            if (item.fontColorName !== undefined && item.fontColorName !== null) {
                newItem.fontHex = argbToHex(parseInt(item.fontColorName));
            }

            return newItem;
        });
    }

    // Reload grid với filter từ form
    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetStatusList",
            type: 'GET',
            success: function (data) {
                let parsedData = parseColorData(data);

                loadGrid(parsedData);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function (xhr, status, error) {
                alert("Unable to loading data");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }
</script>
