@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    // Kiểm tra xem có biến `media` nào được dùng không
    // Ví dụ: var media = Model.Media; // Đảm bảo Model có thuộc tính Media nếu cần
}

<!-- Comment reservation.css để tránh xung đột, nhưng có thể thêm lại sau khi fix -->
@* <link href="~/css/pages/reservation.css" rel="stylesheet" /> *@
<style>
    :root {
        --main-color: #2b6cb0; /* Màu chính (xanh dương) */
        --secondary-color: #f5f5f5; /* Màu nền thứ cấp (xám nhạt) */
        --highlight-color: #d65a00; /* Màu nổi bật (cam) */
        --text-color: #2d3748; /* Màu chữ (xám đậm) */
        --accent-color: #ffffff; /* Màu bổ sung (trắng) */
    }

    .menu-group-title {
        font-weight: bold;
        padding: 8px;
        cursor: pointer;
        background: var(--secondary-color);
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .menu-left .submenu {
        display: none;
        margin-top: 2px;
        padding-left: 10px;
        background: var(--accent-color);
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        min-width: 120px;
        position: relative;
        z-index: 20;
    }

        .menu-left .submenu.active {
            display: block !important;
        }

    /* Đảm bảo các style khác sử dụng biến CSS */
    .menu-item {
        display: block;
        padding: 12px 16px;
        color: var(--text-color);
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        border-bottom: 1px solid #bcbcbc;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

        .menu-item:hover,
        .menu-item.active {
            color: var(--text-color);
            background-color: var(--secondary-color);
            border-left: 4px solid var(--highlight-color);
        }

    .menu-group > .menu-left {
        display: none; /* ẩn mặc định */
        margin-top: 2px;
        background: var(--accent-color);
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
</style>
<div class="mt-3">
    <div class="row">

        <div class="content-right">
            <div class="header">
                <h3 id="content-title">
                    Config Status Color

                </h3>
            </div>

            <div class="sticky-header bg-white p-2 shadow-sm z-3">
                <div class="d-flex align-items-center gap-3 p-2" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
                    <form id="itemForm">
                        <div class="d-flex align-items-center">
                            <div class="d-flex align-items-center me-3">
                                <label for="name" class="me-2 mb-0">Name</label>
                                <input type="text" id="name" name="name" class="form-control form-control-sm" style="width: 200px;" disabled/>
                            </div>
                        </div>
                        <label for="bgColor" class="me-2 mb-0">Color</label>
                        <input type="color" id="bgColor" value="#00ffff" />
                        <input type="hidden" name="bgColor" id="backgroundColor" />
                        <label for="fontColor" class="me-2 mb-0">Fore Color</label>
                        <input type="color" id="fontColor" value="#ff0000" />
                        <input type="hidden" name="fontColor" id="fontColorHidden" />

                        <input type="hidden" id="id" name="id" value="0" />
                
                    </form>
                </div>               
            </div>
            <div class="ms-3">
            <button style="border-radius: 4px; margin-right: 6px;background-color: #007bff;" id="btnSaveItem" class="mui-button mui-button-edit"><i class="fa-solid fa-pen"></i> Save</button>
            </div>
            <div class="mui-card">
                <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
            </div>
        </div>

    </div>
</div>

<div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    DevExpress.localization.locale("vi");
       let selectedRowData = null;

        $(document).ready(function () {
        $(".menu-group-title").on("click", function (event) {
                const submenu = $(this).next(".menu-left"); // lấy thằng menu-left con
           const icon = $(this).find("i");

           // toggle submenu
           submenu.slideToggle(200);

           // đổi icon
           icon.toggleClass("fa-chevron-down fa-chevron-up");
           });
         reloadGrid();
     });
       function hexToArgb(hex) {
        let r = parseInt(hex.substr(1, 2), 16);
        let g = parseInt(hex.substr(3, 2), 16);
        let b = parseInt(hex.substr(5, 2), 16);

        let argb = (255 << 24) | (r << 16) | (g << 8) | b;
        if (argb > 0x7FFFFFFF) {
            argb = argb - 0x100000000; // ép về signed int
        }
        return argb;
    }

    document.getElementById("bgColor").addEventListener("input", function() {
        let argb = hexToArgb(this.value);
        console.log("Màu nền:", this.value, "=>", argb);


    });

    document.getElementById("fontColor").addEventListener("input", function() {
        let argb = hexToArgb(this.value);
        console.log("Màu chữ:", this.value, "=>", argb);

    });

        $("#btnSaveItem").click(function () {
        // Gán giá trị color vào hidden trước khi serialize
        $("#backgroundColor").val(hexToArgb($("#bgColor").val()));
        $("#fontColorHidden").val(hexToArgb($("#fontColor").val()));

        const formData = $("#itemForm").serialize();
          if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

        if (selectedRowData) {
            url = "/Administration/UpdateConfigStatusColor";
        }

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (res) {
                if (res.success) {
                    showToast("Success", url.includes("Update") ? "Update success" : "Insert success", true);
                    $("#itemForm").trigger("reset");
                    selectedRowData = null;

                    reloadGrid();
                } else {
                    showToast("Failed", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                console.error("Save error:", xhr.responseText);
                showToast("Error", "Request error!", false);
            }
        });
    });


            function argbToHex(argb) {
        if (argb < 0) {
            argb = 0xFFFFFFFF + argb + 1; // ép về unsigned
        }
        let r = (argb >> 16) & 0xFF;
        let g = (argb >> 8) & 0xFF;
        let b = argb & 0xFF;

        return "#" + [r, g, b].map(x => x.toString(16).padStart(2, "0")).join("");
    }

    function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
             columns: [
                        { dataField: "statusName", caption: "Status Name" ,
                         
                            cellTemplate: function(container, options) {
                                $("<div>")
                                    .text(options.data.statusName)
                                    .css({
                                        "background-color": options.data.colorHex || "#fff",
                                        "color": options.data.fontHex || "#000",
                                        "padding": "3px 8px",
                                        "border-radius": "4px",
                                        "display": "inline-block"
                                    })
                                    .appendTo(container);
                            }
                        },
                        { dataField: "description", caption: "Description",
                            cellTemplate: function(container, options) {
                                $("<div>")
                                    .text(options.data.description)
                                    .css({
                                        "background-color": options.data.colorHex || "#fff",
                                        "color": options.data.fontHex || "#000",
                                        "padding": "3px 8px",
                                        "border-radius": "4px",
                                        "display": "inline-block"
                                    })
                                    .appendTo(container);
                            }
                            },
                        
                    ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
                onSelectionChanged: function(e) {
                    selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                    console.log("Selected Row:", selectedRowData);

                    if (selectedRowData) {
                        // Màu nền
                        if (selectedRowData.colorHex) {
                            $("#bgColor").val(selectedRowData.colorHex);
                            $("#backgroundColor").val(selectedRowData.colorName); // giữ lại giá trị int gốc để submit
                
                        }

                        // Màu chữ
                        if (selectedRowData.fontHex) {
                            $("#fontColor").val(selectedRowData.fontHex);
                            $("#fontColorHidden").val(selectedRowData.fontColorName); // giữ lại int gốc
    

                        }
                        if (selectedRowData.statusName) {
                            $("#name").val(selectedRowData.statusName);

                        }
                        if (selectedRowData.id) {
                            $("#id").val(selectedRowData.id);

                        }
                    }
                }

        });
    }
        function parseColorData(data) {
        return data.map(item => {
            let newItem = { ...item };

            if (item.colorName !== undefined && item.colorName !== null) {
                newItem.colorHex = argbToHex(parseInt(item.colorName));
            }

            if (item.fontColorName !== undefined && item.fontColorName !== null) {
                newItem.fontHex = argbToHex(parseInt(item.fontColorName));
            }

            return newItem;
        });
    }

    // Reload grid với filter từ form
        function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: "/Administration/GetStatusList",
            type: 'GET',
            success: function(data) {
                console.log("Raw data:", data);

                let parsedData = parseColorData(data);
                console.log("Parsed data:", parsedData);

                loadGrid(parsedData);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Không thể tải dữ liệu");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }



            

</script>