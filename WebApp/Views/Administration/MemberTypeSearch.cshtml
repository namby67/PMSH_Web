@* <link href="~/css/pages/reservation.css" rel="stylesheet" /> *@
<style>
    #sendDate:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .card-type-item label {
        display: flex;
        align-items: center; /* Căn giữa theo chiều dọc */
        gap: 6px; /* Khoảng cách giữa checkbox và text */
        white-space: nowrap; /* Không xuống dòng */
    }

    .card-type-list input[type="checkbox"] {
        width: 10px; /* chiều rộng */
        height: 10px; /* chiều cao */
        transform: scale(1.5); /* phóng to checkbox */
        margin-right: 6px; /* khoảng cách label */
        margin-top: 6px;
    }


    .card-type-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 cột đều nhau */
        gap: 6px 12px; /* khoảng cách giữa các ô: 6px hàng, 12px cột */
        margin-top: 6px;
    }

    /* Phóng to checkbox "All" */
    #cardAll {
        width: 10px;
        height: 10px;
        transform: scale(1.5);
        margin-right: 6px;
    }
</style>
<link href="~/css/reservation.css" rel="stylesheet" />
<div class="mt-3">
    <div class="row">
        <div class="col-md-2 mb-2">
            <div class="menu-left">
                <button class="toggle-btn"><i class="fas fa-bars"></i></button>
                <a class="menu-item " asp-controller="Administration" asp-action="MemberList">MEMBER LIST</a>   
                <a class="menu-item " asp-controller="Administration" asp-action="MemberCategory">MEMBER CATEGORY</a>
                <a class="menu-item active">MEMBER TYPE SEARCH</a>
            </div>
        </div>

        <!-- Nội dung bên phải -->
        <div class="col-md-10">
            <div class="content-right ms-2">
                <div class="header">
                    <h3 id="content-title">
                        Member Type Search

                    </h3>
                </div>
                    
                <div class="row g-3">
                    <!-- Reservations Status -->
                    <div class="col-md-2">
                        <label>Date </label>
                        <div class="mt-2 mb-2" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center me-2" >
                                <label class="me-2 mb-0">From Date: </label>
                                <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto mt-2" />
                            </div>

                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">To Date: </label>
                                <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto mt-2 ms-3" />
                            </div>
                        </div>
                        <label>Reservations Status</label>
                        <div class="card-type-list mt-2" id="reservations" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div>
                                <label><input type="checkbox" id="reservationsAll" value="999" checked /> All</label>
                            </div>
                            <div>
                                <label><input type="checkbox" id="reservation" value="0','5" checked /> Reservation</label>
                            </div>
                            <div>
                                <label><input type="checkbox" id="inHouse" value="1','6" checked /> In House</label>
                            </div>
                            <div>
                                <label><input type="checkbox" id="checkOut" value="2" checked /> Check Out</label>
                            </div>
                        </div>
                    </div>

                    <!-- Card Category -->
                    <div class="col-md-5">
                        <label>Card Category</label>
                        <div class="card-type-list mt-2" id="categoryList" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div>
                                <label><input type="checkbox" id="cardAll" /> All</label>
                            </div>
                            <div class="card-type-grid row">
                                @if (ViewBag.MemberCategoryList != null)
                                {
                                    foreach (var card in ViewBag.MemberCategoryList)
                                    {
                                        <div class="card-type-item col-3">
                                            <label>
                                                <input type="checkbox" name="CardCategory" value="@card.ID" /> @card.Code
                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Card Type -->
                    <div class="col-md-5">
                        <label>Card Type</label>
                        <div class="card-type-list mt-2" id="typeList" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="card-type-grid row">
                                @if (ViewBag.MemberTypeList != null)
                                {
                                    foreach (var cardt in ViewBag.MemberTypeList)
                                    {
                                        <div class="card-type-item col-3">
                                            <label>
                                                <input type="checkbox" name="CardType" value="@cardt.ID" data-categoryid="@cardt.MemberCategoryID" /> @cardt.Code

                                            </label>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div style="display:flex;column-gap:12px">
                <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new ms-2"><i class="fa-solid fa-eye"></i>View</button>
           
            </div>
            <div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="mui-card">
                <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>

    DevExpress.localization.locale("vi");
    let selectedRowData = null;

      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }

      $(document).ready(function () {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);
                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;
                               // Khi thay đổi checkbox "All"
                $("#reservationsAll").change(function() {
                    var isChecked = $(this).is(":checked");
                    $("#reservations input[type='checkbox']").not(this).prop("checked", isChecked);
                });

                // Khi thay đổi từng checkbox con, nếu tất cả được check thì tự động check "All"
                   $("#reservations input[type='checkbox']").not("#reservationsAll").change(function() {
                    var allChecked = $("#reservations input[type='checkbox']").not("#reservationsAll").length ===
                                     $("#reservations input[type='checkbox']:checked").not("#reservationsAll").length;
                    $("#reservationsAll").prop("checked", allChecked);
                });
                        // Khi thay đổi Card All
                $("#cardAll").change(function() {
                    var isChecked = $(this).is(":checked");
                    // Check/uncheck tất cả checkbox con trong categoryList
                    $("#categoryList input[type='checkbox']").not(this).prop("checked", isChecked);
                    // Check/uncheck tất cả checkbox con trong typeList
                    $("#typeList input[type='checkbox']").prop("checked", isChecked);
                });

                      $("#categoryList input[type='checkbox']").not("#cardAll").change(function() {
                    var categoryID = $(this).val(); // dùng ID
                    var isChecked = $(this).is(":checked");

                    $("#typeList input[type='checkbox']").each(function() {
                        var typeCategoryID = $(this).data("categoryid");
                        if (typeCategoryID == categoryID) {
                            $(this).prop("checked", isChecked);
                        }
                    });

                    // Kiểm tra CardAll
                    var allChecked = $("#categoryList input[type='checkbox']").not("#cardAll").length ===
                                     $("#categoryList input[type='checkbox']:checked").not("#cardAll").length;
                    $("#cardAll").prop("checked", allChecked);
                });
                       $("#typeList input[type='checkbox']").change(function() {
                var categoryID = $(this).data("categoryid");
                var allTypes = $("#typeList input[data-categoryid='" + categoryID + "']");

                // Nếu ít nhất 1 type con được check, thì category được check
                var anyChecked = allTypes.filter(":checked").length > 0;
                $("#categoryList input[value='" + categoryID + "']").prop("checked", anyChecked);

                // Kiểm tra CardAll
                var allCategoriesChecked = $("#categoryList input[type='checkbox']").not("#cardAll").length ===
                                           $("#categoryList input[type='checkbox']:checked").not("#cardAll").length;
                $("#cardAll").prop("checked", allCategoriesChecked);
            });




                reloadGrid();
        });

              function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                { dataField: "roNo", caption: "Ro.No", width: "11%" },
                { dataField: "name", caption: "name", width: "11%" },
                { dataField: "cardNumber", caption: "Card Number", width: "12%" },
                { dataField: "arrival", caption: "Arrival", width: "11%" },
                { dataField: "depart", caption: "Departure", width:"11%" },
                { dataField: "nights", caption: "Nights", width: "11%" },
                { dataField: "marketCode", caption: "Market Code ", width: "11%" },
                { dataField: "rateCode", caption: "Rate Code", width: "11%" },
                { dataField: "status", caption: "Status", width: "11%" },

            ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
            onSelectionChanged: function(e){
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }
    $("#btnView").on("click", function() {
        reloadGrid();
        });

        // Reload grid với filter từ form
        function reloadGrid() {
            $("#loadingSpinnerRateCode").show();

                // Lấy tất cả checkbox status được chọn
                    var selectedStatus = $("#reservations input[type='checkbox']:checked").map(function() {
                    return this.value; // lấy value của checkbox
                }).get();

                if (selectedStatus.length === 0) {
                    selectedStatus = ['999']; // mặc định nếu không check gì
                }

                    var statusString = selectedStatus.map(v => v.replace("''")).join("','");


           

                // Tương tự cho MemberID
                var selectedMember = $("#typeList input[name='CardType']:checked").map(function() {
                    return this.value;
                }).get();
                if(selectedMember.length === 0){
                    selectedMember = ['99']; // mặc định 99 nếu không chọn gì
                }
                var memberString = selectedMember.map(v => v.replace("''")).join("','");

                // Gửi ajax
                $.ajax({
                    url: '/Administration/GetMemberTypeSearch',
                    type: 'GET',
                    data: {
                        fromDate: $("#fromDate").val(),
                        toDate: $("#toDate").val(),
                        status: statusString,
                        memberID: memberString,
                        isSortByCardName: 0
                    },
                    success: function(data){
                        loadGrid(data);
                    $("#loadingSpinnerRateCode").hide();
                    },
                    error: function(xhr, status, error){
                        alert("Không thể tải dữ liệu");
                        $("#loadingSpinnerRateCode").hide();
                    }
                });

        }



</script>