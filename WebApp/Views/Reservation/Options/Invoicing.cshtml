
<!-- Modal invoicing-->
<div class="modal fade modal-xl" id="modalInvoicing" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabelBilling" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="border: 1px solid #bcbcbc">
            <div class="modal-header">
                <h5 class="modal-title" >Invoicing</h5>
                <button type="button" class="btn-close" onclick="closeModalInvoicing()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-primary btn-primary-post-billing" style="padding: 4px 8px;" onclick="searchFolioInvoicing();">Search</button>
                    <button class="btn btn-primary btn-primary-post-billing" style="padding: 4px 8px;background-color:#006600" onclick="exportInvoicing();">Excel</button>

                </div>
                <div class="" style="display: flex;padding: 0px 15px">

                    <div class="col-md-10 row filter-section">
                        <div class="header" style="justify-content:space-between">
                            <h3 id="content-title" style="font-size:14px">
                                Search Information
                            </h3>
                            <div class="row">
                                <div class="form-group col-md-1">
                                    <label >Folio. No</label>
                                    <input type="text" class="form-control" id="folioNoInvoicing">
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Confirm. No</label>
                                    <input type="text" class="form-control" id="confirmationNoInvoicing">
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Room</label>
                                    <input type="text" class="form-control" id="roomInvoicing">
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Name</label>
                                    <input type="text" class="form-control" id="nameInvoicing">
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Guest Status</label>
                                    <select class="form-control" id="guestStatusInvoicing">
                                        <option value="0"> All</option>
                                        <option value="1"> Guest In House</option>
                                        <option value="2"> Checked Out</option>

                                    </select>
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Folio Status</label>
                                    <select class="form-control" id="folioStatusInvoicing">
                                        <option value="0"> All</option>
                                        <option value="1"> Opened</option>
                                        <option value="2"> Closed</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-1">
                                    <label >Folio Type</label>
                                    <select class="form-control" id="folioTyoeInvoicing">
                                        <option value="0"> All</option>
                                        <option value="1"> Guest Folio</option>
                                        <option value="2"> Master Folio</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-1 ">
                                    <label >Date</label>
                                    <input type="date" class="form-control" id="dateInvoicing">
                                    <input class="form-check-input" type="checkbox" value="" id="checkBoxInvoicing">

                                </div>
                            </div>

                        </div>
                    </div>

                </div>
                <div class="row mt-2" style="margin-left:4px">

                    <div class="col-md-12">

                        <div>
                            <div id="gridContainerInvoicing" class="mt-2 gridContainer"></div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>


<script>

    function openModalInvoicing(){
        const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
    $('#dateInvoicing').val(today);
        searchFolioInvoicing();
        $('#modalInvoicing').modal('show');
    }
    function closeModalInvoicing(){
        $('#modalInvoicing').modal('hide');
    }

    function searchFolioInvoicing() {
        // Thu thập giá trị từ các trường input
        var folioNo = $('#folioNoInvoicing').val();
        var confirmationNo = $('#confirmationNoInvoicing').val();
        var room = $('#roomInvoicing').val();
        var name = $('#nameInvoicing').val();
        var guestStatus = $('#guestStatusInvoicing').val();
        var folioStatus = $('#folioStatusInvoicing').val();
        var folioType = $('#folioTyoeInvoicing').val(); 
        var isChecked = $('#checkBoxInvoicing').is(':checked');
        var date = isChecked ? $('#dateInvoicing').val() : ""; 

        // Chuẩn bị dữ liệu gửi lên API
        var data = {
            folioNo: folioNo,
            confirmationNo: confirmationNo,
            room: room,
            name: name,
            guestStatus: guestStatus,
            folioStatus: folioStatus,
            folioType: folioType,
            date: date 
        };

        $.ajax({
            url: '/Billing/SearchFolio',
            type: 'GET',
            dataType: 'json',
            data: data,
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                initializeDataGridInvoicing(result);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout(); // Hàm xử lý hết phiên
                } else {
                    alert("Đã xảy ra lỗi: " + xhr.responseText);
                }
            }
        });
    }
    function initializeDataGridInvoicing(data) {
         // Kiểm tra dữ liệu đầu vào

         // Nếu cần giới hạn tổng số bản ghi, ví dụ 100 bản ghi
         const limitedData = data.slice(0, 100);

         $("#gridContainerInvoicing").dxDataGrid({
             dataSource: limitedData, // Sử dụng dữ liệu đã giới hạn
             allowColumnResizing: true,
             columnAutoWidth: true,
             columnMinWidth: 90,
             paging: {
                 enabled: true, // Bật phân trang
                 pageSize: 15 // Mỗi trang 15 bản ghi
             },
             pager: {
                 visible: true,
                 allowedPageSizes: [15, 20, 30], // Chỉ các kích thước trang cố định
                 showPageSizeSelector: true,
                 showInfo: true, // Hiển thị thông tin phân trang
                 showNavigationButtons: true
             },
             scrolling: {
                 mode: 'standard', // Thay 'virtual' bằng 'standard' để kiểm tra
                 showScrollbar: 'always',
                 useNative: false
             },
             filterRow: {
                 visible: true,
                 applyFilter: "auto"
             },
             selection: {
                 mode: "single"
             },

         });
    }
        // Function to export invoicing data to Excel
    function exportInvoicing() {
        // Load required libraries dynamically
        const script1 = document.createElement('script');
        script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
        document.head.appendChild(script1);

        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
        document.head.appendChild(script2);

        script1.onload = function() {
            script2.onload = function() {
                // Get the DataGrid instance
                const dataGrid = $("#gridContainerInvoicing").dxDataGrid("instance");

                // Get the data source from the grid
                const dataSource = dataGrid.getDataSource();
                // Load all data from the current view (including filters)
                dataSource.load().done(function(data) {
                    if (!data || data.length === 0) {
                        alert("No data available to export.");
                        return;
                    }

                    // Create a new workbook and worksheet
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('Invoicing Data');

                    // Define columns for the worksheet (adjust based on your data structure)
                    worksheet.columns = [
                        { header: 'Reservation ID', key: 'reservationID', width: 15 },
                        { header: 'Confirmation No', key: 'confirmationNo', width: 15 },
                        { header: 'Arrival Date', key: 'arrivalDate', width: 15 },
                        { header: 'Departure Date', key: 'departureDate', width: 20 },
                        { header: 'Folio No', key: 'folioNo', width: 15 },
                        { header: 'Folio Date', key: 'folioDate', width: 15 },
                        { header: 'Folio Name', key: 'folioName', width: 15 },
                        { header: 'Win No', key: 'winNo', width: 15 },
                        { header: 'Balance VND', key: 'balanceVND', width: 15 },
                        { header: 'Is Passer By', key: 'isPasserBy', width: 15 },
                        { header: 'Ar No', key: 'arNo', width: 15 },
                        { header: 'Invoice No', key: 'invoiceNo', width: 15 },
                        { header: 'Count Transaction', key: 'countTransaction', width: 15 },
                        { header: 'Room No', key: 'roomNo', width: 15 },
                        { header: 'Status', key: 'status', width: 15 },
                        { header: 'Amount Before Tax', key: 'amountBeforeTax', width: 15 },
                        { header: 'Tax', key: 'tax', width: 15 },
                        { header: 'Amount After Tax', key: 'amountAfterTax', width: 15 },

                    ];

                    // Add rows to the worksheet
                    data.forEach(item => {
                        worksheet.addRow({
                            reservationID: item.ReservationID || '',
                            confirmationNo: item.ConfirmationNo || '',
                            arrivalDate: item.ArrivalDate || '',
                            departureDate: item.DepartureDate || '',
                            folioNo: item.FolioNo || '',
                            folioDate: item.FolioDate || '',
                            folioName: item.FolioName || '',
                            winNo: item.WinNo || '',
                            balanceVND: item.BalanceVND || '',
                            isPasserBy: item.IsPasserBy || '',
                            arNo: item.ArNo || '',
                            invoiceNo: item.InvoiceNo || '',
                            countTransaction: item.CountTransaction || 0,
                            roomNo: item.RoomNo || '',
                            status: item.Status || '',
                            amountBeforeTax: item.AmountBeforeTax || 0,
                            tax: item.Tax || 0,
                            amountAfterTax: item.AmountAfterTax || 0,

                        });
                    });

                    // Style the header row
                    worksheet.getRow(1).font = { bold: true };
                    worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

                    // Generate Excel file
                    workbook.xlsx.writeBuffer().then(function(buffer) {
                        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                        saveAs(blob, 'InvoicingData.xlsx');
                    });
                }).fail(function(error) {
                    alert("Error retrieving grid data: " + error);
                });
            };
        };
    }
</script>