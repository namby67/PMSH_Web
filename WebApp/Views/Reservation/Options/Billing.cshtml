
<style>

    .folio-container {

        padding: 0;
        overflow: hidden;
    }

    .folio-header {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #0055b8;
        color: white;
        text-align: center;
        padding: 8px;
        font-weight: 600;
        font-size: 16px;
    }

    .add-icon {
        margin-left: 8px;
        cursor: pointer;
    }

        .add-icon:hover {
        }

    .folio-list {
        list-style: none;
        padding: 8px;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .folio-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .folio-item {
        background-color: #f5f5f5;
        border: 1px solid #aaaaaa;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        cursor: pointer;
        width: 80px;
        text-align: center;
    }

        .folio-item:hover {
            background-color: #0055b8;
            border-color: #003087;
            color: white;
        }

        .folio-item.active {
            background-color: #0055b8;
            border-color: #003087;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

    .delete-icon {
        cursor: pointer;
        color: #333;
        font-size: 12px;
    }

        .delete-icon:hover {
            color: #ff0000;
        }

    .overlay-menu {
        position: absolute;
        right: 25px;
        top: 180px; /* Điều chỉnh để menu xuất hiện dưới tiêu đề */
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        z-index: 1000; /* Đảm bảo menu nằm trên bảng */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        width:200px
    }
</style>
<!-- Modal billimg-->
<div class="modal fade modal-xl" id="modalBilling" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabelBilling" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="border: 1px solid #bcbcbc">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabelBilling">Billing</h5>
                <button type="button" class="btn-close" onclick="closeModalBilling()"></button>
            </div>
            <div class="modal-body" style="padding:0;margin:0">
                @* <div class="mb-2">
                    <button class="mui-button mui-button-search" >Post</button>
                </div> *@
                <div class="functions-pane mb-2 row" style="background-color: var(--accent-color);border-radius: 8px; border: 1px solid #e5e7eb;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);padding:0px">
                    <div class="function-menu col-md-10">
                        <div class="dropdown">

                            <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">View</a>
                            <div class="dropdown-menu-custom">
                                <a href="#" onclick="openBilling0();">By Total</a>
                                <a href="#" onclick="openBilling1();">By Detail : Include Tax</a>
                                <a href="#" onclick="openBilling2();">By Detail : Not Include Tax</a>
                            </div>
                        </div>
                        <a href="#" onclick="openModalPosting();">Posting</a>
                        <a href="#" onclick="openModalEditPosting();">Edit</a>
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Preview && Print</a>
                            <div class="dropdown-menu-custom">
                                <a href="#" onclick="PrintAndPreview(1);">Style: Billing Information</a>
                                <a href="#" onclick="PrintAndPreview(2);">Style: Billing Information (selected transaction)</></a>
                            </div>
                        </div>
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Screen View</a>
                            <div class="dropdown-menu-custom">
                                <a href="#">Full</a>
                                <a href="#">Split</a>
                                <a href="#">Quad</a>

                            </div>
                        </div>

                        <a href="#" onclick="openModalPaymentBilling();">Payment</a>
                        <a href="#" onclick="openModalEditPosting();">Deposit</a>

                    </div>
                    <div class="function-menu col-md-2">

                        <a href="#" id="toggleFunctionMenu"><i class="fa-solid fa-sliders"></i>Show functions</a>

                    </div>
                </div>

                <div class="mui-card" >

                    <div class="col-md-12 row ">
    
                        <label class="form-label col-md-2">RSV Status: <i><span id="rsvStatusBilling"></span></i></label>
                        <label class="form-label col-md-2">Conf.No: <i><span id="conNoBilling"></span></i></label>
                        <label class="form-label col-md-2">Group: <i><span id="groupBilling"></span></i></label>
                        <label class="form-label col-md-2">Company: <i><span id="companyBilling"></span></i></label>
                        <label class="form-label col-md-2">Arrival: <i><span id="arivalBilling"></span></i></label>
                        <label class="form-label col-md-2">Departure: <i><span id="departureBilling"></span></i></label>
                        <label class="form-label col-md-2">Balance: <i><span id="balanceBilling"></span></i></label>
                        <label class="form-label col-md-2">Total: <i><span id="totalBilling"></span></i></label>
  
                    </div>
                </div>


                <div class="row mt-2" style="margin:0;justify-content:space-between">
                    <div class="folio-container col-md-1 mui-card">
                        <div class="folio-header">
                            <span>Folio No</span>
                            <i class="fas fa-plus add-icon" onclick="openModalNewWindow();"></i>
                        </div>
                        <ul id="listFolioNo" class="folio-list"></ul>
                    </div>
                    <div class="col-md-11" style="padding-left: 15px; ">
                        <div style="justify-content:space-between" class="row">
                            <div class="col-md-12 mui-card">
                                <span id="infoBillingName" style="font-size:18px;color:#0055b8">
                                </span>

                                <div style="display:flex">
                                    <span>Balance:</span>
                                    <label id="balanceBillingMaster"></label>
                                </div>
                                <!-- Thêm nút toggle -->
                            </div>
                            <!-- Menu chức năng với lớp overlay -->
                            <div class="function-menu col-md-2 overlay-menu mt-2" id="functionMenu" style="display: none;">
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Lock Folio</a>
                                    <div class="dropdown-menu-custom">
                                        <a href="#" onclick="LockFolioOnly(folioNoID);">Only One</a>
                                        <a href="#" onclick="LockFolio();">All Folio</a>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Unlock Folio</a>
                                    <div class="dropdown-menu-custom">
                                        <a href="#" onclick="UnLockFolioOnly(folioNoID);">Only One</a>
                                        <a href="#" onclick="UnLockFolio();">All Folio</a>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Posting History</a>
                                    <div class="dropdown-menu-custom">
                                        <a href="#" onclick="PostingHistory(1);">By Folio</a>
                                        <a href="#" onclick="PostingHistory(2);">By Invoice</a>
                                    </div>
                                </div>
                                <a href="#" onclick="openModalSplitTransaction();">Split Transaction</a>
                                <a href="#" onclick="adjustTransaction();">Adjust Transaction</a>
                                <a href="#" id="deleteTransactionBilling">Delete Transactions</a>
                                <a href="#" onclick="ExportExcelBilling();">Export to Excel</a>
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Transfer to Window</a>
                                    <div class="dropdown-menu-custom" id="listTransferToWindow"></div>
                                </div>
                                <a href="#" onclick="openModalTransferTransaction();">Transfer Transaction</a>
                                <a href="#" onclick="openModalSelectOption();">Option</a>
                            </div>
                        </div>
                        <div class="mui-card mt-2" >
                            <div id="gridContainerBilling" class="mt-2 gridContainer"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync("Billing/Posting")
@await Html.PartialAsync("Billing/Payment")
@await Html.PartialAsync("Billing/NewFolio")
@await Html.PartialAsync("Billing/PostingHistory")
@await Html.PartialAsync("Billing/ShiftLogin")
@await Html.PartialAsync("Billing/EditPosting")
@await Html.PartialAsync("Billing/SplitTransaction")
@await Html.PartialAsync("Billing/TransferTransaction")
@await Html.PartialAsync("Billing/AdjustTransaction")
@await Html.PartialAsync("Billing/SelectOption")

<script>
    $(document).ready(function() {
        // Gắn sự kiện cho nút toggle
        $("#toggleFunctionMenu").on("click", function() {
            $("#functionMenu").toggle();
        });
    });
    var folioPosting = 1;
    var transactionNoPost = "0";
    var totalAmountBilling = 0;

    function openBilling0(){

        searchFolioDetail(0);
    }
    function openBilling1(){
        searchFolioDetail(1);
    }
     function openBilling2(){
        searchFolioDetail(0);
    }
    function searchFolioDetail(type) {
        $.ajax({
            url: '/Reservation/GetFolioDetailByFolioID',
            type: 'get',
            dataType: 'json',
            data:{
                mode: type,
                folioNo: folioNoID
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                initializeDataGridBilling(result);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            }

        });
    }
    invoiceNoPosting = 0;
    var listFolioNoID = [];
    function getFolioNo() {
        $('#infoBillingName').text('[1]  ' +  lastname + '(' + idReservation + ')');

        $.ajax({
            url: '/Billing/GetFolioNo',
            type: 'get',
            dataType: 'json',
            data: {
                reservationID: idReservation,
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                listFolioNoID = [];
                $('#listFolioNo').empty();
                $('#listTransferToWindow').empty();
                var html = '';
                var htmlWindow = '';
                if(result.length > 0){
                    html = `<li class="folio-row">
                                ${result[0].status ? '<i class="fas fa-lock lock-icon"></i>' : ''}
                               <div class="folio-item active" onclick="filterByFolioNo(${result[0].id},0)">${result[0].folioNo}</div>
                               <i class="fas fa-trash delete-icon ${result[0].status ? 'disabled' : ''}" ${result[0].status ? '' : `onclick="deleteFolioNo(${result[0].id})"`}></i>
                            </li>`;
                    listFolioNoID.push(result[0].id);
                    for(var i = 0; i < result.length; i++){
                        htmlWindow += `<a href="#" onclick="transferToWindow(${result[i].id});">${i+1}</a>`;
                        if (i == 0) continue;
                        html += `<li class="folio-row">
                                ${result[i].status ? '<i class="fas fa-lock lock-icon"></i>' : ''}
                                <div class="folio-item" onclick="filterByFolioNo(${result[i].id},${i})">${result[i].folioNo}</div>
                                <i class="fas fa-trash delete-icon ${result[i].status ? 'disabled' : ''}" ${result[i].status ? '' : `onclick="deleteFolioNo(${result[i].id})"`}></i>
                             </li>`;
                        listFolioNoID.push(result[i].id);
                    }
                }
                $('#listFolioNo').append(html);
                $('#listTransferToWindow').append(htmlWindow);

                folioNoID = listFolioNoID[0];
                searchFolioDetail(0);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            }
        });
    }

    function getTotalAmount(data) {
        return data.reduce((total, item) => total + (parseFloat(item.amount) || 0), 0);
    }
    var folioDetailID = 0;
    var transCodeBilling = "";
    function initializeDataGridBilling(data) {
        totalAmountBilling = getTotalAmount(data);
        $('#balanceBillingMaster').text(totalAmountBilling.toLocaleString('en-US'));

        $("#gridContainerBilling").dxDataGrid({
            dataSource: data,
            keyExpr: "id",
            allowColumnResizing: true,
            columns: [
                {
                    type: "selection",
                    width: 50,
                    allowFiltering: false,
                    allowSorting: false,
                    headerCellTemplate: function() { return $("<div>"); }
                },
                { dataField: "id", caption: "ID", visible: false },
                { dataField: "date", caption: "Date" },
                { dataField: "code", caption: "Trans Code" },
                { dataField: "description", caption: "description" },
                { dataField: "invoiceNo", caption: "Inv .No" },
                { dataField: "amount", caption: "Amount" },
                { dataField: "supplement", caption: "Suplement" },
                { dataField: "reference", caption: "Reference" },
                { dataField: "userName", caption: "User" },
                { dataField: "time", caption: "Time" },
                { dataField: "groupCode", caption: "Group Code" },
                { dataField: "subgroupCode", caption: "Sub Group Code" },
                { dataField: "shiftID", caption: "Shift" },
                { dataField: "property", caption: "Property" },
                { dataField: "transactionNo", caption: "Trans .No" }
            ],
            paging: { pageSize: 15 },
            scrolling: {
                rowRenderingMode: 'virtual'
            },
            pager: {
                visible: true,
                allowedPageSizes: [15, 20, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            selection: {
                mode: "multiple",
                showCheckBoxesMode: "always"
            },
            onRowClick: function(e) {
                // Cập nhật thông tin giao dịch
                
                invoiceNoPosting = e.data.invoiceNo;
                folioDetailID = e.data.id;
                $("#transactionInfoSplit").text(e.data.code + ' - ' + e.data.description);
                $("#amountTtoalSplit").text(formatNumberBilling(e.data.amount.split('.')[0]));
                $("#valueSplitTransaction").val(formatNumberBilling(e.data.amount.split('.')[0]));
                if (e.data.amount == '0.00') {
                    $("#amountTtoalSplit").text('0');
                    $("#valueSplitTransaction").val('0');
                }
                // Hiển thị menu chức năng khi click vào dòng
                $("#functionMenu").show();
                // Chọn dòng được click
                const grid = $("#gridContainerBilling").dxDataGrid("instance");
                grid.selectRows([e.key], false);
            },
            onContentReady: function(e) {
                // Tìm các dòng có code trùng với selectedCodesFromResult
                const keysToSelect = data
                    .filter(item => selectedCodesFromResult.includes(item.code))
                    .map(item => item.id)
                    .filter(id => id !== undefined && id !== null);
                // Tích chọn các dòng có id tương ứng
                if (keysToSelect.length > 0) {
                    const grid = e.component;
                    grid.selectRows(keysToSelect, false);
                }
            }
        });


    }
    $("#deleteTransactionBilling").on("click", function() {
        console.log('check a');
        var grid = $("#gridContainerBilling").dxDataGrid("instance");

        var selectedRows = grid.getSelectedRowsData();

        var selectedIds = selectedRows.map(row => row.id);

        $.ajax({
            url: '/Billing/DeleteTransaction',
            type: 'POST',
            data: {folioDetailID :  selectedIds},
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    });
    function openModalBilling(){
        if(reservationStatus == 0 || reservationStatus == 3){
            showToast('Error', 'Booking status must not be Reservation or Cancel', false);
            return;
        }
        getInforServices();
        getFolioNo();
        // searchFolioDetail(0);
                // $('#infoBillingName').text('[1]  ' +  lastname + '(' + idReservation + ')');

        $('#staticBackdropLabelBilling').text('Billing [' + lastname + ' - ' + 'RoomNo: ' + roomNo + ']');
        $('#modalBilling').modal('show');
    }
    function closeModalBilling(){
        $('#modalBilling').modal('hide');
    }

    var groupTransaction = [];
    var subGroupTransaction = [];
    var transactionList = [];
    var articleList = [];
        var groupTransactionSelectOption = [];
    var subGroupTransactionSelectOption = [];
    var transactionListSelectOption = [];
    // hàm lấy transaction group, transaction sub group, transactions, articles
    function getInforServices(){
        $.ajax({
            url: '/Billing/GetInforService',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                groupTransaction = result.groupTransaction;
                subGroupTransaction = result.groupSubTransaction;
                transactionList = result.transactions;
                groupTransactionSelectOption = result.groupTransaction;
                subGroupTransactionSelectOption = result.groupSubTransaction;
                transactionListSelectOption = result.transactions;
                articleList = result.articles

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            }
        });
    }
    function filterByFolioNo(folioNo,i){
                        $('#infoBillingName').text('[' + (i + 1) + ']  ' +  lastname + '(' + idReservation + ')');

        folioNoID = folioNo;
        $('.folio-item').removeClass('active');
        // Add 'active' class to the clicked folio item
        $(`.folio-item[onclick="filterByFolioNo(${folioNo},${i})"]`).addClass('active');
        folioPosting = i + 1;
        searchFolioDetail(0);
    }
    function deleteFolioNo(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/DeleteFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }

    function LockFolioOnly(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/LockFolioOnly',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function LockFolio(){
        var formData = new FormData();
        formData.append('folioNo', listFolioNoID);
        $.ajax({
            url: '/Billing/LockFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function UnLockFolioOnly(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/UnLockFolioOnly',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function UnLockFolio(){
        var formData = new FormData();
        formData.append('folioNo', listFolioNoID);
        $.ajax({
            url: '/Billing/UnLockFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function ExportExcelBilling() {
        // Load required libraries dynamically
        const script1 = document.createElement('script');
        script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
        document.head.appendChild(script1);

        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
        document.head.appendChild(script2);

        script1.onload = function() {
            script2.onload = function() {
                // Get the DataGrid instance
                const dataGrid = $("#gridContainerBilling").dxDataGrid("instance");
                const data = dataGrid.option("dataSource");

                // Create a new workbook and worksheet
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Billing Data');

                // Define columns for the worksheet
                worksheet.columns = [
                    { header: 'Date', key: 'date', width: 15 },
                    { header: 'Account', key: 'code', width: 15 },
                    { header: 'Description', key: 'description', width: 30 },
                    { header: 'InvoiceNo', key: 'invoiceNo', width: 15 },
                    { header: 'Amount', key: 'amount', width: 15 },
                    { header: 'Supplement', key: 'supplement', width: 15 },
                    { header: 'Reference', key: 'reference', width: 15 },
                    { header: 'User', key: 'userName', width: 15 },
                    { header: 'Time', key: 'time', width: 15 },
                    { header: 'Group Code', key: 'groupCode', width: 15 },
                    { header: 'Sub Group Code', key: 'subgroupCode', width: 15 },
                    { header: 'Shift', key: 'shiftID', width: 15 },
                    { header: 'Property', key: 'property', width: 15 },
                    { header: 'Transaction No', key: 'transactionNo', width: 15 }
                ];

                // Add rows to the worksheet
                data.forEach(item => {
                    worksheet.addRow({
                        date: item.date,
                        code: item.code,
                        description: item.description,
                        invoiceNo: item.invoiceNo,
                        amount: item.amount,
                        supplement: item.supplement,
                        reference: item.reference,
                        userName: item.userName,
                        time: item.time,
                        groupCode: item.groupCode,
                        subgroupCode: item.subgroupCode,
                        shiftID: item.shiftID,
                        property: item.property,
                        transactionNo: item.transactionNo
                    });
                });

                // Style the header row
                worksheet.getRow(1).font = { bold: true };
                worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

                // Generate Excel file
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    saveAs(blob, 'BillingData.xlsx');
                });
            };
        };
    }

    function transferToWindow(folioID){
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        var grid = $("#gridContainerBilling").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();
        var selectedIds = selectedRows.map(row => row.id);
        $.ajax({
            url: '/Billing/TransferToWindow',
            type: 'POST',
            data: {
                userName: userName,
                userID:userID,
                folioDetailID: selectedIds,
                folioMasterID: folioNoID,
                folioID: folioID,
            },
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }


    function PrintAndPreview(type) {
        const grid = $("#gridContainerBilling").dxDataGrid("instance");
        let data;

        if (type === 1) {
            data = grid.option("dataSource");
        } else if (type === 2) {
            data = grid.getSelectedRowsData();
        }
        $.ajax({
            url: '/Billing/PrintBilling',
            type: 'POST',
            data:{
                arrivalDate:arivalDate.split(' ')[0],
                departureDate:departureDate.split(' ')[0],
                folioNo:folioNoID,
                confirmationNo:' ',
                roomNo: roomNo,
                dataBilling: data,
                customerName: lastname
            },
            success: function (data) {
                try {
                    // Nếu data có prefix, tách ra phần base64
                    let base64String = data;

                    // Nếu có tiền tố "data:application/pdf;base64," thì tách ra
                    if (base64String.startsWith('data:')) {
                        base64String = base64String.split(',')[1];
                    }

                    // Giải mã base64
                    const byteCharacters = atob(base64String);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });

                    // Tạo URL và mở trong cửa sổ mới
                    const blobUrl = URL.createObjectURL(blob);
                    window.open(blobUrl);
                } catch (e) {
                    console.error("Base64 decode error:", e);
                }
            },
            error: function (xhr, statusText, err) {
                console.error("AJAX error:", err);
            }
        });
    }

</script>