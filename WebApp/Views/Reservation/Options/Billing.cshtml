<link rel="stylesheet" href="~/css/pages/billing.css" asp-append-version="true" />

<div class="modal fade" id="modalBilling" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabelBilling" aria-hidden="true">
    <div class="modal-dialog modal-xl billing-module-dialog">
        <div class="modal-content billing-module">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabelBilling">Billing Information</h5>
            </div>

            <div class="modal-body">
                <div class="functions-pane">
                    <div class="function-menu flex-grow-1">
                        <div class="dropdown d-inline-block">
                            <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown"><i class="fa-solid fa-eye"></i> View</a>
                            <div class="dropdown-menu dropdown-menu-custom-rsv">
                                <a class="dropdown-item" href="#" onclick="openBilling0();">By Total</a>
                                <a class="dropdown-item" href="#" onclick="openBilling1();">By Detail : Include Tax</a>
                                <a class="dropdown-item" href="#" onclick="openBilling2();">By Detail : Not Include Tax</a>
                            </div>
                        </div>

                        <a href="#" onclick="openModalPosting();"><i class="fa-solid fa-calculator"></i> Posting</a>
                        <a href="#" onclick="openModalEditPosting();"><i class="fa-solid fa-pen-to-square"></i> Edit</a>

                        <div class="dropdown d-inline-block">
                            <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown"><i class="fa-solid fa-print"></i> Print</a>
                            <div class="dropdown-menu dropdown-menu-custom-rsv">
                                <a class="dropdown-item" href="#" onclick="PrintAndPreview(1);">Style: Billing Information</a>
                                <a class="dropdown-item" href="#" onclick="PrintAndPreview(2);">Style: Billing Information (Selection)</a>
                            </div>
                        </div>

                        <a href="#" onclick="openModalPaymentBilling();"><i class="fa-solid fa-money-bill-wave"></i> Payment</a>
                        <a href="#" onclick="openModalEditPosting();"><i class="fa-solid fa-piggy-bank"></i> Deposit</a>
                    </div>

                    <div class="function-menu ms-auto">
                        <a href="#" class="mui-button mui-button-option" id="toggleFunctionMenu"><i class="fa-solid fa-sliders"></i> Show Func.</a>
                        <a href="#" class="mui-button mui-button-close" data-bs-dismiss="modal" id="btn-close"><i class="fa-solid fa-xmark"></i> Close</a>
                    </div>
                </div>

                <div class="mui-card">
                    <div class="row g-2">
                        <div class="col-6 col-md-3"><div class="form-label">RSV Status: <span id="rsvStatusBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Conf.No: <span id="conNoBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Arrival: <span id="arivalBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Departure: <span id="departureBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Group: <span id="groupBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Company: <span id="companyBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Balance: <span id="balanceBilling"></span></div></div>
                        <div class="col-6 col-md-3"><div class="form-label">Total: <span id="totalBilling"></span></div></div>
                    </div>
                </div>

                <div class="billing-body-main">

                    <div class="folio-container">
                        <div class="folio-header">
                            <span>FOLIO</span>
                            <i class="fas fa-plus add-icon" title="Add New Folio" onclick="openModalNewWindow();"></i>
                        </div>
                        <ul id="listFolioNo" class="folio-list">
                        </ul>
                    </div>

                    <div class="grid-wrapper">
                        <div class="grid-header-info">
                            <span id="infoBillingName"><i class="fas fa-spinner fa-spin"></i> Loading...</span>
                            <div class="d-flex align-items-center">
                                <span class="me-2 text-muted" style="font-size:0.8rem; font-weight:600;">Folio Balance:</span>
                                <label id="balanceBillingMaster" class="text-danger fw-bold">0</label>
                            </div>
                        </div>

                        <div class="overlay-menu" id="functionMenu" style="display: none;">
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Lock Folio</a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="LockFolioOnly(folioNoID);">Only One</a>
                                    <a class="dropdown-item" href="#" onclick="LockFolio();">All Folio</a>
                                </div>
                            </div>
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Unlock Folio</a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="UnLockFolioOnly(folioNoID);">Only One</a>
                                    <a class="dropdown-item" href="#" onclick="UnLockFolio();">All Folio</a>
                                </div>
                            </div>
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Posting History</a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="PostingHistory(1);">By Folio</a>
                                    <a class="dropdown-item" href="#" onclick="PostingHistory(2);">By Invoice</a>
                                </div>
                            </div>
                            <a href="#" onclick="openModalSplitTransaction();">Split Transaction</a>
                            <a href="#" onclick="adjustTransaction();">Adjust Transaction</a>
                            <a href="#" id="deleteTransactionBilling" style="color:var(--danger-color);">Delete Transactions</a>
                            <a href="#" onclick="ExportExcelBilling();">Export to Excel</a>

                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">Transfer to Window</a>
                                <div class="dropdown-menu" id="listTransferToWindow"></div>
                            </div>
                            <a href="#" onclick="openModalTransferTransaction();">Transfer Transaction</a>
                            <a href="#" onclick="openModalSelectOption();">Options</a>
                        </div>

                        <div class="grid-body-container">
                            <div id="gridContainerBilling"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmDeleteTransaction" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content billing-module">
            <div class="modal-header">
                <h5 class="modal-title">Deletion Reason</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Reason</label>
                    <select id="codeDeletionReason" class="form-select form-select-sm"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control form-control-sm" id="descriptionDeletionReason" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button class="mui-button mui-button-option border" onclick="closeModalConfirmTransaction();"><i class="fa-solid fa-xmark"></i> Close</button>
                    <button class="mui-button mui-button-delete border" onclick="confirmDelete();"><i class="fa-solid fa-trash-can"></i>Confirm Delete</button>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("Billing/Posting")
@await Html.PartialAsync("Billing/Payment")
@await Html.PartialAsync("Billing/NewFolio")
@await Html.PartialAsync("Billing/PostingHistory")
@await Html.PartialAsync("Billing/ShiftLogin")
@await Html.PartialAsync("Billing/EditPosting")
@await Html.PartialAsync("Billing/SplitTransaction")
@await Html.PartialAsync("Billing/TransferTransaction")
@await Html.PartialAsync("Billing/AdjustTransaction")
@await Html.PartialAsync("Billing/SelectOption")

<script>
    $(document).ready(function() {
        // Toggle Option Menu
        $("#toggleFunctionMenu").on("click", function(e) {
            e.stopPropagation(); // Ngăn sự kiện click lan ra ngoài
            $("#functionMenu").toggle();
        });

        // Ẩn menu khi click ra ngoài
        $(document).on("click", function(e) {
            if (!$(e.target).closest("#toggleFunctionMenu, #functionMenu").length) {
                $("#functionMenu").hide();
            }
        });

        getDeletionReason();
    });

    var folioPosting = 1;
    var transactionNoPost = "0";
    var totalAmountBilling = 0;
    var invoiceNoPosting = 0;
    var listFolioNoID = [];
    var folioNoID = 0; 

    function openBilling0(){ searchFolioDetail(0); }
    function openBilling1(){ searchFolioDetail(1); }
    function openBilling2(){ searchFolioDetail(0); }
    function searchFolioDetail(type) {
         var $gridElement = $("#gridContainerBilling");

        if ($gridElement.length > 0 && $gridElement.data("dxDataGrid")) {
            // Chỉ clear data khi Grid ĐÃ tồn tại
            $gridElement.dxDataGrid("instance").option("dataSource", []);
        }
         $.ajax({
             url: '/Reservation/GetFolioDetailByFolioID',
             type: 'get',
             dataType: 'json',
             data:{
                 mode: type,
                 folioNo: folioNoID
             },
             crossDomain: false,
             headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
             success: function (result) {
                 initializeDataGridBilling(result);
             },
             error: function (xhr, statusText, err) {
                 if (xhr.status == 401) sessionTimeout();
             }
         });
     }
    invoiceNoPosting = 0;
    var listFolioNoID = [];
    function getFolioNo() {
        if(typeof lastname !== 'undefined' && typeof idReservation !== 'undefined'){
             if(folioNoID === 0) {
                 $('#infoBillingName').text('[1]  ' +  lastname + '(' + idReservation + ')');
             }
        }

        $.ajax({
            url: '/Billing/GetFolioNo',
            type: 'get',
            dataType: 'json',
            data: { reservationID: idReservation },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                console.log(result);
                listFolioNoID = [];
                $('#listFolioNo').empty();
                $('#listTransferToWindow').empty();

                var html = '';
                var htmlWindow = '';

                var isCurrentFolioFound = false;
                var foundIndex = 0;
                var needInitialLoad = false; 

                if(result.length > 0){
                    for(var i = 0; i < result.length; i++){
                        listFolioNoID.push(result[i].id);

                        htmlWindow += `<a class="dropdown-item" href="#" onclick="transferToWindow(${result[i].id});">Window ${i+1}</a>`;

                        var activeClass = '';

                        if (folioNoID !== 0 && folioNoID === result[i].id) {
                            activeClass = 'active';
                            isCurrentFolioFound = true;
                            foundIndex = i;
                        }
                        else if (folioNoID === 0 && i === 0) {
                            activeClass = 'active';
                            isCurrentFolioFound = true;
                            folioNoID = result[i].id;
                            foundIndex = 0;
                            needInitialLoad = true;  
                        }

                        var lockIcon = result[i].status ? '<i class="fas fa-lock lock-icon"></i>' : '';
                        var deleteClass = result[i].status ? 'disabled' : '';
                        var deleteAction = result[i].status ? '' : `onclick="deleteFolioNo(${result[i].id}); event.stopPropagation();"`;

                        html += `
                        <li class="folio-row">
                            <div class="folio-item ${activeClass}" onclick="filterByFolioNo(${result[i].id}, ${i}, this)">
                                ${result[i].folioNo}
                            </div>
                            ${lockIcon}
                            <i class="fas fa-times delete-icon ${deleteClass}"
                               ${deleteAction}
                               title="Delete">
                            </i>
                        </li>`;
                    }
                }

                $('#listFolioNo').append(html);
                $('#listTransferToWindow').append(htmlWindow);

                if (result.length > 0) {
                    if (!isCurrentFolioFound) {
                        folioNoID = listFolioNoID[0];
                        setTimeout(function(){
                            $('#listFolioNo .folio-item').first().addClass('active');
                            filterByFolioNo(folioNoID, 0);
                        }, 50);
                    }
                    else if (needInitialLoad) {
                        filterByFolioNo(folioNoID, 0);
                    }
                    else {
                        if(typeof lastname !== 'undefined'){
                            $('#infoBillingName').text('[' + (foundIndex + 1) + ']  ' +  lastname + '(' + idReservation + ')');
                        }

                        searchFolioDetail(0);
                    }
                }
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) sessionTimeout();
            }
        });
    }

    function filterByFolioNo(folioNo, index, element){
        $('.folio-item').removeClass('active');

        if (element) {
            // Người dùng Click trực tiếp -> Dùng 'this'
            $(element).addClass('active');
        } else {
            // Gọi tự động bằng code -> Dùng Index
            $('#listFolioNo .folio-row').eq(index).find('.folio-item').addClass('active');
        }

        if(typeof lastname !== 'undefined' && typeof idReservation !== 'undefined'){
            $('#infoBillingName').text('[' + (index + 1) + ']  ' +  lastname + '(' + idReservation + ')');
        }

        folioNoID = folioNo;
        folioPosting = index + 1;
        searchFolioDetail(0);
    }
    function getTotalAmount(data) {
        return data.reduce((total, item) => total + (parseFloat(item.amount) || 0), 0);
    }
    var folioDetailID = 0;
    var transCodeBilling = "";
    function initializeDataGridBilling(data) {
        totalAmountBilling = getTotalAmount(data);
        $('#balanceBillingMaster').text(totalAmountBilling.toLocaleString('vi-VN'));

        $("#gridContainerBilling").dxDataGrid({
            dataSource: data,
            keyExpr: "id",
            height: '100%',
            columnAutoWidth: false,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            columnHidingEnabled: true,
            scrolling: {
                mode: "standard",
                showScrollbar: "always"
            },
            showRowLines: true,
            rowAlternationEnabled: true,
            hoverStateEnabled: true,
            paging: { pageSize: 20 },
            pager: {
                visible: true,
                allowedPageSizes: [20, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            columns: [
                {
                    type: "selection",
                    width: "3%", 
                    fixed: true,
                    allowResizing: false
                },
                { dataField: "id", visible: false },

                {
                    dataField: 'date',
                    caption: 'Date',
                    width: "7%",
                    dataType: 'date',
                    format: 'dd/MM/yyyy',
                    hidingPriority: 5
                },
                {
                    dataField: "code",
                    caption: "Code",
                    width: "5%",
                    hidingPriority: 4
                },
                {
                    dataField: "description",
                    caption: "Description",
                    width: "26%",
                    cellTemplate: function(container, options) {
                        $("<div>")
                            .addClass("text-truncate")
                            .attr("title", options.value)
                            .css("font-weight", "600")
                            .text(options.value)
                            .appendTo(container);
                    }
                },

                {
                    dataField: "invoiceNo",
                    caption: "Inv.No",
                    width: "6%"
                },
                {
                    dataField: "amount",
                    caption: "Amount",
                    width: "8%",
                    dataType: "number",
                    cssClass: "text-danger fw-bold",
                    format: { type: "fixedPoint", precision: 0 },
                    hidingPriority: 10
                },
                { dataField: "supplement", caption: "Supplement", width: "7%" },
                { dataField: "reference", caption: "Reference", width: "7%" },

                { dataField: "userName", caption: "User", width: "5%"},
                { dataField: "time", caption: "Time", width: "5%"},

                {
                    dataField: "groupCode",
                    caption: "Group",
                    width: "5%",
                    hidingPriority: 0
                },
                {
                    dataField: "subgroupCode",
                    caption: "Sub",
                    width: "6%",
                    hidingPriority: 1
                },
                {
                    dataField: "shiftID",
                    caption: "Shift",
                    width: "5%",
                    hidingPriority: 2
                },

                {
                    dataField: "transactionNo",
                    caption: "Trn.No",
                    width: "5%",
                    hidingPriority: 3
                }
            ],
            filterRow: { visible: true, applyFilter: "auto" },
            selection: { mode: "multiple", showCheckBoxesMode: "always" },
            onRowClick: function(e) {
                invoiceNoPosting = e.data.invoiceNo;
            },
            onContentReady: function(e) {
                if (typeof selectedCodesFromResult !== 'undefined' && data) {
                    const keysToSelect = data.filter(item => selectedCodesFromResult.includes(item.code)).map(item => item.id);
                    if (keysToSelect.length > 0) e.component.selectRows(keysToSelect, false);
                }
            }
        });
    }

    function clearSelectedRowsBilling() {
        const grid = $("#gridContainerBilling").dxDataGrid("instance");
        if (grid) {
            grid.deselectAll();  // Bỏ chọn tất cả các hàng
            // Optional: Cập nhật lại UI hoặc biến nếu cần
            // Ví dụ: Reset các biến liên quan đến lựa chọn
            invoiceNoPosting = null;
            folioDetailID = null;
            $("#transactionInfoSplit").text('');
            $("#functionMenu").hide();
        }
    }

    $("#deleteTransactionBilling").on("click", function() {
        var grid = $("#gridContainerBilling").dxDataGrid("instance");

        var selectedRows = grid.getSelectedRowsData();

        var selectedIds = selectedRows.map(row => row.id);
        if(selectedIds.length == 0){
            showToast('Error', "Please choose at least 1 Transaction", false);
            return;
         }
        localStorage.setItem("currentFromID", "modalConfirmDeleteTransaction");
        const crashierLogin = localStorage.getItem("crashierLogin");
        if(crashierLogin == "NotYet"){
            openModalShilftLogin();
        }
        else{
            openModalConfirmTransaction();
        }

    });

    function confirmDelete(){
        var grid = $("#gridContainerBilling").dxDataGrid("instance");

        var selectedRows = grid.getSelectedRowsData();

        var selectedIds = selectedRows.map(row => row.id);
        if($('#codeDeletionReason').val() == ""){
            showToast('Error', "Please choose Reason", false);
            return;
        }
        $.ajax({
            url: '/Billing/DeleteTransaction',
            type: 'POST',
            data: {
                folioDetailID :  selectedIds,
                reasonCode: $('#codeDeletionReason').val(),
                reasonText: $('#descriptionDeletionReason').val(),
            },
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    closeModalConfirmTransaction();
                    showToast('Success', data.msg, true);
                     GetBalanceVND(idReservation);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }

    function openModalBilling(){
        if(reservationStatus == 0 || reservationStatus == 3){
            showToast('Error', 'Booking status must not be Reservation or Cancel', false);
            return;
        }
        getInforServices();
        getFolioNo();
        // searchFolioDetail(0);
                // $('#infoBillingName').text('[1]  ' +  lastname + '(' + idReservation + ')');

        $('#staticBackdropLabelBilling').text('Billing [' + lastname + ' - ' + 'RoomNo: ' + roomNo + ']');
        $('#modalBilling').modal('show');
    }

    function closeModalBilling(){
        $('#modalBilling').modal('hide');
    }

    var groupTransaction = [];
    var subGroupTransaction = [];
    var transactionList = [];
    var articleList = [];
        var groupTransactionSelectOption = [];
    var subGroupTransactionSelectOption = [];
    var transactionListSelectOption = [];
    // hàm lấy transaction group, transaction sub group, transactions, articles
    function getInforServices(){
        $.ajax({
            url: '/Billing/GetInforService',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                groupTransaction = result.groupTransaction;
                subGroupTransaction = result.groupSubTransaction;
                transactionList = result.transactions;
                groupTransactionSelectOption = result.groupTransaction;
                subGroupTransactionSelectOption = result.groupSubTransaction;
                transactionListSelectOption = result.transactions;
                articleList = result.articles

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            }
        });
    }
    function deleteFolioNo(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/DeleteFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }

    function LockFolioOnly(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/LockFolioOnly',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function LockFolio(){
        var formData = new FormData();
        formData.append('folioNo', listFolioNoID);
        $.ajax({
            url: '/Billing/LockFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function UnLockFolioOnly(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/UnLockFolioOnly',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function UnLockFolio(){
        var formData = new FormData();
        formData.append('folioNo', listFolioNoID);
        $.ajax({
            url: '/Billing/UnLockFolio',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    // searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }
    function ExportExcelBilling() {
        // Load required libraries dynamically
        const script1 = document.createElement('script');
        script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
        document.head.appendChild(script1);

        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
        document.head.appendChild(script2);

        script1.onload = function() {
            script2.onload = function() {
                // Get the DataGrid instance
                const dataGrid = $("#gridContainerBilling").dxDataGrid("instance");
                const data = dataGrid.option("dataSource");

                // Create a new workbook and worksheet
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Billing Data');

                // Define columns for the worksheet
                worksheet.columns = [
                    { header: 'Date', key: 'date', width: 15 },
                    { header: 'Account', key: 'code', width: 15 },
                    { header: 'Description', key: 'description', width: 30 },
                    { header: 'InvoiceNo', key: 'invoiceNo', width: 15 },
                    { header: 'Amount', key: 'amount', width: 15 },
                    { header: 'Supplement', key: 'supplement', width: 15 },
                    { header: 'Reference', key: 'reference', width: 15 },
                    { header: 'User', key: 'userName', width: 15 },
                    { header: 'Time', key: 'time', width: 15 },
                    { header: 'Group Code', key: 'groupCode', width: 15 },
                    { header: 'Sub Group Code', key: 'subgroupCode', width: 15 },
                    { header: 'Shift', key: 'shiftID', width: 15 },
                    { header: 'Property', key: 'property', width: 15 },
                    { header: 'Transaction No', key: 'transactionNo', width: 15 }
                ];

                // Add rows to the worksheet
                data.forEach(item => {
                    worksheet.addRow({
                        date: item.date,
                        code: item.code,
                        description: item.description,
                        invoiceNo: item.invoiceNo,
                        amount: item.amount,
                        supplement: item.supplement,
                        reference: item.reference,
                        userName: item.userName,
                        time: item.time,
                        groupCode: item.groupCode,
                        subgroupCode: item.subgroupCode,
                        shiftID: item.shiftID,
                        property: item.property,
                        transactionNo: item.transactionNo
                    });
                });

                // Style the header row
                worksheet.getRow(1).font = { bold: true };
                worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

                // Generate Excel file
                workbook.xlsx.writeBuffer().then(function(buffer) {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    saveAs(blob, 'BillingData.xlsx');
                });
            };
        };
    }

    function transferToWindow(folioID){
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        var grid = $("#gridContainerBilling").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();

        // 🔴 BẮT BUỘC chọn đúng 1 dòng
        if (selectedRows.length !== 1) {
            showToast('Error', 'Please select exactly one row to transfer', false);
            return;
        }
        var selectedIds = selectedRows.map(row => row.id);
        $.ajax({
            url: '/Billing/TransferToWindow',
            type: 'POST',
            data: {
                userName: userName,
                userID:userID,
                folioDetailID: selectedIds,
                folioMasterID: folioNoID,
                folioID: folioID,
            },
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo();
                    showToast('Success', data.msg, true);
                   GetBalanceVND(idReservation);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }

    function PrintAndPreview(type) {
        const grid = $("#gridContainerBilling").dxDataGrid("instance");
        let data;

        if (type === 1) {
            data = grid.option("dataSource");
        } else if (type === 2) {
            data = grid.getSelectedRowsData();
        }
        $.ajax({
            url: '/Billing/PrintBilling',
            type: 'POST',
            data:{
                arrivalDate:arivalDate.split(' ')[0],
                departureDate:departureDate.split(' ')[0],
                folioNo:folioNoID,
                confirmationNo: confirmationNo,
                roomNo: roomNo,
                dataBilling: data,
                customerName: lastname
            },
            success: function (data) {
                try {
                    // Nếu data có prefix, tách ra phần base64
                    let base64String = data;

                    // Nếu có tiền tố "data:application/pdf;base64," thì tách ra
                    if (base64String.startsWith('data:')) {
                        base64String = base64String.split(',')[1];
                    }

                    // Giải mã base64
                    const byteCharacters = atob(base64String);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });

                    // Tạo URL và mở trong cửa sổ mới
                    const blobUrl = URL.createObjectURL(blob);
                    window.open(blobUrl);
                } catch (e) {
                    console.error("Base64 decode error:", e);
                }
            },
            error: function (xhr, statusText, err) {
                console.error("AJAX error:", err);
            }
        });
    }

    function openModalConfirmTransaction(){
        $('#modalConfirmDeleteTransaction').modal('show');
    }
    function closeModalConfirmTransaction(){
        $('#codeDeletionReason').val("");
        $('#descriptionDeletionReason').val("");

        $('#modalConfirmDeleteTransaction').modal('hide');

    }
    function getDeletionReason(){
        $.ajax({
            url: '/Billing/GetDeletionReason',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                var html = '<option value="">Please choose reason</option>';
                if(result.length > 0){
                    for(var i = 0;i < result.length;i++){
                        html += `<option value='${result[i].code}'>${result[i].code}</option>`;
                    }
                }
                $('#codeDeletionReason').empty();
                $('#codeDeletionReason').html(html);

            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                }
            }
        });
    }
    $('#codeDeletionReason').change(function() {
        getDeletionReasonByCode();
    });
    function getDeletionReasonByCode(){
        if($('#codeDeletionReason').val() != ""){
            $.ajax({
                url: '/Billing/GetDeletionReasonByCode',
                type: 'get',
                data:{
                    code: $('#codeDeletionReason').val()
                },
                dataType: 'json',
                crossDomain: false,
                headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    $('#descriptionDeletionReason').val(result.description);

                },
                error: function (xhr, statusText, err) {
                    if (xhr.status == 401) {
                        sessionTimeout();
                    } else {
                    }
                }
            });
        }
    }
    
    function deleteFolioNo(folioID){
        var formData = new FormData();
        formData.append('folioNo', folioID);
        $.ajax({
            url: '/Billing/DeleteFolio', type: 'POST', processData: false, contentType: false, data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getFolioNo(); // Load lại danh sách
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            }
        });
    }
</script>
