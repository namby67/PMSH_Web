
<div class="modal fade modal-xl" id="modalAccompanying" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Accompanying</h5>
                <button type="button" class="btn-close" onclick="closeModalAccompanying()"></button>
            </div>
            <div class="modal-body">
                <div class="">
                    <button class="submit-button-clear-reservation" id="attach" onclick="AttachAccompanying();"> Attach</button>
                    <button class="submit-button-clear-reservation" id="detach" onclick="detach()">Detach</button>
                    <button class="submit-button-clear-reservation" id="detach" onclick="openModalViewProfile()">Profile</button>

                    <button class="submit-button-clear-reservation" onclick="closeModalAccompanying();"> Close</button>
                </div>
                <div class="form-group-new-reservation col-md-6 mt-2">
                    <div class="row" style="margin-left:1px;margin-right:2px">
                        <input id="txtNameAccompanying" readonly style="display:none" />
                        <input id="txtNameAccompanyingText" readonly class="col-md-8" />
                        <button onclick="openModalSearchProfileAccompany()" class="col-md-2"><i class="fa-solid fa-arrow-down"></i></button>
                        <div class="col-md-1" style="justify-content:center;text-align:center;color:red;" id="clearProfileAccompanying" onclick="clearProfileAccompanying()">
                            <i class="fa-solid fa-xmark" style="padding-top:6px"></i>
                        </div>
                    </div>

                </div>

                <div class="mui-card mt-2">
                    <div id="gridContainerAccompanying" class="mt-2 gridContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal search profile-->
<div class="modal fade modal-xl" id="modalProfileAccompany" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Search Profile</h5>
                <button type="button" class="btn-close" onclick="closeModalSearchProfleAccompany()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2" style="margin-top:0px">
                    <button class="submit-button-clear-reservation" onclick="getAllProfilesAccompany(3);"><i class="fas fa-search"></i> Search</button>
                </div>
                <div class="row mui-card mb-2 mx-1">
                    <div class="col-md-2 mb-2">
                        <label for="input1">Full Name</label>
                        <input type="text" id="nameProfileSearchAccompany" placeholder="Enter name">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input2">First Name</label>
                        <input type="text" id="firstNameProfileSearchAccompany" placeholder="Enter first name">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input3">View By</label>
                        <select type="text" id="viewByProfileSearchAccompany" disabled style="line-height:1.28">
                            <option selected value="3">Individual</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input4">City</label>
                        <select type="text" id="cityProfileSearchAccompany" placeholder="Enter value" asp-items="ViewBag.cboCity" style="line-height:1.28"></select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input5">Key word</label>
                        <input type="text" id="keywordProfileSearchAccompany" placeholder="Enter value">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input6">Code</label>
                        <input type="text" id="codeProfileSearchAccompany" placeholder="Enter value">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="input4">Property</label>
                        <select type="text" id="propertyProfileSearchAccompany" disabled style="line-height:1.28">
                            <option selected>PMSh TheArena</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label>Sale in charge</label>
                        <div>
                            <input type="checkbox" id="saleAccompany" name="myCheckbox">
                        </div>
                    </div>
                </div>

                <div class="mui-card">
                    <div id="gridContainerSearchProfileAccompany" class="mt-2 gridContainer"></div>
                </div>
            </div>

        </div>
    </div>
</div>
<script>

    function openModalAccompanying(){
        if (idReservation === 0) {
            showToast('Error', 'Please choose booking', false);
            return;
        }
         $('#clearProfileAccompanying').hide();
         getInfoByProfileIDAccompanying(idReservation);
         $('#modalAccompanying').modal('show');
    }
    function closeModalAccompanying(){
        clearProfileAccompanying();
        $('#clearProfileAccompanying').hide();
         $('#modalAccompanying').modal('hide');
    }

   function getInfoByProfileIDAccompanying(id) {
        $.ajax({
            url: '/Reservation/GetReservationAccompanyingByReservationID',
            type: 'get',
            dataType: 'json',
            data: {
                reservationID: id
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                initializeDataGridAccompanying(result);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }
    var profileID = 0;
    function detach(){
        $.ajax({
            url: '/Reservation/DettachAccompanying',
            type: 'POST',
            // headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: {id:profileID},
            success: function (data) {
                if (data.code == 0) {
                    getInfoByProfileIDAccompanying(idReservation);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }

            },
            error: function (xhr, statusText, err) {

            }
        });

    }

    function AttachAccompanying() {
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        var formData = new FormData();
        formData.append('rsvID', idReservation);
        formData.append('profileAgentID', $('#txtNameAccompanying').val());
        formData.append('userName', userName);
        formData.append('userID', userID);
        $.ajax({
            url: '/Reservation/AttachAccompanying',
            type: 'POST',
            processData: false,
            contentType: false,
            // headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    getInfoByProfileIDAccompanying(idReservation);

                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }

            },
            error: function (xhr, statusText, err) {

            }
        });

    }

    function initializeDataGridAccompanying(data) {

        $("#gridContainerAccompanying").dxDataGrid({

        dataSource: data, allowColumnResizing: true,
            columns: [


                { dataField: "ID", caption: "ID",  visible: false},
                { dataField: "ProfileID", caption: "ProfileID",  visible: false},

                { dataField: "Account", caption: "Name"  },
                { dataField: "City", caption: "City"},
                { dataField: "DateOfBirth", caption: "Birthday"},
            ],
            paging: { pageSize: 15 },
            scrolling: {
                rowRenderingMode: 'virtual',
            },
            pager: {
                visible: true,
                allowedPageSizes: [15, 20, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true,
            },
            filterRow: {
                    visible: true,
                    applyFilter: "auto"
            },
            selection: {
                mode: "single" // Allows only one row to be selected at a time
            },
            onRowClick: function(e) {
                profileID = e.data.ProfileID;
                                 console.log(profileID);

                $('#detach').show();
            }
        });
    }

     function openModalSearchProfileAccompany(){
          getAllProfilesAccompany(3);
          $('#modalProfileAccompany').modal('show');
     }
     function closeModalSearchProfleAccompany(){
          $('#nameProfileSearchAccompany').val('');
          $('#firstNameProfileSearchAccompany').val('');
          $('#cityProfileSearchAccompany').val(0);

        $('#modalProfileAccompany').modal('hide');

     }
     function getAllProfilesAccompany(type) {
         $('#viewByProfileSearch').val(type || 3); // Đặt giá trị mặc định nếu không có type
          initializeDataGridSearchProfileAccompany();
     }

     function initializeDataGridSearchProfileAccompany() {
          $("#gridContainerSearchProfileAccompany").dxDataGrid({
             dataSource: {
                 load: function (loadOptions) {
                     var d = $.Deferred();
                     var params = {
                          code: $('#codeProfileSearchAccompany').val(),
                          account: $('#nameProfileSearchAccompany').val(),
                          firstName: $('#firstNameProfileSearchAccompany').val(),
                          keyWord: $('#keywordProfileSearchAccompany').val(),
                          city: $('#cityProfileSearchAccompany').val(),
                          type: $('#viewByProfileSearchAccompany').val(),
                          showSaleInCharge: $("#saleAccompany").is(":checked"),
                         page: loadOptions.skip / loadOptions.take + 1, // Tính số trang
                         pageSize: loadOptions.take // Kích thước trang
                     };

                     $.ajax({
                         url: '/Profile/GetAllProfiles2',
                         type: 'GET',
                         dataType: 'json',
                         data: params,
                         headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                         success: function (result) {
                             d.resolve(result.data, {
                                 totalCount: result.totalCount // Tổng số bản ghi
                             });
                         },
                         error: function (xhr, statusText, err) {
                             if (xhr.status == 401) {
                                 sessionTimeout();
                             } else {
                                 informBox(TOAST_STATUS.DANGER, "Lỗi tải chi tiết danh sách danh mục dịch vụ hoặc bạn không có quyền tải");
                                 d.reject();
                             }
                         },
                         complete: function () {
                         }
                     });
                     return d.promise();
                 }
             },
             remoteOperations: {
                 paging: true,
                 filtering: true
             },
             columns: [
                 { dataField: "id", caption: "ID", width: 70, visible: false },
                 { dataField: "code", caption: "Code", width: 70 },
                 { dataField: "account", caption: "Account", width: 300 },
                 { dataField: "taxCode", caption: "Tax Code", width: 150 },
                 { dataField: "city", caption: "City", width: 150 },
                 { dataField: "nationality", caption: "Nat", width: 150 },
                 { dataField: "address", caption: "Address", width: 150 },
                 { dataField: "homeAddress", caption: "Business Address", width: 150 },
                 { dataField: "company", caption: "Company", width: 150 },
                 { dataField: "handPhone", caption: "HandPhone", width: 150 },
                 { dataField: "telephone", caption: "Telephone", width: 150 },
                 { dataField: "email", caption: "Email", width: 150 },
                 { dataField: "website", caption: "Website", width: 150 },
                 { dataField: "aRNo", caption: "ARNo", width: 150 },
                 { dataField: "postalCode", caption: "Postal Code", width: 150 },
                 { dataField: "keyword", caption: "Keyword", width: 150 },
                 { dataField: "description", caption: "Description", width: 150 },
                 { dataField: "personInChargeID", caption: "Sale In Charge", width: 150 },
             ],
             paging: { pageSize: 15 },
             pager: {
                 visible: true,
                 allowedPageSizes: [15, 20, 'all'],
                 showPageSizeSelector: true,
                 showInfo: true,
                 showNavigationButtons: true,
             },
             filterRow: {
                 visible: true,
                 applyFilter: "auto"
             },
             selection: {
                 mode: "single"
             },
             onRowDblClick: function (e) {
                 // getInfoByProfileID(e.data.id);
                 // $('#modalProfile').modal('hide');
                $('#modalProfileAccompany').modal('hide');
                $('#clearProfileAccompanying').show();
                 $('#txtNameAccompanying').val(e.data.id);
                $('#txtNameAccompanyingText').val(e.data.account);

                 console.log(e.data);
             }
         });
     }
     function clearProfileAccompanying(){
        $('#txtNameAccompanying').val('');
        $('#txtNameAccompanyingText').val('');
        $('#clearProfileAccompanying').hide();
    $('#nameProfileSearchAccompany').val('');
              $('#firstNameProfileSearchAccompany').val('');
              $('#cityProfileSearchAccompany').val(0);
     }
</script>