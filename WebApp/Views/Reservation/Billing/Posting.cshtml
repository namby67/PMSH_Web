<link href="~/css/pages/Posting.css" rel="stylesheet" />

<div class="modal fade" id="modalPosting" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <strong class="modal-title" style="font-size: 1rem;">Posting Transaction - Article</strong>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="main-toolbar d-flex">
                        @* <button class="mui-button mui-button-export me-1" id="btn-print"><i class="fa-solid fa-print"></i><span> Print</span></button> *@
                        <button class="mui-button mui-button-save me-1" id="btn-post" onclick="PostingService();"><i class="fa-solid fa-save"></i><span> Post</span></button>
                        <button class="mui-button mui-button-new me-1" id="btn-add" style="display: none"><i class="fa-solid fa-plus"></i><span>Add</span></button>
                        <button class="mui-button mui-button-close me-1" data-bs-dismiss="modal" id="btn-close"><i class="fa-solid fa-xmark"></i><span> Close</span></button>
                    </div>

                    <div class="mobile-nav">
                        <button onclick="switchView('group')" id="nav-group">1. Group Trans.</button>
                        <button onclick="switchView('trans')" id="nav-trans">2. List Trans.</button>
                        <button onclick="switchView('form')" id="nav-form" class="active">3. Posting (F2/F3)</button>
                    </div>

                    <div class="container-fluid main-content">
                        <div class="row g-1 h-100">
                            <div class="col-md-3 h-100" id="view-group">
                                <div class="split-column">
                                    <div class="split-item"><div class="app-header">Group Transaction</div>
                                        <div class="p-1 border-bottom bg-light">
                                            <input type="text" class="form-control form-control-sm js-search-box" data-target="#list-group-container" placeholder="Search Group..." />
                                        </div>
                                    <div class="scroll-area list-group list-group-flush" id="list-group-container"></div></div>
                                    <div class="split-item"><div class="app-header">Subgroup Transaction</div>
                                        <div class="p-1 border-bottom bg-light">
                                            <input type="text" class="form-control form-control-sm js-search-box" data-target="#list-subgroup-container" placeholder="Search Subgroup..." />
                                        </div>
                                    <div class="scroll-area list-group list-group-flush" id="list-subgroup-container"></div></div>
                                </div>
                            </div>
                            <div class="col-md-3 h-100" id="view-trans">
                                <div class="split-column">
                                    <div class="split-item"><div class="app-header">Transaction List</div>
                                        <div class="p-1 border-bottom bg-light">
                                            <input type="text" class="form-control form-control-sm js-search-box" data-target="#list-transaction-container" placeholder="Search Trans..." />
                                        </div>
                                    <div class="scroll-area list-group list-group-flush" id="list-transaction-container"></div></div>
                                    <div class="split-item"><div class="app-header">Article List</div>
                                        <div class="p-1 border-bottom bg-light">
                                            <input type="text" class="form-control form-control-sm js-search-box" data-target="#list-article-container" placeholder="Search Article..." />
                                        </div>
                                    <div class="scroll-area list-group list-group-flush" id="list-article-container"></div></div>
                                </div>
                            </div>

                            <div class="col-md-6 h-100 active-view" id="view-form">
                                <div class="form-container">
                                    <div class="d-flex bg-dark align-items-center justify-content-between pe-2">
                                        <ul class="nav nav-tabs" role="tablist">
                                            <li class="nav-item"><button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail-pane" type="button">Post Detail (F2)</button></li>
                                            <li class="nav-item"><button class="nav-link" id="invoice-tab" data-bs-toggle="tab" data-bs-target="#invoice-pane" type="button">Post Invoice (F3)</button></li>
                                        </ul>
                                    </div>

                                    <div class="tab-content" id="postingTabsContent">

                                        <div class="tab-pane fade show active" id="detail-pane" role="tabpanel">
                                            <form class="d-flex flex-column h-100 posting-form-content">
                                                <div class="form-body-scroll">
                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">T/A .Code</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm js-trans-code" /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm js-trans-desc" /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1 align-items-center js-row-article d-none">
                                                        <div class="col-12 col-sm-2"><label class="form-label text-primary fw-bold">↳ Article</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm text-primary js-art-code" readonly /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm text-primary js-art-desc" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Quantity</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm fw-bold text-end js-input-qty" value="1" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label">Bill No</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm" /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Price ++</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm amount-display js-input-price" value="0.00" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Amount ++</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm amount-display bg-white js-amount-gross" value="0.00" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Price.Net</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm text-end text-muted js-input-price-net" value="0.00" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Amount.Net</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm text-end text-muted bg-white js-amount-net" value="0,00" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Currency</label></div>
                                                        <div class="col-12 col-sm-3">
                                                            <select name="currencyID" class="form-select form-select-sm currency-select"><option value="">-- Loading... --</option></select>
                                                        </div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Win.No</label></div>
                                                        <div class="col-12 col-sm-4">
                                                            <select class="form-select form-select-sm js-window-select">
                                                                <option value="">Loading...</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">RmT.Charge</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm" disabled /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm" disabled /></div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Reference</label></div>
                                                        <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-ref-main" /></div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Supplement</label></div>
                                                        <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-sup-folio" /></div>
                                                    </div>

                                                    <div class="section-header">More Information</div>
                                                    <div class="express-box">
                                                        <div class="express-check-group">
                                                            <input type="checkbox" class="form-check-input mt-0 js-chk-express" />
                                                            <label class="lbl-express ms-1">Express Service</label>
                                                        </div>
                                                        <div class="express-input-group">
                                                            <div class="input-group input-group-sm" style="width: auto;">
                                                                <span class="input-group-text">Percent</span>
                                                                <input type="text" class="form-control input-express-pct js-input-express-pct" value="50.00" disabled />
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                            <div class="small d-flex align-items-center gap-2">
                                                                <label><input type="radio" name="r_express_f2" value="10" class="js-express-radio" disabled /> 10%</label>
                                                                <label><input type="radio" name="r_express_f2" value="50" class="js-express-radio" checked disabled /> 50%</label>
                                                                <label><input type="radio" name="r_express_f2" value="100" class="js-express-radio" disabled /> 100%</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="express-box">
                                                        <div class="express-check-group">
                                                            <input type="checkbox" class="form-check-input mt-0 js-chk-discount" />
                                                            <label class="lbl-discount ms-1">Disct. Service</label>
                                                        </div>
                                                        <div class="express-input-group">
                                                            <div class="input-group input-group-sm" style="width: auto;">
                                                                <span class="input-group-text">Percent</span>
                                                                <input type="text" class="form-control input-express-pct js-input-discount-pct" value="10.00" disabled />
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                            <div class="small d-flex align-items-center gap-2">
                                                                <label><input type="radio" name="r_discount_f2" value="10" class="js-discount-radio" checked disabled /> 10%</label>
                                                                <label><input type="radio" name="r_discount_f2" value="20" class="js-discount-radio" disabled /> 20%</label>
                                                                <label><input type="radio" name="r_discount_f2" value="50" class="js-discount-radio" disabled /> 50%</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <fieldset class="border p-1 mt-1" disabled>
                                                        <legend class="float-none w-auto p-0 m-0 text-danger small fw-bold px-1">Invoice Infor</legend>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Description</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-desc" value="Invoicing Package" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Reference</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-ref" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Supplement</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-supp" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Check.No</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-checkNo" /></div>
                                                        </div>
                                                    </fieldset>
                                                </div>
                                                <div class="form-footer-fixed">
                                                    <div class="footer-list-area">
                                                        <div class="footer-header text-danger"><span class="fw-bold">Posted List</span></div>
                                                        <div class="footer-bottom-bar">
                                                            <div class="small fw-bold">Amount posted : <span class="text-primary">0.00</span></div>
                                                            <a class="clear-btn">Clear Posted</a>
                                                        </div>
                                                        <div class="footer-content"></div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                        <div class="tab-pane fade" id="invoice-pane" role="tabpanel">
                                            <form class="d-flex flex-column h-100 posting-form-content">
                                                <div class="form-body-scroll">
                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">T/A .Code</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm js-trans-code" /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm js-trans-desc" /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1 align-items-center js-row-article d-none">
                                                        <div class="col-12 col-sm-2"><label class="form-label text-primary fw-bold">↳ Article</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm text-primary js-art-code" readonly /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm text-primary js-art-desc" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Quantity</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm fw-bold text-end js-input-qty" value="1" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label">Bill No</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm" /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Price ++</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm amount-display js-input-price" value="0.00" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Amount ++</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm amount-display bg-white js-amount-gross" value="0.00" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Price.Net</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm text-end text-muted js-input-price-net" value="0.00" /></div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Amount.Net</label></div>
                                                        <div class="col-12 col-sm-4"><input type="text" class="form-control form-control-sm text-end text-muted bg-white js-amount-net" value="0,00" readonly /></div>
                                                    </div>
                                                    <div class="row g-1 mb-1">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Currency</label></div>
                                                        <div class="col-12 col-sm-3">
                                                            <select name="currencyID" class="form-select form-select-sm currency-select"><option value="">-- Loading... --</option></select>
                                                        </div>
                                                        <div class="col-12 col-sm-3 text-sm-end pe-2"><label class="form-label fw-bold">Win.No</label></div>
                                                        <div class="col-12 col-sm-4">
                                                            <select class="form-select form-select-sm js-window-select">
                                                                <option value="">Loading...</option>
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">RmT.Charge</label></div>
                                                        <div class="col-12 col-sm-3"><input type="text" class="form-control form-control-sm" disabled /></div>
                                                        <div class="col-12 col-sm-7"><input type="text" class="form-control form-control-sm" disabled /></div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Reference</label></div>
                                                        <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-ref-main" /></div>
                                                    </div>

                                                    <div class="row g-1 mb-1 align-items-center">
                                                        <div class="col-12 col-sm-2"><label class="form-label">Supplement</label></div>
                                                        <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-sup-folio" /></div>
                                                    </div>

                                                    <div class="section-header">More Information</div>
                                                    <div class="express-box">
                                                        <div class="express-check-group">
                                                            <input type="checkbox" class="form-check-input mt-0 js-chk-express" />
                                                            <label class="lbl-express ms-1">Express Service</label>
                                                        </div>
                                                        <div class="express-input-group">
                                                            <div class="input-group input-group-sm" style="width: auto;">
                                                                <span class="input-group-text">Percent</span>
                                                                <input type="text" class="form-control input-express-pct js-input-express-pct" value="50.00" disabled />
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                            <div class="small d-flex align-items-center gap-2">
                                                                <label><input type="radio" name="r_express_f3" value="10" class="js-express-radio" disabled /> 10%</label>
                                                                <label><input type="radio" name="r_express_f3" value="50" class="js-express-radio" checked disabled /> 50%</label>
                                                                <label><input type="radio" name="r_express_f3" value="100" class="js-express-radio" disabled /> 100%</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="express-box">
                                                        <div class="express-check-group">
                                                            <input type="checkbox" class="form-check-input mt-0 js-chk-discount" />
                                                            <label class="lbl-discount ms-1">Disct. Service</label>
                                                        </div>
                                                        <div class="express-input-group">
                                                            <div class="input-group input-group-sm" style="width: auto;">
                                                                <span class="input-group-text">Percent</span>
                                                                <input type="text" class="form-control input-express-pct js-input-discount-pct" value="10.00" disabled />
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                            <div class="small d-flex align-items-center gap-2">
                                                                <label><input type="radio" name="r_discount_f3" value="10" class="js-discount-radio" checked disabled /> 10%</label>
                                                                <label><input type="radio" name="r_discount_f3" value="20" class="js-discount-radio" disabled /> 20%</label>
                                                                <label><input type="radio" name="r_discount_f3" value="50" class="js-discount-radio" disabled /> 50%</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <fieldset class="border p-1 mt-1">
                                                        <legend class="float-none w-auto p-0 m-0 text-danger small fw-bold px-1">Invoice Infor</legend>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Description</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-desc" value="Invoicing Package" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Reference</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-ref" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Supplement</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-supp" /></div>
                                                        </div>
                                                        <div class="row g-1 mb-1">
                                                            <div class="col-12 col-sm-2"><label class="form-label">Check.No</label></div>
                                                            <div class="col-12 col-sm-10"><input type="text" class="form-control form-control-sm js-invoice-checkNo" /></div>
                                                        </div>
                                                    </fieldset>
                                                </div>
                                                <div class="form-footer-fixed">
                                                    <div class="footer-list-area">
                                                        <div class="footer-header text-danger"><span class="fw-bold">Transactions Posted to Invoice</span></div>
                                                        <div class="footer-bottom-bar">
                                                            <div class="small fw-bold">Total Amount : <span class="text-primary">0.00</span></div>
                                                            <a class="clear-btn">Clear Invoice</a>
                                                        </div>
                                                        <div class="footer-content"></div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="text-align:center; color:white;">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <div style="margin-top:10px; font-weight:600; font-size: 1rem;">Processing...</div>
    </div>
</div>
<script>
    // --- UTILS ---
    function formatNumberWithComma(num) {
        if (num === null || num === undefined || isNaN(num) || num === '') return '0,00';
        return parseFloat(num).toLocaleString('vi-VN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function parseNumberWithComma(str) {
        if (!str) return 0;
        let strVal = str.toString();
        let cleanStr = strVal.replace(/\./g, '').replace(/,/g, '.');
        return parseFloat(cleanStr) || 0;
    }

    // --- HELPER: Lấy element trong Tab đang active ---
    function getActiveEl(selector) {
        return $('.tab-pane.active').find(selector);
    }

    // --- API CALCULATIONS  ---

    // Nhập Net -> Ra Gross (amount++)
    function apiCalcPlusFromNet() {
        let tCode = getActiveEl('.js-trans-code').val();
        let $netInput = getActiveEl('.js-input-price-net');
        let netVal = parseNumberWithComma($netInput.val());

        if (!tCode) return;

        $.ajax({
            url: '/Billing/CalculatePricePlusPlus',
            type: 'GET',
            data: { transactionCode: tCode, netPrice: netVal },
            success: function (res) {
                if (!isNaN(res)) {
                    let fmtGross = formatNumberWithComma(res);
                    getActiveEl('.js-input-price').val(fmtGross);

                    $netInput.val(formatNumberWithComma(netVal));
                    calculateLineTotal();
                }
            }
        });
    }

    // Nhập Gross(price++) -> Ra Net
    function apiCalcNetFromPlus() {
        let tCode = getActiveEl('.js-trans-code').val();
        let $grossInput = getActiveEl('.js-input-price');
        let grossVal = parseNumberWithComma($grossInput.val());

        if (!tCode) return;

        $.ajax({
            url: '/Billing/CalculatePriceNet',
            type: 'GET',
            data: { transactionCode: tCode, grossPrice: grossVal },
            success: function (res) {
                if (!isNaN(res)) {
                    let fmtNet = formatNumberWithComma(res);
                    getActiveEl('.js-input-price-net').val(fmtNet);

                    // Format lại ô Gross
                    $grossInput.val(formatNumberWithComma(grossVal));
                    calculateLineTotal();
                }
            }
        });
    }

    // Tính tổng tiền
    function calculateLineTotal() {
        let qty = parseFloat(getActiveEl('.js-input-qty').val()) || 0;
        let priceGross = parseNumberWithComma(getActiveEl('.js-input-price').val());
        let priceNet   = parseNumberWithComma(getActiveEl('.js-input-price-net').val());

        let totalGross = qty * priceGross;
        let totalNet   = qty * priceNet;

        getActiveEl('.js-amount-gross').val(formatNumberWithComma(totalGross));
        getActiveEl('.js-amount-net').val(formatNumberWithComma(totalNet));
    }

    // --- EVENTS ---
    $(document).ready(function() {
        //  Search List (transGroup,...,article)
        $(document).on('keyup', '.js-search-box', function() {
            var value = $(this).val().toLowerCase();
            var valueNoTone = removeVietnameseTones(value); 
            var targetId = $(this).data('target'); 

            // Duyệt qua tất cả các thẻ <a> (item) trong danh sách tương ứng
            $(targetId + ' .list-group-item').filter(function() {
                var itemText = $(this).text().toLowerCase();
                var itemTextNoTone = removeVietnameseTones(itemText);

                var isMatch = itemText.indexOf(value) > -1 || itemTextNoTone.indexOf(valueNoTone) > -1;
                $(this).toggle(isMatch);
            });
        });

        // Chỉ cho phép nhập số dương và dấu chấm/phẩy (cho Price, Percent, Quantity)
        $(document).on('keypress', '.js-input-qty, .js-input-price, .js-input-price-net, .js-input-express-pct, .js-input-discount-pct', function(e) {
            // Mã ký tự (char code)
            var charCode = (e.which) ? e.which : e.keyCode;

            if ((charCode >= 48 && charCode <= 57) || charCode === 46 || charCode === 44) {
                return true;
            }

            return false;
        });

        // Xử lý sự kiện Paste (Dán) 
        $(document).on('paste', '.js-input-qty, .js-input-price, .js-input-price-net, .js-input-express-pct, .js-input-discount-pct', function(e) {
            e.preventDefault();

            var pastedData = (e.originalEvent || e).clipboardData.getData('text/plain');

            var cleanData = pastedData.replace(/[^0-9.,]/g, '');

            document.execCommand("insertText", false, cleanData);
        });

        //  Kiểm tra input để đảm bảo không âm khi blur
        $(document).on('blur', '.js-input-qty, .js-input-price, .js-input-price-net', function() {
            var valStr = $(this).val();
            // Chuyển dấu phẩy thành chấm để parse
            var cleanStr = valStr.replace(/\./g, '').replace(/,/g, '.');
            var valNum = parseFloat(cleanStr);

            if (valNum < 0) {
                alert("Negative numbers are not allowed!");
                $(this).val(0); 
                if($(this).hasClass('js-input-qty')) $(this).val(1);
            }
        });

        //  INPUT PRICE ++
        $(document).on('blur keypress', '.js-input-price', function(e) {
            if (e.type === 'keypress' && e.which !== 13) return;
            if (e.type === 'keypress') { e.preventDefault(); $(this).blur(); return; }
            apiCalcNetFromPlus();
        });

        //  INPUT PRICE NET
        $(document).on('blur keypress', '.js-input-price-net', function(e) {
            if (e.type === 'keypress' && e.which !== 13) return;
            if (e.type === 'keypress') { e.preventDefault(); $(this).blur(); return; }
            apiCalcPlusFromNet();
        });

        //  QUANTITY
        $(document).on('blur keypress', '.js-input-qty', function(e) {
             if (e.type === 'keypress' && e.which !== 13) return;
             if (e.type === 'keypress') { e.preventDefault(); $(this).blur(); return; }
             calculateLineTotal();
        });

        //  FOCUS EFFECT
        $(document).on('focus click', '.js-input-price', function() {
            $(this).addClass('active-user-input');
            getActiveEl('.js-input-price-net').removeClass('active-user-input');
        });
        $(document).on('focus click', '.js-input-price-net', function() {
            $(this).addClass('active-user-input');
            getActiveEl('.js-input-price').removeClass('active-user-input');
        });

        // --- EXPRESS/DISCOUNT SERVICE ---
        //  Sự kiện Radio & Input Express và Discount
        $(document).on('change', '.js-express-radio, .js-discount-radio', function() {
            var val = parseFloat($(this).val()).toFixed(2);
            $(this).closest('.express-input-group').find('input[type="text"]').val(val);
            updateReferenceText();
        });

        $(document).on('input blur propertychange', '.js-input-express-pct, .js-input-discount-pct', function() {
            var valNum = parseFloat($(this).val());
            var $container = $(this).closest('.express-box');

            $container.find('input[type="radio"]').prop('checked', false);

            if ([10, 20, 50, 100].includes(valNum)) {
                $container.find(`input[value="${valNum}"]`).prop('checked', true);
            }
            updateReferenceText();
        });
          
        function updateReferenceText() {
        var $activePane = $('.tab-pane.active');
        var $refInput = $activePane.find('.js-ref-main');

        var $chkExpress = $activePane.find('.js-chk-express');
        var pctExpress = $activePane.find('.js-input-express-pct').val();

        var $chkDiscount = $activePane.find('.js-chk-discount');
        var pctDiscount = $activePane.find('.js-input-discount-pct').val();

        var currentRef = $refInput.val();

        var cleanRef = currentRef.replace(/ Express Service : .*?%/g, '')
                                 .replace(/ Discount Service : .*?%/g, '');

        if ($chkExpress.is(':checked') && pctExpress) {
            cleanRef = cleanRef + " Express Service : " + pctExpress + "%";
        }
        else if ($chkDiscount.is(':checked') && pctDiscount) {
            cleanRef = cleanRef + " Discount Service : " + pctDiscount + "%";
        }

            $refInput.val(cleanRef);
        }

        function toggleInputs($container, isChecked) {
            $container.find('input[type="text"], input[type="radio"]').prop('disabled', !isChecked);
        }

        //  Sự kiện Checkbox EXPRESS
        $(document).on('change', '.js-chk-express', function() {
            var isChecked = $(this).is(':checked');
            var $activePane = $(this).closest('.tab-pane');
            var $container = $(this).closest('.express-box');

            toggleInputs($container, isChecked);

            if(isChecked) {
                var $chkDiscount = $activePane.find('.js-chk-discount');
                if ($chkDiscount.is(':checked')) {
                    $chkDiscount.prop('checked', false).trigger('change'); 
                }
                updateReferenceText();
                getActiveEl('.js-ref-main').focus();
            } else {
                updateReferenceText();
            }
        });

        //  Sự kiện Checkbox DISCOUNT
        $(document).on('change', '.js-chk-discount', function() {
            var isChecked = $(this).is(':checked');
            var $activePane = $(this).closest('.tab-pane');
            var $container = $(this).closest('.express-box');

            toggleInputs($container, isChecked);

            if(isChecked) {
                var $chkExpress = $activePane.find('.js-chk-express');
                if ($chkExpress.is(':checked')) {
                    $chkExpress.prop('checked', false).trigger('change');
                }
                updateReferenceText();
                getActiveEl('.js-ref-main').focus();
            } else {
                updateReferenceText();
            }
        });

    });

    // --- DATA LOADING & FORM FILLING ---

    function fillToForm(tCode, tDesc, aCode, aDesc, price, element) {
        if (element) highlightItem(element, '#list-article-container');

        const activeForm = $('.tab-pane.active');

        activeForm.find('.js-trans-code').val(tCode);
        activeForm.find('.js-trans-desc').val(tDesc);

        if (aCode) {
            activeForm.find('.js-row-article').removeClass('d-none').addClass('d-flex');
            activeForm.find('.js-art-code').val(aCode);
            activeForm.find('.js-art-desc').val(aDesc);
        } else {
            activeForm.find('.js-row-article').addClass('d-none').removeClass('d-flex');
            activeForm.find('.js-art-code').val('');
            activeForm.find('.js-art-desc').val('');
        }

        activeForm.find('.js-input-qty').val('1');

        let formattedPrice = formatNumberWithComma(price);
        // Sửa lại selector ID thành Class
        activeForm.find('.js-input-price').val(formattedPrice);
        activeForm.find('.js-input-price').addClass('active-user-input');
        activeForm.find('.js-input-price-net').removeClass('active-user-input');

        apiCalcNetFromPlus();

        if (window.innerWidth < 768) switchView('form');
        setTimeout(function() {
            activeForm.find('.js-input-qty').focus().select();
        }, 100);
    }

    function resetForm() {
        let $activePane = $('.tab-pane.active');
        $activePane.find('input[type="text"]').val('');
        $activePane.find('.js-invoice-desc').val('Invoicing Package');
        $activePane.find('.js-input-qty').val('1');
        $activePane.find('.js-input-price, .js-input-price-net').val('0,00');
        $activePane.find('.amount-display').val('0,00');
        $activePane.find('.js-row-article').addClass('d-none').removeClass('d-flex');

        // Reset Express
        $activePane.find('.js-chk-express').prop('checked', false).trigger('change');
        $activePane.find('.js-input-express-pct').val('50.00');

        // Reset Discount
        $activePane.find('.js-chk-discount').prop('checked', false).trigger('change');
        $activePane.find('.js-input-discount-pct').val('10.00'); 

        $('.list-group-item').removeClass('active-item-custom');
        $activePane.find('.js-trans-code').focus();
    }

    //  các hàm hỗ trợ mở modal chuyển view v.v

    function openModalPosting() {
        localStorage.setItem("currentFromID", "modalPosting");
        const crashierLogin = localStorage.getItem("crashierLogin");
        if(crashierLogin == "NotYet"){
            openModalShilftLogin();
        } else {
            $('#modalPosting').modal('show');
        }
    }

    function switchView(viewName) {
        document.querySelectorAll(".mobile-nav button").forEach((btn) => btn.classList.remove("active"));
        document.getElementById("nav-" + viewName).classList.add("active");
        const cols = ["view-trans", "view-group", "view-form"];
        cols.forEach((id) => {
            const el = document.getElementById(id);
            if (id === "view-" + viewName) el.classList.add("active-view");
            else el.classList.remove("active-view");
        });
    }

    // Logic view button next tab f2/f3
    document.addEventListener("DOMContentLoaded", function () {
        const btnAdd = document.getElementById("btn-add");
        const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach((tabEl) => {
            tabEl.addEventListener("shown.bs.tab", function (event) {
                if (event.target.id === "detail-tab") btnAdd.style.display = "none";
                else if (event.target.id === "invoice-tab") btnAdd.style.display = "flex";
                resetForm();
            });
        });
    });

    // F2/F3
    document.addEventListener("keydown", function (event) {
        if (event.key === "F2") {
            event.preventDefault();
            switchView("form");
            bootstrap.Tab.getOrCreateInstance(document.querySelector("#detail-tab")).show();
        }
        if (event.key === "F3") {
            event.preventDefault();
            switchView("form");
            bootstrap.Tab.getOrCreateInstance(document.querySelector("#invoice-tab")).show();
        }
    });

    // Load Data
    function loadCurrencies() {
        var $selects = $('.currency-select');
        $.ajax({
            url: '/Billing/GetCurrencies',
            type: 'GET',
            success: function (data) {
                if(data.error) return console.error(data.error);
                let html = '<option value="">-- Select --</option>';
                data.forEach(item => { html += `<option value="${item.id}">${item.id}</option>`; });
                $selects.html(html).val('VND');
            }
        });
    }

    function loadFolioWindows() {
        var $selects = $('.js-window-select');
        if (typeof idReservation === 'undefined' || !idReservation) return;

        $.ajax({
            url: '/Billing/GetFolioNoByReservationID',
            type: 'GET',
            data: { reservationID: idReservation },
            success: function (data) {
                if (data.error) { console.error(data.error); return; }

                let html = '';
                data.forEach(item => {
                    let isLocked = item.status === true ? 'true' : 'false';
                    let lockText = item.status === true ? ' (Locked)' : '';

                    html += `<option value="${item.id}" data-locked="${isLocked}">${item.folioNo}${lockText}</option>`;
                });
                $selects.html(html);

                if (typeof folioNoID !== 'undefined' && folioNoID) {
                    $selects.val(folioNoID);
                }
            }
        });
    }

    function loadGroups() {
        $('#list-group-container').html('<div class="p-2">Loading...</div>');
        $.ajax({
            url: '/Billing/GetTransactionGroups',
            type: 'GET',
            success: function (data) {
                if (data.error) { alert(data.error); return; }
                let html = '';
                data.forEach(item => {
                    html += `<a href="javascript:void(0)" onclick="loadSubGroups(${item.id}, this)" class="list-group-item list-group-item-action">${item.description}</a>`;
                });
                $('#list-group-container').html(html);
                if (data.length > 0) {
                    $('#list-group-container .list-group-item:first-child').trigger('click');
                }
            }
        });
    }

    function loadSubGroups(groupId, element) {
        highlightItem(element, '#list-group-container');
        $('#view-group').data('selected-group-id', groupId);
        $('#list-subgroup-container').html('Loading...');
        $('#list-transaction-container').empty();
        $('#list-article-container').empty();

        $.ajax({
            url: '/Billing/GetTransactionSubGroups',
            type: 'GET',
            data: { groupId: groupId },
            success: function (data) {
                let html = data.length === 0 ? '<div class="p-2 small text-muted">No Data</div>' : '';
                data.forEach(item => {
                    html += `<a href="javascript:void(0)" onclick="loadTransactions(${item.id}, this)" class="list-group-item list-group-item-action">${item.description}</a>`;
                });
                $('#list-subgroup-container').html(html);
                $('.js-search-box[data-target="#list-subgroup-container"]').val('');
                if (data.length > 0) {
                    $('#list-subgroup-container .list-group-item:first-child').trigger('click');
                }
            }
        });
    }

    function loadTransactions(subGroupId, element) {
        highlightItem(element, '#list-subgroup-container');
        let groupId = $('#view-group').data('selected-group-id');
        $('#list-transaction-container').html('<div class="p-2">Loading...</div>');
        $('#list-article-container').empty();

        $.ajax({
            url: '/Billing/GetTransactions',
            type: 'GET',
            data: { groupId: groupId, subGroupId: subGroupId },
            success: function (data) {
                let html = data.length === 0 ? '<div class="p-2 text-muted small">No Transactions</div>' : '';
                data.forEach(item => {
                    html += `<a href="javascript:void(0)" onclick="checkAndLoadArticles('${item.code}', '${item.description}', ${item.defaultPrice}, this)" class="list-group-item list-group-item-action">
                                <span class="text-danger fw-bold me-2">${item.code}</span> ${item.description}
                             </a>`;
                });
                $('#list-transaction-container').html(html);
                $('.js-search-box[data-target="#list-transaction-container"]').val('');
            }
        });
    }

    function checkAndLoadArticles(transCode, transName, transPrice, element) {
        highlightItem(element, '#list-transaction-container');
        $('#list-article-container').html('<div class="p-2 text-muted">Loading...</div>');

        $.ajax({
            url: '/Billing/GetArticles',
            type: 'GET',
            data: { transactionCode: transCode },
            success: function (data) {
                if (data.length === 0) {
                    $('#list-article-container').html('<div class="p-2 small text-muted">No Articles. Selected Transaction.</div>');
                    // Không có article -> Load TransPrice vào và tính Net
                    fillToForm(transCode, transName, null, null, transPrice, null);
                } else {
                    let html = '';
                    data.forEach(item => {
                        let artPrice = item.defaultPrice || 0;
                        html += `<a href="javascript:void(0)"
                                    onclick="fillToForm('${transCode}', '${transName}', '${item.code}', '${item.description}', ${artPrice}, this)"
                                    class="list-group-item list-group-item-action">
                                    <span class="text-danger fw-bold me-2">${item.code}</span>
                                    <span>${item.description}</span>
                                    <span class="float-end text-danger small fw-bold">${formatNumberWithComma(artPrice)}</span>
                                 </a>`;
                    });
                    $('#list-article-container').html(html);
                    $('.js-search-box[data-target="#list-article-container"]').val('');
                }
            }
        });
    }

    // --- UTILS: Hàm bỏ dấu tiếng Việt để tìm kiếm ---
    function removeVietnameseTones(str) {
        str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
        str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
        str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
        str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
        str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
        str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
        str = str.replace(/đ/g, "d");
        str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
        str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
        str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
        str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
        str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
        str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
        str = str.replace(/Đ/g, "D");
        // Một số ký tự đặc biệt
        str = str.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g, "");
        str = str.replace(/\u02C6|\u0306|\u031B/g, "");
        return str;
    }

    function highlightItem(element, containerId) {
        $(containerId + ' .list-group-item').removeClass('active-item-custom');
        $(element).addClass('active-item-custom');
    }

    // sự kiện đóng modal
    $('#modalPosting').on('hidden.bs.modal', function () {
        resetForm();
        $('#list-subgroup-container').empty();
        $('#list-transaction-container').empty();
        $('#list-article-container').empty();

        var triggerEl = document.querySelector('#detail-tab');
        if(triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
    });

    // sự kiện mở modal
    $('#modalPosting').on('shown.bs.modal', function () {
        loadGroups();
        loadCurrencies();
        loadFolioWindows();
    });

    // nut add and post
    var invoiceList = []; 

    // ---. XỬ LÝ NÚT ADD (CHỈ DÙNG CHO F3) ---
    $('#btn-add').click(function() {
        var $activePane = $('#invoice-pane');
        var transCode = $activePane.find('.js-trans-code').val();

        if (!transCode) { alert("Please select a transaction first!"); return; }

        var qty = parseFloat($activePane.find('.js-input-qty').val()) || 0;
        var price = parseNumberWithComma($activePane.find('.js-input-price-net').val()); 

        var desc = $activePane.find('.js-trans-desc').val();
        var artDesc = $activePane.find('.js-art-desc').val();
        var finalDesc = artDesc ? artDesc : desc;

        var artCode = $activePane.find('.js-art-code').val() || "";
        
        var amountBeforeTax = $activePane.find('.js-amount-gross').val() || "";

        var isExpress = $activePane.find('.js-chk-express').is(':checked');
        var isDiscount = $activePane.find('.js-chk-discount').is(':checked');

        var pctVal = 0;
        var serviceType = '';

        if (isExpress) {
            pctVal = parseFloat($activePane.find('.js-input-express-pct').val()) || 0;
            serviceType = 'EXP';
        } else if (isDiscount) {
            pctVal = parseFloat($activePane.find('.js-input-discount-pct').val()) || 0;
            serviceType = 'DIS';
        }

        // --- TÍNH TOÁN TIỀN ---
        var rawTotal = qty * price;
        var adjustAmount = rawTotal * (pctVal / 100);
        var finalTotal = 0;

        if (serviceType === 'EXP') {
            finalTotal = rawTotal + adjustAmount; 
        } else if (serviceType === 'DIS') {
            finalTotal = rawTotal - adjustAmount; 
        } else {
            finalTotal = rawTotal;
        }

        var reference = $activePane.find('.js-ref-main').val();
        var remarkInvoice = $activePane.find('.js-invoice-desc').val();
        var checkNo = $activePane.find('.js-invoice-checkNo').val();

        var itemObj = {
            id: Date.now(),
            code: transCode,
            articleCode: artCode,
            description: finalDesc,
            amountBeforeTax: amountBeforeTax,
            quantity: qty,
            price: price,
            serviceType: serviceType,
            servicePct: pctVal,
            amount: finalTotal,
            reference: reference,
            remark: remarkInvoice,
            checkNo: checkNo
        };

        invoiceList.push(itemObj);
        renderInvoiceFooter();
        resetFormKeepInvoiceInfo();
    });

    // ---  HÀM RENDER LIST XUỐNG FOOTER F3 ---
    function renderInvoiceFooter() {
        var $footerContent = $('#invoice-pane .footer-content');
        var html = '<table class="table table-sm table-striped mb-0" style="font-size: 0.7rem;">';

        html += '<thead class="table-light"><tr><th>Code</th><th>Desc</th><th class="text-end">Qty</th><th class="text-end">Price</th><th class="text-end">Total</th><th>Ref</th><th>Action</th></tr></thead><tbody>';

        var grandTotal = 0;

        invoiceList.forEach(function(item, index) {
            grandTotal += item.amount;
            html += `<tr>
                        <td>${item.code}</td>
                        <td>${item.description}</td>
                        <td class="text-end">${item.quantity}</td>
                        <td class="text-end">${formatNumberWithComma(item.price)}</td>
                        <td class="text-end fw-bold">${formatNumberWithComma(item.amount)}</td>
                        <td>${item.reference}</td>
                        <td><a href="javascript:void(0)" onclick="removeInvoiceItem(${index})" class="text-danger">Delete</a></td>
                     </tr>`;
        });

        html += '</tbody></table>';

        $footerContent.html(html);

        // Cập nhật Tổng tiền ở thanh Footer Bar
        $('#invoice-pane .footer-bottom-bar span.text-primary').text(formatNumberWithComma(grandTotal));
    }

    // ---  HÀM XÓA 1 DÒNG KHỎI LIST INVOICE ---
    function removeInvoiceItem(index) {
        invoiceList.splice(index, 1);
        renderInvoiceFooter(); 
    }

    // ---  NÚT CLEAR INVOICE ---
    $('.clear-btn').click(function() {
        if(confirm('Are you sure you want to clear all items?')) {
            invoiceList = [];
            renderInvoiceFooter();
        }
    });

    // ---. HÀM RESET FORM NHƯNG GIỮ INPUT FIELD INVOICE DESC (CHO NÚT ADD) ---
    function resetFormKeepInvoiceInfo() {
        var $activePane = $('#invoice-pane');
        var currentDesc = $activePane.find('.js-invoice-desc').val(); 

        resetForm(); 

        $activePane.find('.js-invoice-desc').val(currentDesc);

        $activePane.find('.js-trans-code').focus();
    }

    // ---  HÀM POSTING SERVICE  ---
    function PostingService() {
        const loginUser = parseInt(localStorage.getItem("userID")) || 0;
        const loginName = (localStorage.getItem("Loginname") || "").trim().replace(/^"(.*)"$/, '$1');
        const shiftID = parseInt(localStorage.getItem("shiftID")) || 0;

        const currentFolioID = parseInt(localStorage.getItem("CurrentFolioID")) || 0;
        const currentRoomID = parseInt(localStorage.getItem("CurrentRoomID")) || 0;

        //  Xác định Tab đang active
        var $activePane = $('.tab-pane.active');
        var activeTabId = $activePane.attr('id');
        var dataToSend = []; 

        var $selectBox = $activePane.find('.js-window-select');
        var selectedFolioID = parseInt($selectBox.val());

        if (!selectedFolioID) {
            showToast('Error', "Please select a Window No (Folio)!", false);
            return;
        }

        var $selectedOption = $selectBox.find('option:selected');
        var isLocked = $selectedOption.attr('data-locked');

        if (isLocked === 'true') {
            showToast('Error', "This Folio is Locked. Cannot Post Transaction!", false);
            return; 
        }

        if (activeTabId === 'detail-pane') {
            var $pane = $('#detail-pane');
            var tCode = $pane.find('.js-trans-code').val();

            if (!tCode) { alert("No transaction selected!"); return; }

            var qty = parseFloat($pane.find('.js-input-qty').val()) || 0;
            var price = parseNumberWithComma($pane.find('.js-input-price-net').val());
            var amount = parseNumberWithComma($pane.find('.js-amount-net').val());

            var reference = $pane.find('.js-ref-main').val();
            var supplement = $pane.find('.js-sup-folio').val() || "";
            var receiptNo = $pane.find('.js-invoice-checkNo').val() || "";

            var model = {
                UserID: loginUser,
                UserName: loginName,
                ShiftID: shiftID,
                CashierNo: loginName,
                FolioID: selectedFolioID,
                OriginFolioID: selectedFolioID,
                ReservationID: idReservation,
                OriginReservationID: idReservation,
                RoomType: roomType,
                ReceiptNo: receiptNo,
                CheckNo: receiptNo,
                RoomID: roomID,

                TransactionCode: tCode,
                Description: $pane.find('.js-trans-desc').val(),
                ArticleCode: $pane.find('.js-art-code').val(),

                Quantity: qty,
                Price: price,
                Amount: amount,
                AmountMaster: amount,
                AmountBeforeTax:parseNumberWithComma( $pane.find('.js-amount-gross').val()),
                AmountMasterBeforeTax:parseNumberWithComma( $pane.find('.js-amount-gross').val()),
                AmountGross: amount,
                AmountMasterGross: amount,

                CurrencyID: $pane.find('.currency-select').val(),
                CurrencyMaster: $pane.find('.currency-select').val(),
                Reference: reference,
                Supplement: supplement,

                PostType: 2,
                RowState: 2,
                GroupType: 1,
                UserInsertID: loginUser,
                UserUpdateID: loginUser

            };

            dataToSend.push(model);

        } else if (activeTabId === 'invoice-pane') {
            if (invoiceList.length === 0) {
                alert("Invoice list is empty! Please 'Add' items first.");
                return;
            }

            // Lấy thông tin chung của cả Invoice (Invoice Info Header)
            var $pane = $('#invoice-pane');
            var invCheckNo = $pane.find('.js-invoice-checkNo').val();
            var invDesc = $pane.find('.js-invoice-desc').val();
            var invRef = $pane.find('.js-invoice-ref').val(); 
            var invSuppl = $pane.find('.js-invoice-supp').val();
           
            invoiceList.forEach(function(item) {
                var model = {
                    UserID: loginUser,
                    UserName: loginName,
                    ShiftID: shiftID,
                    CashierNo: loginName,
                    FolioID: selectedFolioID,
                    OriginFolioID: selectedFolioID,
                    ReservationID: idReservation,
                    OriginReservationID: idReservation,
                    RoomType: roomType,
                    ReceiptNo: item.checkNo,
                    CheckNo: item.checkNo,
                    RoomID: roomID,

                    TransactionCode: item.code,
                    Description: item.description, 
                    ArticleCode: item.articleCode,

                    Quantity: item.quantity,
                    Price: item.price,
                    Amount: item.amount,
                    AmountMaster: item.amount,
                    AmountBeforeTax: parseNumberWithComma(item.amountBeforeTax),
                    AmountMasterBeforeTax:parseNumberWithComma( item.amountBeforeTax),
                    AmountMasterGross: amount,
                    AmountGross: item.amount,

                    CurrencyID: $pane.find('.currency-select').val(),
                    CurrencyMaster: $pane.find('.currency-select').val(),

                    // Kết hợp Reference riêng của món + Reference chung của Invoice
                    Reference: item.reference ? (item.reference + ". " + invRef) : invRef,

                    Supplement: supplement, 
                    CheckNo: invCheckNo,

                    PostType: 3,
                    RowState: 3,
                    GroupType: 1,
                    UserInsertID: loginUser,
                    UserUpdateID: loginUser
                };  

                dataToSend.push(model);
            });
        }

        submitToDB(dataToSend,selectedFolioID);
    }

    // Hàm gửi Ajax
    function submitToDB(dataList,targetFolioID) {
        $('#loadingOverlay').css("display", "flex").hide().fadeIn(200);

        $.ajax({
            url: '/Billing/PostingSave',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dataList),
            success: function (res) {
                $('#loadingOverlay').fadeOut(200);
                if (res.success) {
                    showToast("Success","Posted Successfully! Invoice No: " + res.invoiceNo,true);

                    if(typeof invoiceList !== 'undefined') {
                        invoiceList = [];
                        renderInvoiceFooter(); 
                    }

                    resetForm(); 
                    $('#modalPosting').modal('hide');
                    if (typeof listFolioNoID !== 'undefined' && typeof filterByFolioNo === 'function') {
                        // Tìm index của folioID vừa post trong danh sách folio của trang billing
                        var index = listFolioNoID.indexOf(targetFolioID);
                        if (index !== -1) {
                            filterByFolioNo(targetFolioID, index);
                        } else {
                            searchFolioDetail(0);
                        }
                    }
                } else {
                    showToast('Error', res.message || "Posting Failed", false);
                }
            },
            error: function (err) {
                $('#loadingOverlay').fadeOut(200);
                console.error(err);
                showToast('Error', "System Error: " + error, false);
            }
        });
    }


</script>