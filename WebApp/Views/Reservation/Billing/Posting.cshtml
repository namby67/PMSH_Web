<link href="~/css/pages/posting.css" rel="stylesheet" />
<div class="modal fade" id="modalPosting" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">POS Order Screen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-primary btn-primary-post-billing" style="padding: 4px 8px;" onclick="PostingService();">Post</button>
                </div>
                <div class="row g-3">
                    <!-- LEFT -->
                    <div class="col-lg-5">
                        <div class="card p-3">
                            <div class="filter-bar-post-billing-2">
                                <i class="fa-solid fa-filter filter-icon-post-billing-2" onclick="toggleFilters()"></i>
                                <input type="text" class="form-control form-control-sm" id="productSearch" placeholder="Tìm kiếm sản phẩm...">
                            </div>
                            <div class="filters-container-post-billing-2" id="filtersContainer">
                                <select class="form-select form-select-sm" id="transactionGroupIDPosting">
                                </select>
                                <select class="form-select form-select-sm" id="subTransactionGroupIDPosting">

                                </select>
                            </div>
                            <div class="product-list-post-billing-2" id="listTransactionPosting">

                            </div>
                            <div class="sub-product-list-post-billing-2" id="subProductList"></div>
                        </div>
                    </div>

                    <!-- MIDDLE -->
                    <div class="col-lg-4">
                        <div class="card p-3">
                            <div class="section-card-post-billing-2">
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>T/A Code</label>
                                            <input type="text" class="form-control-post-billing-2" id="taCode1PostBilling" placeholder="Enter T/A Code">
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>&nbsp;</label>
                                            <input type="text" class="form-control-post-billing-2" id="taCode2PostBilling" placeholder="Enter Bill No">
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-1">
                                    <label id="articleCodePostBilling"></label>

                                </div>
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Quantity</label>
                                            <input type="number" class="form-control-post-billing-2" id="quantityPostBilling" style="text-align:right" value="1" min="1">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Price++</label>
                                            <input type="text" step="0.01" class="form-control-post-billing-2" id="pricePostBilling" style="text-align:right" value="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Amount++</label>
                                            <input type="text" step="0.01" class="form-control-post-billing-2" id="amountPostBilling" style="text-align:right" value="0" placeholder="0.00" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Price.net</label>
                                            <input type="text" step="0.01" class="form-control-post-billing-2" id="priceNetPostBilling" style="text-align:right" value="0" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Amount.net</label>
                                            <input type="text" step="0.01" class="form-control-post-billing-2" id="amountNetPostBilling" style="text-align:right" value="0" placeholder="0.00" readonly>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Currency</label>
                                            <input type="text" class="form-control-post-billing-2" id="currencyPostBilling" value="VND" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Win.No</label>
                                            <input type="text" class="form-control-post-billing-2" id="winNoPostBilling" style="text-align:right" readonly/>
    
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="input-group-post-billing-2">
                                            <label>Bill No</label>
                                            <input type="text" class="form-control-post-billing-2" id="billNoPostBilling" placeholder="Enter Bill No">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1">
                                    <div class="col">
                                        <button class="btn btn-primary-post-billing-2" onclick="addItemToCart();">Push To List</button>
                                    </div>
                                </div>
                            </div>

                            <div class="cart-header-post-billing-2">
                                <span class="ta-selected-post-billing-2" id="taSelected">T/A Selected</span>
                                <a href="#" class="delete-all-post-billing-2" onclick="deleteAllCartItems()">Delete All</a>
                            </div>
                            <div class="table-responsive-post-billing-2">
                                <ul class="cart-list-post-billing-2" id="cartList">

    
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT -->
                    <div class="col-lg-3">
                        <div class="card p-3 mb-2">
                            <div class="section-card section-card-post-billing has-overlap-post-billing">
                                <h8 class="section-heading section-heading-post-billing">
                                    <input class="form-check-input form-check-input-post-billing me-1" type="checkbox" id="expressService-post-billing">
                                    Express Service
                                </h8>
                                <div class="row mt-1">
                                    <div class="col">
                                        <div class="input-group input-group-post-billing">
                                            <label>Percentage</label>
                                            <input type="number" class="form-control form-control-post-billing" id="percentageInput-post-billing" step="0.01">
                                        </div>
                                    </div>
                                    <div style="display: flex; column-gap: 8px;" class="col">
                                        <div class="form-check">
                                            <input class="form-check-input form-check-input-post-billing" type="radio" name="percentage-post-billing" id="percent10-post-billing" value="10">
                                            <label class="form-check-label form-check-label-post-billing" for="percent10-post-billing">10%</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input form-check-input-post-billing" type="radio" name="percentage-post-billing" id="percent50-post-billing" value="50">
                                            <label class="form-check-label form-check-label-post-billing" for="percent50-post-billing">50%</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input form-check-input-post-billing" type="radio" name="percentage-post-billing" id="percent100-post-billing" value="100">
                                            <label class="form-check-label form-check-label-post-billing" for="percent100-post-billing">100%</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card p-3">
                            <div class="radio-group-post-billing-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="detailsToggle" id="post-details-radio" value="post-details" checked>
                                    <label class="form-check-label" for="post-details-radio">Post Details</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="detailsToggle" id="invoice-details-radio" value="invoice-details">
                                    <label class="form-check-label" for="invoice-details-radio">Post Invoice</label>
                                </div>
                            </div>
                            <div class="right-tab-content-post-billing-2" id="rightTabContent">
                                <div class="right-tab-pane-post-billing-2 active post-details-tab-post-billing-2" id="post-details">
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Rmt.Charge</label>
                                            <input type="text" class="form-control-post-billing-2" id="rmtChargePostBilling" >

                                        </div>
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Reference</label>
                                            <input type="text" class="form-control-post-billing-2" id="referencePostBilling" >
                                        </div>
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Supplement</label>
                                            <input type="text" class="form-control-post-billing-2" id="supplementPostBilling" >
                                        </div>
  
                                </div>
                                <div class="right-tab-pane-post-billing-2 invoice-details-tab-post-billing-2" id="invoice-details">
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Description</label>
                                            <input type="text" class="form-control-post-billing-2" id="desInvoicePostBilling">
                                        </div>
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Reference</label>
                                            <input type="text" class="form-control-post-billing-2" id="referenceInvoiceBilling">
                                        </div>
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Supplement</label>
                                            <input type="text" class="form-control-post-billing-2" id="supplementInvoiceBilling">
                                        </div>
                                        <div class="input-group-post-billing-2 mb-1">
                                            <label>Check No</label>
                                            <input type="text" class="form-control-post-billing-2" id="checkNoInvoicePostBilling">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
         </div>
    </div>
</div>
<script>
    var postType = 1;
    function openModalPosting() {
        const crashierLogin = localStorage.getItem("crashierLogin");
        if(crashierLogin == "NotYet"){
            openModalShilftLogin();
        }
        else{
            $('#winNoPostBilling').val(folioPosting);
            setGroupTransactionPosting();
            setSubGroupTransactionPosting($('#transactionGroupIDPosting').val());
            getTransactionPosting($('#transactionGroupIDPosting').val(), $('#subTransactionGroupIDPosting').val());
            $('#modalPosting').modal('show');
        }

    }
      let selectedProductName = ''; // Store selected transaction name globally
    let isFiltersVisible = false; // Track filter visibility state

    // Toggle filters visibility and move search input
    function toggleFilters() {
      const filtersContainer = document.getElementById('filtersContainer');
      const filterBar = document.querySelector('.filter-bar-post-billing-2');
      const productSearch = document.getElementById('productSearch');

      isFiltersVisible = !isFiltersVisible;
      filtersContainer.classList.toggle('filters-visible-post-billing-2', isFiltersVisible);

      if (isFiltersVisible) {
        // Move search input to filters-container only if it's not already there
        if (!filtersContainer.contains(productSearch)) {
          filtersContainer.appendChild(productSearch);
        }
      } else {
        // Move search input back to filter-bar only if it's not already there
        if (!filterBar.contains(productSearch)) {
          filterBar.appendChild(productSearch);
        }
      }
    }
    // Use vanilla JavaScript for both event handling and logic to avoid jQuery dependency
    document.querySelectorAll('input[name="detailsToggle"]').forEach(radio => {
        radio.addEventListener('change', function () {
            // UI toggling logic
            const postDetails = document.getElementById('post-details');
            const invoiceDetails = document.getElementById('invoice-details');
            const postRadio = document.getElementById('post-details-radio');

            if (postRadio.checked) {
                postDetails.classList.add('active');
                invoiceDetails.classList.remove('active');
            } else {
                postDetails.classList.remove('active');
                invoiceDetails.classList.add('active');
            }

            // Additional logic from jQuery code
            const selectedValue = this.value; // Get the value of the clicked radio button
            listCart = [];
            listSelected();
            resetInfoPost();

            if (selectedValue === 'post-details') {
                postType = 1;
            } else if (selectedValue === 'invoice-details') {
                postType = 2;
            }
        });
    });
    // get transaction
    function getTransactionPosting(groupTransactionID, subGroupTransactionID) {
         filteredSubGroupTransaction = transactionList.filter(function (item) {
            // Case 1: If both IDs are 0, return all transactions
            if (groupTransactionID == 0 && subGroupTransactionID == 0) {
                return true; // This returns every item in transactionList
            }
            // Case 2: If groupTransactionID is not 0 and subGroupTransactionID is 0,
            // return all transactions matching groupTransactionID
            if (groupTransactionID != 0 && subGroupTransactionID == 0) {
                return item.transactionGroupID == groupTransactionID;
            }
            // Case 3: If both IDs are provided, filter by both
            return item.transactionSubGroupID == subGroupTransactionID &&
                item.transactionGroupID == groupTransactionID;
         });

        if (filteredSubGroupTransaction.length > 0) {
            $('#listTransactionPosting').empty();
            var html = '';
            for (var i = 0; i < filteredSubGroupTransaction.length; i++) {
                var filterArticlePosting = articleList.filter(function (item) {
                    return item.transactionCode == filteredSubGroupTransaction[i].code;
                });
                const subProducts = filterArticlePosting.map(item => ({
                    code: item.code,
                    name: item.description,
                    id:item.id
                }));
                html += `<div class="product-item-post-billing-2" data-subproducts='${JSON.stringify(subProducts)}'>
                        <span class="product-code-post-billing-2">${filteredSubGroupTransaction[i].code}</span>
                        <div class="product-name-row-post-billing-2">
                            <span class="product-name-post-billing-2">${filteredSubGroupTransaction[i].description}</span>
                            <button class="btn-add-post-billing-2" data-id="${filteredSubGroupTransaction[i].code}" onclick="addItem(1,this)">+</button>
                        </div>
                    </div>`;
            }
            $('#listTransactionPosting').append(html);
        }

        document.querySelectorAll('.product-item-post-billing-2').forEach(item => {
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('btn-add-post-billing-2') && !e.target.closest('.btn-add-post-billing-2')) {
                    const isActive = item.classList.contains('active');
                    closeSubProductList();
                    if (!isActive) {
                        showSubProductList(item);
                    }
                }
            });
        });
    }



    function setGroupTransactionPosting() {
        $('#transactionGroupIDPosting').empty();
        var html = `<option value='0' selected>Group Transaction</option>`;

        if (groupTransaction.length > 0) {

            for (var i = 0; i < groupTransaction.length; i++) {
                html += `<option value='${groupTransaction[i].id}'>${groupTransaction[i].description}</option>`
            }

        }
        $('#transactionGroupIDPosting').append(html);
    }
    function setSubGroupTransactionPosting(transactionGroupID) {
        $('#subTransactionGroupIDPosting').empty();
        var html = `<option value='0' selected>Sub Group Transaction</option>`;
        var filteredSubGroupTransaction = subGroupTransaction;
        if (transactionGroupID != 0) {
            filteredSubGroupTransaction = subGroupTransaction.filter(function (item) {
                return item.transactionGroupID == transactionGroupID;
            });
        }

        if (filteredSubGroupTransaction.length > 0) {

            for (var i = 0; i < filteredSubGroupTransaction.length; i++) {
                html += `<option value='${filteredSubGroupTransaction[i].id}'>${filteredSubGroupTransaction[i].description}</option>`
            }

        }
        $('#subTransactionGroupIDPosting').append(html);
    }

    $('#transactionGroupIDPosting').change(function () {
        let selectedValue = $(this).val();
        setSubGroupTransactionPosting(selectedValue);
        getTransactionPosting(selectedValue, $('#subTransactionGroupIDPosting').val());
    });
    $('#subTransactionGroupIDPosting').change(function () {
        let selectedValue = $(this).val();
        getTransactionPosting($('#transactionGroupIDPosting').val(),selectedValue);
    });
    // Show article list when clicking a transaction item
    function showSubProductList(element) {
      try {
        const subProducts = JSON.parse(element.getAttribute('data-subproducts') || '[]');
        const productName = element.querySelector('.product-name-post-billing-2').textContent.trim();
        const productCode = element.querySelector('.product-code-post-billing-2').textContent.trim();
        const subProductList = document.getElementById('subProductList');
        const taSelected = document.getElementById('taSelected');

        // Remove active class from all transaction items
        document.querySelectorAll('.product-item-post-billing-2').forEach(item => {
          item.classList.remove('active');
        });

        // Add active class to the clicked item
        element.classList.add('active');
        selectedProductName = `${productName} (${productCode})`;
        //taSelected.textContent = selectedProductName;
        document.getElementById('taCode1PostBilling').value = productCode;

        // Populate article list
        if (subProducts.length > 0) {
          subProductList.innerHTML = `
            <div class="list-header-post-billing-2">
              <h6>Articles for ${productName}</h6>
              <button class="btn-close-list-post-billing-2" onclick="closeSubProductList()">✕</button>
            </div>
            ${subProducts.map(sub => `
              <div class="sub-product-post-billing-2">
                <span>${sub.name} - Code: ${sub.code}</span>
                <button class="btn-add-post-billing-2" data-id="${sub.id}" onclick="addItem(2,this)">+</button>
              </div>
            `).join('')}
          `;
        } else {
          subProductList.innerHTML = `
            <div class="list-header-post-billing-2">
              <h6>Articles for ${productName}</h6>
              <button class="btn-close-list-post-billing-2" onclick="closeSubProductList()">✕</button>
            </div>
            <div class="sub-product-post-billing-2">No articles available</div>
          `;
        }

        subProductList.classList.add('active');
      } catch (error) {
        console.error('Error displaying articles:', error);
        const subProductList = document.getElementById('subProductList');
        subProductList.innerHTML = `
          <div class="list-header-post-billing-2">
            <h6>Articles for ${element.querySelector('.product-name-post-billing-2').textContent.trim()}</h6>
            <button class="btn-close-list-post-billing-2" onclick="closeSubProductList()">✕</button>
          </div>
          <div class="sub-product-post-billing-2">Error loading articles</div>
        `;
        subProductList.classList.add('active');
      }
    }

    // Close article list
    function closeSubProductList() {
      const subProductList = document.getElementById('subProductList');
      subProductList.classList.remove('active');
      subProductList.innerHTML = '';
      document.querySelectorAll('.product-item-post-billing-2').forEach(item => {
        item.classList.remove('active');
      });
      selectedProductName = '';
      //document.getElementById('taSelected').textContent = 'No T/A Selected';
      resetInputs();
    }


   
 
    // Reset transaction detail inputs
    function resetInputs() {
      document.getElementById('taCode1PostBilling').value = '';
      document.getElementById('quantityPostBilling').value = '1';
      document.getElementById('billNoPostBilling').value = '';
      document.getElementById('pricePostBilling').value = '0';
      document.getElementById('amountPostBilling').value = '0';
      document.getElementById('priceNetPostBilling').value = '0';
      document.getElementById('amountNetPostBilling').value = '0';
      // document.getElementById('winNoPostBilling').value = '';
    //  document.getElementById('taSelected').textContent = 'No T/A Selected';
    }
    var cartArrticle;
    function addItem(type, button) {
        var dataId = button.getAttribute('data-id');
        var filteredSubGroupTransaction = [];
        var filteredSubGroupTransaction2 = [];
        if (type == 2) {
            filteredSubGroupTransaction = articleList.filter(function (item) {
                return item.id == dataId;
            });
            filteredSubGroupTransaction2 = transactionList.filter(function (item) {
                return item.code == filteredSubGroupTransaction[0].transactionCode;
            });
        } else {
            filteredSubGroupTransaction2 = transactionList.filter(function (item) {
                return item.code == dataId;
            });
        }
        cartArrticle = filteredSubGroupTransaction[0];
        setValueFormPostArticle(cartArrticle, filteredSubGroupTransaction2[0]);
    }

    function setValueFormPostArticle(cartArrticle, transaction) {

        if (cartArrticle != undefined) {
            $('#articleCodePostBilling').text(cartArrticle.code + ' - ' + cartArrticle.description);
            $('#pricePostBilling, #amountPostBilling, #priceNetPostBilling, #amountNetPostBilling').val(cartArrticle.defaultPrice.toLocaleString('en-US'));
        }
        $('#taCode1PostBilling').val(transaction.code);
        $('#taCode2PostBilling').val(transaction.description);
        $('#quantityPostBilling').val('1');
    }
    function resetInfoPost() {
        $('#taCode1PostBilling, #taCode2PostBilling, #billNoPostBilling, #referencePostBilling, #supplementPostBilling, #desInvoicePostBilling, #checkNoInvoicePostBilling, #invoiceNoPostBilling, #invoiceDatePostBilling, #customerNamePostBilling, #customerAddressPostBilling').val('');
        $('#pricePostBilling, #amountPostBilling, #priceNetPostBilling, #amountNetPostBilling, #totalAmountPostBilling, #taxAmountPostBilling').val('0');
        $('#quantityPostBilling').val('1');
        $('#currencyPostBilling').val('VND');
        $('#articleCodePostBilling').text('');
        $('#rmtChargePostBilling').val('');
        $('#expressService-post-billing').prop('checked', false);
        $('#percentageInput-post-billing').val('');
        $('#percent10-post-billing, #percent50-post-billing, #percent100-post-billing').prop('checked', false);
    }

    var listCart = [];
    class CartItem {
        constructor(transCode, transName, articleCode, articleName, quantity, priceNet, price, amount, amountNet) {
            this.transCode = transCode;
            this.transName = transName;
            this.articleCode = articleCode;
            this.articleName = articleName;
            this.quantity = quantity;
            this.priceNet = priceNet;
            this.price = price;
            this.amount = amount;
            this.amountNet = amountNet;
        }
    }

    function addItemToCart() {
        if (postType == 1 && listCart.length == 1) {
            showToast('Error', "Posted transaction! Please create another post", false);
            return;
        }
        listCart.push(new CartItem(
            $('#taCode1PostBilling').val(),
            $('#taCode2PostBilling').val(),
            $('#articleCodePostBilling').text().split('-')[0],
            $('#articleCodePostBilling').text().split('-')[1],
            $('#quantityPostBilling').val(),
            $('#priceNetPostBilling').val().replace(/\B(?=(\d{3})+(?!\d))/g, ','),
            $('#pricePostBilling').val().replace(/\B(?=(\d{3})+(?!\d))/g, ','),
            $('#amountPostBilling').val().replace(/\B(?=(\d{3})+(?!\d))/g, ','),
            $('#amountNetPostBilling').val().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
        ));
        listSelected();
        resetInfoPost();
    }

    function listSelected() {
        $('#cartList').empty();
        let html = '';
        if (listCart.length > 0) {
            for (let i = 0; i < listCart.length; i++) {
                html += `                                    <li>
                                        <span class="item-name-post-billing-2">${listCart[i].transName} - ${listCart[i].transCode}</span>
                                        <span class="item-quantity-post-billing-2">${listCart[i].quantity}</span>
                                        <span class="item-subtotal-post-billing-2">${listCart[i].amountNet}</span>
                                        <span class="item-remove-post-billing-2"><button data-id="${i}" onclick="removeCartItem(this)">x</button></span>
                                    </li>`;
            }
        } else {
            html = '<li class="list-group-item list-group-item-post-billing">No items in list</li>';
        }
        $('#cartList').append(html);
        
    }
    function deleteAllCartItems() {
        listCart = [];
        listSelected();
    }

    function calculateNetPost(transactionCode, price) {
        $.ajax({
            url: '/Billing/CalculateNet',
            type: 'get',
            dataType: 'json',
            data: {
                transactionCode: transactionCode,
                price: price
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                $('#pricePostBilling').val(price.toLocaleString('en-US'));
                $('#priceNetPostBilling').val(result.toLocaleString('en-US'));
                $('#amountNetPostBilling').val((result * $('#quantityPostBilling').val()).toLocaleString('en-US'));
                $('#amountPostBilling').val((price * $('#quantityPostBilling').val()).toLocaleString('en-US'));
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }

    function calculatePost(transactionCode, price) {
        $.ajax({
            url: '/Billing/CalculatePrice',
            type: 'get',
            dataType: 'json',
            data: {
                transactionCode: transactionCode,
                price: price
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                $('#pricePostBilling').val(result.toLocaleString('en-US'));
                $('#priceNetPostBilling').val(price.toLocaleString('en-US'));
                $('#amountNetPostBilling').val((price * $('#quantityPostBilling').val()).toLocaleString('en-US'));
                $('#amountPostBilling').val((result * $('#quantityPostBilling').val()).toLocaleString('en-US'));
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }
    $("#pricePostBilling").blur(function () {
        var price = parseFloat($('#pricePostBilling').val().replace(/,/g, ''));
        calculateNetPost($('#taCode1PostBilling').val(), price);
    });

    $("#priceNetPostBilling").blur(function () {
        var price = parseFloat($('#priceNetPostBilling').val().replace(/,/g, ''));
        calculatePost($('#taCode1PostBilling').val(), price);
    });

    $("#amountPostBilling").blur(function () {
        var price = parseFloat($('#amountPostBilling').val().replace(/,/g, ''));
        calculateNetPost($('#taCode1PostBilling').val(), price / $('#quantityPostBilling').val());
    });

    $("#amountNetPostBilling").blur(function () {
        var price = parseFloat($('#amountNetPostBilling').val().replace(/,/g, ''));
        calculateNetPost($('#taCode1PostBilling').val(), price / $('#quantityPostBilling').val());
    });

    $("#quantityPostBilling").blur(function () {
        var price = parseFloat($('#amountPostBilling').val().replace(/,/g, ''));
        $('#amountPostBilling').val((price * $("#quantityPostBilling").val()).toLocaleString('en-US'));
        var price2 = parseFloat($('#amountNetPostBilling').val().replace(/,/g, ''));
        $('#amountNetPostBilling').val((price2 * $("#quantityPostBilling").val()).toLocaleString('en-US'));
    });
    function removeCartItem(button) {
        var dataId = button.getAttribute('data-id');
        var index = parseInt(dataId); // Convert dataId to a number
        if (index >= 0 && index < listCart.length) { // Check if index is valid
            listCart.splice(index, 1); // Remove 1 item at the specified index
        }
        listSelected();
    }

    const expressServiceCheckbox = document.getElementById('expressService-post-billing');
    const percentageInput = document.getElementById('percentageInput-post-billing');
    const radioButtons = document.querySelectorAll('input[name="percentage-post-billing"]');
    expressServiceCheckbox.addEventListener('change', () => {
        if (expressServiceCheckbox.checked) {
            percentageInput.value = '50.00';
            $('#referencePostBilling').val('Express Service: 50%');
            document.getElementById('percent50-post-billing').checked = true;
        } else {
            percentageInput.value = '';
            $('#referencePostBilling').val('');
            radioButtons.forEach(radio => radio.checked = false);
        }
    });
    radioButtons.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.checked) {
                percentageInput.value = parseFloat(radio.value).toFixed(2);
                $('#referencePostBilling').val('Express Service: ' + $('#percentageInput-post-billing').val() + '%');
            }
        });
    });

    percentageInput.addEventListener('input', () => {
        const value = parseFloat(percentageInput.value);
        const radioValues = ['10', '50', '100'];
        const matchingRadio = radioValues.find(radioValue => parseFloat(radioValue) === value);

        radioButtons.forEach(radio => {
            radio.checked = false;
        });
        $('#referencePostBilling').val('Express Service: ' + $('#percentageInput-post-billing').val() + '%');
        if (matchingRadio) {
            document.getElementById(`percent${matchingRadio}-post-billing`).checked = true;
        }
    });

    function PostingService() {
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        const shiftID = localStorage.getItem("shiftID");
        const shiftName = localStorage.getItem("shiftName");

        var formData = new FormData();
        formData.append('rsvID', idReservation);
        formData.append('description', $('#taCode2PostBilling').val());
        formData.append('roomID', roomID);
        formData.append('referencePost', $('#referencePostBilling').val());
        formData.append('listItem', JSON.stringify(listCart));
        formData.append('userName', userName);
        formData.append('userID', userID);
        formData.append('postType', postType);
        formData.append('window', $('#winNoPostBilling').val());
        formData.append('shiftID', shiftID);
        formData.append('shiftName', shiftName);

        $.ajax({
            url: '/Billing/PostArticle',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    resetInfoPost();
                    listCart = [];
                    listSelected();
                    searchFolioDetail(0);
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) { }
        });
    }


</script>