<link href="~/css/pages/edit-posting.css" rel="stylesheet" />

<div class="modal fade" id="modalEditPosting" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Edit Posting</h5>
            </div>

            <div class="modal-body pb-0">
                <div class="button-group mb-3">
                    <button type="button" class="mui-button mui-button-save" onclick="EditPosting();">Save</button>
                    <button type="button" class="mui-button mui-button-close" data-bs-dismiss="modal">Close</button>
                </div>
            </div>

            <div class="modal-body pt-0">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label" for="room">Room</label>
                        <input type="text" id="roomEditPosting" class="form-control" readonly>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label" for="name">Name</label>
                        <input type="text" id="nameEditPosting" class="form-control" readonly>
                    </div>
                </div>

                <div class="row mb-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label" for="code">Code</label>
                        <input type="text" id="codeEditPosting" class="form-control" readonly>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label">Description</label>
                        <div id="nameTransactionEditPosting" class="form-control bg-light" style="min-height: 38px;"></div>
                    </div>
                </div>

                <hr class="hr">

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Price</label>
                        <input type="text" id="priceEditPosting" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="quantityEditPosting" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Amount</label>
                        <input type="text" id="amountEditPosing" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Currency</label>
                        <input type="text" id="currency" class="form-control" value="VND" readonly>
                    </div>
                </div>

                <hr class="hr">

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Cashier</label>
                        <input type="text" id="crashierEditPosting" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Win.No</label>
                        <input type="text" id="winNoEditPosting" class="form-control" value="1" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Posting Date</label>
                        <input type="date" id="postingDate" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Add. Date</label>
                        <input type="date" id="additionalDate" class="form-control">
                    </div>
                </div>

                <hr class="hr">

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Check No</label>
                        <input type="text" id="checkNoEditPosting" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Article Code</label>
                        <input type="text" id="articleCodeEditPosting" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Supplement</label>
                        <input type="text" id="supplementEditPosting" class="form-control">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label">Reference</label>
                        <input type="text" id="referenceEditPosting" class="form-control">
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    var checkEditOpen = false;
    function openModalEditPosting(){
        localStorage.setItem("currentFromID", "modalEditPosting");
        const crashierLogin = localStorage.getItem("crashierLogin");
         getFolioDetailMaster();
        if(crashierLogin == "NotYet"){
            openModalShilftLogin();
        }
        else{

            if(checkEditOpen == true){
                $('#modalEditPosting').modal('show');

            }
        }
    }
    function closeModalEditPosting(){
        $('#modalEditPosting').modal('hide');
    }

       function getFolioDetailMaster() {
        var grid = $("#gridContainerBilling").dxDataGrid("instance");
        var selectedRows = grid.getSelectedRowsData();
        var selectedIds = selectedRows.map(row => row.transactionNo);
        if(selectedIds.length == 0){
            checkEditOpen = false;
            showToast('Error', 'Please choose service', false);
            return;
        }
        transactionNoPost = selectedIds[0];
            console.log(selectedRows);
        checkEditOpen = true;
        $.ajax({
            url: '/Billing/GetFolioDetailMasterEdit',
            type: 'get',
            dataType: 'json',
            data: {
                invoiceNoPosting: selectedRows[0].invoiceNo,
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                console.log(result);
                 $("#roomEditPosting").val(roomNo);
                 $("#nameEditPosting").val(lastname);
                 $("#codeEditPosting").val(result.transactionCode);
                 $("#nameTransactionEditPosting").text(result.description);
                 $("#priceEditPosting").val(result.price.toLocaleString('vi-VN'));
                 $("#quantityEditPosting").val(result.quantity);
                const amount = Number(result.price) * Number(result.quantity);
                $("#amountEditPosing").val(amount.toLocaleString('vi-VN'));
                 $("#currency").val("VND");
                 $("#crashierEditPosting").val(result.crashierNo);
                // // $("#winNo").val("30,000.00");
                 $("#postingDate").val(result.transactionDate.split('T')[0]);
                 //$("#additionalDate").val(result.transactionDate.split('T')[0]);
                  $("#additionalDate").val(result.transactionDate.split('T')[0]);
                 $("#articleCodeEditPosting").val(result.articleCode);
                 $("#supplementEditPosting").val(result.supplement);
                 $("#referenceEditPosting").val(result.reference);
                 $("#checkNoEditPosting").val(result.checkNo);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }
    function parseLocaleNumber(str) {
        if (!str) return 0;
        return parseFloat(str.toString().replace(/\./g, '').replace(',', '.')) || 0;
    }

    $("#priceEditPosting").blur(function () {
        var price = parseLocaleNumber($('#priceEditPosting').val());
        var quantity = parseLocaleNumber($('#quantityEditPosting').val()) || 1;

        $('#priceEditPosting').val(price.toLocaleString('vi-VN'));
        $('#amountEditPosing').val((price * quantity).toLocaleString('vi-VN'));
    });

    $("#amountEditPosing").blur(function () {
        var amount = parseLocaleNumber($('#amountEditPosing').val()); 
        var quantity = parseLocaleNumber($('#quantityEditPosting').val()) || 1;

        var price = 0;
        if(quantity !== 0) {
            price = amount / quantity;
        }

        $('#priceEditPosting').val(price.toLocaleString('vi-VN'));
        $('#amountEditPosing').val(amount.toLocaleString('vi-VN'));
    });

    $("#quantityEditPosting").blur(function () {
        var price = parseLocaleNumber($('#priceEditPosting').val()) || 0;
        var quantity = parseLocaleNumber($("#quantityEditPosting").val()) || 1; 

        var newAmount = price * quantity;

        $('#amountEditPosing').val(newAmount.toLocaleString('vi-VN'));
    });

    $("#priceEditPosting, #quantityEditPosting").keypress(function (event) {
        if (event.which === 13 || event.keyCode === 13) {
            event.preventDefault(); 

            $(this).blur();
        }
    });

    function calculateNetPostEdit(transactionCode, price) {
        $.ajax({
            url: '/Billing/CalculateNet',
            type: 'get',
            dataType: 'json',
            data: {
                transactionCode: transactionCode,
                price: price
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                var quantity = parseLocaleNumber($('#quantityEditPosting').val()) || 1;

                $('#priceEditPosting').val(price.toLocaleString('vi-VN'));
                $('#amountEditPosing').val((price * quantity).toLocaleString('vi-VN'));
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }

    function calculatePostEdit(transactionCode, price) {
        $.ajax({
            url: '/Billing/CalculatePrice',
            type: 'get',
            dataType: 'json',
            data: {
                transactionCode: transactionCode,
                price: price
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                var quantity = parseLocaleNumber($('#quantityEditPosting').val()) || 1;

                $('#priceEditPosting').val(result.toLocaleString('vi-VN'));
                $('#amountEditPosing').val((result * quantity).toLocaleString('vi-VN'));
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }

    function EditPosting() {
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        var formData = new FormData();

        var rawPrice = parseLocaleNumber($('#priceEditPosting').val());
        var rawAmount = parseLocaleNumber($('#amountEditPosing').val());
        var rawQuantity = parseLocaleNumber($('#quantityEditPosting').val());

        formData.append('userName', userName);
        formData.append('transactionNo', transactionNoPost);
        formData.append('userID', userID);
        formData.append('quantity', rawQuantity); 
        formData.append('price', rawPrice);       
        formData.append('amount', rawAmount);     
        formData.append('transactionDate', $('#additionalDate').val());
        formData.append('supplement', $('#supplementEditPosting').val());
        formData.append('reference', $('#referenceEditPosting').val());

        $.ajax({
            url: '/Billing/EditPosting',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.code == 0) {
                    closeModalEditPosting();
                    searchFolioDetail(0);
                    // GetBalanceVND(idReservation); // Hàm này chưa thấy khai báo trong snippet, cẩn thận lỗi
                    showToast('Success', data.msg, true);
                } else {
                    showToast('Error', data.msg, false);
                }
            },
            error: function (xhr, statusText, err) {}
        });
    }
</script>