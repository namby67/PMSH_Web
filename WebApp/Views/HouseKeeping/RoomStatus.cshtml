@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var zoneList = ViewBag.ZoneList;
    var roomtypeList = ViewBag.RoomTypeList;
    var roomList = ViewBag.RoomList;
}
@* <link asp-append-version="true" href="~/css/reservation.css" rel="stylesheet" /> *@

<style>
   /*  #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; 
        color: white !important; 
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; 
        color: white !important; 
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

     
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important;
        color: white !important; 
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; 
        color: white !important;
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

       
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }
 */
    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }
    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <!-- From Date -->
        <div class="d-flex flex-column">

            <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="mb-1 fw-bold me-3">Room Status:</label>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="cleannon" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Clean Non-Checked</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="clean" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Clean</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="dirty" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Dirty</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="pickup" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Pickup</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="oocheck" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">OO</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="oscheck" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">OS</label>
                </div>
            </div>
        </div>

        <div class="d-flex flex-column">

            <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="mb-1 fw-bold me-3">FO Status:</label>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="vacant" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Vacant</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="occupied" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Occupied</label>
                </div>

            </div>
        </div>

        <div class="d-flex flex-column">

            <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="mb-1 fw-bold me-3">Reservation Status:</label>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="arrivals" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Arrivals</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="arrived" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Arrived</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="stayover" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Stayover</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input " type="checkbox" id="dayuse" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">DayUse</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="dueout" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Due Out</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="departed" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Departed</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input include-option" type="checkbox" id="notReserved" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">NotReserved</label>
                </div>
                <div class="form-check me-3">
                    <input class="form-check-input " type="checkbox" id="departuredarr" name="masterllio" value="1" checked>
                    <label class="form-check-label" for="cancel">Departured/Arrival</label>
                </div>
            </div>
        </div>

        <div class="d-flex flex-column">

            <!-- Hàng 1: B? l?c Room -->
            <div class="d-flex align-items-center flex-wrap mb-2">
                <label class="fw-bold me-3">Room:</label>

                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-1 mt-1">Room Type:</label>
                    <select id="roomtype" name="roomtype" class="tomselect-custom" multiple>
                        @foreach (var item in roomtypeList)
                        {
                            <option value="@item.Code">@item.Code</option>
                        }
                    </select>
                </div>

                <div class="d-flex align-items-center me-3"> 
                    <label class="me-2 mb-1  mt-1">Zone:</label>
                    <select id="zone" name="zone" class="tomselect-custom" multiple>
                        @foreach (var item in zoneList)
                        {
                            <option value="@item.Code">@item.Code</option>
                        }
                    </select>
                </div>

                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-1 mt-1">From Room:</label>
                    <select id="roomfrom" name="roomfrom" class="form-control form-control-sm" style="width: 100px">
                        <option value=""></option>
                        @foreach (var item in roomList)
                        {
                            <option value="@item.RoomNo">@item.RoomNo</option>
                        }
                    </select>
                </div>

                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-1 mt-1">To Room:</label>
                    <select id="roomto" name="roomto" class="form-control form-control-sm" style="width: 100px">
                        <option value=""></option>
                        @foreach (var item in roomList)
                        {
                            <option value="@item.RoomNo">@item.RoomNo</option>
                        }
                    </select>
                </div>
            </div>

           
        </div>

        <div class="d-flex flex-column">

          
            <div class="d-flex align-items-center flex-wrap mb-2">
                <label class="fw-bold me-3 mb-1">Change Status:</label>

                <div class="form-check me-3">
                    <input class="form-check-input " type="checkbox" id="cleannonup" name="masterllioup" value="1">
                    <label class="form-check-label" for="cleannonup">Clean Non-Checked</label>
                </div>

                <div class="form-check me-3">
                    <input class="form-check-input " type="checkbox" id="dirtyup" name="masterllioup" value="1">
                    <label class="form-check-label" for="dirtyup">Dirty</label>
                </div>

                <div class="form-check me-3">
                    <input class="form-check-input " type="checkbox" id="cleanup" name="masterllioup" value="1" checked>
                    <label class="form-check-label" for="cleanup">Clean</label>
                </div>
            </div>

        </div>
    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px; margin-right: 6px; background-color: indianred" id="btnSelectAll" class="mui-button mui-button-new" type="button">
            <i class="fa-solid fa-check-square"></i> Select All
        </button>

        <button style="border-radius: 4px; margin-right: 6px; background-color: darkgray;" id="btnClearAll" class="mui-button mui-button-new" type="button">
            <i class="fa-solid fa-x"></i> Clear All
        </button>
        <button style="border-radius: 4px; margin-right: 6px; background-color: lightpink" id="btnChangeStatus" class="mui-button mui-button-new" type="button">
            <i class="fa-solid fa-rotate"></i> Chg Status
        </button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color:hotpink;" id="btnChecklog" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Ac.Log</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: darkorange;" id="btnExportPdf" class="mui-button mui-button-new" type="button"><i class="fas fa-eraser"></i> PDF</button>
       <button style="border-radius: 4px;  margin-right: 6px;background-color: chocolate;" id="btnUpdatestatus" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Update</button>
        <button style="border-radius: 4px; margin-right: 6px; background-color: #3b9ac6;" id="btnFlorrflan" class="mui-button mui-button-new" type="button">
            <i class="fa-solid fa-rotate"></i> Floor Flan
        </button>



    </div>
</div>
<!-- N?n m? -->
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>

<!-- Popup -->
<div id="popupChangeStatus" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px;">

    <h5 class="mb-3">Change Room Status</h5>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button id="btnSavePopup" class="btn text-white" style="background-color: #3b9ac6; border-radius: 4px;">
            <i class="fa-solid fa-floppy-disk me-1"></i> Save
        </button>
        <button id="btnClearPopup" class="btn text-white" style="background-color: #3b9ac6; border-radius: 4px;">
            <i class="fa-solid fa-eraser me-1"></i> Clear
        </button>
        <button id="btnClosePopup" class="btn text-white" style="background-color: #3b9ac6; border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>


    <!-- ? Room List -->
    <div class="mb-3 d-flex align-items-center gap-2">
        <div class="form-check mb-0">
            <input class="form-check-input" type="checkbox" id="checkRoomList" checked>
        </div>
        <label class="fw-bold me-2 mb-0" style="min-width: 90px;">Room List:</label>
        <select id="popupRoomList" class="form-control form-control-sm" multiple style="flex: 1;">
            @foreach (var item in roomList)
            {
                <option value="@item.ID">@item.RoomNo</option>
            }
        </select>
    </div>

    <!-- ? From Room - To Room -->
    <div class="mb-3 d-flex align-items-center gap-2">
        <div class="form-check mb-0">
            <input class="form-check-input" type="checkbox" id="checkRoomRange">
        </div>
        <label class="fw-bold me-2 mb-0" style="min-width: 90px;">From Room:</label>

        <select id="popupRoomFrom" class="form-control form-control-sm" style="width: 120px;">
            <option value=""></option>
            @foreach (var item in roomList)
            {
                <option value="@item.RoomNo">@item.RoomNo</option>
            }
        </select>

        <span class="fw-bold">? To</span>

        <select id="popupRoomTo" class="form-control form-control-sm" style="width: 120px;">
            <option value=""></option>
            @foreach (var item in roomList)
            {
                <option value="@item.RoomNo">@item.RoomNo</option>
            }
        </select>
    </div>

    <div class="d-flex flex-column mt-2">
        <label class="fw-bold mb-2">Change Status:</label>

        <!-- Dòng ch?a các checkbox -->
        <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" id="cleannonupop" name="masterlliouppop" value="1">
                <label class="form-check-label" for="cleannonup">Clean Non-Checked</label>
            </div>

            <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" id="dirtyupop" name="masterlliouppop" value="1">
                <label class="form-check-label" for="dirtyup">Dirty</label>
            </div>

            <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" id="cleanupop" name="masterlliouppop" value="1">
                <label class="form-check-label" for="cleanupop">Clean</label>
            </div>

            <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" id="pickup" name="masterlliouppop" value="1">
                <label class="form-check-label" for="pickup">Pickup</label>
            </div>

            <div class="form-check me-3">
                <input class="form-check-input" type="checkbox" id="dueout" name="masterlliouppop" value="1">
                <label class="form-check-label" for="dueout">Due Out</label>
            </div>
        </div>
    </div>


</div>
<!-- Popup log tr?ng thái -->
<div id="popupLogGrid" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 1000px; max-height: 600px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 class="mb-0">Room Status History</h5>
        <div class="d-flex justify-content-start mb-3 gap-2">
            <button id="btnSearchHis" class="btn text-white" style="background-color: #3b9ac6; border-radius: 4px;">
                <i class="fa-solid fa-floppy-disk me-1"></i> Search
            </button>
            <button onclick="$('#popupLogGrid').hide()" class="btn btn-sm btn-danger" style="background-color: #3b9ac6; border-radius: 4px;">
                <i class="fa-solid fa-xmark me-1"></i> Close
            </button>
        </div>
    </div>
    <div class="d-flex align-items-center flex-wrap mb-2">
        <label class="fw-bold me-3">Room:</label>

        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">Room:</label>
            <select id="roomstatus" name="roomstatus" class="form-control form-control-sm" style="width: 100px">
                <option value=""></option>
                @foreach (var item in roomList)
                {
                    <option value="@item.ID">@item.RoomNo</option>
                }
            </select>
        </div>

        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">User name:</label>
            <input id="username" type="text" class="form-control form-control-sm" placeholder="Enter user name" style="width: 100px;">
        </div>
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">From Date:</label>
            <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
        </div>

        <!-- To Date -->
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">To Date:</label>
            <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
        </div>

    </div>
    <div id="logGridContainer" class="gridContainer mt-2"></div>
</div>



<div class="mui-card">
    @*     <div style="font-size: 20px;" class="mt-1" id="reportTitle"></div> *@
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>


        function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }

        $(document).ready(function () {
                    const today = new Date();

           const firstDayOfMonth = new Date(today);
        firstDayOfMonth.setDate(today.getDate() - 1);

        // Ngày hôm nay
        const lastDayOfMonth = new Date(today);

        // Ð?nh d?ng theo local time
        const formattedFirstDay = formatDate(firstDayOfMonth);
        const formattedLastDay = formatDate(lastDayOfMonth);

        console.log(formattedFirstDay); // Ki?m tra giá tr? dúng chua
        console.log(formattedLastDay); // Ki?m tra giá tr? dúng chua
        // Gán giá tr? cho input date
    $('#fromDate').val(formattedFirstDay);
    $('#toDate').val(formattedLastDay);

                 $("#btnPrint").trigger("click");
             document.getElementById("reportTitle").innerText = 'Room Status';

               $("input[name='masterllioup']").on("change", function () {
                 $("input[name='masterllioup']").not(this).prop("checked", false);
              });

               $("input[name='masterlliouppop']").on("change", function () {
                 $("input[name='masterlliouppop']").not(this).prop("checked", false);
              });
              $('#btnSelectAll').click(function () {
                $('.include-option').prop('checked', true);
            });

            // Khi nh?n "Clear All" => b? check t?t c? checkbox có class include-option
            $('#btnClearAll').click(function () {
                $('.include-option').prop('checked', false);
            });

             $('#btnChangeStatus').click(function () {
                $('#overlay').fadeIn(200);
                $('#popupChangeStatus').fadeIn(200);
             });

        // Ðóng popup
            $('#btnClosePopup, #overlay').click(function () {
                $('#popupChangeStatus').fadeOut(200);
                $('#overlay').fadeOut(200);
                     // $("#btnPrint").trigger("click");
                     //          const grid = $("#gridContainer").dxDataGrid("instance"); var selectedReport2 = '@ViewBag.ReportTitle';
                     //   grid.refresh();
            });
           $('#checkRoomList').change(function () {
                $('#checkRoomRange').prop('checked', false);
                updateRoomInputs();
           });

            $('#checkRoomRange').change(function () {
                $('#checkRoomList').prop('checked', false);
                updateRoomInputs();
            });

            // N?u ngu?i dùng click label ? set checked và g?i l?i logic
            $('label[for="checkRoomList"]').click(function () {
                $('#checkRoomList').prop('checked', true).trigger('change');
            });

            $('label[for="checkRoomRange"]').click(function () {
                $('#checkRoomRange').prop('checked', true).trigger('change');
            });


             $('#btnClearPopup').on('click', function () {
        // B? ch?n t?t c? option trong Room List (multiple select)
                $('#popupRoomList').val([]).trigger('change');

                // Reset From Room và To Room v? r?ng
                $('#popupRoomFrom').val('');
                $('#popupRoomTo').val('');

                // B? check 2 checkbox
                $('#checkRoomList').prop('checked', false);
                $('#checkRoomRange').prop('checked', false);
            });
            // G?i kh?i t?o ban d?u
           initializePopupRoomListTomSelect();
           updateRoomInputs();
            initializeTomSelects();

        });
        function initializeTomSelects() {
        const selectors = ["#roomtype","#zone"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }

        function updateRoomInputs() {
            const useList = $('#checkRoomList').is(':checked');

            $('#checkRoomRange').prop('checked', !useList);

            const popupRoomListEl = document.querySelector("#popupRoomList");
            if (popupRoomListEl.tomselect) {
                popupRoomListEl.tomselect.setDisabled(!useList);
            } else {
                $('#popupRoomList').prop('disabled', !useList);
            }

            $('#popupRoomFrom, #popupRoomTo').prop('disabled', useList);
        }
         $("#btnFlorrflan").on("click", function () {
                window.location.href = "/HouseKeeping/FloorPlan";
       
        });

        function initializePopupRoomListTomSelect() {
            const el = document.querySelector("#popupRoomList");
            if (!el) return;

            // N?u dã du?c kh?i t?o thì hu? tru?c
            if (el.tomselect) el.tomselect.destroy();

            new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: 'Select rooms...',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });
        }

    $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $("#loadingSpinner").show();

        // ROOM STATUS
        let cleannon_room = $("#cleannon").is(":checked") ? 1 : 0;
        let clean = $("#clean").is(":checked") ? 1 : 0;
        let dirty = $("#dirty").is(":checked") ? 1 : 0;
        let pickup = $("#pickup").is(":checked") ? 1 : 0;
        let oocheck = $("#oocheck").is(":checked") ? 1 : 0;
        let oscheck = $("#oscheck").is(":checked") ? 1 : 0;

        // FO STATUS
        let vacant = $("#vacant").is(":checked") ? 1 : 0;
        let occupied = $("#occupied").is(":checked") ? 1 : 0;

        // RESERVATION STATUS
        let arrivals = $("#arrivals").is(":checked") ? 1 : 0;
        let arrived = $("#arrived").is(":checked") ? 1 : 0;
        let stayover = $("#stayover").is(":checked") ? 1 : 0;
        let dayuse = $("#dayuse").is(":checked") ? 1 : 0;
        let dueout = $("#dueout").is(":checked") ? 1 : 0;
        let departed = $("#departed").is(":checked") ? 1 : 0;
        let notReserved = $("#notReserved").is(":checked") ? 1 : 0;
        let departuredarr = $("#departuredarr").is(":checked") ? 1 : 0;

        // ROOM FILTER
        let roomType = $("#roomtype").val();
        let zone = $("#zone").val();
        let roomFrom = $("#roomfrom").val();
        let roomTo = $("#roomto").val();

        // G?i ajax
        $.ajax({
            url: '/HouseKeeping/RoomStatusData',
            type: 'GET',
            data: {
                cleannon_room: cleannon_room,
                clean: clean,
                dirty: dirty,
                pickup: pickup,
                oocheck: oocheck,
                oscheck: oscheck,

                vacant: vacant,
                occupied: occupied,

                arrivals: arrivals,
                arrived: arrived,
                stayover: stayover,
                dayuse: dayuse,
                dueout: dueout,
                departed: departed,
                notReserved: notReserved,
                departuredarr: departuredarr,

                roomType: roomType,
                zone: zone,
                roomFrom: roomFrom,
                roomTo: roomTo
            },
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    // $("#reportViewerContainer").html(result);
                    // $("#loadingSpinner").hide();
                console.log(result);
            initializeRoomStatusGrid(result);
                        $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });




        let selectedRoomIds = [];
           function initializeRoomStatusGrid(data) {
        const columnWidth = 120;

        $("#gridContainer").dxDataGrid({
            dataSource: data,     
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                 { dataField: "id", caption: "ID", width: columnWidth -10 , visible: false},
                { dataField: "roomNumber", caption: "Room No", width: columnWidth -10 },
                { dataField: "roomType", caption: "Room Type", width: columnWidth  },
                { dataField: "roomName", caption: "Room Name", width: columnWidth +50 },
                { dataField: "roomStatus", caption: "Room Status", width: columnWidth+ 30 },
                { dataField: "foStatus", caption: "FO Status", width: columnWidth  },
        { dataField: "floor", caption: "Floor", width: columnWidth, dataType: "number", format: "#,##0" },
                { dataField: "roomClass", caption: "Room Class", width: columnWidth  },
                { dataField: "reservationStatus", caption: "Resv.Type", width: columnWidth  },
                 { dataField: "arrival", caption: "Arrivals", width: columnWidth , dataType: "date", format: "dd/MM/yyyy" },
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,
            onRowPrepared: function (e) {
                if (e.rowType === "data") {

                    if (e.data?.isTotal) {
                        e.rowElement.css({
                            "font-weight": "bold",
                            "background-color": "#f6f6f6"
                        });
                    }
                }

            },
                onCellPrepared: function (e) {
                    if (e.rowType === "data" && e.column.dataField === "roomStatus") {
                        const status = (e.value || "").toLowerCase();

                        if (status.includes("dirty")) {
                            e.cellElement.css("background-color", "Red"); // d? nh?t
                              e.cellElement.css("color", "white");
                        } else if (status.includes("pickup")) {
                            e.cellElement.css("background-color", "#f740f4"); // tím nh?t
                        } else if (status.includes("clean non-checked")) {
                            e.cellElement.css("background-color", "#1bdff5"); // xanh nu?c bi?n nh?t
                        } else if (status.includes("out of order")) {
                            e.cellElement.css("background-color", "#cf159a"); // h?ng
                              e.cellElement.css("color", "white");
                        } else if (status.includes("clean")) {
                            e.cellElement.css("background-color", "green"); // xanh lá
                            e.cellElement.css("color", "white"); // ch? tr?ng cho d? nhìn
                        }
                    }
                },

               onRowClick: onRowClick,

        });
    }

    function onRowClick(e) {
        selectedRoomIds = [];

        // L?y grid instance
        const dataGrid = $("#gridContainer").dxDataGrid("instance");

        // L?y toàn b? data dã ch?n t? DOM (tr, class dx-selection)
        $("tr.dx-selection").each(function () {
            const rowIndex = $(this).attr("aria-rowindex");

            if (rowIndex) {
                const index = parseInt(rowIndex) - 1; // Vì aria-rowindex b?t d?u t? 1
                const rowData = dataGrid.getVisibleRows()[index]?.data;

                if (rowData && rowData.id) {
                    selectedRoomIds.push(rowData.id);
                }
            }
        });

        console.log("Danh sách ID du?c ch?n:", selectedRoomIds);
    }

    $(document).off("click", "#btnUpdatestatus").on("click", "#btnUpdatestatus", function () {
        if (!selectedRoomIds || selectedRoomIds.length === 0) {
            alert("You must choose at least one room.");
            return;
        }

        // Hi?n th? h?p tho?i xác nh?n
        const confirmChange = confirm("Are you sure you want to change room status?");
        if (!confirmChange) {
            return;
        }

        updateStatus(selectedRoomIds);
    });
        $(document).off("click", "#btnChecklog").on("click", "#btnChecklog", function () {
        if (!selectedRoomIds || selectedRoomIds.length === 0) {
            alert("You must choose at least one room.");
            return;
        }

        const fromDate = $('#fromDate').val();
        console.log(fromDate);
        const toDate = $('#toDate').val();
     const username = $('#username').val();


        checkLogStatus(selectedRoomIds,fromDate,toDate,username);
    });


        $(document).off("click", "#btnSearchHis").on("click", "#btnSearchHis", function () {
        if (!selectedRoomIds || selectedRoomIds.length === 0) {
            alert("You must choose at least one room.");
            return;
        }

        const fromDate = $('#fromDate').val();
        console.log(fromDate);
        const toDate = $('#toDate').val();
     const username = $('#username').val();

      const roomStatusValue = $('#roomstatus').val();
        checkLogStatus(roomStatusValue,fromDate,toDate,username);
    });
         function checkLogStatus(selectedRoomIds,fromDate,toDate,username) {

            $.ajax({
                url: '/HouseKeeping/CheckLogStatus',
                type: 'POST',
                data: {  id: selectedRoomIds,
                    fromDate: fromDate,
                    toDate: toDate,
                    username: username
                },
                headers: {
                    "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                },
                success: function (response) {

                    if (response.length > 0 && response[0].roomNo) {
                        $('#roomstatus').val(response[0].roomNo);
                        selectedRoomIds = [];
                    }


                    // Hi?n th? grid m?i
                    initializeLogStatusGrid(response);

                    // Hi?n th? popup
                    $("#popupLogGrid").show();
                },
                error: function () {
                    alert("Ðã x?y ra l?i khi c?p nh?t tr?ng thái.");
                }
            });
         }

         function updateStatus(selectedRoomIds) {
            let status = 0;

            if ($("#cleannonup").is(":checked")) {
                status = 1;
            } else if ($("#dirtyup").is(":checked")) {
                status = 2;
            } else if ($("#cleanup").is(":checked")) {
                status = 4;
            }

            if (selectedRoomIds.length === 0) {
                alert("You must chose room.");
                return;
            }
                const loginName = JSON.parse(localStorage.getItem("Loginname"));
            $.ajax({
                url: '/HouseKeeping/UpdateRoomStatus',
                type: 'POST',
                data: { ids: selectedRoomIds  , status: status,loginName:loginName},
                headers: {
                    "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                },
                success: function (response) {
                   if (response.success) {
                        alert(response.message);
                       $("#btnPrint").trigger("click");
                              const grid = $("#gridContainer").dxDataGrid("instance"); var selectedReport2 = '@ViewBag.ReportTitle';
                       grid.refresh();

                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert("Ðã x?y ra l?i khi c?p nh?t tr?ng thái.");
                }
            });
         }

        $(document).off("click", "#btnSavePopup").on("click", "#btnSavePopup", function () {
            $("#loadingSpinner").show();

            // Determine status from checkboxes
            let status = 0;
            if ($("#cleannonupop").is(":checked")) {
                status = 1;
            } else if ($("#dirtyupop").is(":checked")) {
                status = 2;
            } else if ($("#cleanupop").is(":checked")) {
                status = 4;
            } else if ($("#dueout").is(":checked")) {
                status = 7;
            } else if ($("#pickup").is(":checked")) {
                status = 3;
            }

            if (status === 0) {
                alert("Please select a room status.");
                $("#loadingSpinner").hide();
                return;
            }

            // Get room list
            let isFromTo = 0;
            let roomIds = [];

            if ($("#checkRoomRange").is(":checked")) {
                isFromTo = 1;
                let from = $("#popupRoomFrom").val();
                let to = $("#popupRoomTo").val();

                if (!from || !to) {
                    alert("Please select both From and To rooms.");
                    $("#loadingSpinner").hide();
                    return;
                }

                roomIds = [from, to]; // Let server handle range
            } else if ($("#checkRoomList").is(":checked")) {
                isFromTo = 0;
                roomIds = $("#popupRoomList").val();

                if (!roomIds || roomIds.length === 0) {
                    alert("Please select at least one room.");
                    $("#loadingSpinner").hide();
                    return;
                }
            } else {
                alert("Please choose how to select rooms (List or From ? To).");
                $("#loadingSpinner").hide();
                return;
            }
             const loginName = JSON.parse(localStorage.getItem("Loginname"));
            // Send AJAX
            $.ajax({
                url: '/HouseKeeping/UpdateRoomStatusPopup',
                type: 'POST',
                data: {
                    status: status,
                    roomIds: roomIds,
                    isFromTo: isFromTo,
                    loginName:loginName
                },
                traditional: true,
                crossDomain: false,
                headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (response) {
                   if (response.success) {
                        alert(response.message);


                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert("Failed to update room status.");
                    $("#loadingSpinner").hide();
                }
            });
        });

            function initializeLogStatusGrid(data) {
        const columnWidth = 130;

        $("#logGridContainer").dxDataGrid({
            dataSource: data,    
            allowColumnResizing: true,
            columnAutoWidth: true,
            showBorders: true,
            columns: [
                { dataField: "roomNo", caption: "Room No", width: columnWidth },
                { dataField: "oldValue", caption: "Old Value", width: columnWidth },
                { dataField: "newValue", caption: "New Value", width: columnWidth },
                { dataField: "userName", caption: "User Name", width: columnWidth },
                { dataField: "action", caption: "Action", width: columnWidth },
                { dataField: "computerName", caption: "Computer", width: columnWidth },
                { dataField: "changeDate", caption: "Change Date", width: columnWidth + 30 , dataType: "date", format: "dd/MM/yyyy" },
            ],
            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
    }



        $("#btnExportExcel").click(function () {
                   const grid = $("#gridContainer").dxDataGrid("instance"); var selectedReport2 = '@ViewBag.ReportTitle';
            var selectedReport = '@ViewBag.ReportTitle';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
            worksheet.addRow(['Công ty C? ph?n Gi?i pháp Công ngh? CS-Solution']);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });



        // Nút xu?t PDF
           $("#btnExportPdf").click(function () {
            const { jsPDF } = window.jspdf; // ?? B? sung dòng này

            const doc = new jsPDF();

            DevExpress.pdfExporter.exportDataGrid({
                jsPDFDocument: doc,
                component: $("#gridContainer").dxDataGrid("instance"),
                autoTableOptions: {
                    styles: { cellPadding: 2, fontSize: 8 },
                    margin: { top: 20 }
                }
            }).then(() => {
                doc.save("BaoCao.pdf");
            });
        });
</script>