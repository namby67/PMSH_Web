@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var listrt = ViewBag.RoomTypeList;
    var listzone = ViewBag.ZoneList;
    var hkpSectionlist = ViewBag.hkpSectionList;

    var listatt = ViewBag.hkpAttendantList;
    var listhkpFT = ViewBag.hkpFacilityTaskList;
}
@* <link asp-append-version="true" href="~/css/reservation.css" rel="stylesheet" /> *@

<style>
    /*     #gridContainer .dx-datagrid-rowsview .dx-selection {
            background-color: #005f87 !important;
            color: white !important;
        }

            #gridContainer .dx-datagrid-rowsview .dx-selection * {
                color: white !important;
            }

        .dx-datagrid-headers .dx-header-row td {
            white-space: pre-line !important;
            text-align: center;
            font-size: 11px;
        }


        .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
            display: none;
        }

        #gridContainer .dx-datagrid-rowsview .dx-row > td {
            padding-top: 2px !important;
            padding-bottom: 2px !important;
            font-size: 12px !important;
            line-height: 24px !important;
        }

        #gridContainer .dx-datagrid-headers {
            background-color: #3b9ac6 !important;
            color: white !important;
        }

            #gridContainer .dx-datagrid-headers .dx-header-row > td {
                padding-top: 12px !important;
                padding-bottom: 12px !important;
                font-size: 12px !important;
            }

            #gridContainer .dx-datagrid-headers .dx-header-row > td {
                background-color: #3b9ac6 !important;
                color: white !important;
                font-weight: bold;
                border-right: 1px solid #ddd !important;
                text-align: center !important;
            }

            #gridContainer .dx-datagrid-rowsview td,
            #gridContainer .dx-datagrid-headers td {
                border-right: 1px solid #ddd !important;
            }


            #gridContainer .dx-datagrid-rowsview tr td:last-child,
            #gridContainer .dx-datagrid-headers tr td:last-child {
                border-right: none !important;
            }

        #gridContainer .dx-datagrid-rowsview .dx-selection {
            background-color: #01579b !important;
            color: white !important;
        }

            #gridContainer .dx-datagrid-rowsview .dx-selection * {
                color: white !important;
            }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox {
            height: 24px !important;
            min-height: 24px !important;
        }

            #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
                font-size: 12px !important;
                height: 24px !important;
            }

        #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
        #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
            height: 24px !important;
            line-height: 24px !important;
            padding: 2px 6px !important;
            font-size: 12px !important;
            box-sizing: border-box;
        }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox,
        #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
            height: 26px !important;
            min-height: 26px !important;
            font-size: 12px !important;
        }
     */
    .status-color-box {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 4px;
        vertical-align: middle;
        border: 1px solid #ccc;
    }

    .color-clean-uncheck {
        background-color: cyan;
    }

    .color-dirty {
        background-color: red;
    }

    .color-outoforder {
        background-color: lightgray;
    }

    .color-pickup {
        background-color: yellow;
    }

    .color-clean {
        background-color: lime;
    }

    .color-outofservices {
        background-color: lightgray;
    }
    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    /*     #gridContainer .dx-datagrid-rowsview .dx-selection {
            background-color: #01579b !important;
            color: white !important;
        } */

    #gridContainer .dx-datagrid-rowsview .dx-selection * {
        color: white !important;
    }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3">
                    <label class="mb-1 me-2 fw-bold">Turndown Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="required" name="includeOptionsTurndown" value="1" checked>
                        <label class="form-check-label" for="required">Required</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="notrequired" name="includeOptionsTurndown" value="2" checked>
                        <label class="form-check-label" for="notrequired">Not Required</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="completed" name="includeOptionsTurndown" value="3" checked>
                        <label class="form-check-label" for="completed">Completed</label>
                    </div>
                    <label class="mb-1 me-2 fw-bold">Reservation Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="arrivals" name="includeOptionsReservation" value="5" checked>
                        <label class="form-check-label" for="arrivals">Arrivals</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="arrived" name="includeOptionsReservationVI" value="1" checked>
                        <label class="form-check-label" for="arrived">Arrived</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="stayover" name="includeOptionsReservation" value="1,6" checked>
                        <label class="form-check-label" for="stayover">Stay Over</label>
                    </div>
                </div>
            </div>



            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3">
                    <label class="mb-1 me-2 fw-bold">Room Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-clean-uncheck"></span>
                        <input class="form-check-input" type="checkbox" id="cleanNoncheck" name="includeOptionsRoom" value="1" checked>
                        <label class="form-check-label" for="cleanNoncheck">Clean Non-Checked</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-dirty"></span>
                        <input class="form-check-input" type="checkbox" id="dirty" name="includeOptionsRoom" value="2" checked>
                        <label class="form-check-label" for="dirty">Dirty</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-outoforder"></span>
                        <input class="form-check-input" type="checkbox" id="outofOrder" name="includeOptionsRoom" value="5" checked>
                        <label class="form-check-label" for="outofOrder">Out of Order</label>
                    </div>

                    <!-- Pickup -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-pickup"></span>
                        <input class="form-check-input" type="checkbox" id="pickup" name="includeOptionsRoom" value="3" checked>
                        <label class="form-check-label" for="pickup">Pickup</label>
                    </div>

                    <!-- Clean -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-clean"></span>
                        <input class="form-check-input" type="checkbox" id="clean" name="includeOptionsRoom" value="4" checked>
                        <label class="form-check-label" for="clean">Clean</label>
                    </div>

                    <!-- Out of Services -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-outofservices"></span>
                        <input class="form-check-input" type="checkbox" id="outofServices" name="includeOptionsRoom" value="6" checked>
                        <label class="form-check-label" for="outofServices">Out of Services</label>
                    </div>
                </div>
            </div>


            <div class="d-flex flex-column">
                <!-- Row 1 -->
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="mb-1 me-2 fw-bold">Advance Search:</label>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">From Room:</label>
                        <input type="text" id="fromRoom" name="fromRoom" class="form-control form-control-sm w-auto" />
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">To Room:</label>
                        <input type="text" id="toRoom" name="toRoom" class="form-control form-control-sm w-auto" />
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Room Type:</label>
                        <select id="roomTypead" name="roomTypead" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in listrt)
                            {
                                <option value="@item.Code">@item.Code</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Row 2: Section & Zone -->
                <div class="d-flex align-items-center me-3 mb-2">
                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Section:</label>
                        <select id="sectionAd" name="sectionAd" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in hkpSectionlist)
                            {
                                <option value="@item.ID">@item.Code</option>
                            }
                        </select>
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Zone:</label>
                        <select id="zoneAd" name="zoneAd" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in listzone)
                            {
                                <option value="@item.Code">@item.Code</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnViewTurndown" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-eye"></i> View</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCheckAll" class="mui-button mui-button-advance" type="button"> <i class="fa-solid fa-check-double"></i> Check All</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button style="border-radius: 4px; margin-right: 6px; " id="btnResvGuest" class="mui-button mui-button-search" type="button">
            <i class="fa-solid fa-calendar-week"></i> Resv
        </button>
        <button style="border-radius: 4px; margin-right: 6px; " id="btnTsheet" class="mui-button mui-button-card" type="button"><i class="fa-solid fa-list"></i> T.sheet</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAutotasksheet" class="mui-button mui-button-option" type="button"><i class="fa-solid fa-gear"></i>Auto</button>
    </div>
</div>


<div class="mui-card">
    <div id="logGriTurndownContainer" class="gridContainer mt-2">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>
<div id="popupAuTo" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 400px; max-height: 600px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 class="mb-0"> Generating Turndown Tasksheets</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnSaveAuto" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Ok</button>
        <button onclick="$('#popupAuTo').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="sticky-header bg-white p-2 shadow-sm z-3">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
            <div class="d-flex align-items-center flex-wrap mb-2">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center me-3">
                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Task Date:</label>
                            <input type="date" id="taskdateauto" name="taskdateauto" class="form-control form-control-sm w-auto" disabled />
                        </div>




                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0"> Attendants:</label>
                            <select id="attendantauto" name="attendantauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listatt)
                                {
                                    <option value="@item.ID">@item.Name</option>
                                }
                            </select>

                        </div>
                      
                    </div>
                </div>

                <div class="d-flex flex-column">
                    <!-- Row 1 -->
                    <div class="d-flex align-items-center me-3 mb-2">

                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Max. Credits:</label>
                            <input type="text" id="maxcreditauto" name="maxcreditauto" class="form-control form-control-sm w-auto" value="0" />
                        </div>

                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">FacilityTask:</label>
                            <select id="taskcodeauto" name="taskcodeauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listhkpFT)
                                {
                                    <option value="@item.ID">@item.Description</option>
                                }
                            </select>

                        </div>
                    </div>


                </div>
            </div>

        </div>
    </div>

</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
        function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }

            let parsedBusinessDate = null;
        $(document).ready(function () {
                $("#btnViewTurndown").trigger("click");
             document.getElementById("reportTitle").innerText = 'Makeup Service Room';
                var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
            console.log(businessDateStr);
             // Lấy phần ngày tháng năm
             var dateOnly = businessDateStr.split(' ')[0]; // '8/29/2024'
             var dateParts = dateOnly.split('/'); // ['8', '29', '2024']

             // Parse đúng thứ tự: new Date(year, monthIndex, day)
              parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

             // Gán vào input type="date"
             $('#taskdateauto').val(formatDate(parsedBusinessDate));
               initializeTomSelects();


        });
       
        function initializeTomSelects() {
                const selectors = ["#sectionAd","#roomTypead","#zoneAd","#attendantauto","#taskcodeauto"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
            }

            $("#btnAutotasksheet").on("click", function () {
                if (selectedRowData.length > 0) {
                    // ví dụ lấy dòng đầu tiên để hiển thị popup
                    let firstRow = selectedRowData[0];
                    console.log("First selected row:", firstRow);

                    $('#overlay').fadeIn(200);
                    $('#popupAuTo').fadeIn(200);
                } else {
                    showToast("Error", "Please select a row first!", false);
                }
            });

           $('#btnClosePopup, #overlay').click(function () {
                $('#popupNewGrid').fadeOut(200);
                $('#overlay').fadeOut(200);
           });

            $("#btnSaveAuto").on("click", function () {
                  const userName = JSON.parse(localStorage.getItem("Loginname"));
                  const roomIDs = (selectedRowData && selectedRowData.length > 0) ? selectedRowData.map(r => r.roomID).join(","): "";
                $.ajax({
                    url: '/HouseKeeping/AutoMakeupServiceRoom',
                    type: 'POST',
                    data: {
                        taskdateauto: $("#taskdateauto").val(),
                      
                        taskcodeauto: $("#taskcodeauto").val()?.map(r => r.replace("''")).join(",") || "",
                        attendantauto: $("#attendantauto").val()?.map(r => r.replace("''")).join(",") || "",
                        maxcreditauto: $("#maxcreditauto").val(),
                        userName:userName,
                        roomIDs: roomIDs
                    },
                    traditional: true,
                    crossDomain: false,
                    headers: {
                        "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                    },
                    success: function (result) {
                        if (result.success) {
                            showToast('Success', result.message, true);
                               $("#btnPrint").trigger("click");
                             


                                var taskSelect = $("#taskcodeauto")[0]?.tomselect;
                                if (taskSelect) taskSelect.clear();

                                var attendantSelect = $("#attendantauto")[0]?.tomselect;
                                if (attendantSelect) attendantSelect.clear();

                                $("#maxcreditauto").val("");
                        } else {
                            showToast('Error', result.message, false);
                        }
                        $("#loadingSpinner").hide();
                    },
                    error: function () {
                        alert("Không thể tải báo cáo.");
                        $("#loadingSpinner").hide();
                    }
                });
            });

         $("#btnViewTurndown").on("click", function () {
                     $("#loadingSpinner").show();
                    const selectedStatuses = [];
                    $("input[name='includeOptionsRoom']:checked").each(function () {
                        selectedStatuses.push($(this).val());
                    });

                      const selectedReservation = [];
                    $("input[name='includeOptionsReservation']:checked").each(function () {
                        selectedReservation.push($(this).val());
                    });

                           const selectedTurndown = [];
                    $("input[name='includeOptionsTurndown']:checked").each(function () {
                        selectedTurndown.push($(this).val());
                    });
                    $.ajax({
                        url: '/HouseKeeping/ViewTurnDown',
                        type: 'GET',
                        data: {

                                    roomTypead: $("#roomTypead").val()?.map(r => r.replace("''")).join(",") || "",
                                      sectionAd: $("#sectionAd").val()?.map(r => r.replace("''")).join(",") || "",
                                        zoneAd: $("#zoneAd").val()?.map(r => r.replace("''")).join(",") || "",
                                    fromRoom: $("#fromRoom").val(),
                                      toRoom: $("#toRoom").val(),
                                       HKStatusID: selectedStatuses.join(","),
                                          ReservationStatus: selectedReservation.join(","),
                                       arrived: $("#arrived").is(":checked") ? "1" : "",
                                                  turndownStatus: selectedTurndown.join(","),

                        },
                        traditional: true,
                            crossDomain: false,
                            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                        success: function (result) {
                            // $("#reportViewerContainer").html(result);
                            // $("#loadingSpinner").hide();
                                    console.log(result);
                                         initializeViewTurnDownGrid(result);
                                $("#loadingSpinner").hide();
                        },
                        error: function () {
                            alert("Không th? t?i báo cáo.");
                            $("#loadingSpinner").hide();
                        }
                    });
              });
              let toggleSelectAll = false;
               let selectedRowData = null;
    function initializeViewTurnDownGrid(data) {
                    const columnWidth = 120;

                    $("#logGriTurndownContainer").dxDataGrid({
                        dataSource: data,          
                         height: "100%",
                        columnAutoWidth: false,   
                        wordWrapEnabled: true,   
                        allowColumnResizing: true, 
                        columns: [
                              {
                            dataField: "hkstatusID",
                            caption: "C",
                            width: columnWidth - 60,
                            cellTemplate: function (container, options) {
                                const colorClass = getStatusColorClass(options.value);
                                $("<div>")
                                    .addClass("status-color-box")
                                    .addClass(colorClass)
                                    .css({
                                        width: "20px",
                                        height: "20px",
                                        borderRadius: "4px"
                                    })
                                    .appendTo(container);
                            }
                        },

                            { dataField: "roomNo", caption: "Room", width: columnWidth },
                            { dataField: "roomType", caption: "Room Type", width: columnWidth },
                            { dataField: "hkstatusID", caption: "Room Status", width: columnWidth+20 },
                            { dataField: "vip", caption: "Vip", width: columnWidth },
                            { dataField: "nationanity", caption: "Nationanity", width: columnWidth },
                            { dataField: "guestName", caption: "Name", width: columnWidth+80  },
                            { dataField: "status", caption: "Status", width: columnWidth },
                            { dataField: "turndownStatus", caption: "Turndown Status", width: columnWidth+40 },
                        ],

                        paging: { pageSize: 25 },
                        scrolling: {
                            useNative: true,
                            showScrollbar: "always"
                        },
                        pager: {
                            visible: true,
                            allowedPageSizes: [25, 50, 'all'],
                            showPageSizeSelector: true,
                            showInfo: true,
                            showNavigationButtons: true
                        },
                        filterRow: { visible: true, applyFilter: "auto" },
                        headerFilter: { visible: true },
                         selection: {
                            mode: "multiple",
                            showCheckBoxesMode: "always"
                        },

                        showBorders: true,

                        onSelectionChanged: function (e) {
                           if (e.selectedRowsData.length > 0) {
                                selectedRowData = e.selectedRowsData; // ✅ giữ tất cả các dòng
                                console.log("Selected rows:", selectedRowData);
                            } else {
                                selectedRowData = [];
                                console.log("No row selected");
                            }
                        }
                    });
                }

                    function getStatusColorClass(statusName) {
                        switch (statusName.trim().toLowerCase()) {
                            case "clean non-checked":
                                return "color-clean-uncheck";
                            case "dirty":
                                return "color-dirty";
                            case "pickup":
                                return "color-pickup";
                            case "clean":
                                return "color-clean";
                            case "out of order":
                                return "color-outoforder";
                            case "out of services":
                                return "color-outofservices";
                            default:
                                return "";
                        }
                    }

               // xử lý khi bấm nút Resv
            $("#btnResvGuest").on("click", function () {
                if (selectedRowData && selectedRowData.length > 0 && selectedRowData[0].reservationID) {
                    // chuyển trang kèm id của dòng đầu tiên
                    window.location.href = "/Reservation/SearchReservation?id=" + selectedRowData[0].reservationID;
                } else {
                    showToast("Error", "Please select a row first!", false);
                }
            });

            $("#btnTsheet").on("click", function () {
               
                    window.location.href = "/HouseKeeping/TurndownTasksheet";
               
            });

           $("#btnCheckAll").on("click", function () {
                const grid = $("#logGriTurndownContainer").dxDataGrid("instance");

                if (!toggleSelectAll) {
                    grid.selectAll();   // chọn hết
                    toggleSelectAll = true;
                    $(this).html('<i class="fa-solid fa-xmark"></i> Uncheck All'); // đổi text/icon
                } else {
                    grid.deselectAll(); // bỏ chọn hết
                    toggleSelectAll = false;
                    $(this).html('<i class="fa-solid fa-check-double"></i> Check All');
                }
            });

        $("#btnExportExcel").click(function () {
                   const grid = $("#logGriTurndownContainer").dxDataGrid("instance");
            var selectedReport = 'MakeupServiceRoom';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
            worksheet.addRow(['Công ty C? ph?n Gi?i pháp Công ngh? CS-Solution']);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
</script>