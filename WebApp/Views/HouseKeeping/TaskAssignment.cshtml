@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var listhkpFT = ViewBag.hkpFacilityTaskList;
    var listhkpTS = ViewBag.hkpTaskSheetList;
    var listzone = ViewBag.ZoneList;
    var hkpSectionlist = ViewBag.hkpSectionList;
    var  listatt =ViewBag.hkpAttendantList;
    var  listrt = ViewBag.RoomTypeList;
    var listflo = ViewBag.FloorList;
}

@* <link asp-append-version="true" href="~/css/reservation.css" rel="stylesheet" /> *@

<style>



    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

  /*   #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; 
        color: white !important; 
    } */

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    .room-status-container {
        font-family: Arial, sans-serif;
        padding: 8px;
    }

    .room-status-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* chia đều 4 cột */
        gap: 6px 10px; /* giảm khoảng cách: 6px dọc, 10px ngang */
        margin-top: 5px;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 3px; /* giảm khoảng cách icon và text */
    }


    .status-color {
        width: 16px;
        height: 16px;
        display: inline-block;
        border: 1px solid #000;
    }
    .status-symbol {
    display: inline-block;
    width: 15px;
    height: 15px;
    text-align: center;
    margin-right: 5px;
    font-weight: bold;
    color: #000;
    background-color: #fff;
    border: 1px solid #ccc;
}

    /* Color mapping like the image */
    .ocn {
        background-color: green;
    }

    .oc {
        background-color: yellow;
    }

    .od {
        background-color: brown;
    }

    .do {
        background-color: purple;
    }

    .vcn {
        background-color: white;
        border: 1px solid black;
    }

    .vc {
        background-color: cyan;
    }

    .vd {
        background-color: navy;
    }

    .ooo {
        background-color: hotpink;
    }

    .status-color-box {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 4px;
        vertical-align: middle;
        border: 1px solid #ccc;
    }

    .color-OCN {
        background-color: #00FF00;
    }
    /* Green */
    .color-OC {
        background-color: #FFFF00;
    }
    /* Yellow */
    .color-OD {
        background-color: #800000;
    }
    /* Dark Red */
    .color-DO {
        background-color: #800080;
    }
    /* Purple */
    .color-VCN {
        background-color: #FFFFFF;
    }
    /* White */
    .color-VC {
        background-color: #00FFFF;
    }
    /* Cyan */
    .color-VD {
        background-color: #0000FF;
    }
    /* Blue */
    .color-OOO {
        background-color: #FF00FF;
    }
    /* Magenta */
    .color-clean-uncheck {
        background-color: cyan;
    }

    .color-dirty {
        background-color: red;
    }

    .color-outoforder {
        background-color: lightgray;
    }

    .color-pickup {
        background-color: yellow;
    }

    .color-clean {
        background-color: lime;
    }

    .color-outofservices {
        background-color: lightgray;
    }

    .dx-context-menu .dx-menu-item .dx-menu-item-content {
        padding: 2px 8px; /* nhỏ gọn */
        font-size: 12px; /* chữ nhỏ */
    }

    .custom-context-menu .dx-menu-separator {
        margin: 3px 0; /* khoảng cách */
    }

    .custom-context-menu {
        font-size: 12px;
    }

    /* Submenu có scroll dọc */
    .dx-submenu .custom-context-menu {
        max-height: 200px; /* chiều cao tối đa (tùy chỉnh) */
        overflow-y: auto;
    }

    /* Style cho item New Task Sheet */
    .dx-context-menu .menu-new-task {
        font-weight: bold;
        color: #007bff;
    }

    /* Divider */
    .dx-context-menu .menu-divider {
        border-bottom: 1px solid #ccc;
        margin: 4px 0;
        height: 1px;
    }



    #logGridNewContainer {
        width: 1450px;
        overflow-x: auto; /* ✅ Scroll ngang */
    }




    #logGridAddUserContainer {
        width: 500px;
        overflow-x: auto; /* ✅ Scroll ngang */
    }


</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <!-- From Date -->

        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Task Date:</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Task Code:</label>
                    <select id="taskcode" name="taskcode" class="tomselect-custom" multiple>
                        @foreach (var item in listhkpFT)
                        {
                            <option value="@item.Description">@item.Description</option>
                        }
                    </select>

                </div>
               
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Task Sheet:</label>
                    <select id="tasksheet" name="tasksheet" class="tomselect-custom" multiple>
                        @foreach (var item in listhkpTS)
                        {
                            <option value="@item.TaskSheetNo">@item.TaskSheetNo</option>
                        }
                    </select>

                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Zone:</label>
                    <select id="zone" name="zone" class="tomselect-custom" multiple>
                        @foreach (var item in listzone)
                        {
                            <option value="@item.Code">@item.Name</option>
                        }
                    </select>

                </div>
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center me-3">
                        <label class="mb-1 me-2"></label>

                        <!-- Clean Uncheck -->
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="pending" name="includeOptions" value="1" checked>
                            <label class="form-check-label" for="Pending">Pending</label>
                        </div>

                        <!-- Dirty -->
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="completed" name="includeOptions" value="2" checked>
                            <label class="form-check-label" for="completed">Completed</label>
                        </div>

                    </div>
                </div>
            </div>
        </div>


    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnReport" class="mui-button mui-button-export" type="button"> <i class="fa-solid fa-file"></i> Report</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnExpanded" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-expand"></i> Expanded</button>

        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAddtasksheet" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-plus"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnDetailtasksheet" class="mui-button mui-button-advance" type="button"><i class="fa-solid fa-circle-info"></i>Detail</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAddUsertasksheet" class="mui-button mui-button-profile" type="button"><i class="fa-solid fa-user-plus"></i>Add User</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnDeletetasksheet" class="mui-button mui-button-delete" type="button"><i class="fa-solid fa-xmark"></i>Delete</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCompletetasksheet" class="mui-button mui-button-reinstate" type="button"><i class="fa-solid fa-check"></i>Complete</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAutotasksheet" class="mui-button mui-button-option" type="button"><i class="fa-solid fa-gear"></i>Auto</button>
    </div>
</div>
<div id="overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;"></div>
<div id="popupNewGridAddUser" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 500px; max-height: 800px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 class="mb-0"> Search Employee</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnSaveEmployee" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Ok</button>
        <button onclick="$('#popupNewGridAddUser').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div id="logGridAddUserContainer" class="gridContainer mt-2">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>
<div id="popupNewGridNew" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px; max-height: 800px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 id="attendantPointTitle" class="mb-0"> Task Sheet Details</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAddRoomtasksheet" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-plus"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnSavetasksheet" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnCompletedetailtasksheet" class="mui-button mui-button-reinstate" type="button"><i class="fa-solid fa-check"></i>Complete</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnAddUserDetailtasksheet" class="mui-button mui-button-profile" type="button"><i class="fa-solid fa-user-plus"></i>Add User</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnDailytasksheet" class="mui-button mui-button-profile" type="button"><i class="fa-solid fa-calendar-check"></i>Daily</button>
        
        <button onclick="$('#popupNewGridNew').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="container mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Sheet:</label>
                <input type="text" id="tasksheetnew" name="tasksheetnew" class="form-control form-control-sm w-auto" disabled/>
            </div>
            <div id="taskcodenewshow">
                <div class="d-flex align-items-center me-3 mb-2" >
                    <label class="me-2 mb-0">Task Code:</label>
                    <select id="taskcodenew" name="taskcodenew" class="tomselect-custom" multiple>
                        <option value=""></option> 
                        @foreach (var item in listhkpFT)
                        {
                            <option value="@item.ID">@item.Description</option>
                        }
                    </select>

                </div>
            </div>
            <div id="attendantshow">
                <div class="d-flex align-items-center me-3 mb-2" >
                    <label class="me-2 mb-0"> Attendant ID:</label>
                    <select id="attendantnew" name="attendantnew" class="form-control form-control-sm w-auto">
                        <option value=""></option>
                        @foreach (var item in listatt)
                        {
                            <option value="@item.ID">@item.Name</option>
                        }
                    </select>

                </div>
            </div>
        </div>


    </div>
    <div id="logGridNewContainer" class="gridContainer mt-2">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>

<div id="popupNewGridAddRoom" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px; max-height: 600px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 id="attendantPointTitle" class="mb-0">Adding Room, task code to Tasksheet</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnSaveRoomtasksheet" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Ok</button>

        <button onclick="$('#popupNewGridAddRoom').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="container mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Date:</label>
                <input type="date" id="taskdate" name="taskdate" class="form-control form-control-sm w-auto" />
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Sheet:</label>
                <input type="text" id="tasksheetroom" name="tasksheetroom" class="form-control form-control-sm w-auto" disabled />
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Room:</label>
                <input type="text" id="roomturndown" name="roomturndown" class="form-control form-control-sm w-auto"/>
                <input type="hidden" id="roomturndownHidden" name="roomturndownHidden" />
                <i id="detailturndowwn" class="fas fa-ellipsis-h ellipsis-icon ms-2" style="cursor:pointer;"></i>   
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Code:</label>
                <select id="taskcodenewroom" name="taskcodenewroom" class="tomselect-custom" multiple>
                    <option value=""></option>
                    @foreach (var item in listhkpFT)
                    {
                        <option value="@item.ID">@item.Description</option>
                    }
                </select>

            </div>
             <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Max. Credits:</label>
                <input type="text" id="maxcredit" name="maxcredit" class="form-control form-control-sm w-auto" value="0" />
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Description:</label>
                <input type="text" id="descriptiontc" name="descriptiontc" class="form-control form-control-sm w-auto" />
            </div>
          
        </div>


    </div>
    <div id="logGridAddRoomContainer" class="gridContainer mt-2">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>
<div id="popupNewGridTurndown" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 1000px; max-height: 600px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 id="attendantPointTitle" class="mb-0">Turndown Management</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnViewTurndown" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-eye"></i> View</button>
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnOkTurndown" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-check"></i> Ok</button>
        <button onclick="$('#popupNewGridTurndown').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="sticky-header bg-white p-2 shadow-sm z-3">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3">
                    <label class="mb-1 me-2 fw-bold">Turndown Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="required" name="includeOptionsTurndown" value="1" checked>
                        <label class="form-check-label" for="required">Required</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="notrequired" name="includeOptionsTurndown" value="2" checked>
                        <label class="form-check-label" for="notrequired">Not Required</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">

                        <input class="form-check-input" type="checkbox" id="completed" name="includeOptionsTurndown" value="3" checked>
                        <label class="form-check-label" for="completed">Completed</label>
                    </div>
                        <label class="mb-1 me-2 fw-bold">Reservation Status: </label>

                        <!-- Clean Uncheck -->
                        <div class="form-check me-3">

                            <input class="form-check-input" type="checkbox" id="arrivals" name="includeOptionsReservation" value="5" checked>
                            <label class="form-check-label" for="arrivals">Arrivals</label>
                        </div>

                        <!-- Dirty -->
                        <div class="form-check me-3">

                            <input class="form-check-input" type="checkbox" id="arrived" name="includeOptionsReservationVI" value="1" checked>
                            <label class="form-check-label" for="arrived">Arrived</label>
                        </div>

                        <!-- Out of Order -->
                        <div class="form-check me-3">

                            <input class="form-check-input" type="checkbox" id="stayover" name="includeOptionsReservation" value="1,6" checked>
                            <label class="form-check-label" for="stayover">Stay Over</label>
                        </div>
                </div>
            </div>
     
            
     
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3">
                    <label class="mb-1 me-2 fw-bold">Room Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-clean-uncheck"></span>
                            <input class="form-check-input" type="checkbox" id="cleanNoncheck" name="includeOptionsRoom" value="1" checked>
                        <label class="form-check-label" for="cleanNoncheck">Clean Non-Checked</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-dirty"></span>
                        <input class="form-check-input" type="checkbox" id="dirty" name="includeOptionsRoom" value="2" checked>
                        <label class="form-check-label" for="dirty">Dirty</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-outoforder"></span>
                            <input class="form-check-input" type="checkbox" id="outofOrder" name="includeOptionsRoom" value="5" checked>
                        <label class="form-check-label" for="outofOrder">Out of Order</label>
                    </div>

                    <!-- Pickup -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-pickup"></span>
                        <input class="form-check-input" type="checkbox" id="pickup" name="includeOptionsRoom" value="3" checked>
                        <label class="form-check-label" for="pickup">Pickup</label>
                    </div>

                    <!-- Clean -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-clean"></span>
                            <input class="form-check-input" type="checkbox" id="clean" name="includeOptionsRoom" value="4" checked>
                        <label class="form-check-label" for="clean">Clean</label>
                    </div>

                    <!-- Out of Services -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-outofservices"></span>
                            <input class="form-check-input" type="checkbox" id="outofServices" name="includeOptionsRoom" value="6" checked>
                        <label class="form-check-label" for="outofServices">Out of Services</label>
                    </div>
                </div>
            </div>


            <div class="d-flex flex-column">
                <!-- Row 1 -->
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="mb-1 me-2 fw-bold">Advance Search:</label>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">From Room:</label>
                        <input type="text" id="fromRoom" name="fromRoom" class="form-control form-control-sm w-auto" />
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">To Room:</label>
                        <input type="text" id="toRoom" name="toRoom" class="form-control form-control-sm w-auto" />
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Room Type:</label>
                        <select id="roomTypead" name="roomTypead" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in listrt)
                            {
                                    <option value="@item.Code">@item.Code</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Row 2: Section & Zone -->
                <div class="d-flex align-items-center me-3 mb-2">
                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Section:</label>
                        <select id="sectionAd" name="sectionAd" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in hkpSectionlist)
                            {
                                <option value="@item.ID">@item.Code</option>
                            }
                        </select>
                    </div>

                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">Zone:</label>
                        <select id="zoneAd" name="zoneAd" class="tomselect-custom" multiple>
                            <option value=""></option>
                            @foreach (var item in listzone)
                            {
                                    <option value="@item.Code">@item.Code</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

        </div>

        </div>
    </div>
    <div id="logGriTurndownContainer" class="gridContainer mt-2">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>
<div id="popupNewGridReport" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px; max-height: 600px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 id="attendantPointTitle" class="mb-0"> Task Sheet Report</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnViewpopExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-eye"></i> View</button>

        <button onclick="$('#popupNewGridReport').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style="background-color: #3b9ac6; border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="container mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Date From:</label>
                <input type="date" id="fromDatere" name="fromDatere" class="form-control form-control-sm w-auto" />
            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">To:</label>
                <input type="date" id="toDatere" name="toDatere" class="form-control form-control-sm w-auto" />
            </div>
         
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0"> Facility Task:</label>
                <select id="taskcodeexpan" name="taskcodeexpan" class="form-control form-control-sm w-auto">
                    <option value=""></option>
                    @foreach (var item in listhkpFT)
                    {
                        <option value="@item.Code">@item.Description</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0"> Attendant ID:</label>
                <select id="attendantrepop" name="attendantrepop" class="form-control form-control-sm w-auto">
                    <option value=""></option>
                    @foreach (var item in listatt)
                    {
                        <option value="@item.ID">@item.Name</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Task Sheet:</label>
                <select id="tasksheetpopre" name="tasksheetpopre" class="tomselect-custom" multiple>
                    @foreach (var item in listhkpTS)
                    {
                        <option value="@item.TaskSheetNo">@item.TaskSheetNo</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3 mb-2">
                <label class="me-2 mb-0">Report Style:</label>
                <select id="reportstyle" name="reportstyle" class="form-control form-control-sm w-auto">
                    <option value="1">Room Attendant Daily Worksheet</option>
                    <option value="2">R/A Evening Worksheet</option>
                    <option value="3">Supervisor Hoor Checklist</option>
                </select>
            </div>
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3 mb-2">
                    <label class="mb-1 me-2">Due Outs Only</label>            
                    <!-- Dirty -->
                    <div class="form-check me-3">
                       
                        <input class="form-check-input" type="checkbox" id="dueoutonly" name="includeOptions" value="1" >
                    </div>

                </div>
            </div>
        </div>


    </div>

</div>
<div id="gridContainerInner" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    padding: 20px;
    z-index: 1055;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    overflow: hidden; /* KHÔNG để scroll ở đây */
">

    <div class="d-flex justify-content-between mb-2">

        <button style="border-radius: 4px; margin-right: 10px; background-color: green; color: white;"
                id="btnExportExcel1"
                class="mui-button mui-button-new"
                type="button">
            <i class="fa-solid fa-file-excel"></i> Excel
        </button>

        <!-- Nút Close bên phải -->
        <span onclick="$('#gridContainerInner').fadeOut(200)"
              style="cursor: pointer; font-size: 18px; color: BLACK;"
              title="Close">
            <i class="fa-solid fa-xmark"></i>
        </span>
       
    </div>
    <!-- TIÊU ĐỀ CĂN GIỮA -->
    <!-- TIÊU ĐỀ CĂN GIỮA -->
    <div style="text-align: center; margin-bottom: 10px;">
        <strong>Housekeeping Department</strong><br>
        <strong>Room Attendant Daily Work Sheet</strong>
    </div>

    <!-- LEGEND FLEX HÀNG NGANG -->
    <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
        <!-- BED ROOM -->
        <div style="flex: 1;">
            <div style="text-align: left; margin-bottom: 5px;">
                <i><strong>Legends:</strong></i>
            </div>
            <table border="1" style="width: 100%; text-align: center; font-size: 13px; border-collapse: collapse;">
                <tr>
                    <th colspan="4">BED ROOM</th>
                </tr>
                <tr style="border-top: solid 1px;">
                    <td>Water</td>
                    <td>Café</td>
                    <td>Tea</td>
                    <td>Sugar</td>
                </tr>
            </table>
        </div>

        <!-- BATH ROOM -->
        <div style="flex: 2;">
            <div style="visibility: hidden; height: 24px; margin-bottom: 5px;">Placeholder</div>
            <!-- Ẩn dòng Legends để 2 bảng thẳng hàng -->
            <table border="1" style="width: 100%; text-align: center; font-size: 13px; border-collapse: collapse;">
                <tr>
                    <th colspan="10">BATH ROOM</th>
                </tr>
                <tr style="border-top: solid 1px;">
                    <td style="font-weight:bold">BT</td>
                    <td>Bath Towel</td>
                    <td style ="font-weight:bold">FT</td>
                    <td>Face Towel</td>
                    <td style ="font-weight:bold">HT</td>
                    <td>Hand Towel</td>
                    <td style="font-weight:bold">BM</td>
                    <td>Bathmat</td>
                    <td style="font-weight:bold">AM</td>
                    <td>Amenities</td>
                </tr>
            </table>
        </div>
    </div>


    <!-- PHẦN THÔNG TIN -->
    <div class="row mb-3" style="display: flex; justify-content: space-between; flex-wrap: wrap;">
        <div style="width: 23%;">
            <label><strong>Floor/Area:</strong></label>
            <div style="border-bottom: 1px solid black; height: 20px;"></div>
        </div>
        <div style="width: 23%;">
            <label><strong>Card No.:</strong></label>
            <div style="border-bottom: 1px solid black; height: 20px;"></div>
        </div>
        <div style="width: 23%;">
            <label><strong>Shift:</strong></label>
            <div style="border-bottom: 1px solid black; height: 20px;"></div>
        </div>
        <div style="width: 23%;">
            <label><strong>Date:</strong></label>
            <div id="datepopreport" style="border-bottom: 1px solid black; height: 20px;"></div>
        </div>
    </div>

    <!-- PHẦN BẢNG SCROLL -->
    <!-- PHẦN BẢNG SCROLL (sửa lại calc) -->
    <div style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; height: calc(100% - 230px);">
        <div id="logGridReportContainer" class="gridContainer mt-2"></div>
    </div>

</div>
<div id="gridContainerInner2" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    padding: 20px;
    z-index: 1055;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    overflow: hidden; /* KHÔNG để scroll ở đây */
">

    <div class="d-flex justify-content-between mb-2">
        <button style="border-radius: 4px; margin-right: 10px; background-color: green; color: white;"
                id="btnExportExcel2"
                class="mui-button mui-button-new"
                type="button">
            <i class="fa-solid fa-file-excel"></i> Excel
        </button>
        <span onclick="$('#gridContainerInner2').fadeOut(200)"
              style="cursor: pointer; font-size: 18px; color: BLACK;"
              title="Close">
            <i class="fa-solid fa-xmark"></i>
        </span>
    </div>


    <div style="text-align: center; margin-bottom: 10px;">
        <strong>Housekeeping Department</strong><br>
        <strong>R/A Evening Worksheet</strong>
    </div>
    <div style="font-size: 13px; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 15%;"><strong>Floor:</strong> ___________</td>
                <td style="width: 15%; text-align: center;"><strong>Special assignment:</strong> ___________</td>
                <td style="width: 15%; text-align: center;">
                    <strong>Date:</strong> <span id="datepopreport2"></span>
                </td>

            </tr>
            <tr>
                <td colspan="3" style="padding-top: 10px;">
                    <strong>Legends:</strong><br />
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td><strong>VD</strong><br />Vacant Dirty</td>
                            <td><strong>VC</strong><br />Vacant Clean</td>
                            <td><strong>VM</strong><br />Vacant Maintenance</td>
                            <td><strong>OD</strong><br />Occupied Dirty</td>
                            <td><strong>OC</strong><br />Occupied Clean</td>
                            <td><strong>RS</strong><br />Refused Service</td>
                        </tr>
                        <tr>
                            <td><strong>DND</strong><br />Do Not Disturb</td>
                            <td><strong>LB</strong><br />Light Baggage</td>
                            <td><strong>ED</strong><br />Expected Departure</td>
                            <td><strong>EA</strong><br />Expected Arrival</td>
                            <td><strong>NB</strong><br />No Baggage</td>
                            <td><strong>SO</strong><br />Slept Out</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <div style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; height: calc(100% - 230px);">
        <div id="logGridReportContainer2" class="gridContainer mt-2"></div>
    </div>

</div>
<div id="gridContainerInner3" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    padding: 20px;
    z-index: 1055;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    overflow: hidden; /* KHÔNG để scroll ở đây */
">

    <div class="d-flex justify-content-between mb-2">
        <button style="border-radius: 4px; margin-right: 10px; background-color: green; color: white;"
                id="btnExportExcel3"
                class="mui-button mui-button-new"
                type="button">
            <i class="fa-solid fa-file-excel"></i> Excel
        </button>
        <span onclick="$('#gridContainerInner3').fadeOut(200)"
              style="cursor: pointer; font-size: 18px; color: BLACK;"
              title="Close">
            <i class="fa-solid fa-xmark"></i>
        </span>
    </div>


    <div style="text-align: center; margin-bottom: 10px;">
        <strong>Housekeeping Department</strong><br>
        <strong>Supervisor Hoor Checklist</strong>
    </div>
    <div style="font-size: 13px; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 15%;"><strong>Name:</strong> ___________</td>
                <td style="width: 15%; text-align: center;"><strong>Floor:</strong> <span id="floorDisplay3"></span></td>
                <td style="width: 15%; text-align: center;">
                    <strong>Date:</strong> <span id="datepopreport3"></span>
                </td>
                <td style="width: 15%;"><strong>Shift:</strong> ___________</td>
            </tr>
      
        </table>
    </div>

    <div style="overflow-x: auto; overflow-y: hidden; white-space: nowrap; height: calc(100% - 125px);">
        <div id="logGridReportContainer3" class="gridContainer mt-2"></div>
    </div>

</div>

<div id="popupNewGrid" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; transform: none; background: white; padding: 20px; border-radius: 0; z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: unset; max-height: unset; overflow-y: auto;">
    <div class="d-flex justify-content-between mb-2">
        <h5 id="attendantPointTitle" class="mb-0">Turndown Task Sheet Grid</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportpopExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>

        <button onclick="$('#popupNewGrid').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style="background-color: #3b9ac6; border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class=" mb-2">
        <div class="d-flex align-items-center flex-wrap mb-2">
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center me-3">
                    <label class="mb-1 me-2">Room Status: </label>

                    <!-- Clean Uncheck -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-ocn"></span>
                        <input class="form-check-input" type="checkbox" id="OCN" name="includeOptions" value="1" checked>
                        <label class="form-check-label" for="cleanUncheck">OCN</label>
                    </div>

                    <!-- Dirty -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-OC"></span>
                        <input class="form-check-input" type="checkbox" id="OC" name="includeOptions" value="2" checked>
                        <label class="form-check-label" for="OC">OC</label>
                    </div>

                    <!-- Out of Order -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-OD"></span>
                        <input class="form-check-input" type="checkbox" id="OD" name="includeOptions" value="5" checked>
                        <label class="form-check-label" for="OD">OD</label>
                    </div>

                    <!-- Pickup -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-DO"></span>
                        <input class="form-check-input" type="checkbox" id="DO" name="includeOptions" value="3" checked>
                        <label class="form-check-label" for="DO">DO</label>
                    </div>

                    <!-- Clean -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-VCN"></span>
                        <input class="form-check-input" type="checkbox" id="VCN" name="includeOptions" value="4" checked>
                        <label class="form-check-label" for="VCN">VCN</label>
                    </div>

                    <!-- Out of Services -->
                    <div class="form-check me-3">
                        <span class="status-color-box color-VC"></span>
                        <input class="form-check-input" type="checkbox" id="VC" name="includeOptions" value="6" checked>
                        <label class="form-check-label" for="VC">VC</label>
                    </div>
                    <div class="form-check me-3">
                        <span class="status-color-box color-VD"></span>
                        <input class="form-check-input" type="checkbox" id="VD" name="includeOptions" value="6" checked>
                        <label class="form-check-label" for="VD">VD</label>
                    </div>

                    <div class="form-check me-3">
                        <span class="status-color-box color-OOO"></span>
                        <input class="form-check-input" type="checkbox" id="VD" name="includeOptions" value="6" checked>
                        <label class="form-check-label" for="OOO">OOO</label>
                    </div>
                </div>
            </div>
        
            <div class="d-flex align-items-center me-3">
                <label class="me-2 mb-0">Zone:</label>
                <select id="zoneexpan" name="zoneexpan" class="form-control form-control-sm w-auto">
                    <option value=""></option>
                    @foreach (var item in listzone)
                    {
                        <option value="@item.Code">@item.Name</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3">
                <label class="me-2 mb-0"> Code:</label>
                <select id="taskcodeExpanded" name="taskcodeExpanded" class="form-control form-control-sm w-auto">
                    <option value=""></option>
                    @foreach (var item in listhkpFT)
                    {
                        <option value="@item.Code">@item.Description</option>
                    }
                </select>

            </div>
            <div class="d-flex align-items-center me-3">
                <label class="me-2 mb-0"> Section:</label>
                <select id="hkpSectionExpanded" name="hkpSectionExpanded" class="form-control form-control-sm w-auto">
                    <option value=""></option>
                    @foreach (var item in hkpSectionlist)
                    {
                        <option value="@item.ID">@item.Code</option>
                    }
                </select>

            </div>
        </div>
      <div class="d-flex align-items-center flex-wrap mb-2" style= padding: 5px;">
            <div class="me-3"><span class="status-symbol">!</span> Arrival</div>
            <div class="me-3"><span class="status-symbol">$</span> Due out</div>
            <div class="me-3"><span class="status-symbol">*</span> Stayover</div>
            <div class="me-3"><span class="status-symbol">%</span> Back to back</div>
      </div>

    </div>


    <div id="logGridReportContainerExpanded" class="gridContainer mt-2 popup-scroll-container">
        <!-- Nội dung bảng hoặc grid sẽ được render tại đây -->
    </div>
</div>
<div id="popupFullScreen" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); width: 100vw; max-width: 100vw; max-height: 800px; overflow-y: auto;
">
    <h2 style="
        text-align:center;
        margin-top:0;
        padding-top:10px;
        font-size:20px;
        font-weight:bold;
        color:#444;
    ">
        Room Attendent Daily Worksheet
    </h2>
    <!-- Nút đóng -->
    <button id="btnClosePopupFG" style="
        position:absolute;
        top:10px;
        right:15px;
        background:transparent;
        border:none;
        font-size:24px;
        font-weight:bold;
        cursor:pointer;
        color:#333;
        z-index:10000;
    " title="Đóng">
        &times;
    </button>

    <!-- Nội dung -->
    <div id="popupContent" style="padding:50px 20px 20px;">
        <!-- Chừa padding-top 50px để nút X không che nội dung -->
    </div>
</div>
<div id="popupAuTo" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px;
    z-index: 1050; box-shadow: 0 0 10px rgba(0,0,0,0.3); min-width: 600px; max-height: 800px; overflow-y: auto;">

    <div class="d-flex justify-content-between mb-2">
        <h5 class="mb-0"> Automatic Generation of Tasks</h5>

    </div>
    <div class="d-flex justify-content-start mb-3 gap-2">
        <button style="border-radius: 4px;  margin-right: 6px;" id="btnSaveAuto" class="mui-button mui-button-new" type="button"><i class="fa-solid fa-floppy-disk"></i> Ok</button>
        <button onclick="$('#popupAuTo').hide()" id="btnClosePopup" class="btn btn-sm btn-danger" style=" border-radius: 4px;">
            <i class="fa-solid fa-xmark me-1"></i> Close
        </button>
    </div>
    <div class="sticky-header bg-white p-2 shadow-sm z-3">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
            <div class="d-flex align-items-center flex-wrap mb-2">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center me-3">
                       <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Task Date:</label>
                            <input type="date" id="taskdateauto" name="taskdateauto" class="form-control form-control-sm w-auto" />
                        </div>

                        <!-- Clean Uncheck -->
                        <div class="form-check me-3">

                            <input class="form-check-input" type="checkbox" id="includeroomAS" name="includeOptionsAssigned" value="1" >
                            <label class="form-check-label" for="required">Include Room Assigned</label>
                        </div>
                    </div>
                </div>



                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center me-3">
                      

                        <!-- Clean Uncheck -->
                        <div class="form-check me-3">
                        
                            <input class="form-check-input" type="checkbox" id="vcAuto" name="includeOptionsAuto" value="1" >
                            <label class="form-check-label" for="cleanNoncheck">VC</label>
                        </div>

                        <!-- Dirty -->
                        <div class="form-check me-3">
                      
                            <input class="form-check-input" type="checkbox" id="vcnAuto" name="includeOptionsAuto" value="2" >
                            <label class="form-check-label" for="dirty">VCN</label>
                        </div>

                        <!-- Out of Order -->
                        <div class="form-check me-3">
                        
                            <input class="form-check-input" type="checkbox" id="vdAuto" name="includeOptionsAuto" value="5" >
                            <label class="form-check-label" for="outofOrder">VD</label>
                        </div>

                      
                        <div class="form-check me-3">
                     
                            <input class="form-check-input" type="checkbox" id="doAuto" name="includeOptionsAuto" value="4" checked>
                            <label class="form-check-label" for="clean">DO</label>
                        </div>

                        <!-- Out of Services -->
                        <div class="form-check me-3">
                          
                            <input class="form-check-input" type="checkbox" id="ocAuto" name="includeOptionsAuto" value="6" >
                            <label class="form-check-label" for="outofServices">OC</label>
                        </div>
                        <!-- Out of Services -->
                        <div class="form-check me-3">
                        
                            <input class="form-check-input" type="checkbox" id="ocnAuto" name="includeOptionsAuto" value="6" >
                            <label class="form-check-label" for="outofServices">OCN</label>
                        </div>
                        <div class="form-check me-3">
                           
                            <input class="form-check-input" type="checkbox" id="odAuto" name="includeOptionsAuto" value="6"checked >
                            <label class="form-check-label" for="outofServices">OD</label>
                        </div>
                        <div class="form-check me-3">
                        
                            <input class="form-check-input" type="checkbox" id="oooAuto" name="includeOptionsAuto" value="6" >
                            <label class="form-check-label" for="outofServices">OOO</label>
                        </div>
                          <div class="form-check me-3">
                           
                            <input class="form-check-input" type="checkbox" id="oosAuto" name="includeOptionsAuto" value="6" >
                            <label class="form-check-label" for="outofServices">OOS</label>
                        </div>
                    </div>
                </div>


                <div class="d-flex flex-column">
                    <!-- Row 1 -->
                    <div class="d-flex align-items-center me-3 mb-2">
                        <div class="form-check me-3">
                           
                            <input class="form-check-input" type="checkbox" id="arrivalOnly" name="includeOptionsRoomstatus" value="1" checked>
                            <label class="form-check-label" for="outofServices">Arrival Only</label>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label class="me-2 mb-0">Floor:</label>
                            <select id="floorauto" name="floorauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listflo)
                                {
                                    <option value="@item.ID">@item.Code</option>
                                }
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label class="me-2 mb-0">Room Type:</label>
                            <select id="roomTypeauto" name="roomTypeauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listrt)
                                {
                                    <option value="@item.Code">@item.Code</option>
                                }
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label class="me-2 mb-0">Zone:</label>
                            <select id="zonecodeauto" name="zonecodeauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listzone)
                                {
                                    <option value="@item.Code">@item.Code</option>
                                }
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label class="me-2 mb-0">Sub Zone:</label>
                            <select id=">subzonecodeauto" name="subzonecodeauto" class="form-control form-control-sm" style="width:80px">
                                <option value=""></option>
                                
                            </select>
                        </div>
                    </div>

                   
                </div>
                <div class="d-flex flex-column">
                    <!-- Row 1 -->
                    <div class="d-flex align-items-center me-3 mb-2">
                       
                     
                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Task Code:</label>
                            <select id="taskcodeauto" name="taskcodeauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listhkpFT)
                                {
                                    <option value="@item.ID">@item.Description</option>
                                }
                            </select>

                        </div>
                        
                      
                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0"> Attendant ID:</label>
                            <select id="attendantauto" name="attendantauto" class="tomselect-custom" multiple>
                                <option value=""></option>
                                @foreach (var item in listatt)
                                {
                                    <option value="@item.ID">@item.Name</option>
                                }
                            </select>

                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Max. Credits:</label>
                            <input type="text" id="maxcreditauto" name="maxcreditauto" class="form-control form-control-sm w-auto" value="0" />
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <label class="me-2 mb-0">Description:</label>
                            <input type="text" id="descriptionauto" name="descriptionauto" class="form-control form-control-sm w-auto" />
                        </div>
                    </div>


                </div>
            </div>

        </div>
    </div>
 
</div>


<div class="mui-card">
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
        function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }

            let parsedBusinessDate = null;
        $(document).ready(function () {

             document.getElementById("reportTitle").innerText = 'Task Assignment';
              var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
                   console.log(businessDateStr);
                    // Lấy phần ngày tháng năm
                    var dateOnly = businessDateStr.split(' ')[0]; // '8/29/2024'
                    var dateParts = dateOnly.split('/'); // ['8', '29', '2024']

                    // Parse đúng thứ tự: new Date(year, monthIndex, day)
                     parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

                    // Gán vào input type="date"
                    $('#fromDate').val(formatDate(parsedBusinessDate));
                    $('#fromDatere').val(formatDate(parsedBusinessDate));
                    $('#toDatere').val(formatDate(parsedBusinessDate));
                    $('#datepopreport').text(formatDate(parsedBusinessDate));
                   $('#datepopreport2').text(formatDate(parsedBusinessDate));
                    $('#datepopreport3').text(formatDate(parsedBusinessDate));
                   $('#taskdate').val(formatDate(parsedBusinessDate));
                     $('#taskdateauto').val(formatDate(parsedBusinessDate));
               initializeTomSelects();
                 initializeTomSelectstasksheet();
                 initializeTomSelectzone();
                 initializeTomSelectshkpSection();
                 initializeTomSelectstasksheetpopre();
                 initializeTomSelecttaskcodenew();
                initializeTomSelecttaskcodenewroom();
                initializeTomSelectRoomtype();
                        initializeTomSelectSectionAd();
                         initializeTomSelectZoneAd();
                               $("#btnPrint").trigger("click");

        });
             
        function initializeTomSelects() {
                   const selectors = ["#taskcode", "#taskcodeauto", "#floorauto","#zonecodeauto","#attendantauto"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
        }
          function initializeTomSelectshkpSection() {
                const selectors = ["#hkpSection"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
        }
             function initializeTomSelectstasksheetpopre() {
                const selectors = ["#tasksheetpopre"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
        }

     
        function initializeTomSelectzone() {
                const selectors = ["#zone"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
            }
             function initializeTomSelecttaskcodenew() {
                const selectors = ["#taskcodenew"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
            }
             function initializeTomSelecttaskcodenewroom() {
                const selectors = ["#taskcodenewroom"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
            }
        function initializeTomSelectstasksheet() {
            const selectors = ["#tasksheet"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
         function initializeTomSelectRoomtype() {
              const selectors = ["#roomTypead", "#roomTypeauto"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
         function initializeTomSelectSectionAd() {
            const selectors = ["#sectionAd"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
         function initializeTomSelectZoneAd() {
            const selectors = ["#zoneAd"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
         $('#btnClosePopup, #overlay').click(function () {
                $('#popupNewGrid').fadeOut(200);
                $('#overlay').fadeOut(200);
           });

              $("#btnReport").on("click", function () {
                   $('#overlay').fadeIn(200);
                    $('#popupNewGridReport').fadeIn(200);
            });
                  $("#btnAutotasksheet").on("click", function () {
                   $('#overlay').fadeIn(200);
                    $('#popupAuTo').fadeIn(200);
            });

              $("#btnAddtasksheet").on("click", function () {
                   $('#overlay').fadeIn(200);
                    $('#popupNewGridNew').fadeIn(200);
                      $("#taskcodenewshow").show();
                    $("#attendantshow").show();
                    var tomselectInstance = $("#taskcodenew")[0].tomselect;
                    if (tomselectInstance) {
                        tomselectInstance.clear();
                    }
                    $("#attendantnew").val('');
                        $("#tasksheetnew").val('');
               $("#btnAddRoomtasksheet").hide();
                            $("#btnSavetasksheet").show();
                     $("#logGridNewContainer").dxDataGrid({
                            dataSource: null // or []
                        });
           });

              $("#btnDetailtasksheet").on("click", function () {
                   $('#overlay').fadeIn(200);
                    $('#popupNewGridNew').fadeIn(200);
                      $("#taskcodenewshow").hide();
                    $("#attendantshow").hide();
                    var tomselectInstance = $("#taskcodenew")[0].tomselect;
                    if (tomselectInstance) {
                        tomselectInstance.clear();
                    }
                    $("#attendantnew").val('');
                        $("#tasksheetnew").val(selectedRowDataTS[0].taskSheetNo);
               $("#btnAddRoomtasksheet").show();
                            $("#btnSavetasksheet").hide();
                              if (!selectedRowDataTS) {
                                    showToast('Success', "Vui lòng chọn một hàng trước khi xem chi tiết", true);
                               
                                return;
                            }
                    ViewTaskDetailGrid(selectedRowDataTS[0].id)
           });

           $("#btnAddUsertasksheet,#btnAddUserDetailtasksheet").on("click", function () {
                $('#popupNewGridAddUser').css('z-index', 2000);
                   $('#overlay').fadeIn(200);
                    $('#popupNewGridAddUser').fadeIn(200);                 
                              if (!selectedRowDataTS) {
                               showToast('Error', 'Please select at least one row before deleting.', false);
                                return;
                            }
                    ViewTaskAddUserGrid();
            });
            $(document).on("click", "#btnClosePopupFG", function () {
                   $("#popupFullScreen").hide();
            });

            $(document).on("click", "#btnDailytasksheet", function () {
                  $("#popupFullScreen").show();
                var tasksheetnew = $("#tasksheetnew").val();

                $.ajax({
                    url: '/HouseKeeping/RoomAttendentDailyWorksheet', // thay tên controller vào đây
                    type: 'GET',
                    data: { isPopup: true, tasksheetnew: tasksheetnew },
                    success: function (html) {
                        $("#popupContent").html(html).show(); 
                         $("#popupContent script").each(function () {
                                eval($(this).text() || this.textContent || this.innerHTML || "");
                            });
                          
                    },
                    error: function (xhr) {
                        console.error("Lỗi khi load partial view", xhr);
                    }
                });
            });





          $("#btnDeletetasksheet").on("click", function () {
                if (!selectedRowDataTS || selectedRowDataTS.length === 0) {
                     showToast('Error', 'Please select at least one row before deleting.', false);
                    return;
                }

                // Lọc bỏ những hàng Completed
                const rowsToDelete = selectedRowDataTS.filter(row => row.status !== "Completed");

                if (rowsToDelete.length === 0) {
                   showToast('Error', 'Cannot delete Tasksheet(s) with status "Completed".', false);
                    return;
                }

                const idtsList = rowsToDelete.map(row => row.id);
                const taskSheetNoList = rowsToDelete.map(row => row.taskSheetNo);

                // Chuỗi hiển thị
                const taskSheetNosString = taskSheetNoList.join(", ");

                // Xác nhận
                if (!confirm(`Are you sure you want to delete Tasksheet (${taskSheetNosString})?`)) {
                    return;
                }

                $.ajax({
                    url: '/HouseKeeping/Deletetasksheet',
                    type: 'POST',
                    data: {
                        idts: idtsList
                    },
                    traditional: true,
                    crossDomain: false,
                    headers: {
                        "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                    },
                    success: function (result) {
                        if (result.success) {
                            showToast('Success', result.message, true);
                               $("#btnPrint").trigger("click");
                        } else {
                            showToast('Error', result.message, false);
                        }
                        $("#loadingSpinner").hide();
                    },
                    error: function () {
                           showToast('Error', 'Không thể tải báo cáo', false);
                    
                        $("#loadingSpinner").hide();
                    }
                });
            });
             $("#btnCompletetasksheet").on("click", function () {
                if (!selectedRowDataTS || selectedRowDataTS.length === 0) {
                     showToast('Error', 'Please select at least one row before deleting.', false);
                    return;
                }

                // Lọc bỏ những hàng Completed
                const rowsToDelete = selectedRowDataTS.filter(row => row.status !== "Completed");

                if (rowsToDelete.length === 0) {
                   showToast('Error', 'Cannot  Tasksheet(s) with status "Completed".', false);
                    return;
                }

                const idtsList = rowsToDelete.map(row => row.id);
                const taskSheetNoList = rowsToDelete.map(row => row.taskSheetNo);

                // Chuỗi hiển thị
                const taskSheetNosString = taskSheetNoList.join(", ");

                // Xác nhận
                if (!confirm(`Are you sure you want to update status is completed for this Tasksheet (${taskSheetNosString})?`)) {
                    return;
                }

                $.ajax({
                    url: '/HouseKeeping/Completedtasksheet',
                    type: 'POST',
                    data: {
                        idts: idtsList
                    },
                    traditional: true,
                    crossDomain: false,
                    headers: {
                        "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                    },
                    success: function (result) {
                        if (result.success) {
                            showToast('Success', result.message, true);
                               $("#btnPrint").trigger("click");
                        } else {
                            showToast('Error', result.message, false);
                        }
                        $("#loadingSpinner").hide();
                    },
                    error: function () {
                        alert("Không thể tải báo cáo.");
                        $("#loadingSpinner").hide();
                    }
                });
            });

               $("#btnSaveAuto").on("click", function () {
              
                      const userName = JSON.parse(localStorage.getItem("Loginname"));
                $.ajax({
                    url: '/HouseKeeping/AutoTasksheet',
                    type: 'POST',
                    data: {
                        taskdateauto: $("#taskdateauto").val(),
                        includeroomAS: $("#includeroomAS").is(':checked') ? 1 : 0,
                        vcAuto: $("#vcAuto").is(':checked') ? 1 : 0,
                        vcnAuto: $("#vcnAuto").is(':checked') ? 1 : 0,
                        vdAuto: $("#vdAuto").is(':checked') ? 1 : 0,
                        doAuto: $("#doAuto").is(':checked') ? 1 : 0,
                        ocAuto: $("#ocAuto").is(':checked') ? 1 : 0,
                        ocnAuto: $("#ocnAuto").is(':checked') ? 1 : 0,
                        odAuto: $("#odAuto").is(':checked') ? 1 : 0,
                        oooAuto: $("#oooAuto").is(':checked') ? 1 : 0,
                        oosAuto: $("#oooAuto").is(':checked') ? 1 : 0,
                        arrivalOnly: $("#arrivalOnly").is(':checked') ? 1 : 0,
                        floorauto: $("#floorauto").val()?.map(r => r.replace("''")).join(",") || "",
                        roomTypeauto: $("#roomTypeauto").val()?.map(r => r.replace("''")).join(",") || "",
                        zonecodeauto: $("#zonecodeauto").val()?.map(r => r.replace("''")).join(",") || "",
                        subzonecodeauto: $("#subzonecodeauto").val(),
                        taskcodeauto: $("#taskcodeauto").val()?.map(r => r.replace("''")).join(",") || "",
                        attendantauto: $("#attendantauto").val()?.map(r => r.replace("''")).join(",") || "",
                        maxcreditauto: $("#maxcreditauto").val(),
                        descriptionauto: $("#descriptionauto").val(),
                        userName:userName
                    },
                    traditional: true,
                    crossDomain: false,
                    headers: {
                        "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                    },
                    success: function (result) {
                        if (result.success) {
                            showToast('Success', result.message, true);
                               $("#btnPrint").trigger("click");
                                var floorSelect = $("#floorauto")[0]?.tomselect;
                                if (floorSelect) floorSelect.clear();

                                var roomTypeSelect = $("#roomTypeauto")[0]?.tomselect;
                                if (roomTypeSelect) roomTypeSelect.clear();

                                var zoneSelect = $("#zonecodeauto")[0]?.tomselect;
                                if (zoneSelect) zoneSelect.clear();

                              

                                var taskSelect = $("#taskcodeauto")[0]?.tomselect;
                                if (taskSelect) taskSelect.clear();

                                var attendantSelect = $("#attendantauto")[0]?.tomselect;
                                if (attendantSelect) attendantSelect.clear();

                                // ✅ Clear input / textarea
                                $("#maxcreditauto").val("");
                                $("#descriptionauto").val("");
                        } else {
                            showToast('Error', result.message, false);
                        }
                        $("#loadingSpinner").hide();
                    },
                    error: function () {
                        alert("Không thể tải báo cáo.");
                        $("#loadingSpinner").hide();
                    }
                });
            });

                $("#btnCompletedetailtasksheet").on("click", function () {
                        console.log(selectedRowDatadetail);
                    if (!selectedRowDatadetail) {
                        showToast('Error', 'Please select a row before updating.', false);
                        return;
                    }

                    // Kiểm tra nếu đã Completed
                    if (selectedRowDatadetail.status === "Completed") {
                        showToast('Error', 'Cannot update a Tasksheet that is already "Completed".', false);
                        return;
                    }

                    const idts = selectedRowDatadetail.id;
                    const taskSheetNo = selectedRowDatadetail.taskSheetNo;
                      const room = selectedRowDatadetail.room;
                       const hkStatusID_Internal = selectedRowDatadetail.hkStatusID_Internal;
                    // Xác nhận
                    if (!confirm(`Are you sure you want to completed room: (${room})?`)) {
                        return;
                    }

                    $.ajax({
                        url: '/HouseKeeping/CompletedDetailtasksheet',
                        type: 'POST',
                        data: {
                            idts: idts,             
                            taskSheetNo: taskSheetNo ,  
                             hkStatusID_Internal: hkStatusID_Internal
                        },
                        traditional: true,
                        crossDomain: false,
                        headers: {
                            "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
                        },
                        success: function (result) {
                            if (result.success) {
                                showToast('Success', result.message, true);
                                $("#btnDetailtasksheet").trigger("click"); 
                                $("#btnPrint").trigger("click");
                            } else {
                                showToast('Error', result.message, false);
                            }
                            $("#loadingSpinner").hide();
                        },
                        error: function () {
                            alert("Không thể tải báo cáo.");
                            $("#loadingSpinner").hide();
                        }
                    });
                });


           $("#btnSaveEmployee").on("click", function () {
                console.log(selectedRowDataTS);
                  const idtsList = selectedRowDataTS.map(row => row.id);
                  const idauList = selectedRowDataAU.map(row => row.id);

                    $.ajax({
                    url: '/HouseKeeping/SaveEmployeeTaskAss',
                    type: 'POST',
                    data: {

                         idts: idtsList,
                         idau: idauList
 
                    },
                    traditional: true,
                        crossDomain: false,
                        headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                    success: function (result) {
                           showToast('Success', result.message, true);
                           $('#popupNewGridAddUser').hide();
                            $("#loadingSpinner").hide();
                            $("#btnPrint").trigger("click");
                    },
                    error: function () {
                        alert("Không th? t?i báo cáo.");
                        $("#loadingSpinner").hide();
                    }
                });
     
           });

            $("#btnExpanded").on("click", function () {
                   $('#overlay').fadeIn(200);
                    $('#popupNewGrid').fadeIn(200);
                     ExpandedTaskSheet();
            });

            $("#btnViewpopExcel").on("click", function () {
                    TaskSheetReport();
            });

            $("#btnAddRoomtasksheet").on("click", function () {
                   $('#overlay').fadeIn(200);
                   $('#popupNewGridAddRoom').fadeIn(200);
                   var tasksheetroom= $("#tasksheetnew").val();
                    $("#tasksheetroom").val(tasksheetroom);
            });
              $("#detailturndowwn").on("click", function () {
               $('#overlay').fadeIn(200);
                   $('#popupNewGridTurndown').fadeIn(200);
                    $("#logGriTurndownContainer").dxDataGrid({
                            dataSource: null // or []
                        });
                           $("#btnViewTurndown").trigger("click");
              });
              $("#btnViewTurndown").on("click", function () {
                     $("#loadingSpinner").show();
                    const selectedStatuses = [];
                    $("input[name='includeOptionsRoom']:checked").each(function () {
                        selectedStatuses.push($(this).val());
                    });

                      const selectedReservation = [];
                    $("input[name='includeOptionsReservation']:checked").each(function () {
                        selectedReservation.push($(this).val());
                    });

                           const selectedTurndown = [];
                    $("input[name='includeOptionsTurndown']:checked").each(function () {
                        selectedTurndown.push($(this).val());
                    });
                    $.ajax({
                        url: '/HouseKeeping/ViewTurnDown',
                        type: 'GET',
                        data: {

                                    roomTypead: $("#roomTypead").val()?.map(r => r.replace("''")).join(",") || "",
                                      sectionAd: $("#sectionAd").val()?.map(r => r.replace("''")).join(",") || "",
                                        zoneAd: $("#zoneAd").val()?.map(r => r.replace("''")).join(",") || "",
                                    fromRoom: $("#fromRoom").val(),
                                      toRoom: $("#toRoom").val(),
                                       HKStatusID: selectedStatuses.join(","),
                                          ReservationStatus: selectedReservation.join(","),
                                       arrived: $("#arrived").is(":checked") ? "1" : "",
                                                  turndownStatus: selectedTurndown.join(","),
                                    
                        },
                        traditional: true,
                            crossDomain: false,
                            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                        success: function (result) {
                            // $("#reportViewerContainer").html(result);
                            // $("#loadingSpinner").hide();
                                    console.log(result);
                                         initializeViewTurnDownGrid(result);
                                $("#loadingSpinner").hide();
                        },
                        error: function () {
                            alert("Không th? t?i báo cáo.");
                            $("#loadingSpinner").hide();
                        }
                    });
              });
               function initializeViewTurnDownGrid(data) {
                    const columnWidth = 120;

                    $("#logGriTurndownContainer").dxDataGrid({
                        dataSource: data,
                        allowColumnResizing: true,
                        columnAutoWidth: true,
                                   height: "100%",
                        columns: [
                              {
                            dataField: "hkstatusID",
                            caption: "C",
                            width: columnWidth - 40,
                            cellTemplate: function (container, options) {
                                const colorClass = getStatusColorClass(options.value);
                                $("<div>")
                                    .addClass("status-color-box")
                                    .addClass(colorClass)
                                    .css({
                                        width: "20px",
                                        height: "20px",
                                        borderRadius: "4px"
                                    })
                                    .appendTo(container);
                            }
                        },

                            { dataField: "roomNo", caption: "Room", width: columnWidth },
                            { dataField: "roomType", caption: "Room Type", width: columnWidth },
                            { dataField: "hkstatusID", caption: "Room Status", width: columnWidth+20 },
                            { dataField: "vip", caption: "Vip", width: columnWidth },
                            { dataField: "nationanity", caption: "Nationanity", width: columnWidth },
                            { dataField: "guestName", caption: "Name", width: columnWidth+40  },
                            { dataField: "status", caption: "Status", width: columnWidth },
                            { dataField: "turndownStatus", caption: "Turndown Status", width: columnWidth+40 },
                        ],

                        paging: { pageSize: 25 },
                        scrolling: {
                            useNative: true,
                            showScrollbar: "always"
                        },
                        pager: {
                            visible: true,
                            allowedPageSizes: [25, 50, 'all'],
                            showPageSizeSelector: true,
                            showInfo: true,
                            showNavigationButtons: true
                        },
                        filterRow: { visible: true, applyFilter: "auto" },
                        headerFilter: { visible: true },
                         selection: {
                            mode: "multiple",
                            showCheckBoxesMode: "always"
                        },

                        showBorders: true,

                        onRowClick: function (e) {
                            selectedRowData = e.data; // lưu dòng được chọn
                        }
                    });
                }
                  $("#btnSaveRoomtasksheet").on("click", function () {
                          const roomturndown = $("#roomturndownHidden").val();
                        const taskCodeNewRoom = $("#taskcodenewroom").val();

                        // Check if a room has been selected
                        if (!roomturndown  === "") {
                            showToast('Error', 'Please select a room before saving.', false);
                            return;
                        }

                        // Check if a Task Code has been selected
                        if (!taskCodeNewRoom  === "") {
                            showToast('Error', 'Please select a Task Code before saving.', false);
                            return;
                        }
                     $("#loadingSpinner").show();
                const userName = JSON.parse(localStorage.getItem("Loginname"));
                    $.ajax({
                        url: '/HouseKeeping/SaveRoomTaskSheetDetail',
                        type: 'POST',
                        data: {
                        roomturndown: $("#roomturndownHidden").val(),
                            taskdate: $("#taskdate").val(),
                            tasksheetroom: $("#tasksheetroom").val(),
                            taskcodenewroom: $("#taskcodenewroom").val(),
                            maxcredit: $("#maxcredit").val(),
                             descriptiontc: $("#descriptiontc").val(),
                             userName:userName
                        },
                        traditional: true,

                            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                            success: function (res) {
                                // $("#reportViewerContainer").html(result);
                                // $("#loadingSpinner").hide();
                                 if (res.success) {
                                   console.log(res.message);
                                    console.log(res.taskSheetID);
                                                $('#popupNewGridAddRoom').fadeOut(200);
                                        $("#roomturndownHidden").val("");
                                        $("#tasksheetroom").val("");
                                        $("#taskcodenewroom").val("");
                                        $("#maxcredit").val(0);
                                        $("#descriptiontc").val("");
                                        $("#roomturndown").val("");

                                        ViewTaskDetailGrid(res.taskSheetID)
                                            var tomselectInstance = $("#taskcodenewroom")[0].tomselect;
                                            if (tomselectInstance) {
                                                tomselectInstance.clear();
                                            }
                                        $("#loadingSpinner").hide();
                                } else {
                                    alert("Lỗi từ server: " + res.message);
                                }
                                   
                            },
                            error: function () {
                                alert("Không th? t?i báo cáo.");
                                $("#loadingSpinner").hide();
                            }
                    });
              });
             function ViewTaskDetailGrid(data) {
                $.ajax({
                        url: '/HouseKeeping/ViewTaskDetailGrid',
                        type: 'GET',
                        data: {
                        roomturndown: $("#roomturndownHidden").val(),
                            id: data,
                           
                        },
                        traditional: true,

                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                   success: function (result) {
                         console.log(result);
                                  
                         initializeTaskDetailGrid(result)
                                         
                     

                    },
                    error: function () {
                        alert("Không th? t?i báo cáo.");
                    }
                });
             }

               function ViewTaskAddUserGrid() {
                $.ajax({
                        url: '/HouseKeeping/ViewTaskAddUserGrid',
                        type: 'GET',
                        data: {
                      
                        },
                        traditional: true,

                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                   success: function (result) {
                         console.log(result);

                         initializeTaskAddUserGrid(result)



                    },
                    error: function () {
                        alert("Không th? t?i báo cáo.");
                    }
                });
             }
              function initializeTaskAddUserGrid(data) {
                 const columnWidth = 120;

                 $("#logGridAddUserContainer").dxDataGrid({
                     dataSource: data,
                     allowColumnResizing: true,
                      height: 500,
                     columnAutoWidth: true,
                     columns: [

                         { dataField: "id", caption: "ID", width: columnWidth -20},
                         { dataField: "name", caption: "Name", width: columnWidth +60},
                        { dataField: "description", caption: "Description", width: columnWidth },
                     ],

                     paging: { pageSize: 25 },
                     scrolling: {
                         useNative: true,
                         showScrollbar: "always"
                     },
                     pager: {
                         visible: true,
                         allowedPageSizes: [25, 50, 'all'],
                         showPageSizeSelector: true,
                         showInfo: true,
                         showNavigationButtons: true
                     },
                     filterRow: { visible: true, applyFilter: "auto" },
                     headerFilter: { visible: true },
                      selection: {
                         mode: "multiple",
                         showCheckBoxesMode: "none"
                     },

                     showBorders: true,

                     // onRowClick: function (e) {
                     //     selectedRowDataAU = e.data; // lưu dòng được chọn
                     // },
                      onSelectionChanged: function (e) {
                            // Lấy tất cả các dòng đã được chọn
                            selectedRowDataAU = e.selectedRowsData;
                            console.log("Danh sách selectedRowDataAU:", selectedRowDataAU);
                        }
                 });
             }
              function initializeTaskDetailGrid(data) {
                 const columnWidth = 120;

                 $("#logGridNewContainer").dxDataGrid({
                     dataSource: data,
                     allowColumnResizing: true,
                      height: 500,
                     columnAutoWidth: true,
                     columns: [
                    
                         { dataField: "room", caption: "Room", width: columnWidth-10 },
                         { dataField: "roomType", caption: "Room Type", width: columnWidth },
                         { dataField: "credits", caption: "Credits", width: columnWidth-10  ,dataType: "number", format: "#,##0"},
                         { dataField: "section", caption: "Section", width: columnWidth },
                         { dataField: "floor", caption: "Floor", width: columnWidth ,dataType: "number", format: "#,##0" },
                         { dataField: "hkStatusID_Internal", caption: "Room Status", width: columnWidth },
                         { dataField: "timeIn", caption: "TimeIn", width: columnWidth-10 },
                         { dataField: "timeOut", caption: "TimeOut", width: columnWidth -10},
                         { dataField: "taskCode", caption: "Task Code", width: columnWidth  },
                         { dataField: "taskNote", caption: "TaskNote", width: columnWidth },
                         { dataField: "status", caption: "Status", width: columnWidth },
                          { dataField: "completedStatus", caption: "Completed Status", width: columnWidth+30 },
                     ],

                     paging: { pageSize: 25 },
                     scrolling: {
                         useNative: true,
                         showScrollbar: "always"
                     },
                     pager: {
                         visible: true,
                         allowedPageSizes: [25, 50, 'all'],
                         showPageSizeSelector: true,
                         showInfo: true,
                         showNavigationButtons: true
                     },
                     filterRow: { visible: true, applyFilter: "auto" },
                     headerFilter: { visible: true },
                      selection: {
                         mode: "multiple",
                         showCheckBoxesMode: "none"
                     },

                     showBorders: true,

                     onRowClick: function (e) {
                         selectedRowDatadetail = e.data; // lưu dòng được chọn
                     }
                 });
             }
              $("#btnOkTurndown").on("click", function () {
                    const selectedRows = $("#logGriTurndownContainer").dxDataGrid("instance").getSelectedRowsData();

                    if (selectedRows.length === 0) {
                          showToast('Success', "Please select at least one row.", true);
                   
                        return;
                    }

                    // Hiển thị roomNo
                    const roomNos = selectedRows.map(row => row.roomNo).filter(Boolean);
                    $("#roomturndown").val(roomNos.join(","));  // textbox dùng để hiển thị

                    // Lưu giá trị thực là roomID (ẩn)
                    const roomIds = selectedRows.map(row => row.roomID).filter(Boolean);
                    $("#roomturndownHidden").val(roomIds.join(",")); // bạn phải thêm input hidden này trong HTML

                    $('#overlay').fadeOut(200);
                    $('#popupNewGridTurndown').fadeOut(200);
              });


              function getStatusColorClass(statusName) {
                    switch (statusName.trim().toLowerCase()) {
                        case "clean non-checked":
                            return "color-clean-uncheck";
                        case "dirty":
                            return "color-dirty";
                        case "pickup":
                            return "color-pickup";
                        case "clean":
                            return "color-clean";
                        case "out of order":
                            return "color-outoforder";
                        case "out of services":
                            return "color-outofservices";
                        default:
                            return "";
                    }
                }



            $("#btnSavetasksheet").on("click", function () {
               
               const userName = JSON.parse(localStorage.getItem("Loginname"));
                $("#loadingSpinner").show();
                $.ajax({
                    url: '/HouseKeeping/SaveTaskSheetDetail',
                    type: 'GET',
                    data: {
                        
                                taskcodenew: $("#taskcodenew").val()?.map(r => r.replace("''")).join(",") || "",
                                attendantnew: $("#attendantnew").val(),
                                businessDate:formatDate(parsedBusinessDate),
                                userName :userName
                    },
                    traditional: true,
                        crossDomain: false,
                        headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                    success: function (result) {
                        // $("#reportViewerContainer").html(result);
                        // $("#loadingSpinner").hide();
                                console.log(result);
                                $("#tasksheetnew").val(result);
                                $("#taskcodenewshow").hide();
                                $("#attendantshow").hide();
                                $("#btnAddRoomtasksheet").show();
                                    // initializeTaskSheetStatusPopGrid(result);
                                        $("#btnSavetasksheet").hide();
                            $("#loadingSpinner").hide();
                    },
                    error: function () {
                        alert("Không th? t?i báo cáo.");
                        $("#loadingSpinner").hide();
                    }
                });
            });
             function TaskSheetReport() {
            $("#loadingSpinner").show();
            $.ajax({
                url: '/HouseKeeping/TaskSheetReport',
                type: 'GET',
                data: {
                    fromDatere: $("#fromDatere").val(),
                     toDatere: $("#toDatere").val(),
                     taskcodeexpan: $("#taskcodeexpan").val(),
                      attendantrepop: $("#attendantrepop").val(),
                            tasksheetpopre: $("#tasksheetpopre").val()?.map(r => r.replace("''")).join(",") || "",
                         reportstyle: $("#reportstyle").val(),
                  dueoutonly: $("#dueoutonly").is(":checked") ? $("#dueoutonly").val() : ""

                },
                traditional: true,
                    crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    // $("#reportViewerContainer").html(result);
                    // $("#loadingSpinner").hide();
                            console.log(result);
                        if ($("#reportstyle").val() == "1")
                        {    $("#gridContainerInner").fadeIn(200);
                            initializeRoomAttendantDailyWorkSheetGrid(result);
                        }
                        else if ($("#reportstyle").val() == "2")
                        {    $("#gridContainerInner2").fadeIn(200);
                            initializeRAWorkSheetGrid(result);
                        }
                        else if ($("#reportstyle").val() == "3")
                        {  $("#gridContainerInner3").fadeIn(200);
                            initializeSupChecklistFloorGrid(result);
                        }

                                // initializeTaskSheetStatusPopGrid(result);
                        $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        }
        let allTaskSheets = [];
    function ExpandedTaskSheet() {
        // Hiển thị spinner
        $("#loadingSpinner").show();

        // Lấy giá trị đầu vào và kiểm tra
        const zoneexpan = $("#zoneexpan").val();
        const taskcodeExpanded = $("#taskcodeExpanded").val();
        const hkpSectionExpanded = $("#hkpSectionExpanded").val();

        // ⚡ Biến lưu dòng click chuột
        let contextRowData = null;
        let contextMenu = null;
        let taskSheetToIndex = {}; // Map taskSheetNo -> grid index

        // Nếu contextMenu chưa có thì tạo trước
        if ($("#contextMenu").length === 0) {
            $("body").append('<div id="contextMenu"></div>');
        }

        // Khởi tạo contextMenu rỗng
        contextMenu = $("#contextMenu").dxContextMenu({
            items: [],
            hideOnOutsideClick: true,
            width: 160,
            cssClass: "custom-context-menu",
            onItemClick: function (e) {
                if (!contextRowData || !e.itemData.text || e.itemData.items) {
                    return;
                }

                const itemCssClass = e.itemData.cssClass;
                const sourceTaskSheetNo = contextRowData.taskSheetNo;
                const sourceTaskSheetData = allTaskSheets
                    .flatMap(tbl => tbl)
                    .filter(row => row.taskSheetNo == sourceTaskSheetNo);

                // ⚡ Lấy grid instance (từ dòng click)
                const gridInstance = $(contextMenu.option("target"))
                    .closest("div[id^='gridContainer_']")
                    .data("gridInstance");

                if (!gridInstance) {
                    console.error("❌ Không tìm thấy gridInstance");
                    return;
                }

                // ⚡ Các dòng đã chọn trong grid (TaskSheet gốc)
                const selectedRows = gridInstance.getSelectedRowsData();

                if (!selectedRows || selectedRows.length === 0) {
                      showToast('Success', "Vui lòng chọn ít nhất 1 phòng để chuyển.", true);
                 
                    return;
                }

                const taskDetailIDs = selectedRows.map(r => r.taskSheetDetailID).join(",");
                const targetTaskSheetNo = e.itemData.text;

                if (itemCssClass === "menu-new-task") {
                    // 👉 Xử lý riêng khi chọn New Task Sheet
                    createNewTaskSheet(taskDetailIDs, sourceTaskSheetData);
                    return;
                    } else if (itemCssClass === "menu-go-to") {
                // 👉 Xử lý Go To: Scroll đến Task Sheet tương ứng, căn giữa màn hình
                const index = taskSheetToIndex[targetTaskSheetNo];
                if (index !== undefined) {
                    const gridElement = $(`#gridContainer_${index}`);
                    if (gridElement.length) {
                        const windowHeight = $(window).height(); // Chiều cao cửa sổ trình duyệt
                        const gridHeight = gridElement.outerHeight(); // Chiều cao của grid
                        const gridOffsetTop = gridElement.offset().top; // Vị trí đầu của grid
                        const scrollTo = gridOffsetTop - (windowHeight / 2) + (gridHeight / 2); // Tính vị trí để căn giữa

                        $('html, body').animate({
                            scrollTop: scrollTo
                        }, 500);

                        const targetGridInstance = gridElement.data("gridInstance");
                        if (targetGridInstance) {
                            targetGridInstance.focus();
                        }
                    }
                }
                return;
            } else if (itemCssClass === "menu-send-to") {
                    // ⚡ Toàn bộ dữ liệu TaskSheet đích
                    const targetTaskSheetData = allTaskSheets
                        .flatMap(tbl => tbl)
                        .filter(row => row.taskSheetNo == targetTaskSheetNo);

                    console.log("🔹 TaskSheet gốc:", sourceTaskSheetNo, sourceTaskSheetData);
                    console.log("🔹 Các dòng đã chọn:", taskDetailIDs);
                    console.log("🔹 TaskSheet đích:", targetTaskSheetNo, targetTaskSheetData);
                    if (confirm(`Bạn có chắc muốn chuyển ${selectedRows.length} phòng từ TaskSheet ${sourceTaskSheetNo} sang TaskSheet ${targetTaskSheetNo}?`)) {
                        $.ajax({
                            url: '/HouseKeeping/MoveTaskSheetDetails',
                            type: 'POST',
                            data: {
                                selectedRows: taskDetailIDs,
                                targetTaskSheetData: targetTaskSheetData[0].taskSheetID
                            },
                            headers: { "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val() },
                            success: function (res) {
                                showToast('Success', res.message, true);
                                ExpandedTaskSheet(); // reload lại lưới
                            },
                            error: function (xhr) {
                                alert("Lỗi khi cập nhật: " + xhr.responseText);
                            }
                        });
                    }
                    return;
                }
            }
        }).dxContextMenu("instance");

        $.ajax({
            url: '/HouseKeeping/ExpandedTaskSheet',
            type: 'GET',
            data: {
                zoneexpan: zoneexpan,
                taskcodeExpanded: taskcodeExpanded,
                hkpSectionExpanded: hkpSectionExpanded
            },
            traditional: true,
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                console.log("result:", result);
                allTaskSheets = result;

                // Xóa nội dung cũ của container
                $("#logGridReportContainerExpanded").empty();

                const columnWidth = 120;
                let html = '<div class="row">';
                let tableCount = 0;

                result.forEach((tableData, index) => {
                    const gridId = `gridContainer_${index}`;
                    html += `
                        <div class="col-md-3" style="padding: 10px;">
                            <div id="${gridId}"></div>
                        </div>
                    `;
                    tableCount++;
                    if (tableCount === 4 || index === result.length - 1) {
                        html += '</div>';
                        if (index < result.length - 1) {
                            html += '<div class="row">';
                        }
                        tableCount = 0;
                    }
                });

                $("#logGridReportContainerExpanded").append(html);

                // ⚡ Tạo map taskSheetNo -> index
                taskSheetToIndex = {};
                result.forEach((tableData, index) => {
                    if (tableData.length > 0) {
                        const tsNo = tableData[0].taskSheetNo;
                        taskSheetToIndex[tsNo] = index;
                    }
                });

                // ⚡ Lấy danh sách taskSheetNo duy nhất
                const taskSheetNos = [...new Set(
                    result.flatMap(table => table.map(row => row.taskSheetNo))
                )];

                // ⚡ Cập nhật contextMenu với cssClass cho phân biệt
                const menuItems = [
                    {
                        text: "Send To",
                        cssClass: "menu-has-scroll",
                        items: [
                            { text: "➕ New Task Sheet", cssClass: "menu-new-task" },
                            {
                                template: function () {
                                    return $("<div>").addClass("menu-divider");
                                },
                                disabled: true
                            },
                            ...taskSheetNos.map(no => ({ text: no, cssClass: "menu-send-to" }))
                        ]
                    },
                    {
                        text: "Go To",
                        cssClass: "menu-has-scroll",
                        items: taskSheetNos.map(no => ({ text: no, cssClass: "menu-go-to" }))
                    }
                ];
                contextMenu.option("items", menuItems);

                // ⚡ Khởi tạo dxDataGrid
                result.forEach((tableData, index) => {
                    const gridId = `gridContainer_${index}`;
                    const grid = $(`#${gridId}`).dxDataGrid({
                        dataSource: tableData,
                        height: 500,
                        allowColumnResizing: true,
                        columnAutoWidth: false,
                        paging: { enabled: false },
                        pager: { visible: false },
                        columns: [
                            { dataField: "taskSheetNo", caption: "Task Sheet No", width: columnWidth, visible: false, groupIndex: 0 },
                            { dataField: "employeeName", caption: "Employee Name", width: columnWidth, visible: false },
                            { dataField: "turndownStatus", caption: "", width: columnWidth - 80 },
                            { dataField: "roomStatus", caption: "", width: columnWidth - 80 },
                            { dataField: "roomNo", caption: "", width: columnWidth },
                            { dataField: "credit", caption: "", width: columnWidth }
                        ],
                        summary: {
                            groupItems: [{
                                column: "taskSheetNo",
                                summaryType: "count",
                                displayFormat: "{0} items"
                            }]
                        },
                        autoExpandAll: true,
                        onCellPrepared: function (e) {
                            if (e.rowType === "group" && e.cellElement.find(".dx-datagrid-group-opened, .dx-datagrid-group-closed").length) {
                                e.cellElement.find(".dx-datagrid-group-opened, .dx-datagrid-group-closed").remove();
                            }
                            if (e.rowType === "data" && e.column.dataField === "roomStatus") {
                                const status = (e.value || "").toUpperCase();
                                switch (status) {
                                    case "OD": e.cellElement.addClass("color-OD").css("color", "white"); break;
                                    case "OOO": e.cellElement.addClass("color-OOO").css("color", "white"); break;
                                    case "VCN": e.cellElement.addClass("color-VCN"); break;
                                    case "OCN": e.cellElement.addClass("color-OCN").css("color", "white"); break;
                                    case "OC": e.cellElement.addClass("color-OC"); break;
                                    case "VC": e.cellElement.addClass("color-VC"); break;
                                    case "VD": e.cellElement.addClass("color-VD").css("color", "white"); break;
                                    case "DO": e.cellElement.addClass("color-DO").css("color", "white"); break;
                                    default:
                                        e.cellElement.css("background-color", "").css("color", "");
                                        break;
                                }
                            }
                        },
                        customizeColumns: function (columns) {
                            columns.forEach(column => {
                                if (column.dataField === 'taskSheetNo') {
                                    column.groupCellTemplate = function (cellElement, cellInfo) {
                                        const roomCount = cellInfo.data.items.length;
                                        cellElement.text(`Task ${cellInfo.data.key} - ${cellInfo.data.items[0].employeeName} | Rms ${roomCount}`);
                                    };
                                }
                            });
                        },
                        scrolling: {
                            useNative: true,
                            showScrollbar: "always",
                            columnRenderingMode: "virtual"
                        },
                        filterRow: { visible: true, applyFilter: "auto" },
                        headerFilter: { visible: true },
                        selection: { mode: "multiple", showCheckBoxesMode: "none" },
                        showBorders: true,
                        onRowPrepared: function (e) {
                            if (e.rowType === "data") {
                                e.rowElement.on("contextmenu", function (ev) {
                                    ev.preventDefault();
                                    return false;
                                });

                                e.rowElement.off("click").on("click", function (ev) {
                                    if (ev.which === 1) { // chuột trái
                                        contextRowData = e.data;
                                        contextMenu.option("target", e.rowElement);
                                        contextMenu.show();
                                    }
                                });
                            }
                        }
                    }).dxDataGrid("instance");

                    // ⚡ Lưu gridInstance để contextMenu lấy lại
                    $(`#${gridId}`).data("gridInstance", grid);
                });

                $("#loadingSpinner").hide();
            },
            error: function (xhr, status, error) {
                console.error("Lỗi AJAX:", status, error, xhr.responseText);
                alert(`Không thể tải báo cáo. Mã lỗi: ${xhr.status}. Vui lòng thử lại sau.`);
                $("#loadingSpinner").hide();
            }
        });
    }

    function createNewTaskSheet(taskDetailIDs,sourceTaskSheetData) {
        console.log("⚡ Tạo TaskSheet mới từ:", sourceTaskSheetData);

        // Ví dụ gọi API tạo mới
        $.ajax({
            url: '/HouseKeeping/CreateNewTaskSheet',
            type: 'POST',
            data: {
                taskDetailIDs: taskDetailIDs,
                targetTaskSheetData: sourceTaskSheetData[0].taskSheetID
            },
            headers: { "X-CSRF-TOKEN-HEADERNAME": $("input[name='__RequestVerificationToken']").val() },
            success: function (res) {
                showToast('Success', res.message, true);
                ExpandedTaskSheet(); // reload lại lưới
            },
            error: function (xhr) {
                alert("Lỗi khi tạo TaskSheet mới: " + xhr.responseText);
            }
        });
    }




        $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
            $("#loadingSpinner").show();
            $.ajax({
                url: '/HouseKeeping/TaskAssignmentData',
                type: 'GET',
                data: {
                    fromDate: $("#fromDate").val(),
                    tasksheet: $("#tasksheet").val(),
                              zone: $("#zone").val()
                },
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    // $("#reportViewerContainer").html(result);
                    // $("#loadingSpinner").hide();
                            console.log(result);
                          initializeTaskSheetStatusGrid(result);
                             // initializeTaskSheetStatusPopGrid(result);
                        $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });

            function initializeRoomAttendantDailyWorkSheetGrid(data) {
        const columnWidth = 100;

        $("#logGridReportContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: false,
                height: "100%",
                 grouping: {
            autoExpandAll: false
        },
        groupPanel: {
            visible: false
        },
            columns: [
                {
                dataField: "taskSheetNo",
                caption: "Task Sheet No.",
                  dataType: "number",
                groupIndex: 0, // Group theo cột này
                sortOrder: "asc", // Sắp xếp nhóm tăng dần
                visible: false // Ẩn cột trong dữ liệu, chỉ hiển thị nhóm
            },
                   {
                    caption: "No",
                    width: 60,
                    cellTemplate: function (container, options) {
                        if (options.rowType === "data") {
                            const visibleRows = options.component.getVisibleRows();
                            let rowIndexInGroup = 0;

                            for (let i = 0; i < visibleRows.length; i++) {
                                const row = visibleRows[i];
                                if (row.rowType === "data" && row.data.taskSheetNo === options.data.taskSheetNo) {
                                    rowIndexInGroup++;
                                    if (row.key === options.key) {
                                        container.text(rowIndexInGroup);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                },

                { dataField: "roomNo", caption: "R. No.", width: columnWidth },
                { dataField: "", caption: "Sur.charge", width: columnWidth },
                { dataField: "roomType", caption: "R.Type", width: columnWidth },
                { dataField: "mainGuestNationality", caption: "MG Nat.", width: columnWidth },
                {
                    caption: "Room Status",
                    columns: [
                        { dataField: "vc", caption: "VC", width: columnWidth-20 , dataType: "number", format: "#,##0" },
                        { dataField: "od", caption: "OD", width: columnWidth-20 , dataType: "number", format: "#,##0" },
                        { dataField: "do", caption: "DO", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "vd", caption: "VD", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "ooo", caption: "OOO", width: columnWidth -20, dataType: "number", format: "#,##0" }
                    ]
                },
                {
                    caption: "Time",
                    columns: [
                        { dataField: "in", caption: "IN", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "out", caption: "OUT", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "status", caption: "Status", width: columnWidth-10 , dataType: "number", format: "#,##0" }
                    ]
                },
                {
                    caption: "Bedroom",
                    columns: [
                        { dataField: "mw", caption: "Water", width: columnWidth, dataType: "number", format: "#,##0"  },
                        { dataField: "br", caption: "Cafe", width: columnWidth , dataType: "number", format: "#,##0" },
                        { dataField: "yk", caption: "Tea", width: columnWidth , dataType: "number", format: "#,##0" },
                        { dataField: "sl", caption: "Sugar", width: columnWidth , dataType: "number", format: "#,##0" }
                    ]
                },
                {
                    caption: "Bathroom",
                    columns: [
                        { dataField: "bt", caption: "Bath Towel", width: columnWidth +10, dataType: "number", format: "#,##0" },
                        { dataField: "ft", caption: "Face Towel", width: columnWidth+10, dataType: "number", format: "#,##0"  },
                        { dataField: "ht", caption: "Hand Towel", width: columnWidth +10, dataType: "number", format: "#,##0" },
                        { dataField: "bm", caption: "BM", width: columnWidth , dataType: "number", format: "#,##0" },
                        { dataField: "am", caption: "AM", width: columnWidth, dataType: "number", format: "#,##0"  }
                    ]
                },
                { dataField: "special", caption: "Special", width: columnWidth },
                { dataField: "itemInventory", caption: "Item Inv", width: columnWidth },
                { dataField: "status", caption: "Resv Status", width: columnWidth +10},
                { dataField: "", caption: "Arrvial/departure", width: columnWidth +10}
            ],


            paging: { pageSize: 50 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [50, 100, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,

            onRowClick: function (e) {
                selectedRowData = e.data; // lưu dòng được chọn
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data") {
                    if (e.data?.isTotal) {
                        e.rowElement.css({
                            "font-weight": "bold",
                            "background-color": "#f6f6f6"
                        });
                    }
                }
            }
        });
    }
               function initializeRAWorkSheetGrid(data) {
        const columnWidth = 100;

        $("#logGridReportContainer2").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: false,
                height: "100%",
                 grouping: {
            autoExpandAll: false
        },
        groupPanel: {
            visible: false
        },
            columns: [
                {
                dataField: "taskSheetNo",
                caption: "Task Sheet No.",
                  dataType: "number",
                groupIndex: 0, // Group theo cột này
                sortOrder: "asc", // Sắp xếp nhóm tăng dần
                visible: false // Ẩn cột trong dữ liệu, chỉ hiển thị nhóm
            },
                   {
                    caption: "No",
                    width: 60,
                    cellTemplate: function (container, options) {
                        if (options.rowType === "data") {
                            const visibleRows = options.component.getVisibleRows();
                            let rowIndexInGroup = 0;

                            for (let i = 0; i < visibleRows.length; i++) {
                                const row = visibleRows[i];
                                if (row.rowType === "data" && row.data.taskSheetNo === options.data.taskSheetNo) {
                                    rowIndexInGroup++;
                                    if (row.key === options.key) {
                                        container.text(rowIndexInGroup);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                },

                { dataField: "roomNo", caption: "Ro. No.", width: columnWidth },
                { dataField: "", caption: "Sur.charge", width: columnWidth },
                { dataField: "roomStatus", caption: "Ro.Sta.", width: columnWidth },
                {
                    caption: "Time",
                    columns: [
                        { dataField: "in", caption: "IN", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "out", caption: "OUT", width: columnWidth -20, dataType: "number", format: "#,##0" },
                       
                    ]
                },
                { dataField: "statusChange", caption: "Status Change", width: columnWidth+30 },
                 { dataField: "choco", caption: "Choco.", width: columnWidth,dataType: "number", format: "#,##0", customizeText: function(e) { return e.value === 0 ? "" : e.text; } },
                   { dataField: "eb", caption: "EB", width: columnWidth },
                 { dataField: "vip", caption: "VIP", width: columnWidth },
                  {
                  caption: "Towel",
                  columns: [
                    {
                      dataField: "bath",
                      caption: "Bath",
                      width: columnWidth,
                      dataType: "number",
                      format: "#,##0",
                      customizeText: function(e) {
                        return e.value === 0 ? "" : e.text;
                      }
                    },
                    {
                      dataField: "hand",
                      caption: "Hand",
                      width: columnWidth,
                      dataType: "number",
                      format: "#,##0",
                      customizeText: function(e) {
                        return e.value === 0 ? "" : e.text;
                      }
                    },
                    {
                      dataField: "face",
                      caption: "Face",
                      width: columnWidth,
                      dataType: "number",
                      format: "#,##0",
                      customizeText: function(e) {
                        return e.value === 0 ? "" : e.text;
                      }
                    },
                    {
                      dataField: "mat",
                      caption: "Mat",
                      width: columnWidth,
                      dataType: "number",
                      format: "#,##0",
                      customizeText: function(e) {
                        return e.value === 0 ? "" : e.text;
                      }
                    }
                  ]
                },

               
                { dataField: "remarks", caption: "Remarks", width: columnWidth +30}
            ],


            paging: { pageSize: 50 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [50, 100, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,

            onRowClick: function (e) {
                selectedRowData = e.data; // lưu dòng được chọn
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data") {
                    if (e.data?.isTotal) {
                        e.rowElement.css({
                            "font-weight": "bold",
                            "background-color": "#f6f6f6"
                        });
                    }
                }
            }
        });
    }
      function initializeSupChecklistFloorGrid(data) {
        const columnWidth = 110;

        $("#logGridReportContainer3").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: false,
                height: "100%",
                 grouping: {
            autoExpandAll: false
        },
        groupPanel: {
            visible: false
        },
            columns: [
                {
                dataField: "floor",
                caption: "Floor",
                  dataType: "number",
                groupIndex: 0, // Group theo cột này
                sortOrder: "asc", // Sắp xếp nhóm tăng dần
                visible: false // Ẩn cột trong dữ liệu, chỉ hiển thị nhóm
            },
                 
                { dataField: "roomNo", caption: "Room No", width: columnWidth },
                { dataField: "roomStatus", caption: "Ro.Sta.", width: columnWidth },
                {
                    caption: "Time",
                    columns: [
                        { dataField: "in", caption: "IN", width: columnWidth -20, dataType: "number", format: "#,##0" },
                        { dataField: "out", caption: "OUT", width: columnWidth -20, dataType: "number", format: "#,##0" },

                    ]
                },
                { dataField: "statusChange", caption: "Status Change", width: columnWidth+20 },
                  { dataField: "roomType", caption: "Room Type", width: columnWidth+20 },
                { dataField: "country", caption: "Nationality", width: columnWidth+20 },
                { dataField: "specials", caption: "Rsq specials", width: columnWidth+20 },
                { dataField: "itemInventory", caption: "Item Inventory", width: columnWidth+20 },
                { dataField: "note", caption: "Note", width: columnWidth+50 },

            ],


            paging: { pageSize: 50 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [50, 100, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,

            onRowClick: function (e) {
                selectedRowData = e.data;

                // Nếu là dòng nhóm (group row)
                if (e.rowType === "group") {
                    // Lấy số tầng từ key group
                    const floorNumber = e.key; // Đây là giá trị groupIndex = 0 => floor

                    // Hiển thị vào ô Floor
                    $('#floorDisplay3').text(floorNumber);
                }
            },

            onRowPrepared: function (e) {
                if (e.rowType === "data") {
                    if (e.data?.isTotal) {
                        e.rowElement.css({
                            "font-weight": "bold",
                            "background-color": "#f6f6f6"
                        });
                    }
                }
            }
        });
    }
    let selectedRowDataTS = null;
        let selectedRowDataAU = null;
                let selectedRowDatadetail = null;
    function initializeTaskSheetStatusGrid(data) {
        const columnWidth = 120;

        $("#gridContainer").dxDataGrid({
            dataSource: data,
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                { dataField: "taskSheetNo", caption: "Sheet", width: columnWidth },
                { dataField: "section", caption: "Section", width: columnWidth },
                { dataField: "rooms", caption: "Rooms", width: columnWidth },
                { dataField: "credits", caption: "Credits", width: columnWidth },
                { dataField: "completedOn", caption: "Completed On", width: columnWidth },
                { dataField: "status", caption: "Status", width: columnWidth },
                { dataField: "taskCode", caption: "Task Code", width: columnWidth },
                { dataField: "employee", caption: "Employee", width: columnWidth +70},
                { dataField: "taskInstructions", caption: "Task Instructions", width: columnWidth+20 },
                  { dataField: "attendant", caption: "Attendant", width: columnWidth },
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,

            // onRowClick: function (e) {
            //     selectedRowDataTS = e.data; // lưu dòng được chọn
            // },
             onSelectionChanged: function (e) {
           
                selectedRowDataTS= e.selectedRowsData;
                console.log("Danh sách dòng đã chọn:", selectedRowDataTS);

            }
        });
    }



        $("#btnExportExcel").click(function () {
                   const grid = $("#gridContainer").dxDataGrid("instance");
            var selectedReport = 'Task Assignment';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
             worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
               $("#btnExportpopExcel").click(function () {
                   const grid = $("#logGridContainer").dxDataGrid("instance");
            var selectedReport = 'Task Assignment';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
            worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });

            $("#btnExportExcel1").click(function () {
                   const grid = $("#logGridReportContainer").dxDataGrid("instance");
            var selectedReport = 'RoomAttendantDailyWorkSheet';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
            worksheet.addRow(['']);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
            $("#btnExportExcel2").click(function () {
                   const grid = $("#logGridReportContainer2").dxDataGrid("instance");
            var selectedReport = 'R/A Evening Worksheet';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
           worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
                $("#btnExportExcel3").click(function () {
                   const grid = $("#logGridReportContainer3").dxDataGrid("instance");
                var selectedReport = 'Supervisor Hoor Checklist';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
              worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
</script>