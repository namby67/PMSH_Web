@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var zoneList = ViewBag.ZoneList;
}

@* <link asp-append-version="true" href="~/css/reservation.css" rel="stylesheet" /> *@
<style>
   /*  #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important;
        color: white !important; 
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; 
        color: white !important; 
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

       
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    } */


    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }
/* 
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; 
        color: white !important; 
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        } */

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <!-- From Date -->
        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <label class="fw-bold me-3">View by:</label>

                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Zone:</label>
                    <select id="zone" name="zone" class="tomselect-custom" multiple>
                        @foreach (var item in zoneList)
                        {
                            if (item == zoneList[0])
                            {
                                <option value="@item.Code" selected>@item.Code</option>
                            }
                            else
                            {
                                <option value="@item.Code">@item.Code</option>
                            }
                        }
                    </select>

                </div>
            </div>
        </div>
        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">From :</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">To :</label>
                    <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>
    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: darkorange;" id="btnExportPdf" class="mui-button mui-button-new" type="button"><i class="fas fa-eraser"></i> PDF</button>
    </div>
</div>

<div class="mui-card">
    @*     <div style="font-size: 20px;" class="mt-1" id="reportTitle"></div> *@
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
       function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }
                let parsedBusinessDate = null;

        $(document).ready(function () {
             document.getElementById("reportTitle").innerText = 'Room Control Panel';
          var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
            console.log(businessDateStr);
             // Lấy phần ngày tháng năm
             var dateOnly = businessDateStr.split(' ')[0]; // '8/29/2024'
             var dateParts = dateOnly.split('/'); // ['8', '29', '2024']

             // Parse đúng thứ tự: new Date(year, monthIndex, day)
              parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

             // Gán vào input type="date"
             $('#fromDate').val(formatDate(parsedBusinessDate));
                 var toDate = new Date(parsedBusinessDate);
                    toDate.setDate(toDate.getDate() + 13);

                    $('#toDate').val(formatDate(toDate));
            initializeTomSelects();


        });
        function initializeTomSelects() {
        const selectors = ["#zone"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }
        $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
            $("#loadingSpinner").show();
            $.ajax({
                url: '/HouseKeeping/RoomControlPanelData',
                type: 'GET',
                data: {
                    fromDate: $("#fromDate").val(),
                    toDate: $("#toDate").val(),
                    zone: $("#zone").val(),
                },
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    // $("#reportViewerContainer").html(result);
                    // $("#loadingSpinner").hide();
                console.log(result);
            initializeReservationSummaryGrid(result, $("#fromDate").val(), $("#toDate").val());
                        $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });


           function generateDateColumns(fromDate, toDate) {
        const columns = [];
        const start = new Date(fromDate);
        const end = new Date(toDate);

        while (start <= end) {
            const dateStr = start.toISOString().split("T")[0]; // yyyy-MM-dd

            const day = start.getDate().toString().padStart(2, '0');
            const month = start.toLocaleString('en-US', { month: 'short' }); // "Jul"
            const weekday = start.toLocaleString('en-US', { weekday: 'short' }); // "Mon"
            const weekNumber = getWeekNumber(start); // CW

            const captionHtml = `${day}-${month}<br>${weekday}<br>CW${-weekNumber}`;

            columns.push({
                dataField: dateStr,
                width: 110,
                dataType: "number",
                format: {
                    type: "fixedPoint",
                    precision: 1 // luôn có 1 ch? s? th?p phân
                },
                alignment: "center",
                headerCellTemplate: function (container) {
                    container.html(`<div style="white-space: normal; text-align:center; font-size:11px;">${captionHtml}</div>`);
                }
            });

            start.setDate(start.getDate() + 1);
        }

        return columns;
    }


        function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }



           function initializeReservationSummaryGrid(data, fromDate, toDate) {
        const columnWidth = 120;



        const dateColumns = generateDateColumns(fromDate, toDate);
         console.log(dateColumns);
        $("#gridContainer").dxDataGrid({
            dataSource: data,     
            allowColumnResizing: true,
            columnAutoWidth: true,
            columns: [
                { dataField: "Statisticname", caption: "Statistic Name", width: columnWidth + 40 },
                ...dateColumns
            ],

            paging: { pageSize: 25 },
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
            pager: {
                visible: true,
                allowedPageSizes: [25, 50, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,
            onRowPrepared: function (e) {
                if (e.rowType === "data") {

                    if (e.data?.isTotal) {
                        e.rowElement.css({
                            "font-weight": "bold",
                            "background-color": "#f6f6f6"
                        });
                    }
                }
            }
        });
    }




        $("#btnExportExcel").click(function () {
                   const grid = $("#gridContainer").dxDataGrid("instance"); var selectedReport2 = '@ViewBag.ReportTitle';
            var selectedReport = '@ViewBag.ReportTitle';
            if (!selectedReport) {
                alert("Vui lòng ch?n báo cáo tru?c khi xu?t Excel.");
                return;
            }

                         const workbook = new ExcelJS.Workbook();const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === T?o header công ty (dòng 1) ===
            worksheet.addRow(['Công ty C? ph?n Gi?i pháp Công ngh? CS-Solution']);
            worksheet.mergeCells('A1:E1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Th?i gian xu?t (ph?i) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', '', ' ' + exportDate]);
            worksheet.mergeCells('E2:H2');
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: Tr?ng
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tên báo cáo ? gi?a ===
            const reportRow = worksheet.addRow(['', '', selectedReport]);
            worksheet.mergeCells('C5:F5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: Tr?ng tru?c khi xu?t d? li?u
            worksheet.addRow([]);

            // === Export d? li?u t? DevExtreme (b?t d?u t? dòng 7)
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 } // d? li?u b?t d?u t? dòng 7
            }).then(function () {
                // Footer
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.getCell(`A${lastRow}`).value = "--- END  ---";
                worksheet.mergeCells(`A${lastRow}:F${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = selectedReport + ".xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });



        // Nút xu?t PDF
           $("#btnExportPdf").click(function () {
            const { jsPDF } = window.jspdf; // ?? B? sung dòng này

            const doc = new jsPDF();

            DevExpress.pdfExporter.exportDataGrid({
                jsPDFDocument: doc,
                component: $("#gridContainer").dxDataGrid("instance"),
                autoTableOptions: {
                    styles: { cellPadding: 2, fontSize: 8 },
                    margin: { top: 20 }
                }
            }).then(() => {
                doc.save("BaoCao.pdf");
            });
        });
</script>
