@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var roomTypeList = ViewBag.RoomTypeList;
    var floorList = ViewBag.FloorList;
    var blockList = ViewBag.BlockList;
      var zoneList = ViewBag.ZoneList;
}

@* <link asp-append-version="true" href="~/css/reservation.css" rel="stylesheet" /> *@
<style>
/*     #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important;
        color: white !important; 
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; 
        color: white !important; 
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

      
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }
 */

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

/*     #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; 
        color: white !important; 
    }
 */
        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }

    .tomselect-custom {
        width: 250px;
        min-height: 30px; /* ho?c tùy theo chi?u cao b?n mu?n */
        font-size: 0.65rem;
    }

    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <!-- From Date -->
        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <label class="fw-bold me-3">Info Search:</label>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Block:</label>
                    <select id="block" name="block" class="form-control form-control-sm w-auto">
                        @foreach (var item in blockList)
                        {
                            <option value="@item.ID">@item.Name</option>
                        }
                    </select>
                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Floor:</label>
                    <select id="floor" name="floor" class="form-control form-control-sm w-auto" >
                        <option value="">-ALL--</option>
                        @foreach (var item in floorList)
                        {
                            <option value="@item.ID">@item.Name</option>
                        }
                    </select>

                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Room Type:</label>
                    <select id="roomtype" name="roomtype" class="form-control form-control-sm w-auto" >
                        <option value="">-Select All--</option>
                        @foreach (var item in roomTypeList)
                        {
                            <option value="@item.ID">@item.Code</option>
                        }
                    </select>

                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Owner:</label>
                    <select id="owner" name="owner" class="form-control form-control-sm w-auto">
                        <option value="0">--ALL--</option>
                        <option value="1">--Hotel--</option>
                        <option value="2">--Owner--</option>

                    </select>
                </div>
                <div class="d-flex align-items-center me-1">
                    <label class="me-2 mb-0">Zone:</label>
                    <select id="zone" name="zone" class="tomselect-custom" style="width: 70px;" multiple>
                        @foreach (var item in zoneList)
                        {
                            <option value="@item.Code">@item.Code</option>
                        }
                    </select>

                </div>
            </div>
        </div>
        <div class="d-flex flex-column ">

        
            <div class="d-flex flex-wrap gap-2 mt-2">
                <label class="fw-bold me-3">Status:</label>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #d38c67; border: 1px solid #000;"></div>
                    <span id="lblOCN" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #ffff00; border: 1px solid #000;"></div>
                    <span  id="lblOC"  class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #cc0000; border: 1px solid #000;"></div>
                    <span id="lblOD" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #ff00ff; border: 1px solid #000;"></div>
                    <span id="lblDO" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #006400; border: 1px solid #000;"></div>
                    <span id="lblVCN"  class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #add8e6; border: 1px solid #000;"></div>
                    <span   id="lblVC" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #0000cc; border: 1px solid #000;"></div>
                    <span id="lblVD" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #d38c67; border: 1px solid #000;"></div>
                    <span id="lblOOO" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #ffe4c4; border: 1px solid #000;"></div>
                    <span id ="lblOOS" class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center">
                    <div style="width: 30px; height: 20px; background-color: #ffa500; border: 1px solid #000;"></div>
                    <span id="lblDISC"  class="ms-1"></span>
                </div>
                <div class="d-flex align-items-center fw-bold">
                    <span id="lblTOTAL" class="ms-1"></span>
                </div>
            </div>

        </div>



    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
       
    </div>
</div>

<div class="mui-card">
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>


        $(document).ready(function () {
                      document.getElementById("reportTitle").innerText = 'Floor Plan';
                $("#btnPrint").trigger("click");
                     initializeTomSelects();
        });
            function initializeTomSelects() {
            const selectors = ["#zone"];

                for (const id of selectors) {
                    const el = document.querySelector(id);
                    if (!el) continue;

                    // Nếu đã khởi tạo rồi thì destroy
                    if (el.tomselect) el.tomselect.destroy();

                    const ts = new TomSelect(el, {
                        plugins: ['remove_button'],
                        create: false,
                        maxItems: null,
                        allowEmptyOption: true,
                        placeholder: '',
                        persist: false,
                        render: {
                            option: function (data, escape) {
                                return `<div>${escape(data.text)}</div>`;
                            }
                        }
                    });

                }
            }
        $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
            $("#loadingSpinner").show();
            $.ajax({
                url: '/HouseKeeping/FloorPlanData',
                type: 'GET',
                data: {
                    block: $("#block").val(),
                    floor: $("#floor").val(),
                    roomtype: $("#roomtype").val(),
                    owner: $("#owner").val(),
                            zone: $("#zone").val().join(",")
                    },
                traditional: true,
                  crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                success: function (result) {
                    // $("#reportViewerContainer").html(result);
                    // $("#loadingSpinner").hide();
                console.log(result);
                const status = result.statusCounts;

    if (status) {
        $("#lblOCN").text(`OCN (${status.OCN || 0})`);
        $("#lblVCN").text(`VCN (${status.VCN || 0})`);
        $("#lblOOO").text(`OOO (${status.OOO || 0})`);
        $("#lblOOS").text(`OOS (${status.OOS || 0})`);
        $("#lblVD").text(`VD (${status.VD || 0})`);
        $("#lblVC").text(`VC (${status.VC || 0})`);
        $("#lblOD").text(`OD (${status.OD || 0})`);
        $("#lblOC").text(`OC (${status.OC || 0})`);
        $("#lblDISC").text(`DISC (${status.DISC || 0})`);
        $("#lblDO").text(`DO (${status.DO || 0})`);
        $("#lblTOTAL").text(`Total (${status.TOTAL || 0})`);
    }

            initializeReservationSummaryGrid(result);
                        $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không th? t?i báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });





             function initializeReservationSummaryGrid(result) {
        const columnWidth = 80;
        const maxCount = result.maxRoomCount;
        const data = result.data;

        const columns = [{
            dataField: "Floor",
            caption: "",
                width: columnWidth,
            fixed: true,
            fixedPosition: "left"
        }];

           for (let i = 1; i <= maxCount; i++) {
            columns.push({
                dataField: i.toString(),
                caption: `${i}`,
                width: columnWidth,
                     cellTemplate(container, options) {
                        const room = options.data[options.column.dataField];
                        if (room && typeof room === "object") {
                            const roomNo = room.roomNo || "";
                                    const roomType = room.roomType || "";

                            // Hiển thị cả room và type trong cùng ô
                            const displayText = `${roomNo}\n(${roomType})`;
                            container.text(displayText);

                            // Đồng thời cũng thêm tooltip cho rõ hơn khi hover
                                const tooltip = `Room: ${roomNo}\n Room Type: ${roomType}`;
                            container.attr("title", tooltip);
                        }
                    }


            });
        }



        $("#gridContainer").dxDataGrid({
            dataSource: data,
            columns: columns,
            allowColumnResizing: true,
            columnAutoWidth: false,
            paging: { enabled: false },
             height: "auto",
            scrolling: {
                useNative: true,
                showScrollbar: "always"
            },
           
            filterRow: { visible: true, applyFilter: "auto" },
            headerFilter: { visible: true },
            selection: { mode: "multiple", showCheckBoxesMode: "none" },
            showBorders: true,
                onCellPrepared: function (e) {
        if (e.rowType === "data" && e.column.dataField !== "Floor") {
            const room = e.data[e.column.dataField];
            if (room && typeof room === "object") {
                const hk = room.hkStatusID;
                const fo = room.foStatus;
                const hkfo = room.hkfoStatus;
                const fop = room.foPerson;
                const hkp = room.hkPersons;

                let bgColor = "";
                       let textColor = "";
                if (hk === 0 && fo === 1) bgColor = "#d38c67";        // OCN
                else if (hk === 1 && fo === 1) bgColor = "#006400";    // VCN
                else if (hk === 5 && hkfo === fo && fop === hkp) bgColor = "#d38c67"; // OOO
                else if (hk === 6 && hkfo === fo && fop === hkp) bgColor = "#ffe4c4"; // OOS
                    else if (hk === 2 && fo === 0) {
                    bgColor = "#0000cc";    // VD
                    textColor = "white";   // Chữ trắng
                }
                else if (hk === 4 && fo === 0) bgColor = "#add8e6";    // VC
                else if (hk === 2 && fo === 1) bgColor = "#cc0000";    // OD
                else if (hk === 4 && fo === 1) bgColor = "#ffff00";    // OC
                else if (hk === 7) bgColor = "#ff00ff";                // DO
                else if (hkfo !== fo || fop !== hkp) bgColor = "#ffa500"; // DISC

                e.cellElement.css("background-color", bgColor);
                    e.cellElement.css("color", textColor);
                e.cellElement.text(room.roomNo || "");
            }
        }
    }
,
            onRowPrepared: function (e) {
                if (e.rowType === "data" && e.data?.isTotal) {
                    e.rowElement.css({
                        "font-weight": "bold",
                        "background-color": "#f6f6f6"
                    });
                }
            }
        });
    }





</script>