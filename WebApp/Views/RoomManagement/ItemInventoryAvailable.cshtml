@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{

}

<style>
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }

    .btn-mini {
        padding: 4px 10px; /* cao hơn btn-sm */
        font-size: 14px; /* chữ lớn hơn một chút */
        line-height: 1.2;
    }
    .selected-cell {
        background-color: #d0eaff !important;
        border: 2px solid #007acc !important;
    }

</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Item Inventory Available</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
        <!-- From Date -->
        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Date:</label>
                    <input type="date" id="firstDate" name="firstDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">Item Group:</label>
            <select id="groupId" name="groupId" class="form-control form-control-sm w-auto">
                <option value="0">--All--</option>
                <option value="1">Recreational</option>
                <option value="2">Audiovisual</option>
                <option value="3">Cocktail</option>
                <option value="4">Decoration</option>
                <option value="5">Room</option>
            </select>
        </div>
        <div style="display:flex; gap:5px;">
            <button id="btnMinus15" type="button" class="btn btn-outline-secondary btn-mini">- 15 days</button>
            <button id="btnPlus15" type="button" class="btn btn-outline-secondary btn-mini">+ 15 days</button>
        </div>

    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnDetail" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Detail</button>

    </div>
</div>

<div class="mui-card">

    <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div id="gridContainer"></div>
    </div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<div id="popupShiftDetail">
</div>

<script>
    // Biến toàn cục lưu dòng của ô được click
    let selectedCellData = null;

    function formatDate(date) {
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Tạo caption cột động theo ngày
    function generateDynamicCaptions(firstDateVal) {
        const captions = [];
        const firstDate = new Date(firstDateVal);

        for (let i = 0; i < 15; i++) {
            const newDate = new Date(firstDate);
            newDate.setDate(firstDate.getDate() + i);

            const day = newDate.getDate().toString().padStart(2, '0');
            const month = newDate.toLocaleString('en-US', { month: 'short' });
            const dayOfWeek = newDate.toLocaleString('en-US', { weekday: 'short' });

            const yearStart = new Date(newDate.getFullYear(), 0, 1);
            const days = Math.floor((newDate - yearStart) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + yearStart.getDay() + 1) / 7);

            captions.push(`${day}-${month}\n(${dayOfWeek})\nCW ${weekNumber}`);
        }

        return captions;
    }

    function loadTelephoneGrid(data) {
        let firstDateVal = $("#firstDate").val();
        const dynamicCaptions = generateDynamicCaptions(firstDateVal);

        $("#gridContainer").dxDataGrid({
            dataSource: data,
            height: 400,
            keyExpr: "id",
            allowColumnResizing: true,
            selection: {
                mode: "none"
            },
            onCellClick: function (e) {
                // Kiểm tra có dữ liệu dòng không
                if (!e.data || !e.column || !e.column.dataField) return;

                $(".dx-datagrid-rowsview .selected-cell").removeClass("selected-cell");
                $(e.cellElement).addClass("selected-cell");

                selectedCellData = e.data;
                selectedColumn = e.column.dataField;

                console.log("== CELL CLICKED ==");
                console.log("Data of row (e.data):", e.data);
                console.log("Clicked column:", e.column.dataField);
                console.log("Value in cell:", e.data[e.column.dataField]);
                if (selectedColumn !== "itemName") {
                    showShiftDetail(selectedCellData, selectedColumn);
                }
            },
            columns: [
                { dataField: "itemName", caption: "Item Name" },
                { dataField: "firstDate1", caption: dynamicCaptions[0], wordWrapEnabled: true },
                { dataField: "secondDate1", caption: dynamicCaptions[1], wordWrapEnabled: true },
                { dataField: "thirthDate1", caption: dynamicCaptions[2], wordWrapEnabled: true },
                { dataField: "fourthDate1", caption: dynamicCaptions[3], wordWrapEnabled: true },
                { dataField: "fifthDate1", caption: dynamicCaptions[4], wordWrapEnabled: true },
                { dataField: "sixthDate1", caption: dynamicCaptions[5], wordWrapEnabled: true },
                { dataField: "seventhDate1", caption: dynamicCaptions[6], wordWrapEnabled: true },
                { dataField: "eighthDate1", caption: dynamicCaptions[7], wordWrapEnabled: true },
                { dataField: "ninthDate1", caption: dynamicCaptions[8], wordWrapEnabled: true },
                { dataField: "tenthDate1", caption: dynamicCaptions[9], wordWrapEnabled: true },
                { dataField: "eleventhDate1", caption: dynamicCaptions[10], wordWrapEnabled: true },
                { dataField: "twelvethDate1", caption: dynamicCaptions[11], wordWrapEnabled: true },
                { dataField: "thirtheenDate1", caption: dynamicCaptions[12], wordWrapEnabled: true },
                { dataField: "fourtheenDate1", caption: dynamicCaptions[13], wordWrapEnabled: true },
                { dataField: "fiftheenDate1", caption: dynamicCaptions[14], wordWrapEnabled: true },
            ],
            scrolling: {
                mode: "standard",
                showScrollbar: "always",
                scrollByContent: true
            },
            paging: {
                pageSize: 20
            },
            pager: {
                visible: true,
                allowedPageSizes: [20, 40, 'all'],
                showPageSizeSelector: true,
                showInfo: true,
                showNavigationButtons: true
            },
            filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            showBorders: true,
            wordWrapEnabled: true
        });
    }

    // Popup chi tiết
    $("#popupShiftDetail").dxPopup({
        title: "Item Reservation",
        width: "85%",
        height: "90%",
        encodeHtml: false,
        showCloseButton: true,
        visible: false,
        contentTemplate: function (container) {
            container.append(`
                <div class="mui-card shift-header mb-1"></div>
                <div id="gridShiftDetail"></div>
            `);

            $("#gridShiftDetail").dxDataGrid({
                dataSource: [],
                showBorders: true,
                height: "90%",
                width: "100%",
                columnAutoWidth: true,
                columns: [
                    { dataField: "confirmationNo", caption: "Confirmation No", dataType: "number" },
                    { dataField: "name", caption: "Name" },
                    { dataField: "roomNo", caption: "Room No", dataType: "number" },
                    { dataField: "reservedFrom", caption: "Reserved From", dataType: "date", format: "dd/MM/yyyy" },
                    { dataField: "reservedTo", caption: "Reserved To", dataType: "date", format: "dd/MM/yyyy"},
                    { dataField: "qty", caption: "Qty", dataType: "number", format: "#,##0.00" },
                ],
                scrolling: {
                    mode: "standard",
                    showScrollbar: "always",
                    scrollByContent: true
                },
                paging: {
                    pageSize: 20
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [20, 40, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                }
            });
        }
    });

    $("#btnDetail").on("click", function () {
        if (!selectedCellData || !selectedColumn) {
            DevExpress.ui.notify("Vui lòng chọn một ô hợp lệ trước", "warning", 2000);
            return;
        }
        showShiftDetail(selectedCellData, selectedColumn);
    });

    function formatDateTimeToSQL(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const mm = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }
    function showShiftDetail(rowData, columnDataField) {
        const popup = $("#popupShiftDetail").dxPopup("instance");
        const dateField = columnDataField;
        const itemID = rowData.id;
        const grid = $("#gridContainer").dxDataGrid("instance");
        const columnIndex = grid.columnOption(columnDataField, "index");

        // Lấy caption của cột
        const firstDateVal = $("#firstDate").val();
        const year = new Date(firstDateVal).getFullYear();

        const caption = grid.columnOption(columnDataField, "caption"); // ví dụ "28-Aug\n(Sat)\nCW 35"
        const dayMonth = caption.split('\n')[0]; // "28-Aug"
        const dateStr = `${dayMonth}-${year}`;   // "28-Aug-2025"
        const selectedDate = new Date(dateStr);

        if (!selectedDate || !itemID) {
            alert("Không đủ dữ liệu để hiển thị chi tiết");
            return;
        }

        popup.option("onShown", function () {
            $(".shift-header").html(`
            
            <div class="d-flex align-items-center mb-2">
                <button style="border-radius: 4px; background-color: green;" id="btnDetailpopup" class="mui-button mui-button-new" type="button">
                    <i class="fa-solid fa-file-excel"></i> Detail
                </button>
                <div class="flex-grow-1 text-center">
                    <i>Item Name</i>: <b>${rowData.itemName}</b>
                </div>               
            </div>
       
        `);

            const gridDetail = $("#gridShiftDetail").dxDataGrid("instance");

            gridDetail.option("dataSource", new DevExpress.data.DataSource({
                load: function () {
                    return $.ajax({
                        url: `/RoomManagement/GetItemResvDetail`,
                        data: {
                            itemID: itemID,
                            day: formatDateTimeToSQL(selectedDate),
                        },
                        dataType: "json"
                    }).then(res => {
                        let arr = Array.isArray(res) ? res : Object.values(res);
                        arr = arr.filter(x => x != null);
                        if (Array.isArray(arr[0])) {
                            arr = arr[0];
                        }
                        return arr;
                    });
                }
            }));
        });

        popup.show();
    }

    // Khởi tạo ngày mặc định và tự động load grid khi bấm Load
    $(document).ready(function () {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const formattedFirstDay = formatDate(firstDayOfMonth);
        $("#firstDate").val(formattedFirstDay);

        $("#btnPrint").trigger("click");
    });

    // Button -15 ngày
    $("#btnMinus15").on("click", function () {
        let dateInput = $("#firstDate");
        let date = new Date(dateInput.val());
        date.setDate(date.getDate() - 15);
        dateInput.val(date.toISOString().split('T')[0]);
        $("#btnPrint").trigger("click");
    });

    // Button +15 ngày
    $("#btnPlus15").on("click", function () {
        let dateInput = $("#firstDate");
        let date = new Date(dateInput.val());
        date.setDate(date.getDate() + 15);
        dateInput.val(date.toISOString().split('T')[0]);
        $("#btnPrint").trigger("click");
    });

    // Load dữ liệu lên grid khi bấm Load
    $("#btnPrint").on("click", function () {
        $("#loadingSpinner").show();

        let groupId = $("#groupId").val() || ""; // Nếu có input groupId
        let firstDateVal = $("#firstDate").val();

        function formatDateTime(date) {
            let y = date.getFullYear();
            let m = String(date.getMonth() + 1).padStart(2, '0');
            let d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d} 00:00:00`;
        }

        let firstDate = new Date(firstDateVal);
        let params = { GroupID: groupId };

        const paramNames = [
            "FirstDate", "SecondDate", "ThirthDate", "FourthDate", "FifthDate",
            "SixthDate", "SeventhDate", "EighthDate", "NinthDate", "TenthDate",
            "ElevenDate", "TwelveDate", "ThirtheenDate", "FourtheenDate", "FiftheenDate"
        ];

        paramNames.forEach((name, index) => {
            let newDate = new Date(firstDate);
            newDate.setDate(firstDate.getDate() + index);
            params[name] = formatDateTime(newDate);
        });

        $.ajax({
            url: '/RoomManagement/GetItemInventoryAvailable',
            type: 'GET',
            data: params,
            success: function (data) {
                loadTelephoneGrid(data);
                $("#loadingSpinner").hide();
            },
            error: function () {
                alert("Không thể tải dữ liệu");
                $("#loadingSpinner").hide();
            }
        });
    });
</script>