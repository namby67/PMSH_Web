@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var selectedReport = @ViewBag.ReportHeader;
    var listroom = ViewBag.RoomList;
    var listrclass = ViewBag.RoomClassList;
    var listzone = ViewBag.ZoneList;
    var listcmt = ViewBag.CommentList;
    var rooms = ViewBag.AvailableRooms;
}


<style>
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }

    .ts-dropdown .ts-dropdown-content > div:first-child {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
    }

    #historyModal .modal-dialog.custom-modal-width {
        max-width: 1650px !important;
        width: 1650px !important;
    }
    .custom-modal-width {
    max-width: 560px !important; /* bạn chỉnh số px tuỳ ý */

 
}
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Out of Oder or Service </div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

        <div class="d-flex flex-column ">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">From Date:</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">To Date:</label>
                    <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Room:</label>
            <select id="room" class="tomselect-custom" multiple>
                @foreach (var u in ViewBag.RoomList)
                {
                    <option value="@u.RoomNo">@u.RoomNo - @u.RoomTypeCode</option>
                }
            </select>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Room Class:</label>
            <select id="roomClass" class="form-control form-control-sm w-auto">

                <option value="0">-- Select Group --</option>
                @foreach (var g in ViewBag.RoomClassList)
                {
                    <option value="@g.ID">@g.Code</option>
                }
            </select>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Zone:</label>
            <select id="zone" class="tomselect-custom" multiple>
                @foreach (var z in ViewBag.ZoneList)
                {
                    <option value="@z.Code">@z.Code </option>
                }
            </select>
        </div>
        <label class="me-2 mb-0">Type:</label>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="optionFilter" id="outofOrder" checked>
            <label class="form-check-label" for="outofService">
                Out of Order
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="optionFilter" id="outofService" checked>
            <label class="form-check-label" for="outofService">
                Out of Service
            </label>
        </div>

    </div>

    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #28a745;" id="btnNew" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #007bff;" id="btnEdit" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Edit</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545;" id="btnDelete" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Delete</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnHistory" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> History</button>


    </div>
   
</div>
<div class="mui-card">

    <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div id="gridContainer"></div>
    </div>


    <!-- Modal Popup for New Item -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog custom-modal-width">
            <!-- modal-lg để form rộng hơn -->
            <div class="modal-content" >
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalLabel">New Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <form id="itemForm">
                        <div class="row g-3">
                           
                                <div style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                                    <div class="">
                                        <label class="">Room:</label>
                                        <select id="roomSelect" class="tomselect-custom" style="width: 523px;" multiple>

                                        </select>
                                    </div>
                                    <label>Out Of Order / Service</label>
                                <select id="oooOrS" name="oooOrS" class="form-control form-control-sm " style="width: 523px;">
                                        <option>--Chose One--</option>
                                        <option value="1">Out Of Order</option>
                                        <option value="2">Out Of Service</option>                                     
                                    </select>
                                    <label>Return Status</label>
                                <select id="rtStatus" name="rtStatus" class="form-control form-control-sm" style="width: 523px;">
                                        <option>--Chose One--</option>
                                        <option value="2">Dirty</option>
                                        <option value="1">Clean Non-Checked</option>
                                        <option value="3">Pickup</option>
                                        <option value="4">Clean</option>
                                    </select>               
                                    <div class="">
                                        <label class="">Reason:</label>
                                        <select id="comment" class="form-control form-control-sm" style="width: 523px;">
                                            <option value="">---Select Reason---</option>
                                            @foreach (var dpm in ViewBag.CommentList)
                                            {
                                            <option value="@dpm.ID" data-desc="@dpm.Description">
                                                @dpm.Code - @dpm.Description
                                            </option>
                                            }
                                        </select>
                                    </div>
                                    <label>Reason Note:</label>
                                    <input type="text" id="txtReasonDesc" class="form-control mb-2" />

                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex align-items-center">
                                        <label for="itemFromDate" class="me-2 mb-0">From Date:</label>
                                        <input type="date" id="itemFromDate" class="form-control form-control-sm w-auto" />
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label for="itemToDate" class="me-2 mb-0">To Date:</label>
                                        <input type="date" id="itemToDate" class="form-control form-control-sm w-auto" />
                                    </div>
                                </div>


                              </div>
                            

                        </div>                       
                    </form>
                </div>
                <div class="modal-footer">                  
                    <button type="button" id="btnSaveItem" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl custom-modal-width">
            <!-- rộng hơn để chứa grid -->
            <div class="modal-content" style="height: 800px;">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">Room Change History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">Room:</label>
                            <input type="text" id="historyRoom" class="form-control form-control-sm w-auto" />
                        </div>
                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">User Name:</label>
                            <input type="text" id="historyUser" class="form-control form-control-sm w-auto" />
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <label for="historyFromDate" class="me-2 mb-0">From Date:</label>
                                <input type="date" id="historyFromDate" class="form-control form-control-sm w-auto" />
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="historyToDate" class="me-2 mb-0">To Date:</label>
                                <input type="date" id="historyToDate" class="form-control form-control-sm w-auto" />
                            </div>
                        </div>

                                            
                    </div>
                    <button class="btn btn-sm btn-primary me-2" id="btnHistorySearch">Search</button>
                    <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
               
                 
                    <div id="gridWrapper" class="mt-2"">
                        <div id="historyGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    DevExpress.localization.locale("vi");
      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }
      $(document).ready(function () {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);
                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;
                document.getElementById('historyFromDate').value = formattedFirstDay;
                document.getElementById('historyToDate').value = formattedLastDay;
                document.getElementById('itemFromDate').value = formattedFirstDay;
                document.getElementById('itemToDate').value = formattedLastDay;
                initializeTomSelects();
                reloadGrid()
        });
        document.getElementById("comment").addEventListener("change", function () {
        var desc = this.options[this.selectedIndex].getAttribute("data-desc");
        document.getElementById("txtReasonDesc").value = desc || "";
    });
      function initializeTomSelects() {
                const selectors = ["#room","#zone"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    maxOptions: 1000,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
      }
                   

          function getStatusValue() {
        const isOOO = $('#outofOrder').is(':checked');
        const isOOS = $('#outofService').is(':checked');

        if (isOOO && isOOS) return 0; // Chọn cả hai
        if (isOOO) return 1;          // Chỉ OOO
        if (isOOS) return 2;          // Chỉ OOS
        return 3;                     // Không chọn cái nào
    }
    function loadTelephoneGrid(data) {
            $("#gridContainer").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",              
            columnAutoWidth: false,    
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
            { dataField: "code", caption: "Code", width: "8%" },
            { dataField: "roomNo", caption: "Room No", width: "7%" },
            { dataField: "roomType", caption: "Room Type", width: "7%" },
            { dataField: "floor", caption: "Floor", width: "6%" },
            { dataField: "zone", caption: "Zone", width: "6%" },
            { dataField: "fromDate", caption: "From Date", width: "8%", dataType: "date", format: "dd/MM/yyyy" },
            { dataField: "toDate", caption: "To Date", width: "8%", dataType: "date", format: "dd/MM/yyyy" },
            { dataField: "noOfNights", caption: "Nights", width: "8%" },
            { dataField: "reason", caption: "Reason", width: "15%" },
            { dataField: "status", caption: "Status", width: "7%" },
            { dataField: "userCreate", caption: "User Create", width: "6%" },
            { dataField: "createdDate", caption: "Create Date", dataType: "date", format: "dd/MM/yyyy", width: "8%" },
            { dataField: "userUpdate", caption: "User Update", width: "6%" },
            { dataField: "updateDate", caption: "Update Date", dataType: "date", format: "dd/MM/yyyy", width: "8%" },
        ],
            scrolling: {
                    mode: "standard", // Không dùng virtual để footer hiển thị đúng
                    showScrollbar: "always",
                    scrollByContent: true
                },
                paging: {
                    pageSize: 20
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [20, 50, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },
                columnAutoWidth: true,
                    filterRow: {
                visible: true,
                applyFilter: "auto"
            },
                summary: {
                totalItems: [{
                    column: "noOfNights",
                    summaryType: "sum",
                    displayFormat: "Total: {0}",
                    showInColumn: "noOfNights"
                }]
            },
            // 🔥 Quan trọng: gán selectedRowData khi click chọn
            onSelectionChanged: function (e) {
                if (e.selectedRowsData.length > 0) {
                    selectedRowData = e.selectedRowsData[0]; // gán row đang chọn
                    console.log("Selected Row:", selectedRowData);
                } else {
                    selectedRowData = null;

                }
            }
        });
        }
            $(document).off("click", "#btnView").on("click", "#btnView", function () {
         reloadGrid();
    });
      function reloadGrid() {
        $("#loadingSpinner").show();
        const status = getStatusValue();
        $.ajax({
            url: '/RoomManagement/GetOOOSload',
            type: 'GET',
            data: {
                status: status,
                roomNo: $("#room").val(),
                roomClassID: $("#roomClass").val(),
                fromDate: $("#fromDate").val(),
                toDate: $("#toDate").val(),
                zone: $("#zone").val().join(',')

            },
            success: function (data) {
                // load lại grid với data mới
                loadTelephoneGrid(data);
                $("#loadingSpinner").hide();
            },
            error: function (xhr, status, error) {
                alert("Không thể tải dữ liệu");
                $("#loadingSpinner").hide();
            }
        });
    }
               $("#btnNew").click(function () {
                $("#itemForm")[0].reset();

                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                $("#itemFromDate").val(formatDate(firstDayOfMonth));
                $("#itemToDate").val(formatDate(lastDayOfMonth));

                loadAvailableRooms();
                $("#itemModal").modal("show");
            });

            // 🔥 Tự động lọc khi user thay đổi ngày
            $("#itemFromDate, #itemToDate").on("change", function() {
                loadAvailableRooms();
            });


        $("#btnHistory").click(function () {
            openHistoryPopup();
            $("#historyModal").modal("show");
        });
        $("#btnHistorySearch").click(function () {
            openHistoryPopup();

        });


               function openHistoryPopup() {
            $("#historyPopup").modal("show");

            // gọi ajax load dữ liệu
            $.ajax({
                url: "/RoomManagement/GetRoomStatusHistoryOOO",
                type: "GET",
                data: { 
                    roomNo: $("#historyRoom").val(),
                    userName: $("#historyUser").val(),
                    fromDate: $("#historyFromDate").val(),
                    toDate: $("#historyToDate").val()
             
                },
                success: function (data) {
                    $("#historyGrid").dxDataGrid({
                        dataSource: data, // bind dữ liệu trả về
                        columnAutoWidth: true,
                        showBorders: true,
                        showColumnLines: true, // hiện đường kẻ cột
                        showRowLines: true,    // hiện đường kẻ hàng
                        height: 600,  // chiều cao lưới
                        width: "100%", // full chiều rộng popup
                        scrolling: { mode: "virtual" },
                        columns: [
                            { dataField: "roomNo", caption: "Room No" , width: "6%"},
                            { dataField: "action", caption: "Action", width: "9%" },
                            { dataField: "oldValue", caption: "Old Value", width: "32%" },
                            { dataField: "newValue", caption: "New Value" , width: "32%"},
                            { dataField: "userName", caption: "User" , width: "5%"},
                            { dataField: "computerName", caption: "Computer" , width: "6%"},
                            { dataField: "changeDate", caption: "Change Date", dataType: "date", format: "dd/MM/yyyy HH:mm", width: "9%" }
                        ]
                    });
                },
                error: function () {
                    alert("Lỗi khi load dữ liệu history");
                }
            });
        }
         $("#btnSaveItem").click(function () {
            SaveOOOS();
          
        });
            function SaveOOOS() {
        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));
        var formData = new FormData();

        // Lấy danh sách phòng
        const selectedValues = $("#roomSelect").val();
        selectedValues.forEach(value => {
            formData.append('roomSelect', value);
        });

        formData.append('oooOrS', $("#oooOrS").val());
        formData.append('rtStatus', $("#rtStatus").val());
        formData.append('comment', $("#comment").val());
        formData.append('txtReasonDesc', $("#txtReasonDesc").val());
        formData.append('itemFromDate', $("#itemFromDate").val());
        formData.append('itemToDate', $("#itemToDate").val());
        formData.append('userName', userName);
        formData.append('userID', userID);

        // Nếu đang edit, lấy id từ selectedRowData
        if (selectedRowData && selectedRowData.id) {
            formData.append('id', selectedRowData.id);
        }

        $.ajax({
            url: (selectedRowData && selectedRowData.id)
                ? '/RoomManagement/UpdateBusinessBlock'
                : '/RoomManagement/InsertBusinessBlock',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                if (data.success) {
                    $("#itemModal").modal("hide");
                    showToast('Success', (selectedRowData && selectedRowData.id)
                        ? "Update thành công"
                        : "Insert thành công", true);
                    reloadGrid();
                } else {
                    showToast('Error', data.message, false);
                }
            },
            error: function (xhr, statusText, err) {
                showToast('Error', "Có lỗi xảy ra!", false);
            }
        });
    }

        $("#btnDelete").click(function () {
        if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

                Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'swal-small'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                deleteSelectedItem();
            }
        });

    });
    function deleteSelectedItem() {
        $.post("/RoomManagement/DeleteBusinessBlock", { id: selectedRowData.id }, function (res) {
            if (res.deleted > 0) {
                showToast("Success", "Deleted successfully!", true);
                reloadGrid();
                $("#itemForm")[0].reset();
                selectedRowData = null;
            } else {
                showToast("Error", "Delete failed!", false);
            }
        }).fail(function (xhr) {
            console.error("Delete error:", xhr.responseText);
            showToast("Error", "Delete error!", false);
        });
    }



               async function editBusinessBlock(rowData) {
        // Mở modal ngay lập tức
        $("#itemModalLabel").text("Edit Item");
        $("#itemModal").modal("show");

        // Gán ngày tháng
        if (rowData.fromDate) $("#itemFromDate").val(rowData.fromDate.split("T")[0]);
        if (rowData.toDate) $("#itemToDate").val(rowData.toDate.split("T")[0]);

        // Load danh sách phòng
        try {
            await loadAvailableRooms(); // Promise resolve đúng
            const ts = $("#roomSelect")[0]?.tomselect;
            if (ts && rowData.roomNo) {
                let opt = Object.values(ts.options).find(o => String(o.roomNo).padStart(6,'0') === String(rowData.roomNo).padStart(6,'0'));
                if(!opt) {
                    ts.addOption({
                        roomID: rowData.roomID || `custom-${rowData.roomNo}`,
                        roomNo: rowData.roomNo,
                        roomType: rowData.roomType || "N/A",
                        roomTypeName: rowData.roomTypeName || "Unknown",
                        hkStatus: rowData.hkStatus || "N/A",
                        fo: rowData.fo || "N/A",
                        floor: rowData.floor || "N/A",
                        smoking: rowData.smoking || "N/A"
                    });
                }
                ts.setValue(rowData.roomID || `custom-${rowData.roomNo}`);
            }
        } catch(err) {
            console.error(err);
        }

        // Set các trường khác như status, returnStatus, reason...
        $("#oooOrS").val(rowData.status === "OOO" ? "1" : rowData.status === "OOS" ? "2" : "");
        $("#rtStatus").val({"Dirty":"2","Clean Non-Checked":"1","Pickup":"3","Clean":"4"}[rowData.returnStatus]||"");
        let matchedId = null;
        $("#comment option").each(function() {
            if($(this).text().trim().startsWith(rowData.reasonCode)) { matchedId = $(this).val(); return false; }
        });
        if(matchedId) $("#comment").val(matchedId).trigger("change");
        $("#txtReasonDesc").val(rowData.reason);
    }

     function loadAvailableRooms() {
        return new Promise((resolve, reject) => {
            const fromDate = $("#itemFromDate").val();
            const toDate = $("#itemToDate").val();

            if (!fromDate || !toDate) {
                const error = new Error("fromDate hoặc toDate không có giá trị!");
                console.error(error.message);
                return reject(error);
            }

            const params = {
                isDummy: '',
                smoking: '',
                floor: '',
                roomTypeCode: '',
                foStatus: '',
                hkStatusID: '',
                roomNo: '',
                fromDate: fromDate,
                toDate: toDate,
                zoneCode: ''
            };

            const queryString = new URLSearchParams(params).toString();
            fetch(`/RoomManagement/GetAvailableRoomsSearchOOO?${queryString}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Lỗi khi gọi API: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log("Dữ liệu từ API (5 phần tử đầu):", data.slice(0, 5));
                    console.log("Danh sách roomNo:", data.map(item => item.roomNo));
                    // Kiểm tra dữ liệu API
                    if (!data.every(item => item.isHeader || (item.roomID && item.roomNo))) {
                        console.error("Dữ liệu API thiếu roomID hoặc roomNo!");
                        throw new Error("Dữ liệu API không hợp lệ");
                    }

                    data.unshift({
                        roomID: "",
                        roomNo: "RoomNo - RoomType - RoomTypeName - HKStatus - FO - Floor - Smoking",
                        isHeader: true,
                        disabled: true
                    });

                    if ($("#roomSelect")[0]?.tomselect) {
                        $("#roomSelect")[0].tomselect.destroy();
                    }

                    new TomSelect("#roomSelect", {
                        valueField: "roomID",
                        labelField: "roomNo",
                        searchField: ["roomNo", "roomTypeName", "roomType", "hkStatus", "fo", "floor", "smoking"],
                        options: data,
                        placeholder: "Chọn phòng...",
                        plugins: ["remove_button"],
                        maxOptions: 1000,
                        render: {
                            option: function(d, escape) {
                                if (d.isHeader) {
                                    return `<div style="font-weight:bold;border-bottom:1px solid #ccc;padding:2px 5px;">${escape(d.roomNo)}</div>`;
                                }
                                return `<div>${escape(d.roomNo || '')} - ${escape(d.roomType || '')} - ${escape(d.roomTypeName || '')} - ${escape(d.hkStatus || '')} - ${escape(d.fo || '')} - ${escape(d.floor || '')} - ${escape(d.smoking || '')}</div>`;
                            },
                            item: function(d, escape) {
                                return `<div>${escape(d.roomNo || '')}</div>`;
                            }
                        },
                        onInitialize: function() {
                            console.log("TomSelect đã khởi tạo!");
                            resolve();
                        }
                       
                    });
                })
                .catch(err => {
                    console.error("Lỗi khi tải danh sách phòng:", err);
                    reject(err);
                });
        });
    }

        function selectRoomByNo(roomNo) {
        const ts = $("#roomSelect")[0]?.tomselect;
        if (!ts) {
            console.error("TomSelect chưa được khởi tạo!");
            return;
        }

        console.log("Đang tìm roomNo:", roomNo, "Loại:", typeof roomNo);
        let foundId = null;
        Object.values(ts.options).forEach(opt => {
            console.log("So sánh với option roomNo:", opt.roomNo, "Loại:", typeof opt.roomNo);
            if (String(opt.roomNo).padStart(6, '0') === String(roomNo).padStart(6, '0')) {
                foundId = opt.roomID;
            }
        });

        if (foundId) {
            console.log(`Tìm thấy roomID: ${foundId} cho roomNo: ${roomNo}`);
            ts.setValue(foundId);
            ts.refreshOptions(false); // Refresh để hiển thị giá trị đã chọn
        } else {
            console.warn(`Không tìm thấy phòng với roomNo: ${roomNo}`);
        }
    }

    $("#btnEdit").click(function () {
        if (!selectedRowData) {
            alert("Vui lòng chọn một dòng để edit!");
            return;
        }

        // Gọi hàm edit
        editBusinessBlock(selectedRowData);
    });


</script>