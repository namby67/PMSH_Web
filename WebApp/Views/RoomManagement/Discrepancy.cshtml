@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var listfloor = ViewBag.FloorList;
    var listrl = ViewBag.RoomClassList;
    var listroom = ViewBag.RoomList;
    var listzo = ViewBag.ZoneList;
}


<style>
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }


</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Room Discrepancy</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

        
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Floor:</label>
            <select id="floor" class="form-control form-control-sm w-auto" >
                <option value="">-- All --</option>
                @foreach (var u in ViewBag.FloorList)
                {
                    <option value="@u.Code">@u.Code</option>
                }
            </select>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Room:</label>
            <select id="room" class="tomselect-custom" style="width: 200px;" multiple>
                @foreach (var g in ViewBag.RoomList)
                {
                    <option value="@g.RoomNo">@g.RoomNo - @g.RoomName</option>
                }
            </select>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Zone:</label>
            <select id="zone" class="tomselect-custom" style="width: 200px;" multiple>
                @foreach (var sg in ViewBag.ZoneList)
                {
                    <option value="@sg.ID">@sg.Code</option>
                }
            </select>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Room Class:</label>
            <select id="roomClass" class="tomselect-custom" style="width: 200px;" multiple>
                @foreach (var tr in ViewBag.RoomClassList)
                {
                    <option value="@tr.ID">@tr.Code - @tr.Description</option>
                }
            </select>
        </div>
        <label class="me-2 mb-0">Show:</label>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sleeps" checked >
            <label class="form-check-label text-primary" for="sleeps" style="cursor:pointer;">
                Sleeps
            </label>
        </div>
         <div class="form-check">
            <input class="form-check-input" type="checkbox" id="skips" checked >
            <label class="form-check-label text-primary" for="skips" style="cursor:pointer;">
                Skips
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="personsDiscrepancy" checked>
            <label class="form-check-label text-primary" for="personsDiscrepancy" style="cursor:pointer;">
                Persons Discrepancy
            </label>
        </div>
        
    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnSave" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Save</button>

    </div>
</div>

<div class="mui-card">

    <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div id="gridContainer"></div>
    </div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    $(document).ready(function () {
        loadTelephoneGrid([]);
        initializeTomSelects();
    });
    function initializeTomSelects() {
                const selectors = ["#room","#zone","#roomClass"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
        $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
             $("#loadingSpinner").show();

                $.ajax({
                    url: '/RoomManagement/GetDiscrepancy',
                    type: 'GET',
                    data: { 
                            sleep: $("#sleeps").is(":checked") ? 1 : 0,
                            skip: $("#skips").is(":checked") ? 1 : 0,
                            person: $("#personsDiscrepancy").is(":checked") ? 1 : 0,
                            floor: $("#floor").val(),
                            room: $("#room").val(),
                            zone: $("#zone").val(),
                            roomClass: $("#roomClass").val(),
                    },
                    success: function (data) {
                        console.log(data);
                        loadTelephoneGrid(data);
                        $("#loadingSpinner").hide();
                    },
                    error: function () {
                        alert("Không thể tải dữ liệu");
                        $("#loadingSpinner").hide();
                    }
                });
        });
                       // Map numeric ↔ tên hiển thị
    const hkStatusMap = { 0: "Vacant", 1: "Occupied" };
    const hkStatusMapReverse = { "Vacant": 0, "Occupied": 1 };

    function loadTelephoneGrid(data) {
        // Map dữ liệu DB (string) sang số
        data.forEach(item => {
            item.hkStatusId = hkStatusMapReverse[item.hkStatus] ?? null;
        });

            $("#gridContainer").dxDataGrid({
        dataSource: data,
        keyExpr: "roomNo",
        height: 400,
        allowColumnResizing: true,
        selection: { mode: "single" }, // chỉ chọn 1 dòng
        editing: { mode: "batch", allowUpdating: true },
        columns: [
            { dataField: "roomNo", caption: "Room No", allowEditing: false },
            {
                dataField: "hkStatusId",
                caption: "HK Status",
                lookup: {
                    dataSource: [
                        { id: 0, name: "Vacant" },
                        { id: 1, name: "Occupied" }
                    ],
                    valueExpr: "id",
                    displayExpr: "name"
                },
                editCellTemplate: function(cellElement, cellInfo) {
                    $("<div>").dxSelectBox({
                        dataSource: [
                            { id: 0, name: "Vacant" },
                            { id: 1, name: "Occupied" }
                        ],
                        valueExpr: "id",
                        displayExpr: "name",
                        value: cellInfo.value,
                        onValueChanged: function(e) { cellInfo.setValue(e.value); }
                    }).appendTo(cellElement);
                }
            },
            { dataField: "roomStatus", caption: "Room Status", allowEditing: false },
            { dataField: "foStatus", caption: "FO Status", allowEditing: false },
            { dataField: "hkPersons", caption: "HK Persons", allowEditing: false },
            { dataField: "foPersons", caption: "FO Persons", allowEditing: false },
            { dataField: "discrepancy", caption: "Discrepancy", allowEditing: false }
        ],
            scrolling: {
                        mode: "standard", // Không dùng virtual để footer hiển thị đúng
                        showScrollbar: "always",
                        scrollByContent: true
                    },
                    paging: {
                        pageSize: 50
                    },
                    pager: {
                        visible: true,
                        allowedPageSizes: [50, 100, 'all'],
                        showPageSizeSelector: true,
                        showInfo: true,
                        showNavigationButtons: true
                    },
                        filterRow: {
                    visible: true,
                    applyFilter: "auto"
                },
    });

            $('#btnSave').click(function() {
            var grid = $("#gridContainer").dxDataGrid("instance");
        var selectedRow = grid.getSelectedRowsData()[0]; // chỉ lấy 1 phòng

        if(!selectedRow) {
            alert('Vui lòng chọn 1 phòng.');
            return;
        }

        var payload = {
            roomNo: selectedRow.roomNo,      // **string, không phải mảng**
            newHKFOStatus: selectedRow.hkStatusId
        };

        console.log("Payload gửi lên server:", payload);

        $.ajax({
            url: '/RoomManagement/UpdateHKFOStatus',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(res) {
                if (res.success) {
                    alert(res.message);
                    grid.refresh();
                } else {
                    alert('Lỗi: ' + res.message);
                }
            },
            error: function(err) {
                console.log(err);
                alert('Có lỗi xảy ra khi lưu!');
            }
        });
    });
}







</script>