
@* <link href="~/css/reservation.css" rel="stylesheet" /> *@
<div class="mt-3">
    <div class="row">
        <!-- Menu trái -->
        <div class="col-md-2 mb-2">
            <div class="menu-left">
                <button class="toggle-btn"><i class="fas fa-bars"></i></button>
                <a class="menu-item " asp-controller="Miscellaneous" asp-action="MealReport">REPORT CHANGE MEAL</a>
                <a class="menu-item " asp-controller="Miscellaneous" asp-action="ReportCustom">REPORT CUSTOM</a>
                <a class="menu-item" asp-controller="Miscellaneous" asp-action="ReportCancelMeal">REPORT CANCEL MEAL</a>
                <a class="menu-item" asp-controller="Miscellaneous" asp-action="ReportWaiveMeal">REPORT WAIVE MEAL</a>
                <a class="menu-item active">REPORT USED BREAKFAST MEAL</a>
                <a class="menu-item" asp-controller="Miscellaneous" asp-action="ReportUseBreakFastMeal">REPORT USE BREAKFAST MEAL</a>
            </div>
        </div>

        <!-- Nội dung bên phải -->
        <div class="col-md-10">
            <div class="content-right">
                <div class="header">
                    <h3 id="content-title">
                        Report Used Breakfast Meal

                    </h3>
                </div>
                <div class="d-flex flex-column mb-2 ">
                    <div class="d-flex align-items-center" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">From Date: </label>
                            <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                        </div>

                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">To Date: </label>
                            <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                        </div>     
                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">Room No: </label>
                            <input type="text" id="roomNo" name="roomNo" class="form-control form-control-sm w-auto" />
                        </div>
                    </div>


                </div>
                <div style="display:flex;column-gap:12px">
                    <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>

                    <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>

                </div>
                <div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="mui-card">
                    <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    DevExpress.localization.locale("vi");
    let selectedRowData = null;
      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }

      $(document).ready(function () {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);
                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;

                reloadGrid();
        });
              function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                { dataField: "stt", caption: "STT", width: "11%" },
                { dataField: "usingDate", caption: "Using Date", width: "11%" },
                { dataField: "mealShift", caption: "Meal Shift", width: "11%" },
                { dataField: "guestName", caption: "Guest Name", width: "23%" },
                { dataField: "restaurant", caption: "Restaurant", width:"11%" },          
                { dataField: "roomNo", caption: "Room No", width: "11%" },
                { dataField: "zone", caption: "Zone", width: "11%" },
                { dataField: "amount", caption: "Amount", width: "11%" },

            ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
            onSelectionChanged: function(e){
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }

    // Reload grid với filter từ form
    function reloadGrid() {
        $("#loadingSpinnerRateCode").show();

        $.ajax({
            url: '/Miscellaneous/GetReportUsedBreakFastMeal',
            type: 'GET',
            data: {
                fromDate: $("#fromDate").val(),
                toDate: $("#toDate").val(),              
                roomNo: $("#roomNo").val(),
            },
            success: function(data){
                console.log(data);
                loadGrid(data);
                $("#loadingSpinnerRateCode").hide();
            },
            error: function(xhr, status, error){
                alert("Không thể tải dữ liệu");
                $("#loadingSpinnerRateCode").hide();
            }
        });
    }

    // Nút view click
    $("#btnView").click(function(){
        reloadGrid();
    });
    $("#btnExcel").click(function () {
        const grid = $("#gridContainerRateCode").dxDataGrid("instance");   // 🔥 khai báo grid

        const workbook = new ExcelJS.Workbook();
        const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === Dòng 1: Tên công ty (merge theo 4 cột) ===
        worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:D1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === Dòng 2: Ngày giờ xuất (bên phải) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', exportDate]);
        worksheet.mergeCells('D2:D2');  // cột D thôi
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === Dòng 3–4: trống
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
        const reportRow = worksheet.addRow(['Report Used Breakfast Meal']);
        worksheet.mergeCells('A5:D5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === Dòng 6: trống
        worksheet.addRow([]);

        // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 }
        }).then(function () {
            // Footer (sau cùng)
            const lastRow = worksheet.lastRow.number + 2;
            worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = "Report Used Breakfast Meal.xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });
</script>