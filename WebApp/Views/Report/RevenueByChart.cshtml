@using DevExpress.XtraReports.UI
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var zoneList = ViewBag.ZoneList;
    var rtList = ViewBag.RoomTypeList;
}

<style>
    .filter_wrapper {
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .sticky-header label,
    .sticky-header .form-control-sm {
        font-size: 0.75rem;
        line-height: 1.2;
    }


    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .tomselect-custom {
        width: 200px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 0.65rem;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">

    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
        <div class="d-flex align-items-center me-3">
            <label class="fw-bold me-3">Date Range:</label>

            <div class="d-flex align-items-center me-1">
                <label class="me-0 mb-0">From:</label>
                <input type="date" id="fromDate" class="form-control form-control-sm w-auto" />
            </div>

            <div class="d-flex align-items-center me-1">
                <label class="me-0 mb-0">To:</label>
                <input type="date" id="toDate" class="form-control form-control-sm w-auto" />
            </div>
        </div>

        <div class="d-flex align-items-center flex-wrap gap-3">

            <div class="d-flex align-items-center me-1">
                <label class="fw-bold me-3">Filter:</label>
                <label class="me-2 mb-0">Room Type:</label>
                <select id="roomType" class="tomselect-custom" style="width: 70px;" multiple>
                    @foreach (var rt in rtList)
                    {
                        <option value="@rt.Code">@rt.Code</option>
                    }
                </select>
            </div>
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Zone:</label>
                    <select id="zone" class="tomselect-custom" style="width: 70px;" multiple>
                        @foreach (var z in zoneList)
                        {
                            <option value="@z.Code">@z.Code</option>
                        }
                    </select>
                </div>
            </div>

        </div>
        <div class="d-flex align-items-center flex-wrap gap-3 w-100">
            <label class="fw-bold me-3">Search Criteria:</label>

            <div class="d-flex align-items-center me-3">
                <label class="me-1 mb-0">Reservation:</label>
                <select id="reservation" class="form-control form-control-sm w-auto">
                    <option value="0">All Reservation</option>
                    <option value="1">Reservation with Block</option>
                    <option value="2">Reservation with Travel Agent</option>
                    <option value="3">Reservation with Company</option>
                    <option value="4">Reservation with Individual</option>
                    <option value="5">Reservation with Travel Agent</option>
                    <option value="6">Reservation with Menber</option>
                    <option value="7">Reservation with VIP</option>
                </select>
            </div>

            <div class="d-flex align-items-center me-3">
                <label class="me-1 mb-0">Sort Order:</label>
                <select id="sortOrder" class="form-control form-control-sm w-auto">
                    <option value="1">Folio No</option>
                    <option value="0">Alphabetical</option>
                    <option value="2">Arrival Date</option>
                    <option value="3">Departure Date</option>


                </select>
            </div>

            <div style="display:none!important" class="d-flex align-items-center me-3">
                <label class="me-2 mb-0">View By:</label>
                <select id="viewBy" name="viewBy" class="form-control form-control-sm w-auto">
                    <option value="VND">VND</option>
                    <option value="USD">USD</option>
                </select>
            </div>
        </div>
    </div>

    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>        
    </div>

</div>

<div class="mui-card chart-container">
    <div id="revenuePieChart" class="chart-fixed-size"></div>
</div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
    function formatDate(date) {
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $(document).ready(function () {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        document.getElementById("reportTitle").innerText = '@ViewBag.ReportTitle';
        $('#fromDate').val(formatDate(firstDayOfMonth));
        $('#toDate').val(formatDate(lastDayOfMonth));
         initializeTomSelects();
    });
    function initializeTomSelects() {
        const selectors = ["#roomType", "#zone"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            // Nếu đã khởi tạo rồi thì destroy
            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }
    $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $.ajax({
            url: '/Report/ReveunueByData',
            type: 'GET',
            data: {
                fromDate: $("#fromDate").val(),
                toDate: $("#toDate").val(),
                reservation: $("#reservation").val(),
                roomType: $("#roomType").val().map(r => r.replace( "''")).join("','") + "",
                zone: $("#zone").val().map(r => r.replace( "''")).join("','") + "",
                sortOrder: $("#sortOrder").val(),
                viewBy: $("#viewBy").val(),
            },
            success: function (result) {
                drawPieChart(result);
            },
            error: function () {
                alert("Không thể tải dữ liệu biểu đồ.");
            }
        });
    });

        function drawPieChart(data){
        const totalRoom  = sum(data,'roomRevenue');
        const totalFB    = sum(data,'fbRevenue');
        const totalOther = sum(data,'otherRevenue');
        const grand      = totalRoom + totalFB + totalOther;

        const pieData = [
            { name:`Room Revenue (${pct(totalRoom,grand)}%)`,  y: totalRoom },
            { name:`F&B Revenue (${pct(totalFB,grand)}%)`,     y: totalFB   },
            { name:`Other Revenue (${pct(totalOther,grand)}%)`,y: totalOther}
        ];

        Highcharts.chart('revenuePieChart',{
            chart:{ type:'pie' },
            title:{ text:'Revenue Summary (Pie)' },
            tooltip:{ pointFormat:'Amount: <b>{point.y:,.0f}</b>' },
            plotOptions:{
                pie:{
                    dataLabels:{ enabled:true, format:'{point.name}: {point.y:,.0f}' },
                    showInLegend:true
                }
            },
            series:[{ name:'Amount', colorByPoint:true, data: pieData }]
        });
    }

    function pct(v,t){ return t?((v/t)*100).toFixed(1):0; }


        function sum(arr, field) {
        if (!Array.isArray(arr)) {
            console.error("Dữ liệu không phải mảng:", arr); // Debug
            return 0;
        }

        return arr.reduce((total, item) => {
            let val = item[field];
            if (val == null) return total;
            if (typeof val === "string") val = val.replace(/[^0-9.-]/g, "");
            val = parseFloat(val);
            return Number.isFinite(val) ? total + val : total;
        }, 0);
    }

</script>
