@using DevExpress.XtraReports.UI
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var zoneList = ViewBag.ZoneList;
}

<!-- Thư viện Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>

<style>
    .filter_wrapper {
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50;
        color: white;
    }

    #highchartBar {
        margin: 0px 8px;
        height: 500px;
    }

    .sticky-header label,
    .sticky-header .form-control-sm {
        font-size: 0.75rem;
        line-height: 1.2;
    }


    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .tomselect-custom {
        width: 200px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 0.65rem;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>

<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">From Date:</label>
            <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
        </div>
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">To Date:</label>
            <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
        </div>
        <div class="d-flex align-items-center me-3">
            <label class="me-2 mb-0">Zone:</label>
            <select id="zone" name="zone" class="tomselect-custom" style="width: 70px;" multiple>
                @foreach (var item in zoneList)
                {
                    <option value="@item.Code">@item.Code</option>
                }
            </select>
        </div>
    </div>
    <div class="">
        <button style="border-radius: 4px; margin-right: 6px; background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i> View</button>
    </div>
</div>

<!-- Biểu đồ -->
<div id="highchartBar" class="mui-card"></div>

<!-- Spinner loading -->
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>

<script>
    function formatDate(date) {
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $(document).ready(function () {
        document.getElementById("reportTitle").innerText = '@ViewBag.ReportTitle';
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        $('#fromDate').val(formatDate(firstDay));
        $('#toDate').val(formatDate(lastDay));
         initializeTomSelects();
    });
    function initializeTomSelects() {
        const selectors = ["#zone"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                // Nếu đã khởi tạo rồi thì destroy
                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
    $("#btnPrint").click(function () {
        $("#loadingSpinner").show();
        $.ajax({
            url: '/Report/RoomOccupancyReport',
            type: 'GET',
            data: {
                fromDate: $("#fromDate").val(),
                toDate: $("#toDate").val(),
                zone: $("#zone").val().map(r => r.replace( "''")).join("','") + "",
            },
            headers: {
                "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val()
            },
        success: function (result) {
        const groupedData = prepareRoomOccupancyGroupedData(result);
        renderRoomOccupancyGroupedBarChart(groupedData);
        $("#loadingSpinner").hide();
    },

            error: function () {
                alert("Không thể tải báo cáo.");
                $("#loadingSpinner").hide();
            }
        });
    });

       function prepareRoomOccupancyGroupedData(data) {
        const grouped = {};

        data.forEach(item => {
            const month = item.monthDisplay;
            if (!grouped[month]) {
                grouped[month] = {
                    VacRo: 0, ResRo: 0, NonDeductRo: 0, AltRo: 0,
                    TotaRo1: 0, ARo: 0, DepRo: 0, OOO: 0, TotaRo2: 0, PT: 0,
                    count: 0
                };
            }

            grouped[month].VacRo += parseFloat(item.vacRo ?? 0);
            grouped[month].ResRo += parseFloat(item.resRo ?? 0);
            grouped[month].NonDeductRo += parseFloat(item.nonDeductRo ?? 0);
            grouped[month].AltRo += parseFloat(item.altRo ?? 0);
            grouped[month].TotaRo1 += parseFloat(item.totaRo1 ?? 0);
            grouped[month].ARo += parseFloat(item.aRo ?? 0);
            grouped[month].DepRo += parseFloat(item.depRo ?? 0);
            grouped[month].OOO += parseFloat(item.ooo ?? 0);
            grouped[month].TotaRo2 += parseFloat(item.totaRo2 ?? 0);
            grouped[month].PT += parseFloat(item.pt ?? 0);
            grouped[month].count++;
        });

        // Tính trung bình
        const months = Object.keys(grouped);
        const result = {
            categories: months,
            series: []
        };

        const fields = ["VacRo", "ResRo", "NonDeductRo", "AltRo", "TotaRo1", "ARo", "DepRo", "OOO", "TotaRo2"];
        fields.forEach(field => {
            result.series.push({
                name: field,
                    data: months.map(month => {
                    const val = grouped[month][field] / 1; 
                    return Math.round(val); 
                })
            });
        });

        return result;
    }

    function average(arr, field) {
        const valid = arr.filter(x => x[field] != null);
        if (valid.length === 0) return 0;
        return valid.reduce((sum, x) => sum + x[field], 0) / valid.length;
    }

       function renderRoomOccupancyGroupedBarChart(groupedData) {
        Highcharts.chart('highchartBar', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Room Occupancy by Month'
            },
            xAxis: {
                categories: groupedData.categories,
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of Rooms'
                }
            },
            tooltip: {
                shared: true,
                valueDecimals: 0
            },
            plotOptions: {
                column: {
                    grouping: true,
                    shadow: false,
                    borderWidth: 0
                }
            },
            series: groupedData.series
        });
    }

</script>
