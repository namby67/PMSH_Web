@using DevExpress.XtraReports.UI
@{
    ViewBag.Title = ViewBag.ReportHeader;
}

<style>
    .filter_wrapper {
        padding: 18px 0 0 14px;
        border-radius: 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0 8px;
    }

    .chart-fixed-size {
        width: 100%;
        max-width: 1050px;
        height: 550px;
        margin: 16px auto;
    }

    .sticky-header label,
    .sticky-header .form-control-sm {
        font-size: 0.75rem;
        line-height: 1.2;
    }


    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }
</style>

<div class="text-center" id="reportTitle" style="font-size:20px"></div>

<!-- ======== Bộ lọc (giữ nguyên) ======== -->
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0">Date:</label>
            <input id="fromDate" type="date" class="form-control form-control-sm w-auto"
                   max='@DateTime.Now:yyyy-MM-dd' />
        </div>
        <div class="radio_wrapper">
            <label class="me-2">Type:</label>
            <label class="me-2"><input type="radio" name="reportType" value="0" checked /> Revenue</label>
            <label class="me-2"><input type="radio" name="reportType" value="1" /> Payment</label>
            <label class="me-2"><input type="radio" name="reportType" value="2" /> NonRevenue</label>
            <label><input type="radio" name="reportType" value="3" /> All</label>
        </div>
    </div>

    <div class="">
        <button id="btnPrint" class="mui-button mui-button-new" style="background:#3b9ac6">
            <i class="fa-solid fa-eye"></i> View
        </button>
      
    </div>
</div>

<div id="barChart" class="mui-card chart-fixed-size"></div>

<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%;
             transform:translate(-50%,-50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
</div>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
    function formatDate(date) {
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $(document).ready(function () {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        $('#fromDate').val(formatDate(firstDayOfMonth));

        document.getElementById("reportTitle").innerText = '@ViewBag.ReportTitle';

        $("#btnPrint").click(function () {
            $("#loadingSpinner").show();

            $.ajax({
                url: '/Report/RevenueReports',
                type: 'GET',
                data: {
                    fromDate: $("#fromDate").val(),
                    type: $("input[name='reportType']:checked").val()
                },
                success: function (result) {              

                    const grand = result.reduce((tot, itm) => {
                        tot.amountBeForeTax  += +itm.amountBeForeTax   || 0;
                        tot.amountGross      += +itm.amountGross       || 0;
                        tot.amountBeforeTaxM += +itm.amountBeforeTaxM  || 0;
                        tot.amountGrossM     += +itm.amountGrossM      || 0;
                        tot.amountBeforeTaxY += +itm.amountBeforeTaxY  || 0;
                        tot.amountGrossY     += +itm.amountGrossY      || 0;
                        return tot;
                    }, {
                        amountBeForeTax: 0, amountGross: 0,
                        amountBeforeTaxM: 0, amountGrossM: 0,
                        amountBeforeTaxY: 0, amountGrossY: 0
                    });

                    drawBarChart(grand);

                    $("#loadingSpinner").hide();
                },
                error: function () {
                    alert("Không thể tải báo cáo.");
                    $("#loadingSpinner").hide();
                }
            });
        });
    });

    function drawBarChart(g) {
        const categories = ['DAY Net', 'DAY Gross', 'MONTH Net', 'MONTH Gross', 'YEAR Net', 'YEAR Gross'];
        const seriesData = [
            g.amountBeForeTax,
            g.amountGross,
            g.amountBeforeTaxM,
            g.amountGrossM,
            g.amountBeforeTaxY,
            g.amountGrossY
        ];

        Highcharts.chart('barChart', {
            chart: { type: 'column' },
            title: { text: 'Revenue Report' },
            xAxis: { categories },
            yAxis: {
                title: { text: 'Amount (VND)' },
                labels: { formatter: function () { return this.value.toLocaleString(); } }
            },
            tooltip: {
                pointFormat: '<b>{point.y:,.0f} VND</b>'
            },
            legend: { enabled: false },
            series: [{
                name: 'Total',
                data: seriesData,
                color: '#1976d2'
            }]
        });
    }
</script>
