@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var uList = ViewBag.UsersList;
}
@* <link href="~/css/pages/reservation.css" rel="stylesheet" /> *@
<style>
    #sendDate:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .card-type-item label {
        display: flex;
        align-items: center; /* Căn giữa theo chiều dọc */
        gap: 6px; /* Khoảng cách giữa checkbox và text */
        white-space: nowrap; /* Không xuống dòng */
    }

    .card-type-list input[type="checkbox"] {
        width: 10px; /* chiều rộng */
        height: 10px; /* chiều cao */
        transform: scale(1.5); /* phóng to checkbox */
        margin-right: 6px; /* khoảng cách label */
        margin-top: 6px;
    }


    .card-type-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 cột đều nhau */
        gap: 6px 12px; /* khoảng cách giữa các ô: 6px hàng, 12px cột */
        margin-top: 6px;
    }

    /* Phóng to checkbox "All" */
    #cardAll {
        width: 10px;
        height: 10px;
        transform: scale(1.5);
        margin-right: 6px;
    }

    .tomselect-custom .ts-control {
        min-height: 28px !important; /* chiều cao tối thiểu */
        height: 28px !important; /* chiều cao cố định */
        padding: 2px 6px !important; /* padding trong input */
        font-size: 0.75rem !important; /* chữ nhỏ hơn */
        line-height: 1.2 !important;
    }

    /* Ô nhập khi gõ */
    .tomselect-custom .ts-input > input {
        min-height: 20px !important;
        height: 20px !important;
        padding: 0 !important;
        font-size: 0.75rem !important;
        line-height: 1.2 !important;
    }

    /* Tag hiển thị khi chọn */
    .tomselect-custom .item {
        font-size: 0.75rem !important;
        padding: 1px 4px !important;
        line-height: 1.2 !important;
    }

      
</style>
<div class="mt-3">
    <div class="row">
        <div class="col-md-2 mb-2">
            <div class="menu-left">
                <button class="toggle-btn"><i class="fas fa-bars"></i></button>
                <a class="menu-item " asp-controller="Cashiering" asp-action="PostingJournal">POSTING JOURNAL </a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="VATSearch"> VAT TABLE</a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="FolioVATSearch">SEARCH VAR VOUCHER </a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="FolioVATSearchByAccounting">SEARCH VAT VOUCHER FOR ACCOUNTING </a>
                <a class="menu-item active">FOLIO HISTORY</a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="CashierReport"> CASHIER REPORT </a>
            </div>
        </div>

        <!-- Nội dung bên phải -->
        <div class="col-md-10">
            <div class="content-right ms-2">
                <div class="header">
                    <h3 id="content-title">
                        Folio History 

                    </h3>
                </div>

                <div class="row g-3">
                    <!-- Reservations Status -->
                    <div class="col-md-2">
                        <label>Date </label>
                        <div class="mt-2 mb-2" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">From Date: </label>
                                <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto mt-2" />
                            </div>

                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">To Date: </label>
                                <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto mt-2 ms-3" />
                            </div>
                        </div>                      
                    </div>

                    <!-- Card Category -->
                    <div class="col-md-5">
                        <label>Card Category</label>
                        <div class="card-type-list mt-2" id="categoryList" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center mb-2" style="gap: 12px;">
                                <div class="d-flex align-items-center">
                                    <label for="fromFolio" class="me-2 mb-0">From Folio:</label>
                                    <input type="text" id="fromFolio" class="form-control form-control-sm ms-2" style="width: 210px;" />
                                </div>
                                <div class="d-flex align-items-center">
                                    <label for="toFolio" class="me-2 mb-0">To Folio:</label>
                                    <input type="text" id="toFolio" class="form-control form-control-sm ms-1" style="width: 210px;" />
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2" style="gap: 12px;">
                                <div class="d-flex align-items-center">
                                    <label for="fromRoom" class="me-2 mb-0">From Room:</label>
                                        <input type="text" id="fromRoom" class="form-control form-control-sm" style="width: 210px;" />
                                </div>
                                <div class="d-flex align-items-center">
                                    <label for="toRoom" class="me-2 mb-0">To Room:</label>
                                        <input type="text" id="toRoom" class="form-control form-control-sm" style="width: 210px;" />
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2" style="gap: 12px;">
                            <label class="">Users:</label>
                            <select id="users" name="users" class="tomselect-custom" style="width: 530px;" multiple>
                                @foreach (var sg in ViewBag.UsersList)
                                {
                                        <option value="@sg.LoginName" data-code="@sg.LoginName">@sg.LoginName - @sg.LastName</option>
                                }
                            </select>
                            </div>
                        </div>
                    </div>

                    <!-- Card Type -->
                    <div class="col-md-5">
                        <label>Action </label>
                        <div class="card-type-list mt-2" id="typeList" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center mb-2" style="gap: 12px;">
                                <div class="ms-3">
                                    <label><input type="checkbox" id="allAction" value="" checked /> All Action</label>
                                </div>
                                <div class="card-type-list mt-2" id="action" style="border: 1px solid #ced4da; border-radius: 6px; padding: 12px;">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="nightPost" value="2" checked /> NIGHT_POST</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="earlyCheckout" value="3" checked /> EARLY_CHECKOUT</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="tranferred" value="7" checked /> TRANSFERRED</label>
                                        </div>

                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="postGen" value="0" checked /> POST_GEN</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="advanceBill" value="4" checked /> ADVANCE_BILL</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="correct" value="5" checked /> CORRECT</label>
                                        </div>

                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="post" value="1" checked /> POST</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="split" value="6" checked /> SPLIT</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="deleted" value="8" checked /> DELETED</label>
                                        </div>

                                        <div class="col-md-4">
                                            <label><input type="checkbox" id="pay" value="9" checked /> PAY</label>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div style="display:flex;column-gap:12px">
                <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new ms-2"><i class="fa-solid fa-eye"></i>View</button>
                <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnDetail" class="mui-button mui-button-new ms-2"><i class="fa-solid fa-eye"></i>Details</button>
                <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
            </div>
            <div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="mui-card">
                <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
            </div>
        </div>
    </div>
</div>

<div id="detailPopup"></div>

<script>

    DevExpress.localization.locale("vi");
    let selectedRowData = null;

      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }

      $(document).ready(function () {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);
                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;
                               // Khi thay đổi checkbox "All"
                $("#allAction").change(function() {
                    var isChecked = $(this).is(":checked");
                    $("#action input[type='checkbox']").not(this).prop("checked", isChecked);
                });

                // Khi thay đổi từng checkbox con, nếu tất cả được check thì tự động check "All"
                   $("#action input[type='checkbox']").not("#allAction").change(function() {
                    var allChecked = $("#action input[type='checkbox']").not("#allAction").length ===
                                     $("#action input[type='checkbox']:checked").not("#allAction").length;
                    $("#allAction").prop("checked", allChecked);
                });
                      
                 initializeTomSelects();
                reloadGrid();
        });
        function initializeTomSelects() {
        const selectors = ["#users"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            // Nếu đã khởi tạo rồi thì destroy
            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }

              function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                { dataField: "property", caption: "Property", width: "10%" },
                { dataField: "actionText", caption: "Action", width: "20%" },
                { dataField: "moreInformation", caption: "More Information ", width: "10%" },
                {
                    caption: "Date",
                    width: "11%",
                    calculateCellValue: function (rowData) {
                        if (!rowData.actionDate) return "";
                        let d = new Date(rowData.actionDate);
                        return d.toLocaleDateString("en-GB"); // dd/MM/yyyy
                    }
                },
                {
                    caption: "Time",
                    width: "11%",
                    calculateCellValue: function (rowData) {
                        if (!rowData.actionDate) return "";
                        let d = new Date(rowData.actionDate);
                        return d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                    }
                },
                { dataField: "fromRoom", caption: "F_Room", width: "11%" },
                { dataField: "fromFolioID", caption: "F_Folio ", width: "11%" },
                { dataField: "fromName", caption: "F_Guest ", width: "11%" },
                { dataField: "toRoom", caption: "T_Room", width: "11%" },
                { dataField: "toFolioID", caption: "T_Folio", width: "11%" },
                { dataField: "toName", caption: "T_Guest", width: "11%" },
                { dataField: "amountIncTax", caption: "Amount", width: "11%" },
                { dataField: "actionUser", caption: "User", width: "11%" },
                { dataField: "machine", caption: "Machine", width: "11%" },

            ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
            onSelectionChanged: function(e){
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }
            $("#detailPopup").dxPopup({
        title: "Detail Information",
        width: 800,
        height: 500,
        visible: false,
        showCloseButton: true,
        contentTemplate: function () {
            return $("<div id='detailGrid'>").dxDataGrid({
                showBorders: true,
                columns: [
                    { dataField: "actionText", caption: "Action" },
                    { dataField: "moreInformation", caption: "More Information" },
                    { dataField: "transactionDate", caption: "Trans. Date" },
                    {
                        caption: "Date",
                        calculateCellValue: function (rowData) {
                            if (!rowData.actionDate) return "";
                            let d = new Date(rowData.actionDate);
                            return d.toLocaleDateString("en-GB");
                        }
                    },
                    {
                        caption: "Time",
                        calculateCellValue: function (rowData) {
                            if (!rowData.actionDate) return "";
                            let d = new Date(rowData.actionDate);
                            return d.toLocaleTimeString("en-GB", {
                                hour: "2-digit",
                                minute: "2-digit",
                                second: "2-digit"
                            });
                        }
                    }
                ]
            });
        }
    });


                function showDetailPopup(rowData) {
        let invoiceNo = rowData.invoiceNo;
        console.log("InvoiceNo:", invoiceNo);

        $.ajax({
            url: "/Cashiering/GetSearchPostingHistoryDetail",
            type: "GET",
            data: { invoiceNo: invoiceNo },
            success: function (data) {
                let popup = $("#detailPopup").dxPopup("instance");
                popup.option("contentTemplate", function () {
                    return $("<div id='detailGrid'>").dxDataGrid({
                        dataSource: data,
                        showBorders: true,
                        columns: [
                            { dataField: "actionText", caption: "Action" },
                            { dataField: "moreInformation", caption: "More Information" },
                            { dataField: "transactionDate", caption: "Trans. Date" },
                            {
                                caption: "Date",
                                calculateCellValue: function (rowData) {
                                    if (!rowData.actionDate) return "";
                                    let d = new Date(rowData.actionDate);
                                    return d.toLocaleDateString("en-GB");
                                }
                            },
                            {
                                caption: "Time",
                                calculateCellValue: function (rowData) {
                                    if (!rowData.actionDate) return "";
                                    let d = new Date(rowData.actionDate);
                                    return d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                                }
                            }
                        ]
                    });
                });
                popup.show();
            }
        });
    }


            $("#btnDetail").on("click", function () {
        if (selectedRowData) {
            showDetailPopup(selectedRowData);
        } else {
            DevExpress.ui.notify("Vui lòng chọn 1 dòng", "warning", 2000);
        }
    });

    $("#btnView").on("click", function() {
        reloadGrid();
        });              

        // Reload grid với filter từ form
        function reloadGrid() {
            $("#loadingSpinnerRateCode").show();

                let selectedusers = $("#users").val();
                let usersParam = "";

                if (!selectedusers || selectedusers.length === 0) {
                    selectedusers = [];
                    $("#users option").each(function () {
                        selectedusers.push($(this).val());
                    });
                }
                usersParam = selectedusers.map(r => r.replace("''")).join("','");
                var actionType = $("#action input[type='checkbox']:checked")
                    .map(function () { return this.value; })
                    .get()
                    .join(",");

                console.log("actionType:", actionType);
                console.log("usersParam:", usersParam);

                // Gửi ajax
                $.ajax({
                    url: '/Cashiering/GetFolioHistoryView',
                    type: 'POST',
                    data: {
                        fromDate: $("#fromDate").val(),
                        toDate: $("#toDate").val(),
                        fromFolioID: $("#fromFolio").val(),
                        toFolioID: $("#toFolio").val(),
                        fromRoom: $("#fromRoom").val(),
                        toRoom: $("#toRoom").val(),
                        actionType: actionType,
                         user: usersParam
                    },
                    success: function(data){
                        loadGrid(data);
                        console.log("Data trả về:", data);
                    $("#loadingSpinnerRateCode").hide();
                    },
                    error: function(xhr, status, error){
                        alert("Không thể tải dữ liệu");
                        $("#loadingSpinnerRateCode").hide();
                    }
                });

        }

    $("#btnExportExcel").click(function () {
           const grid = $("#gridContainerRateCode").dxDataGrid("instance");   // 🔥 khai báo grid

           const workbook = new ExcelJS.Workbook();
           const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
           const worksheet = workbook.addWorksheet("Sheet 1");

           // === Dòng 1: Tên công ty (merge theo 4 cột) ===
           worksheet.addRow([companyName]);
           worksheet.mergeCells('A1:D1');
           worksheet.getRow(1).font = { bold: true };
           worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

           // === Dòng 2: Ngày giờ xuất (bên phải) ===
           const now = new Date();
           const exportDate = now.toLocaleString("vi-VN");
           worksheet.addRow(['', '', '', exportDate]);
           worksheet.mergeCells('D2:D2');  // cột D thôi
           worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

           // === Dòng 3–4: trống
           worksheet.addRow([]);
           worksheet.addRow([]);

           // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
           const reportRow = worksheet.addRow([' Folio History']);
           worksheet.mergeCells('A5:D5');
           reportRow.font = { bold: true, size: 14 };
           reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

           // === Dòng 6: trống
           worksheet.addRow([]);

           // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
           DevExpress.excelExporter.exportDataGrid({
               component: grid,
               worksheet: worksheet,
               autoFilterEnabled: true,
               topLeftCell: { row: 7, column: 1 }
           }).then(function () {
               // Footer (sau cùng)
               const lastRow = worksheet.lastRow.number + 2;
               worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
               worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
               worksheet.getCell(`A${lastRow}`).font = { italic: true };

               // Ghi file
               let fileName = "Folio History.xlsx";
               workbook.xlsx.writeBuffer().then(function (buffer) {
                   saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
               });
           });
       });


</script>