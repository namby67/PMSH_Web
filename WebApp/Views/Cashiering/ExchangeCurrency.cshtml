@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var selectedReport = @ViewBag.ReportHeader;

}


<style>
  
    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }


    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }


    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }



    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

  
    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }

    .shift-header {
        background: #f2f2f2;
        padding: 8px 12px;
        border-bottom: 1px solid #ccc;
        font-size: 13px;
    }

        .shift-header .row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 4px;
        }

            .shift-header .row div {
                flex: 1; /* chia đều các cột */
                min-width: 150px; /* giữ cho không quá hẹp */
            }

        .shift-header i {
            font-style: italic;
            color: #333;
        }

        .shift-header b {
            font-weight: bold;
            margin-left: 4px;
        }

    .dx-popup-title {
        text-align: center !important;
        width: 100%;
    }

    /* Áp dụng cho tất cả text trong grid popup */
    #popupShiftDetail .dx-datagrid {
        font-size: 12px !important;
    }

        /* Nếu vẫn không ăn, target chi tiết hơn */
        #popupShiftDetail .dx-datagrid .dx-row > td,
        #popupShiftDetail .dx-datagrid .dx-header-row > td {
            font-size: 12px !important;
        }

    #fromCurrency {
        font-size: 12px; /* nhỏ chữ */
        padding: 2px 6px; /* thu gọn khoảng cách */
        height: auto; /* tránh Bootstrap ép chiều cao */
    }

    #toCurrency {
        font-size: 12px; /* nhỏ chữ */
        padding: 2px 6px; /* thu gọn khoảng cách */
        height: auto; /* tránh Bootstrap ép chiều cao */
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Ẩn mũi tên trong Firefox */
    input[type=number] {
        -moz-appearance: textfield;
        text-align: right;
    }

    #gridExchangeRate .dx-datagrid-headers td,
    #gridExchangeRate .dx-datagrid-rowsview td,
    #gridExchangeRate .dx-datagrid-filter-row td {
        font-size: 12px !important;
        padding: 2px 4px !important;
        line-height: 1.2 !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Exchange Currency</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

        <div class="d-flex flex-column ">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">From Date:</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">To Date:</label>
                    <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>      
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Account:</label>
            <input style="width: 80px;" type="text" id="account" name="account" class="form-control form-control-sm " />
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Room No:</label>
            <input style="width: 80px;" type="text" id="roomNo" name="roomNo" class="form-control form-control-sm " />
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">ID or Passport No:</label>
            <input style="width: 80px;" type="text" id="passPort" name="passPort" class="form-control form-control-sm" />
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isDelete">
            <label class="form-check-label text-primary" for="isDelete" style="cursor:pointer;">
                Include Delete
            </label>
        </div>

     
    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnView" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrintGrid" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>Print</button>
    </div>
</div>

<div class="mui-card">

    <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div class="gridContainer" id="gridContainer"></div>
    </div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    let selectedRowData = null;
    DevExpress.localization.locale("vi");
      function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }
      $(document).ready(function () {

                const today = new Date();

                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);

                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;
                loadTelephoneGrid([]);
        });

    $(document).off("click", "#btnView").on("click", "#btnView", function () {
         $("#loadingSpinner").show();

            $.ajax({
                url: '/Accounting/GetExchangeCurrency',
                type: 'GET',
                data: {
                    account: $("#account").val(),
                    passPort: $("#passPort").val(),
                    roomNo: $("#roomNo").val(),
                    fromDate: $("#fromDate").val(),
                    toDate: $("#toDate").val(),
                    isDelete: $("#isDelete").is(":checked") ? 1 : 0
                },
                success: function (data) {
                    loadTelephoneGrid(data);
                    console.log(data);
                    $("#loadingSpinner").hide();
                },
                    error: function (xhr, status, error) {
                    console.error("AJAX Error", status, error);
                    console.error("Response Text:", xhr.responseText);
                    alert("Không thể tải dữ liệu");
                    $("#loadingSpinner").hide();
                }
            });
    });

          function loadTelephoneGrid(data) {
            $("#gridContainer").dxDataGrid({
            dataSource: data,        
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            filterRow: { visible: true },
            columns: [
                { dataField: "invoiceNo", caption: "Invoice No",width: 90},
                { dataField: "transactionDate", caption: "Trans. Date", dataType: "datetime", format: "dd/MM/yyyy",width: 100},
                { dataField: "account", caption: "Guest Name",width: 150 },
                { dataField: "passPort", caption: "PassPort", width: 100 },
                { dataField: "roomNo", caption: "Room No", width: 80 },
                { dataField: "totalAmount", caption: "Total Amount", dataType: "number",format: "#,##0.00"  ,width: 120 },
                { dataField: "address", caption: "Address", width: 150},
                { dataField: "description", caption: "Description",width: 200 },
                { dataField: "statusText", caption: "Status", width: 90},
                { dataField: "cashierName", caption: "Cashier Name",width: 100 },
                { dataField: "createdBy", caption: "Created By",width: 90 },
                { dataField: "createddate", caption: "Created Date", dataType: "date", format: "dd/MM/yyyy HH:mm",width: 130 },
                { dataField: "updatedBy", caption: "Updated By",width: 90  },
                { dataField: "updatedDate", caption: "Updated Date", dataType: "date", format: "dd/MM/yyyy HH:mm",width: 130 }
            ],
            scrolling: {
                    mode: "standard", // Không dùng virtual để footer hiển thị đúng
                    showScrollbar: "always",
                    scrollByContent: true
                },
                paging: {
                    pageSize: 50
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [50, 100, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },
                    filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            // 🔥 Quan trọng: gán selectedRowData khi click chọn
             onRowClick: function (e) {
                selectedRowData = e.data; // 🔥 lấy data của row vừa click
                console.log("Selected Row (RowClick):", selectedRowData);
            }
        });
        }
            

          $(document).off("click", "#btnPrintGrid").on("click", "#btnPrintGrid", function () {
         $("#loadingSpinner").show();

            $.ajax({
                url: '/Cashiering/ExchangeCurrencyPrint',
                type: 'GET',
                data: {
                    id: selectedRowData.id,
                 
                },
                success: function (data) {
               
                     if (data && data.pdfBase64) {
                    // Mở cửa sổ mới để hiển thị PDF
                        var pdfWindow = window.open("");
                        pdfWindow.document.write(
                            "<iframe width='100%' height='100%' style='border:none' src='" + data.pdfBase64 + "'></iframe>"
                        );
                    } else {
                        alert("Không có dữ liệu PDF để hiển thị");
                    }
                    $("#loadingSpinner").hide();
                },
                    error: function (xhr, status, error) {
                    console.error("AJAX Error", status, error);
                    console.error("Response Text:", xhr.responseText);
                    alert("Không thể tải dữ liệu");
                    $("#loadingSpinner").hide();
                }
            });
    });

         $("#btnExportExcel").click(function () {
        const grid = $("#gridContainer").dxDataGrid("instance");   // 🔥 khai báo grid

        const workbook = new ExcelJS.Workbook();
        const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
        const worksheet = workbook.addWorksheet("Sheet 1");

        // === Dòng 1: Tên công ty (merge theo 4 cột) ===
        worksheet.addRow([companyName]);
        worksheet.mergeCells('A1:D1');
        worksheet.getRow(1).font = { bold: true };
        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

        // === Dòng 2: Ngày giờ xuất (bên phải) ===
        const now = new Date();
        const exportDate = now.toLocaleString("vi-VN");
        worksheet.addRow(['', '', '', exportDate]);
        worksheet.mergeCells('D2:D2');  // cột D thôi
        worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

        // === Dòng 3–4: trống
        worksheet.addRow([]);
        worksheet.addRow([]);

        // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
        const reportRow = worksheet.addRow(['ExchangeCurrency']);
        worksheet.mergeCells('A5:D5');
        reportRow.font = { bold: true, size: 14 };
        reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

        // === Dòng 6: trống
        worksheet.addRow([]);

        // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
        DevExpress.excelExporter.exportDataGrid({
            component: grid,
            worksheet: worksheet,
            autoFilterEnabled: true,
            topLeftCell: { row: 7, column: 1 }
        }).then(function () {
            // Footer (sau cùng)
            const lastRow = worksheet.lastRow.number + 2;
            worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
            worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
            worksheet.getCell(`A${lastRow}`).font = { italic: true };

            // Ghi file
            let fileName = "Exchange Currency.xlsx";
            workbook.xlsx.writeBuffer().then(function (buffer) {
                saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
            });
        });
    });




</script>