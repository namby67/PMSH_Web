@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var selectedReport = @ViewBag.ReportHeader;
    var tlplist = ViewBag.TransactionGroupList;
    var transg = ViewBag.TransactionSubGroupList;
    var user = ViewBag.UsersList;
    var trans = ViewBag.TransactionsList;
}


<style>
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #logGrid
        .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }

    .shift-header {
        background: #f2f2f2;
        padding: 8px 12px;
        border-bottom: 1px solid #ccc;
        font-size: 13px;
    }

        .shift-header .row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 4px;
        }

            .shift-header .row div {
                flex: 1; /* chia đều các cột */
                min-width: 150px; /* giữ cho không quá hẹp */
            }

        .shift-header i {
            font-style: italic;
            color: #333;
        }

        .shift-header b {
            font-weight: bold;
            margin-left: 4px;
        }

    .dx-popup-title {
        text-align: center !important;
        width: 100%;
    }

    /* Áp dụng cho tất cả text trong grid popup */
    #popupShiftDetail .dx-datagrid {
        font-size: 12px !important;
    }

        /* Nếu vẫn không ăn, target chi tiết hơn */
        #popupShiftDetail .dx-datagrid .dx-row > td,
        #popupShiftDetail .dx-datagrid .dx-header-row > td {
            font-size: 12px !important;
        }

    #gridShiftDetail .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ngọc */
        color: white !important; /* chữ trắng */
    }

        #gridShiftDetail .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridShiftDetail .dx-datagrid-headers td,
    #gridShiftDetail .dx-datagrid-rowsview td,
    #gridShiftDetail .dx-datagrid-filter-row td {
        font-size: 12px !important;
        padding: 2px 4px !important;
        line-height: 1.2 !important;

    }

    #gridShiftDetail .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ngọc */
        color: white !important; /* chữ trắng */
    }

        #gridShiftDetail .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridShiftDetail .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

     #gridShiftDetail .dx-datagrid-headers .dx-header-row td {
        background-color: #3b9ac6 !important;
        color: white !important; 
        font-weight: bold !important; 
    }

       
        #gridShiftDetail .dx-datagrid-headers .dx-header-row td .dx-datagrid-text-content {
            color: white !important;
        } 


</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Cashier Audit</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

        <div class="d-flex flex-column ">
            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">From Date:</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">To Date:</label>
                    <input type="date" id="toDate" name="toDate" class="form-control form-control-sm w-auto" />
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Login Name:</label>
            <select id="userName" class="tomselect-custom" multiple>
                @foreach (var u in ViewBag.UsersList)
                {
                    <option value="@u.LoginName">@u.LoginName</option>
                }
            </select>
        </div>
        

        <div class="d-flex align-items-center me-2">
            <label class="me-2 mb-0">Shift.No:</label>
            <input style="width: 40px;" type="text" id="shiftID" name="shiftID" class="form-control form-control-sm " />
        </div>

        <label class="me-2 mb-0">Option :</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="optionFilter" id="allShift" value="All" checked>
            <label class="form-check-label" for="allShift">
                All shift.
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="optionFilter" id="onlyTransaction" value="Only">
            <label class="form-check-label" for="onlyTransaction">
                Only Transaction Posted
            </label>
        </div>

    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnDetail" class="mui-button mui-button-new"><i class="fa-solid fa-file-lines"></i>Detail</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>

    </div>
</div>

<div class="mui-card">

    <div id="gridWrapper" class="mt-2" style="max-height: 500px;">
        <div id="gridContainer"></div>
    </div>
</div>

<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<div id="popupShiftDetail">
</div>
<script>
    DevExpress.localization.locale("vi");
    function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
            return `${year}-${month}-${day}`;
        }
     function formatDatedetail(date) {
        if (!date) return ""; // null hoặc undefined thì trả về rỗng

        // Nếu truyền vào là string, convert sang Date
        if (!(date instanceof Date)) {
            date = new Date(date);
        }

        if (isNaN(date.getTime())) return ""; // nếu vẫn invalid thì trả về rỗng

        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();

        return `${day}-${month}-${year}`; // nhớ dùng backtick
    }
      
      $(document).ready(function () {

                const today = new Date();

                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                // Lấy ngày cuối cùng của tháng
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                // Định dạng theo local time
                const formattedFirstDay = formatDate(firstDayOfMonth);
                const formattedLastDay = formatDate(lastDayOfMonth);

                console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
                console.log(formattedLastDay); // Kiểm tra giá trị đúng chưa
                // Gán giá trị cho input date
                document.getElementById('fromDate').value = formattedFirstDay;
                document.getElementById('toDate').value = formattedLastDay;
                
                initializeTomSelects();
               
        });


        function initializeTomSelects() {
                const selectors = ["#userName"];

            for (const id of selectors) {
                const el = document.querySelector(id);
                if (!el) continue;

                if (el.tomselect) el.tomselect.destroy();

                const ts = new TomSelect(el, {
                    plugins: ['remove_button'],
                    create: false,
                    maxItems: null,
                    allowEmptyOption: true,
                    placeholder: '',
                    persist: false,
                    render: {
                        option: function (data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        }
                    }
                });

            }
        }
      $("#popupShiftDetail").dxPopup({
        title: "Transactions Shift Detail",
        width: "85%",
        height: "90%",
        encodeHtml: false,
        showCloseButton: true,
        visible: false,
        contentTemplate: function (container) {
            container.append(`
                <div class="mui-card shift-header mb-1"></div>
                <div id="gridShiftDetail"></div>
            `);

            // Khởi tạo grid ngay ở đây, datasource trống
            $("#gridShiftDetail").dxDataGrid({
                dataSource: [],
                showBorders: true,
                height: "90%",
                width: "100%",
                grouping: { autoExpandAll: true },
                groupPanel: { visible: false },
                columns: [
                    { dataField: "paymentType", caption: "Payment", groupIndex: 0 },
                    { dataField: "currencyID", caption: "Currency", groupIndex: 1 },
                    { dataField: "transactionCode", caption: "Trans. Code" },
                    { dataField: "description", caption: "Description" },
                    { dataField: "amount", caption: "Amount", dataType: "number", format: "#,##0.00" },
                    { dataField: "transactionDate", caption: "Date",dataType: "date", format: "dd/MM/yyyy" },
                    { dataField: "transactionDate", caption: "Time" ,dataType: "datetime", format: "HH:mm:ss"},
                    { dataField: "reference", caption: "Reference" },
                    { dataField: "supplement", caption: "Supplement" },
                    { dataField: "folioID", caption: "FolioNo" },
                    { dataField: "roomNo", caption: "Room" },
                    { dataField: "account", caption: "Account" }
                ]
            });
        }
    });

        function showShiftDetail() {
        const grid = $("#gridContainer").dxDataGrid("instance");
        const selectedRow = grid.getSelectedRowsData()[0];
        if (!selectedRow) {
            alert("Vui lòng chọn một ca trước!");
            return;
        }

        const shiftID = selectedRow.shiftNo;
        const popup = $("#popupShiftDetail").dxPopup("instance");

        popup.option("onShown", function () {
            $(".shift-header").html(`
                <div class="row">
                    <div><i>Cashier No</i>: <b>${selectedRow.cashierNo}</b></div>
                    <div><i>Shift.No</i>: <b>${selectedRow.shiftNo}</b></div>
                    <div><i>Shift Date</i>: <b>${formatDatedetail(selectedRow.date)}</b></div>
                </div>
                <div class="row">
                    <div><i>User Name</i>: <b>${selectedRow.userName}</b></div>
                    <div><i>Login Time</i>: <b>${selectedRow.loginTime}</b></div>
                    <div><i>Logout Time</i>: <b>${selectedRow.logoutTime}</b></div>
                </div>
                <div class="row">
                    <div><i>Full Name</i>: <b>${selectedRow.fullName}</b></div>
                </div>
            `);

            const gridDetail = $("#gridShiftDetail").dxDataGrid("instance");

            gridDetail.option("dataSource", new DevExpress.data.DataSource({
                load: function () {
                    return $.ajax({
                        url: `/Cashiering/GetShiftDetail`,
                        data: { shiftID: shiftID, type: 0 },
                        dataType: "json"
                    }).then(res => {
                        console.log("ShiftDetail raw:", res);

                        // convert sang mảng chuẩn
                        let arr = Array.isArray(res) ? res : Object.values(res);
                        arr = arr.filter(x => x != null);
                        if (Array.isArray(arr[0])) {
                            arr = arr[0];
                        }

                        console.log("ShiftDetail parsed:", arr);
                        return arr;
                    });
                }
            }));
        });

        popup.show();
    }



        $("#btnDetail").on("click", function () {
        showShiftDetail();
    });
        let originalData = [];
        function loadPostingJournal() {

        $.ajax({
            url: "/Cashiering/GetCashierAudit",
            type: "GET",
            data: {
                userName: $("#userName").val()?.map(r => r.replace("''")).join("','") || "",
                fromDate: $("#fromDate").val(),
                toDate: $("#toDate").val(),         
                shiftID: $("#shiftID").val(),

            },
                success: function (data) {
                console.log("Data loaded:", data);
                originalData = data; // lưu lại data gốc
                applyFilterAndReload(); // chỉ gọi 1 lần
                $("#loadingSpinner").hide();
            },
            error: function () {
                alert("Không thể tải dữ liệu");
                $("#loadingSpinner").hide();
            }
        });
    }
        function applyFilterAndReload() {
        let option = $("input[name='optionFilter']:checked").val();
        let filteredData = [];

        if (option === "Only") {
            filteredData = originalData.filter(x => Number(x.countTransaction) > 0);
        } else {
            filteredData = originalData; // all
        }

        loadPostingJournalGrid(filteredData);
    }

        $("#btnPrint").on("click", function () {
            loadPostingJournal();
        });

        $("input[name='optionFilter']").on("change", function () {
            applyFilterAndReload();
        });
        function loadPostingJournalGrid(data) {
                $("#gridContainer").dxDataGrid({
                        dataSource: data,
                        height: 400,
                        allowColumnResizing: true,
                        selection: { mode: "single" },

                        columns: [
                            { dataField: "date", caption: "Date", width:120, dataType: "date", format: "dd/MM/yyyy" },
                            { dataField: "shiftNo", caption: "Shift.No", width:120, cellTemplate: function(container, options) {
                              let count = options.data?.countTransaction || 0;
                              $("<span>")
                                    .text(`${options.value} (${count})`)
                                    .css("color", count > 0 ? "blue" : "black" )
                                    .css("font-weight", count > 0 ? "bold" : "normal")
                                    .appendTo(container);
                                }
                            },
                            { dataField: "cashierNo", caption: "Cashier.No", width:120 },
                            { dataField: "amountVND", caption: "Amount (VND)", width:130, dataType: "number",
                                customizeText: function(e) {
                                    return e.value?.toLocaleString("vi-VN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                }
                            },
                            { dataField: "amountUSD", caption: "Amount (USD)", width:120, dataType: "number" },
                            { dataField: "userName", caption: "User", width:120 },
                            { dataField: "fullName", caption: "Full Name", width:270 },
                            { dataField: "loginTime", caption: "Login Time", width:180 },
                            { dataField: "logoutTime", caption: "Logout Time", width:180, dataType: "date" },
                            { dataField: "status", caption: "Status", width:120 },
                            { dataField: "countTransaction", caption: "Count Transaction",visible: false  },

                        ],

                    scrolling: {
                    mode: "standard", // Không dùng virtual để footer hiển thị đúng
                    showScrollbar: "always",
                    scrollByContent: true
                },
                paging: {
                    pageSize: 50
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [50, 100, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },
                    filterRow: {
                visible: true,
                applyFilter: "auto"
            },
                showBorders: true,
              
                onRowPrepared: function(e) {
                    if (e.data && e.data.isSubtotal) {
                        e.rowElement.css({ "font-weight": "bold"});
                    }
                    if (e.data && e.data.isGrandTotal) {
                    e.rowElement.css({ "font-weight": "bold" });
                    }
                }
            });
        }

             $("#btnExportExcel").click(function () {
            const grid = $("#gridContainer").dxDataGrid("instance");   // 🔥 khai báo grid

            const workbook = new ExcelJS.Workbook();
            const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === Dòng 1: Tên công ty (merge theo 4 cột) ===
            worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:D1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Ngày giờ xuất (bên phải) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', exportDate]);
            worksheet.mergeCells('D2:D2');  // cột D thôi
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: trống
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
            const reportRow = worksheet.addRow(['Cashier Audit']);
            worksheet.mergeCells('A5:D5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: trống
            worksheet.addRow([]);

            // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 }
            }).then(function () {
                // Footer (sau cùng)
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = "Cashier Audit.xlsx";
                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });
</script>