<div style="display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        width: 100%;
        background: #f5f5f5; 
        padding: 10px 20px;
        overflow-x: auto;
        position: relative; ">
    <h1 style="font-size:16px;
            font-weight: 700;
            color: #0055b8; /* Neon cyan */
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
            animation: neonGlow 1.5s ease-in-out infinite alternate;">Transaction Shift Detail</h1>
    <div class="column-gap:4px;display:flex">
        <button class="submit-button-clear-small" onclick="closeShift()">Close Shift</button>
        <button class="submit-button-clear-small" onclick="previewDataGrid()">Preview & Print</button>
        <button class="submit-button-clear-small" onclick="exportTransactionShift(1)">Excel</button>
        <button class="submit-button-clear-small" onclick="SaveReservation(1)">Close</button>

    </div>
    <div style="justify-content:space-between;display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 0px;
    border-bottom: 2px solid #ececec;">
        <h3 id="content-title" style="font-size:14px;">
            1. Shift Information
        </h3>
        <div class="row">
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.1. Cashier. No: <span id="cashierNo"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.2. Shift .No: <span id="shiftNo"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.3. Shift Date: <span id="shiftDate"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.4. User Name: <span id="userName"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.5. Full Name: <span id="fullName"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.6. Login Time: <span id="loginTime"></span></label>
            <label class="form-label col-md-2" style="width:auto; border-right: 1px solid #000; padding-right: 10px; margin-right: 10px;color:#2b6cb0">1.7. Logout Time: <span id="logoutTime"></span></label>

        </div>

    </div>
    <div>
        <div id="gridContainerCloseShift" class="mt-2 gridContainer"></div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<script>
    $(document).ready( function () {
        getInfoShift();
        getTransactionShift();
    });
    function getInfoShift(){
        var formData = new FormData();
        const userID = localStorage.getItem("shiftID");
        formData.append('shiftID', userID);

        $.ajax({
            url: '/Billing/GetInfoShift',
            type: 'POST',
            processData: false,
            contentType: false,
            // headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: formData,
            success: function (data) {
                $('#cashierNo').text(data.id);
                $('#shiftNo').text(data.id);
                $('#shiftDate').text(data.loginTime.split('T')[0]);
                $('#userName').text(data.userName);
                $('#loginTime').text(data.loginTime.split('T')[1]);
                $('#logoutTime').text(data.logoutTime.split('T')[1]);
            },
            error: function (xhr, statusText, err) {

            }
        });
    }
    function getTransactionShift() {
        $.ajax({
            url: '/Cashiering/GetTransactionByShift',
            type: 'GET',
            dataType: 'json',
            data: {
                shiftID: localStorage.getItem("shiftID"),
            },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                // Kết hợp dữ liệu resultPayment và resultExchange
                const combinedData = [
                    ...result.resultPayment.map(item => ({ ...item, Type: 'Payment' })),
                    ...result.resultExchange.map(item => ({ ...item, Type: 'Exchange Currency' }))
                ];

                // Gọi hàm khởi tạo DataGrid với dữ liệu kết hợp
                initializeDataGridSearch(combinedData);
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    console.error('Lỗi khi lấy dữ liệu:', err);
                }
            }
        });
    }

    function initializeDataGridSearch(data) {
        // Giới hạn dữ liệu (nếu cần)
        const limitedData = data.slice(0, 100);

        // Tạo danh sách cột động từ dữ liệu
        const columns = [];
        if (limitedData.length > 0) {
            // Lấy tất cả các khóa từ đối tượng đầu tiên, loại bỏ 'Type' khỏi cột hiển thị
            const keys = Object.keys(limitedData[0]).filter(key => key !== 'Type');
            columns.push(
                ...keys.map(key => ({
                    dataField: key,
                    caption: key, // Có thể tùy chỉnh tiêu đề cột
                    allowFiltering: true
                }))
            );
        }

        // Khởi tạo DataGrid
        $("#gridContainerCloseShift").dxDataGrid({
            dataSource: limitedData,
            allowColumnResizing: true,
            columnAutoWidth: true,
            columnMinWidth: 90,
            paging: {
                enabled: true,
                pageSize: 15
            },
            pager: {
                visible: true,
                allowedPageSizes: [15, 20, 30],
                showPageSizeSelector: true,
                showInfo: false,
                showNavigationButtons: false
            },
            scrolling: {
                mode: 'standard',
                showScrollbar: 'always',
                useNative: false
            },
            filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            selection: {
                mode: "single"
            },
            grouping: {
                autoExpandAll: true // Tự động mở rộng các nhóm
            },
            groupPanel: {
                visible: false // Hiển thị bảng nhóm để kéo thả
            },

            columns: [
                {
                    dataField: 'Type',
                    groupIndex: 0 // Nhóm theo Type (Payment hoặc Exchange)
                },
                { dataField: 'TransactionCode', caption: 'Trans. Code', visible: true },
                { dataField: 'Description', caption: 'Description', visible: true },
                { dataField: 'Amount', caption: 'Amount', visible: true },
                { dataField: 'TransactionDate', caption: 'Date', visible: true },
                { dataField: 'Reference', caption: 'Reference', visible: true },
                { dataField: 'Supplement', caption: 'Supplement', visible: true },
                { dataField: 'FolioID', caption: 'FolioNo', visible: true },
                { dataField: 'RoomNo', caption: 'Room', visible: true },
                { dataField: 'Account', caption: 'Account', visible: true },

            ],

        });
    }

    function closeShift(){
        var formData = new FormData();
        const userID = localStorage.getItem("shiftID");
        formData.append('shiftID', userID);

        $.ajax({
            url: '/Cashiering/CloseShiftIn',
            type: 'POST',
            processData: false,
            contentType: false,
            // headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            data: formData,
            success: function (data) {
                if(data.code == 0){
                    showToast("Success",data.msg,true);
                }
                else{
                     showToast("Error",data.msg,false);

                }
            },
            error: function (xhr, statusText, err) {

            }
        });
    }
    function exportTransactionShift() {
        // Load required libraries dynamically
        const script1 = document.createElement('script');
        script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
        document.head.appendChild(script1);

        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
        document.head.appendChild(script2);

        script1.onload = function() {
            script2.onload = function() {
                // Kiểm tra nếu DataGrid chưa được initialize
                if (!$("#gridContainerCloseShift").length || !$("#gridContainerCloseShift").dxDataGrid("instance")) {
                    // alert("DataGrid chưa được tải. Vui lòng chờ dữ liệu load xong rồi thử lại.");
                    return;
                }

                // Load toàn bộ dữ liệu từ server (giống như getTransactionShift)
                const shiftID = localStorage.getItem("shiftID");
                if (!shiftID) {
                    // alert("Không tìm thấy shiftID trong localStorage.");
                    return;
                }

                $.ajax({
                    url: '/Cashiering/GetTransactionByShift',
                    type: 'GET',
                    dataType: 'json',
                    data: { shiftID: shiftID },
                    crossDomain: false,
                    headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
                    success: function (result) {
                        if (!result || (!result.resultPayment && !result.resultExchange)) {
                            // alert("Không có dữ liệu từ server.");
                            return;
                        }

                        // Kết hợp dữ liệu Payment và Exchange
                        const combinedData = [
                            ...(result.resultPayment || []).map(item => ({ ...item, Type: 'Payment' })),
                            ...(result.resultExchange || []).map(item => ({ ...item, Type: 'Exchange Currency' }))
                        ];

                        if (combinedData.length === 0) {
                            // alert("Không có dữ liệu để export.");
                            return;
                        }


                        // Create a new workbook and worksheet
                        const workbook = new ExcelJS.Workbook();
                        const worksheet = workbook.addWorksheet('Transaction Shift Data');

                        // Define columns for the worksheet (dựa trên cấu trúc dữ liệu)
                        worksheet.columns = [
                            { header: 'Type', key: 'Type', width: 18 },
                            { header: 'Transaction Code', key: 'TransactionCode', width: 20 },
                            { header: 'Description', key: 'Description', width: 25 },
                            { header: 'Amount', key: 'Amount', width: 15 },
                            { header: 'Transaction Date', key: 'TransactionDate', width: 18 },
                            { header: 'Reference', key: 'Reference', width: 20 },
                            { header: 'Supplement', key: 'Supplement', width: 20 },
                            { header: 'Folio No', key: 'FolioID', width: 15 },
                            { header: 'Room No', key: 'RoomNo', width: 12 },
                            { header: 'Account', key: 'Account', width: 20 }
                            // Nếu có thêm field khác từ data, thêm vào đây
                        ];

                        // Add rows to the worksheet
                        combinedData.forEach(item => {
                            worksheet.addRow({
                                Type: item.Type || '',
                                TransactionCode: item.TransactionCode || '',
                                Description: item.Description || '',
                                Amount: item.Amount || 0,
                                TransactionDate: item.TransactionDate ? new Date(item.TransactionDate).toLocaleString() : '',
                                Reference: item.Reference || '',
                                Supplement: item.Supplement || '',
                                FolioID: item.FolioID || '',
                                RoomNo: item.RoomNo || '',
                                Account: item.Account || ''
                            });
                        });

                        // Style the header row
                        worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFF' } };
                        worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '0055b8' } }; // Màu header giống theme
                        worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };

                        // Thêm border cho toàn bộ table
                        const lastRow = worksheet.lastRow.number;
                        const lastCol = worksheet.actualColumnCount;
                        for (let i = 1; i <= lastRow; i++) {
                            for (let j = 1; j <= lastCol; j++) {
                                const cell = worksheet.getCell(i, j);
                                cell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            }
                        }

                        // Tên file với timestamp
                        const now = new Date();
                        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                        const fileName = `TransactionShiftData_${timestamp}.xlsx`;

                        // Generate Excel file
                        workbook.xlsx.writeBuffer().then(function(buffer) {
                            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            saveAs(blob, fileName);
                        }).catch(function(error) {
                            // alert("Lỗi khi tạo file Excel: " + error.message);
                        });
                    },
                    error: function (xhr, statusText, err) {
                        if (xhr.status == 401) {
                            sessionTimeout();
                        } else {
                            // alert("Lỗi khi lấy dữ liệu: " + (xhr.responseJSON?.message || err));
                        }
                    }
                });
            };
        };

        // Xử lý nếu script đã load rồi (tránh load lại)
        if (window.ExcelJS && window.saveAs) {
            script1.onload();
        }
    }
                    function previewDataGrid() {
        // Kiểm tra DataGrid (tùy chọn)
        if (!$("#gridContainerCloseShift").length || !$("#gridContainerCloseShift").dxDataGrid("instance")) {
            alert("DataGrid chưa được tải. Vui lòng chờ dữ liệu load xong rồi thử lại.");
            return;
        }

        // Lấy thông tin shift cho header
        const cashierNo = $('#cashierNo').text() || '';
        const shiftNo = $('#shiftNo').text() || '';
        const shiftDate = $('#shiftDate').text() || '';
        const userName = $('#userName').text() || '';
        const fullName = $('#fullName').text() || '';
        const loginTime = $('#loginTime').text() || '';
        const logoutTime = $('#logoutTime').text() || '';

        // Lấy data từ server
        const shiftID = localStorage.getItem("shiftID");
        if (!shiftID) {
            alert("Không tìm thấy shiftID trong localStorage.");
            return;
        }

        $.ajax({
            url: '/Cashiering/GetTransactionByShift',
            type: 'GET',
            dataType: 'json',
            data: { shiftID: shiftID },
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                if (!result || (!result.resultPayment && !result.resultExchange)) {
                    alert("Không có dữ liệu từ server.");
                    return;
                }

                // Kết hợp và sort data theo Type
                let combinedData = [
                    ...(result.resultPayment || []).map(item => ({ ...item, Type: 'Payment' })),
                    ...(result.resultExchange || []).map(item => ({ ...item, Type: 'Exchange Currency' }))
                ].sort((a, b) => a.Type.localeCompare(b.Type));

                if (combinedData.length === 0) {
                    alert("Không có dữ liệu để in PDF.");
                    return;
                }

                // Tính tổng Amount cho footer
                const totalAmount = combinedData.reduce((sum, item) => sum + (parseFloat(item.Amount) || 0), 0);

                // Format data cho table (Date: DD/MM/YYYY HH:mm, Amount: number)
                combinedData = combinedData.map(item => ({
                    Type: item.Type || '',
                    TransactionCode: item.TransactionCode || '',
                    Description: item.Description || '',
                    Amount: parseFloat(item.Amount) || 0,
                    TransactionDate: item.TransactionDate ? new Date(item.TransactionDate).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '',
                    Reference: item.Reference || '',
                    Supplement: item.Supplement || '',
                    FolioID: item.FolioID || '',
                    RoomNo: item.RoomNo || '',
                    Account: item.Account || ''
                }));

                // Tạo PDF landscape (rộng hơn cho bảng)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4'); // Landscape: width ~297mm, height ~210mm

                let yPosition = 10; // Start Y cho shift info

                // Header chung (tiêu đề)
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 85, 184); // #0055b8
                doc.text('Transaction Shift Detail', 148.5, yPosition, { align: 'center' }); // Center
                yPosition += 10;

                // Shift Information (cột 2 cột cho đẹp)
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('1. Shift Information', 20, yPosition);
                yPosition += 8;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const shiftInfoLeft = [
                    `1.1. Cashier No: ${cashierNo}`,
                    `1.3. Shift Date: ${shiftDate}`,
                    `1.5. Full Name: ${fullName}`,
                    `1.7. Logout Time: ${logoutTime}`
                ];
                const shiftInfoRight = [
                    `1.2. Shift No: ${shiftNo}`,
                    `1.4. User Name: ${userName}`,
                    `1.6. Login Time: ${loginTime}`
                ];

                // Vẽ 2 cột
                shiftInfoLeft.forEach((info, i) => {
                    doc.text(info, 20, yPosition + (i * 6));
                });
                shiftInfoRight.forEach((info, i) => {
                    doc.text(info, 150, yPosition + (i * 6));
                });
                yPosition += 35; // Khoảng cách đến table

                // Xử lý group: Tạo tableBody với group rows riêng
                let currentType = '';
                const tableBody = [];
                combinedData.forEach(item => {
                    if (item.Type !== currentType && item.Type) {
                        // Group header row
                        tableBody.push({
                            isGroup: true,
                            Type: item.Type,
                            Description: `--- ${item.Type.toUpperCase()} TRANSACTIONS ---`,
                            Amount: '', // Empty cho các cột khác
                            TransactionDate: '',
                            Reference: '',
                            Supplement: '',
                            FolioID: '',
                            RoomNo: '',
                            Account: ''
                        });
                        currentType = item.Type;
                    }
                    // Data row
                    tableBody.push(item);
                });

                // Columns
                const tableColumns = [
                    { header: 'Type', dataKey: 'Type' },
                    { header: 'Trans. Code', dataKey: 'TransactionCode' },
                    { header: 'Description', dataKey: 'Description' },
                    { header: 'Amount', dataKey: 'Amount' },
                    { header: 'Date', dataKey: 'TransactionDate' },
                    { header: 'Reference', dataKey: 'Reference' },
                    { header: 'Supplement', dataKey: 'Supplement' },
                    { header: 'Folio No', dataKey: 'FolioID' },
                    { header: 'Room', dataKey: 'RoomNo' },
                    { header: 'Account', dataKey: 'Account' }
                ];

                // AutoTable với styles đẹp và tránh vỡ
                doc.autoTable({
                    columns: tableColumns,
                    body: tableBody,
                    startY: yPosition,
                    theme: 'grid', // Border đầy đủ
                    headStyles: {
                        fillColor: [0, 85, 184], // #0055b8
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 9,
                        halign: 'center',
                        valign: 'middle'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        cellPadding: 3, // Padding lớn hơn cho đẹp
                        halign: 'left',
                        valign: 'middle',
                        lineColor: [200, 200, 200], // Border xám nhạt
                        lineWidth: 0.1
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245] // Lẻ row xám nhạt
                    },
                    columnStyles: {
                        0: { cellWidth: 18, halign: 'center' }, // Type
                        1: { cellWidth: 25 }, // Trans. Code
                        2: { cellWidth: 45 }, // Description (rộng nhất, cho wrap)
                        3: { cellWidth: 20, halign: 'right' }, // Amount
                        4: { cellWidth: 28 }, // Date
                        5: { cellWidth: 25 }, // Reference
                        6: { cellWidth: 25 }, // Supplement
                        7: { cellWidth: 18, halign: 'center' }, // Folio No
                        8: { cellWidth: 15, halign: 'center' }, // Room
                        9: { cellWidth: 28 }  // Account (rộng cho text dài)
                    },
                    // Hooks để wrap text ở Description và style group
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.dataKey === 'Description') {
                            // Split text nếu quá dài (wrap tự động)
                            if (data.cell.text && data.cell.text[0] && data.cell.text[0].length > 100) {
                                data.cell.text = [data.cell.text[0].match(/.{1,80}(\s|$)/g).join('\n')];
                            }
                        }
                    },
                    willDrawCell: function(data) {
                        if (data.row.raw && data.row.raw.isGroup) {
                            // Style group header: background xám, bold, center all
                            data.cell.styles.fillColor = [220, 220, 220];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.halign = 'center';
                            data.cell.styles.fontSize = 9;
                            // Chỉ hiển thị text ở cột Description, empty others
                            if (data.column.index !== 2) {
                                data.cell.text = [''];
                            }
                        }
                        // Format Amount với dấu phẩy (nếu cần)
                        if (data.column.dataKey === 'Amount' && !data.row.raw.isGroup) {
                            data.cell.text = [new Intl.NumberFormat('vi-VN').format(data.cell.text[0])];
                        }
                    },
                    didDrawPage: function(data) {
                        // Header lặp lại trên mỗi trang (tiêu đề nhỏ)
                        doc.setFontSize(10);
                        doc.setTextColor(0, 85, 184);
                        doc.text('Transaction Shift Detail - Page ' + data.pageNumber, 20, 10);

                        // Footer: Total Amount (chỉ trang cuối)
                        if (data.pageNumber === doc.internal.getNumberOfPages()) {
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            doc.text(`Total Amount: ${new Intl.NumberFormat('vi-VN').format(totalAmount)}`, 20, doc.internal.pageSize.height - 10);
                        }
                    },
                    margin: { top: yPosition - 5, left: 10, right: 10, bottom: 15 },
                    pageBreak: 'auto', // Tự động break
                    rowPageBreak: 'avoid', // Tránh break giữa row
                    tableWidth: 'auto' // Wrap nếu cần
                });

                // Tên file với timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const fileName = `TransactionShiftDetail_${timestamp}.pdf`;

                // Preview bằng Blob URL (cách mới, tránh lỗi data URI/iframe)
                const blob = doc.output('blob'); // Tạo Blob từ PDF
                const blobUrl = URL.createObjectURL(blob); // Tạo URL tạm thời
                const newWindow = window.open(blobUrl, '_blank'); // Mở tab mới với blob URL

                if (!newWindow) {
                    // Fallback nếu pop-up bị block: Download thay vì preview
                    alert("Không thể mở tab mới (kiểm tra pop-up blocker). Tải PDF về thay thế.");
                    doc.save(fileName);
                    URL.revokeObjectURL(blobUrl); // Dọn dẹp ngay
                    return;
                }

                // Dọn dẹp URL sau khi mở (delay để browser load xong)
                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                }, 2000); // 2 giây delay

                console.log("PDF preview mở thành công với Blob URL:", fileName);
                // Nếu có showToast, dùng để thông báo
                if (typeof showToast === 'function') {
                    showToast("Thành công", `PDF đã mở preview: ${fileName}`, true);
                }
            },
            error: function (xhr, statusText, err) {
                console.error('Lỗi khi lấy dữ liệu từ server:', err, xhr.responseText);
                if (xhr.status == 401) {
                    sessionTimeout();
                } else {
                    alert("Lỗi khi lấy dữ liệu: " + (xhr.responseJSON?.message || err));
                }
            }
        });
    }
</script>