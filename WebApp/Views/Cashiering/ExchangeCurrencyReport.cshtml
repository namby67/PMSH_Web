@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewBag.Title = ViewBag.ReportHeader;
    var zoneList = ViewBag.ZoneList;
    var usersList = ViewBag.UsersList;
}
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px"></div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1 filter-panel">
        <!-- From Date -->

        <div class="d-flex flex-column ">

            <div class="d-flex align-items-center">
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Trans .Date :</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control form-control-sm w-auto" />
                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Cachier:</label>
                    <select id="cachier" name="cachier" class="tomselect-custom" multiple>
                        @foreach (var item in usersList)
                        {
                            <option value="@item.ID">@item.LoginName</option>
                        }
                    </select>

                </div>
                <div class="d-flex align-items-center me-3">
                    <label class="me-2 mb-0">Zone:</label>
                    <select id="zonecode" name="zonecode" class="tomselect-custom" multiple>
                        @foreach (var item in zoneList)
                        {
                            <option value="@item.ID">@item.Code</option>
                        }
                    </select>

                </div>
            </div>
        </div>


    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnPrint" class="mui-button mui-button-new"><i class="fa-solid fa-eye"></i>View</button>
      
    </div>
</div>

<div class="mui-card">
    <div id="gridContainer" class="gridContainer mt-2"></div>
</div>
<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
        function formatDate(date) {
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            let day = date.getDate().toString().padStart(2, '0'); // Ð?m b?o có 2 ch? s?
            return `${year}-${month}-${day}`;
        }

            let parsedBusinessDate = null;
        $(document).ready(function () {
                $("#btnPrint").trigger("click");
             document.getElementById("reportTitle").innerText = 'Attendant Point';
              var businessDateStr = '@ViewBag.BusinessDate'; // Ví dụ: '8/29/2024 12:00:00 AM'
                   console.log(businessDateStr);
                    // Lấy phần ngày tháng năm
                    var dateOnly = businessDateStr.split(' ')[0]; // '8/29/2024'
                    var dateParts = dateOnly.split('/'); // ['8', '29', '2024']

                    // Parse đúng thứ tự: new Date(year, monthIndex, day)
                     parsedBusinessDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

                    // Gán vào input type="date"
                    $('#fromDate').val(formatDate(parsedBusinessDate));
                      
               initializeTomSelects();


        });
         function initializeTomSelects() {
        const selectors = ["#zonecode", "#cachier"];

        for (const id of selectors) {
            const el = document.querySelector(id);
            if (!el) continue;

            // Nếu đã khởi tạo rồi thì destroy
            if (el.tomselect) el.tomselect.destroy();

            const ts = new TomSelect(el, {
                plugins: ['remove_button'],
                create: false,
                maxItems: null,
                allowEmptyOption: true,
                placeholder: '',
                persist: false,
                render: {
                    option: function (data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

        }
    }
      $(document).off("click", "#btnPrint").on("click", "#btnPrint", function () {
        $("#loadingSpinner").show();

        const fromDate = $("#fromDate").val();
        const zonecode = $("#zonecode").val().join(",");
        const cachier = $("#cachier").val().join(",");

        // Gọi API để lấy dữ liệu PDF dưới dạng base64
        $.ajax({
            url: `/Cashiering/ExchangeCurrencyReportData?fromDate=${fromDate}&zonecode=${zonecode}&cachier=${cachier}`,
            method: "GET",
            success: function (response) {
                $("#loadingSpinner").hide();
                if (response.pdfBase64) {
                    // Nhúng PDF vào iframe bằng dữ liệu base64
                    $("#gridContainer").html(
                        `<iframe src="${response.pdfBase64}" width="100%" height="800px" style="border:none;"></iframe>`
                    );
                } else if (response.error) {
                    alert("Lỗi: " + response.error);
                }
            },
            error: function (xhr) {
                $("#loadingSpinner").hide();
                alert("Đã xảy ra lỗi khi tải báo cáo!");
            }
        });
    });

</script>