@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var selectedReport = @ViewBag.ReportHeader;
    var crrlist = ViewBag.CurrencyList;
}


<style>
    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .dx-datagrid-headers .dx-header-row td {
        white-space: pre-line !important;
        text-align: center;
        font-size: 11px;
    }


    .dx-datagrid .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default, .dx-datagrid-container .dx-editor-with-menu .dx-menu-item-content .dx-icon.dx-icon-filter-operation-default {
        display: none;
    }

    #gridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #gridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
        }

        #gridContainer .dx-datagrid-headers .dx-header-row > td {
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #gridContainer .dx-datagrid-rowsview td,
        #gridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #gridContainer .dx-datagrid-rowsview tr td:last-child,
        #gridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #gridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #gridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #gridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #gridContainer .dx-datagrid-filter-row td .dx-datebox,
    #gridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #005f87 !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #logGridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-row > td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 12px !important;
        line-height: 24px !important;
    }

    #logGridContainer .dx-datagrid-headers {
        background-color: #3b9ac6 !important; /* Màu xanh duong */
        color: white !important; /* Ch? tr?ng cho d? d?c */
    }

        #logGridContainer .dx-datagrid-headers .dx-header-row > td {
            padding-top: 12px !important;
            padding-bottom: 12px !important;
            font-size: 12px !important;
            background-color: #3b9ac6 !important;
            color: white !important;
            font-weight: bold;
            border-right: 1px solid #ddd !important;
            text-align: center !important;
        }

        #logGridContainer .dx-datagrid-rowsview td,
        #logGridContainer .dx-datagrid-headers td {
            border-right: 1px solid #ddd !important;
        }

        /* Lo?i b? vi?n ph?i ? c?t cu?i cùng (tùy ch?n) */
        #logGridContainer .dx-datagrid-rowsview tr td:last-child,
        #logGridContainer .dx-datagrid-headers tr td:last-child {
            border-right: none !important;
        }

    #logGridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important;
        color: white !important;
    }

    #logGrid
    .dx-datagrid-rowsview .dx-selection * {
        color: white !important;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox {
        height: 24px !important;
        min-height: 24px !important;
    }

        #logGridContainer .dx-datagrid-filter-row td .dx-datebox input {
            font-size: 12px !important;
            height: 24px !important;
        }

    #logGridContainer .dx-datagrid-filter-row td .dx-editor-with-menu,
    #logGridContainer .dx-datagrid-filter-row td .dx-texteditor input {
        height: 24px !important;
        line-height: 24px !important;
        padding: 2px 6px !important;
        font-size: 12px !important;
        box-sizing: border-box;
    }

    #logGridContainer .dx-datagrid-filter-row td .dx-datebox,
    #logGridContainer .dx-datagrid-filter-row td .dx-dropdowneditor {
        height: 26px !important;
        min-height: 26px !important;
        font-size: 12px !important;
    }

    .filter_wrapper {
        /*     background-color: #ececec; */
        /*   margin: 0px 8px 14px 8px; */
        padding: 18px 0px 0px 14px;
        border-radius: 8px;
    }

    .gridContainer {
        margin: 0px 8px;
    }

    .button_wrapper {
        display: flex;
        column-gap: 12px;
        margin: 0px 8px;
    }

        .button_wrapper .fa-solid {
            margin-right: 5px;
        }

    .selected {
        background-color: #4CAF50; /* Màu xanh */
        color: white;
    }

    #gridContainer .dx-datagrid-rowsview .dx-selection {
        background-color: #01579b !important; /* màu xanh ng?c */
        color: white !important; /* ch? tr?ng */
    }

        #gridContainer .dx-datagrid-rowsview .dx-selection * {
            color: white !important;
        }

    .sticky-header .form-control-sm {
        padding: .1rem .35rem;
        height: calc(1.1em + .2rem + 2px);
    }

    .sticky-header label[class*="me-"] {
        margin-right: .5rem !important;
    }

    #gridContainer .dx-datagrid-headers .dx-header-row > td {
        padding: 5px !important;
        height: 24px !important;
        font-size: 12px !important;
        line-height: 1.1 !important;
    }

    .sticky-header input[type="date"].form-control-sm {
        font-size: 12px !important; /* dúng 12?px */
        height: calc(1.1em + .2rem + 2px); /* gi? cùng chi?u cao */
    }

    .sticky-header label {
        font-size: 12px !important;
        line-height: 1.2;
    }


    .sort-select {
        max-width: 130px; /* ho?c 100px n?u mu?n nh? hon */
        font-size: 12px;
        padding: 0.15rem 0.5rem;
    }

    .sort-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: none !important;
        padding-right: 10px !important;
    }

    button:disabled {
        pointer-events: none; /* Không cho hover/click */
        opacity: 0.6; /* Cho nó mờ đi */
        cursor: not-allowed; /* Hiện con trỏ cấm */
        background-color: #ccc !important; /* tuỳ chỉnh màu khi disable */
    }

    .tomselect-custom {
        width: 100px;
        min-height: 30px; /* hoặc tùy theo chiều cao bạn muốn */
        font-size: 12px !important;
    }

        .tomselect-custom .ts-control {
            padding-left: 8px !important; /* hoặc bất kỳ giá trị nào bạn muốn */
        }

    #groupCode.form-control-sm,
    #subGroupCode.form-control-sm {
        height: 26px !important; /* chiều cao nhỏ */
        font-size: 12px !important; /* chữ nhỏ */
        padding: 2px 6px !important; /* padding nhỏ */
        line-height: 1.2 !important; /* căn giữa chữ */
        max-width: 180px; /* chiều rộng vừa phải */
    }

    .hide-band .dx-datagrid-bands > tr:first-child {
        display: none !important;
    }

    .shift-header {
        background: #f2f2f2;
        padding: 8px 12px;
        border-bottom: 1px solid #ccc;
        font-size: 13px;
    }

        .shift-header .row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 4px;
        }

            .shift-header .row div {
                flex: 1; /* chia đều các cột */
                min-width: 150px; /* giữ cho không quá hẹp */
            }

        .shift-header i {
            font-style: italic;
            color: #333;
        }

        .shift-header b {
            font-weight: bold;
            margin-left: 4px;
        }

    .dx-popup-title {
        text-align: center !important;
        width: 100%;
    }

    /* Áp dụng cho tất cả text trong grid popup */
    #popupShiftDetail .dx-datagrid {
        font-size: 12px !important;
    }

        /* Nếu vẫn không ăn, target chi tiết hơn */
        #popupShiftDetail .dx-datagrid .dx-row > td,
        #popupShiftDetail .dx-datagrid .dx-header-row > td {
            font-size: 12px !important;
        }

    #fromCurrency {
        font-size: 12px; /* nhỏ chữ */
        padding: 2px 6px; /* thu gọn khoảng cách */
        height: auto; /* tránh Bootstrap ép chiều cao */
    }

    #toCurrency {
        font-size: 12px; /* nhỏ chữ */
        padding: 2px 6px; /* thu gọn khoảng cách */
        height: auto; /* tránh Bootstrap ép chiều cao */
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Ẩn mũi tên trong Firefox */
    input[type=number] {
        -moz-appearance: textfield;
        text-align: right;
    }

    #gridExchangeRate .dx-datagrid-headers td,
    #gridExchangeRate .dx-datagrid-rowsview td,
    #gridExchangeRate .dx-datagrid-filter-row td {
        font-size: 12px !important;
        padding: 2px 4px !important;
        line-height: 1.2 !important;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<div class="text-center" id="reportTitle" style="font-size: 20px">Exchange Rate</div>
<div class="sticky-header bg-white p-2 shadow-sm z-3">
    <div class="d-flex flex-wrap align-items-center gap-2 mb-1" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">

        <div class="d-flex flex-column">
            <form id="exchangeRateForm">
                <!-- hidden ID để insert/update -->
                <input type="hidden" id="ID" name="ID" />

            <div class="d-flex align-items-center">
                <!-- Date -->
                <div class="d-flex align-items-center me-2">
                    <label class="me-2 mb-0">Date:</label>
                        <input type="date" id="DateTime" name="DateTime" class="form-control form-control-sm w-auto" />
                </div>

                <div class="d-flex align-items-center mb-2">
                    <!-- From Currency -->
                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">From Currency:</label>
                            <select id="FromCurrencyID" name="FromCurrencyID" class="form-control form-control-sm w-auto">
                            <option value="">---Select a Currency---</option>
                            @foreach (var crr in ViewBag.CurrencyList)
                            {
                                <option value="@crr.ID">@crr.ID - @crr.Description</option>
                            }
                        </select>
                    </div>

                    <!-- To Currency -->
                    <div class="d-flex align-items-center me-3">
                        <label class="me-2 mb-0">To Currency:</label>
                            <select id="ToCurrencyIDSelect" class="form-control form-control-sm w-auto" disabled>
                                @foreach (var crr in crrlist)
                                {
                                    if (crr.ID == "VND")
                                    {
                                        <option value="@crr.ID" selected>@crr.ID - @crr.Description</option>
                                    }
                                }
                            </select>
                            <input type="hidden" id="ToCurrencyID" name="ToCurrencyID" value="VND" />
                    </div>
                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">Buy Rate:</label>
                            <input type="number" value="0" style="width: 80px;" id="ExChangeRate" name="ExChangeRate" class="form-control form-control-sm" />
                        </div>

                        <div class="d-flex align-items-center me-2">
                            <label class="me-2 mb-0">Sell Rate:</label>
                            <input type="number" value="0" style="width: 80px;" id="ExChangeRateSell" name="ExChangeRateSell" class="form-control form-control-sm" />
                        </div>

                </div>

            </div>
                                        
                <div class="d-flex align-items-center ">
                    
                    <label class="me-2 mb-0 fw-bold">Exchange Currency:</label>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Denomination max:</label>
                        <input type="number" value="0" style="width: 80px;" id="DenominationMax" name="DenominationMax" class="form-control form-control-sm" />
                    </div>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Buy Rate max:</label>
                        <input type="number" value="0" style="width: 80px;" id="ExChangeRateMax" name="ExChangeRateMax" class="form-control form-control-sm" />
                    </div>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Denomination medium:</label>
                        <input type="number" value="0" style="width: 80px;" id="DenominationMedium" name="DenominationMedium" class="form-control form-control-sm" />
                    </div>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Buy Rate medium:</label>
                        <input type="number" value="0" style="width: 80px;" id="ExChangeRateMedium" name="ExChangeRateMedium" class="form-control form-control-sm" />
                    </div>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Denomination min:</label>
                        <input type="number" value="0" style="width: 80px;" id="DenominationMin" name="DenominationMin" class="form-control form-control-sm" />
                    </div>

                    <div class="d-flex align-items-center me-2">
                        <label class="me-2 mb-0">Buy Rate min:</label>
                        <input type="number" value="0" style="width: 80px;" id="ExChangeRateMin" name="ExChangeRateMin" class="form-control form-control-sm" />
                    </div>
                </div>
            </form>

      
    </div>
    </div>
    <div class="">
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #28a745;" id="btnNew" class="mui-button mui-button-new"><i class="fa-solid fa-plus"></i> New</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #3b9ac6;" id="btnSave" class="mui-button mui-button-new"><i class="fa-solid fa-file-lines"></i> Save</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545 ;" id="btnCancel" class="mui-button mui-button-new"><i class="fa-solid fa-ban"></i> Cancel</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #007bff;" id="btnEdit" class="mui-button mui-button-new"><i class="fa-solid fa-pen"></i> Edit</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #dc3545;" id="btnDelete" class="mui-button mui-button-new"><i class="fa-solid fa-trash"></i> Delete</button>
        <button style="border-radius: 4px;  margin-right: 6px;background-color: #1D6F42;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>

    </div>
</div>

<div class="mui-card">

    <div id="gridWrapper" style="max-height: 500px;">
        <div id="gridContainer"></div>
    </div>
</div>

<div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
    <i class="fa-solid fa-spinner fa-spin"></i>
</div>
<script>
    let selectedRowData = null;

      DevExpress.localization.locale("vi");
    function formatDate(date) {
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
        let day = date.getDate().toString().padStart(2, '0'); // Đảm bảo có 2 chữ số
        return `${year}-${month}-${day}`;
    }
    $(document).ready(function () {
           const today = new Date();
           const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
           const formattedFirstDay = formatDate(firstDayOfMonth);
           console.log(formattedFirstDay); // Kiểm tra giá trị đúng chưa
           document.getElementById('DateTime').value = formatDate(today);
          
    });
        // function initializeTomSelects() {
        //      const selectors = ["#fromCurrency","#toCurrency"];

        //     for (const id of selectors) {
        //         const el = document.querySelector(id);
        //         if (!el) continue;

        //         if (el.tomselect) el.tomselect.destroy();

        //         const ts = new TomSelect(el, {
        //             plugins: ['remove_button'],
        //             create: false,
        //             maxItems: null,
        //             allowEmptyOption: true,
        //             placeholder: '',
        //             persist: false,
        //             render: {
        //                 option: function (data, escape) {
        //                     return `<div>${escape(data.text)}</div>`;
        //                 }
        //             }
        //         });

        //     }
        // }
           // New
       // New
    $("#btnNew").click(function () {
        let currentDate = $("#DateTime").val();
        $("#exchangeRateForm")[0].reset();
        $("#ID").val(""); // reset ID
        $("#DateTime").val(currentDate);
        selectedRowData = null;
         $("#btnNew, #btnEdit").prop("disabled", true).addClass("btn-disabled");
    });

    // Edit
    $("#btnEdit").click(function () {
        if (!selectedRowData) {
            alert("Please select a row first!");
            return;
        }

        // Map JSON (camelCase) -> form input (PascalCase)
        $("#ID").val(selectedRowData.id);
        $("#DateTime").val(selectedRowData.dateTime.split("T")[0]);
        $("#FromCurrencyID").val(selectedRowData.fromCurrencyID);
        $("#ToCurrencyID").val(selectedRowData.toCurrencyID);
        $("#ExChangeRate").val(selectedRowData.buyRate);
        $("#ExChangeRateSell").val(selectedRowData.sellRate);
        $("#ExChangeRateMax").val(selectedRowData.exChangeRateMax);
        $("#DenominationMax").val(selectedRowData.denominationMax);
        $("#ExChangeRateMedium").val(selectedRowData.exChangeRateMedium);
        $("#DenominationMedium").val(selectedRowData.denominationMedium);
        $("#ExChangeRateMin").val(selectedRowData.exChangeRateMin);
        $("#DenominationMin").val(selectedRowData.denominationMin);
        $("#btnNew, #btnEdit").prop("disabled", true).addClass("btn-disabled");
    });

    // Save
        $("#btnSave").click(function () {
        let id = $("#ID").val();
        let data = $("#exchangeRateForm").serialize(); // serialize => PascalCase name gửi về server

        console.log("Serialized Data:", data); // 👀 log ra để check

        if (!id) {
            // Insert
            $.post("/Cashiering/Insert", data, function (res) {
                let currentDate = $("#DateTime").val();
                console.log("Insert Response:", res);
                DevExpress.ui.notify("Inserted new ID: " + res.id, "success", 2000);
                $("#ID").val(res.id);
                $("#gridContainer").dxDataGrid("instance").refresh();

                // ✅ Reset form sau khi insert
                $("#exchangeRateForm")[0].reset();
                $("#ID").val("");
                $("#DateTime").val(currentDate);
                selectedRowData = null;
            }).fail(function (xhr) {
                console.error("Insert error:", xhr.responseText);
                DevExpress.ui.notify("Insert failed!", "error", 2000);
            });
        } else {
            // Update
            $.post("/Cashiering/Update", data, function (res) {
                let currentDate = $("#DateTime").val();
                console.log("Update Response:", res);
                DevExpress.ui.notify("Updated ID: " + res.id, "success", 2000);
                $("#gridContainer").dxDataGrid("instance").refresh();

                // ✅ Reset form sau khi update
                $("#exchangeRateForm")[0].reset();
                $("#ID").val("");
                $("#DateTime").val(currentDate);
                selectedRowData = null;
            }).fail(function (xhr) {
                console.error("Update error:", xhr.responseText);
                DevExpress.ui.notify("Update failed!", "error", 2000);
            });
        }
    });
        $("#btnDelete").click(function () {
            
        if (!selectedRowData) {
            alert("Please select a row first!");
            return;
        }

        if (!confirm("Are you sure you want to delete this record?")) return;

        $.post("/Cashiering/Delete", { id: selectedRowData.id }, function (res) {
            if (res.deleted > 0) {
                DevExpress.ui.notify("Deleted successfully", "success", 2000);
                $("#gridContainer").dxDataGrid("instance").refresh();
                $("#exchangeRateForm")[0].reset();
                $("#DateTime").val(formatDate(new Date()));
                selectedRowData = null;
            } else {
                DevExpress.ui.notify("Delete failed!", "error", 2000);
            }
        }).fail(function (xhr) {
            console.error("Delete error:", xhr.responseText);
            DevExpress.ui.notify("Delete error!", "error", 2000);
        });
    });
        $("#btnCancel").click(function () {
        // Reset form
        $("#exchangeRateForm")[0].reset();
        $("#ID").val("");
        $("#DateTime").val(formatDate(new Date()));
        selectedRowData = null;

        $("#btnNew, #btnEdit").prop("disabled", false).removeClass("btn-disabled");
    });




            $(function () {
        $("#gridContainer").dxDataGrid({
            dataSource: new DevExpress.data.DataSource({
                load: function () {
                    return $.ajax({
                        url: "/Cashiering/GetExchangeRate",
                        type: "GET",
                        dataType: "json"
                    }).then(res => {
                        console.log("ExchangeRates:", res);
                        return res;
                    });
                }
            }),
            keyExpr: "ID",
            showBorders: true,
            selection: { mode: "single" },
            paging: { pageSize: 20 },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [20, 50, 100],
                showInfo: true
            },
            filterRow: { visible: true },
            columns: [
                { dataField: "dateTime", caption: "Date Time", dataType: "datetime", format: "dd/MM/yyyy HH:mm" },
                { dataField: "fromCurrencyID", caption: "From Curr.",width: 80 },
                { dataField: "toCurrencyID", caption: "To Curr.",width: 70 },
                { dataField: "buyRate", caption: "Buy Rate", dataType: "number", format: "#,##0.00",width: 80 },
                { dataField: "sellRate", caption: "Sell Rate", dataType: "number", format: "#,##0.00",width: 80 },
                { dataField: "exChangeRateMax", caption: "Buy Rate Max", dataType: "number", format: "#,##0.00",width: 120 },
                { dataField: "denominationMax", caption: "Deno. Max", dataType: "number",width: 80},
                { dataField: "exChangeRateMedium", caption: "Buy Rate Medium", dataType: "number", format: "#,##0.00",width: 120 },
                { dataField: "denominationMedium", caption: "Deno. Medium", dataType: "number",width: 90},
                { dataField: "exChangeRateMin", caption: "Buy Rate Min", dataType: "number" , format: "#,##0.00",width: 120},
                { dataField: "denominationMin", caption: "Deno. Min", dataType: "number",width: 80},
                { dataField: "createBy", caption: "Created By",width: 80 },
                { dataField: "createDate", caption: "Created Date", dataType: "date", format: "dd/MM/yyyy HH:mm" },
                { dataField: "updateBy", caption: "Updated By",width: 80 },
                { dataField: "updateDate", caption: "Updated Date", dataType: "date", format: "dd/MM/yyyy HH:mm" }
            ],
            scrolling: {
                    mode: "standard", // Không dùng virtual để footer hiển thị đúng
                    showScrollbar: "always",
                    scrollByContent: true
                },
                paging: {
                    pageSize: 50
                },
                pager: {
                    visible: true,
                    allowedPageSizes: [50, 100, 'all'],
                    showPageSizeSelector: true,
                    showInfo: true,
                    showNavigationButtons: true
                },
                    filterRow: {
                visible: true,
                applyFilter: "auto"
            },
            // 🔥 Quan trọng: gán selectedRowData khi click chọn
            onSelectionChanged: function (e) {
                if (e.selectedRowsData.length > 0) {
                    selectedRowData = e.selectedRowsData[0]; // gán row đang chọn
                    console.log("Selected Row:", selectedRowData);
                } else {
                    selectedRowData = null;
                }
            }
        });
    });

            $("#btnExportExcel").click(function () {
            const grid = $("#gridContainer").dxDataGrid("instance");   // 🔥 khai báo grid

            const workbook = new ExcelJS.Workbook();
            const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
            const worksheet = workbook.addWorksheet("Sheet 1");

            // === Dòng 1: Tên công ty (merge theo 4 cột) ===
            worksheet.addRow([companyName]);
            worksheet.mergeCells('A1:D1');
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

            // === Dòng 2: Ngày giờ xuất (bên phải) ===
            const now = new Date();
            const exportDate = now.toLocaleString("vi-VN");
            worksheet.addRow(['', '', '', exportDate]);
            worksheet.mergeCells('D2:D2');  // cột D thôi
            worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

            // === Dòng 3–4: trống
            worksheet.addRow([]);
            worksheet.addRow([]);

            // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
                const reportRow = worksheet.addRow(['Exchange Rate']);
            worksheet.mergeCells('A5:O5');
            reportRow.font = { bold: true, size: 14 };
            reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

            // === Dòng 6: trống
            worksheet.addRow([]);

            // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
            DevExpress.excelExporter.exportDataGrid({
                component: grid,
                worksheet: worksheet,
                autoFilterEnabled: true,
                topLeftCell: { row: 7, column: 1 }
            }).then(function () {
                // Footer (sau cùng)
                const lastRow = worksheet.lastRow.number + 2;
                worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
                worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`A${lastRow}`).font = { italic: true };

                // Ghi file
                let fileName = "Exchange Rate.xlsx";

                workbook.xlsx.writeBuffer().then(function (buffer) {
                    saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
                });
            });
        });

</script>