@using DevExpress.XtraReports.UI
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
  
    string loginName = Context.Session.GetString("LoginName") ?? "";
    string shiftNo = Context.Session.GetInt32("ShiftID")?.ToString() ?? "";
    string cashierNo = Context.Session.GetInt32("CashierNo")?.ToString() ?? "";
}
@* <link href="~/css/pages/reservation.css" rel="stylesheet" /> *@
<style>
    #sendDate:disabled {
        background-color: #f5f5f5;
        color: #999;    
        cursor: not-allowed;
    }

    input[type="radio"] {
        vertical-align: middle; /* căn giữa theo chiều dọc */
        margin-top: 0; /* loại bỏ margin-top mặc định */
        margin-right: 6px; /* khoảng cách với text */
        transform: scale(1.2); /* phóng to radio nếu cần */
    }

    /* Label căn chỉnh flex */
    .card-type-list label {
        display: flex;
        align-items: center; /* căn giữa theo chiều dọc */
        gap: 6px;
        white-space: nowrap;
        font-size: 0.875rem; /* điều chỉnh chữ */
    }

    /* Phóng to checkbox "All" */
    #cardAll {
        width: 10px;
        height: 10px;
        transform: scale(1.5);
        margin-right: 6px;
    }

    .tomselect-custom .ts-control {
        min-height: 28px !important; /* chiều cao tối thiểu */
        height: 28px !important; /* chiều cao cố định */
        padding: 2px 6px !important; /* padding trong input */
        font-size: 0.75rem !important; /* chữ nhỏ hơn */
        line-height: 1.2 !important;
    }

    /* Ô nhập khi gõ */
    .tomselect-custom .ts-input > input {
        min-height: 20px !important;
        height: 20px !important;
        padding: 0 !important;
        font-size: 0.75rem !important;
        line-height: 1.2 !important;
    }

    /* Tag hiển thị khi chọn */
    .tomselect-custom .item {
        font-size: 0.75rem !important;
        padding: 1px 4px !important;
        line-height: 1.2 !important;
    }

</style>
<div class="mt-3">
    <div class="row">
        <div class="col-md-2 mb-2">
            <div class="menu-left">
                <button class="toggle-btn"><i class="fas fa-bars"></i></button>
                <a class="menu-item " asp-controller="Cashiering" asp-action="PostingJournal">POSTING JOURNAL </a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="VATSearch"> VAT TABLE</a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="FolioVATSearch">SEARCH VAR VOUCHER </a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="FolioVATSearchByAccounting">SEARCH VAT VOUCHER FOR ACCOUNTING </a>
                <a class="menu-item " asp-controller="Cashiering" asp-action="FolioHistoryView"> FOLIO HISTORY</a>
                <a class="menu-item active"> CASHIER REPORT</a>
            </div>
        </div>

        <!-- Nội dung bên phải -->
        <div class="col-md-10">
            <div class="content-right ms-2">
                <div class="header">
                    <h3 id="content-title">
						Cashier Report

                    </h3>
                </div>
                <div class="row g-3">
                                    
                    <div class="col-md-8">
                        <label>View Option </label>
                        <div class="card-type-list mt-2" id="typeList" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center mb-2" style="gap: 12px;">

                                <div class="card-type-list mt-2" id="action" style="border: 1px solid #ced4da; border-radius: 6px; padding: 12px;">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="cash" value="1" checked /> Cash Report</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="credit" value="4" /> Credit Card Report</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="check" value="2" /> Check Report</label>
                                        </div>

                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="foreign" value="5" /> Foreign Currency Report</label>
                                        </div>
                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="ar" value="4" /> AR Settlement Report</label>
                                        </div>
                                         
                                        <div class="col-md-4">
                                            <label><input type="radio" name="actionOption" id="micenalleous" value="0" disabled/> Micenalleous Payment Report</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label>Cashier Info </label>
                        <div class="mt-2 mb-2" style="border: 1px solid #ced4da; border-radius: 6px; padding: 8px;">
                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">Cashier.No : </label>
                                <input type="text" value="@cashierNo" readonly />
                            </div>

                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">Shift.No : </label>
                                <input type="text" value="@ViewBag.ShiftID" readonly class="form-control form-control-sm w-auto mt-2" />
                            </div>

                            <div class="d-flex align-items-center me-2">
                                <label class="me-2 mb-0">Cashier Name : </label>
                                <input type="text" value="@loginName" readonly />
                            </div>
                        </div>
                    </div>


                </div>


            </div>
            <div class="mt-2">
                <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnView" class="mui-button mui-button-new ms-2"><i class="fa-solid fa-eye"></i>View</button>
                <button style="border-radius: 4px;  margin-right: 6px;background-color: #6c757d;" id="btnDetail" class="mui-button mui-button-new ms-2"><i class="fa-solid fa-eye"></i>Details</button>
                <button style="border-radius: 4px;  margin-right: 6px;background-color: green;" id="btnExportExcel" class="mui-button mui-button-new" type="button"> <i class="fa-solid fa-file-excel"></i> Excel</button>
            </div>
            <div id="loadingSpinnerRateCode" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="mui-card">
                <div id="gridContainerRateCode" class="mt-2 gridContainer"></div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Popup for New Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalLabel">New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form id="itemForm">
                    <div class="container-fluid" style="border: 1px solid #ccc; border-radius: 6px; padding: 8px;">

                        <!-- Code + Inactive -->
                        <div class="row mb-1">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="txtroom" class="form-label mb-0 me-2" >Room</label>
                                    <input type="text" id="txtroom" name="txtroom" class="form-control form-control-sm" disabled />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="txtname" class="form-label mb-0 me-2">Name</label>
                                    <input type="text" id="txtname" name="txtname" class="form-control form-control-sm" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-md-6">
                                 <div class="d-flex align-items-center">
                                    <label for="txtcode" class="form-label mb-0 me-2">Code</label>
                                    <input type="text" id="txtcode" name="txtcode" class="form-control form-control-sm" disabled />
                                 </div>
                            </div>
                            <div class="col-md-6">
                                  <div class="d-flex align-items-center">
                                     <label for="txtdescription" class="form-label mb-0 me-2">Description</label>
                                    <input type="text" id="txtdescription" name="txtdescription" class="form-control form-control-sm" disabled />
                                  </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <!-- Cột trái -->
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <label for="txtcreditVND" class="form-label mb-0 me-2" style="width: 80px;">Price</label>
                                    <input type="text" id="txtcreditVND" name="txtcreditVND" class="form-control form-control-sm" />
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <label for="txtquantity" class="form-label mb-0 me-2" style="width: 80px;">Quantity</label>
                                    <input type="text" id="txtquantity" name="txtquantity" class="form-control form-control-sm" />
                                </div>
                                <div class="d-flex align-items-center">
                                    <label for="txtamount" class="form-label mb-0 me-2" style="width: 80px;">Amount</label>
                                    <input type="text" id="txtamount" name="txtamount" class="form-control form-control-sm" disabled />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex align-items-start">
                                    <label for="txtcurrencyID" class="form-label mb-0 me-2" style="width: 80px;">Currency</label>
                                    <textarea id="txtcurrencyID"
                                              name="txtcurrencyID"
                                              class="form-control"
                                              rows="8"
                                              style="background-color:#ffffe6; height:120px;" disabled></textarea>
                                </div>
                            </div>

                        </div>
                        <div class="row mb-1">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="txtcashier" class="form-label mb-0 me-2">Cashier</label>
                                    <input type="text" value="@loginName" class="form-control form-control-sm" disabled />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="txtwinNo" class="form-label mb-0 me-2">Win.No</label>
                                    <input type="text" id="txtwinNo" name="txtwinNo" class="form-control form-control-sm" disabled />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="txttransactionDate" class="form-label mb-0 me-2">Posting Date</label>
                                    <input type="text" id="txttransactionDate" name="txttransactionDate" class="form-control form-control-sm" disabled />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <input type="date" id="txttransactionDatee" name="txttransactionDatee" class="form-control form-control-sm" />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-1">                         
                            <div class="d-flex align-items-center">
                                    <label for="txtarticleCode" class="form-label mb-0 me-2">Article Code</label>
                                <input type="text" id="txtarticleCode" name="txtarticleCode" class="form-control form-control-sm" disabled />
                            </div>                                            
                            <div class="d-flex align-items-center">
                                    <label for="txtsupplement" class="form-label mb-0 me-2">Supplement</label>
                                <input type="text" id="txtsupplement" name="txtsupplement" class="form-control form-control-sm" />
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="txtReference" class="form-label mb-0 me-2"> Reference</label>
                                <input type="text" id="txtReference" name="txtReference" class="form-control form-control-sm" />
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="txtcheckNo" class="form-label mb-0 me-2"> Check No</label>
                                <input type="text" id="txtcheckNo" name="txtcheckNo" class="form-control form-control-sm" disabled />
                            </div>
                         
                        </div>
                        <input type="hidden" id="id" name="id" value="0" />
                    </div>
                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnSaveItem" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<script>

    DevExpress.localization.locale("vi");
    let selectedRowData = null;


      $(document).ready(function () {
                reloadGrid();

        });
      


              function loadGrid(data) {
        $("#gridContainerRateCode").dxDataGrid({
            dataSource: data,
            height: 500,
            width: "100%",
            columnAutoWidth: true,
            allowColumnResizing: true,
            columnResizingMode: "widget",
            selection: { mode: "single" },
            columns: [
                { dataField: "room", caption: "Room", width: "10%" },
                { dataField: "accountName", caption: "AccountName", width: "20%" },
                { dataField: "folioNo", caption: "Folio.No", width: "10%" },               
                { dataField: "transactionCode", caption: "TA.Code", width: "11%" },
                { dataField: "description", caption: "Description ", width: "11%" },
                { dataField: "debitVND", caption: "Debit(VND) ", width: "11%" },
                { dataField: "creditVND", caption: "Credit(VND)", width: "11%" },
                { dataField: "debitUSD", caption: "Debit(USD)", width: "11%" },
                { dataField: "creditUSD", caption: "Credit(USD)", width: "11%" },
                { dataField: "supplement", caption: "Supplement", width: "11%" },
                { dataField: "transactionDate", caption: "Time", width: "11%", dataType: "datetime", format: "HH:mm:ss" },

                { dataField: "arNo", caption: "Ar.No", width: "11%" },

            ],
            filterRow: { visible:true, applyFilter:"auto" },
            paging: { pageSize:20 },
            pager: {
                visible:true,
                allowedPageSizes:[20,50,'all'],
                showPageSizeSelector:true,
                showInfo:true,
                showNavigationButtons:true
            },
            scrolling: { mode:"standard", showScrollbar:"always", scrollByContent:true },
            onSelectionChanged: function(e){
                selectedRowData = e.selectedRowsData.length > 0 ? e.selectedRowsData[0] : null;
                console.log("Selected Row:", selectedRowData);
            }
        });
    }
            function editMember(data) {
        $("#id").val(data.id);                   // hidden field
        $("#txtroom").val(data.room);            // ánh xạ Code
        $("#txtname").val(data.accountName);    
        $("#txtcode").val(data.transactionCode);
        $("#txtamount").val(data.amount);
        $("#txtcreditVND").val(data.creditVND);
        $("#txtcurrencyID").val(data.currencyID);
        $("#txtwinNo").val(data.winNo);
        $("#txttransactionDate").val(data.transactionDate);
         $("#txttransactionDatee").val(data.transactionDate.split(" ")[0]);
        $("#txtsupplement").val(data.supplement);
        $("#txtdescription").val(data.description);

        $("#itemModal").modal("show");
    }


           $("#btnDetail").on("click", function () {
        if (!selectedRowData) {
            DevExpress.ui.notify("Please select a row first!", "warning", 2000);
            return;
        }

        // Gọi hàm ánh xạ dữ liệu vào form
        editMember(selectedRowData);
    });

    $("#btnView").on("click", function() {
        reloadGrid();
        });

        // Reload grid với filter từ form
        function reloadGrid() {
            $("#loadingSpinnerRateCode").show();
                var mode = $("input[name='actionOption']:checked").val();
                // Gửi ajax
                $.ajax({
                    url: '/Cashiering/GetCashierReport',
                    type: 'GET',
                    data: {   
                        mode: mode,
                    },
                    success: function(data){
                        loadGrid(data);
                        console.log("Data trả về:", data);                    
                        $("#loadingSpinnerRateCode").hide();
                    },
                    error: function(xhr, status, error){
                        alert("Không thể tải dữ liệu");
                        $("#loadingSpinnerRateCode").hide();
                    }
                });

        }

                $("#btnSaveItem").click(function () {
        const formData = $("#itemForm").serialize();
         console.log("FormData:", formData);
        let url = "/Administration/InsertDepartment";
        if ($("#id").val() && $("#id").val() !== "0") {
            url = "/Cashiering/UpdateFolioDetail"; // nếu có id thì update
        }

        $.ajax({
            url: url,
            type: "POST",
            data: formData,
            success: function (res) {
                if (res.success) {
                    showToast("Success", (url.includes("Update") ? "Update success" : "Insert success"), true);
                    $("#itemModal").modal("hide");
                    reloadGrid();
                } else {
                    showToast("Failed", res.message || "Action Failed!", false);
                }
            },
            error: function (xhr) {
                showToast("Error", "Request error!", false);
            }
        });
    });


    $("#btnExportExcel").click(function () {
           const grid = $("#gridContainerRateCode").dxDataGrid("instance");   // 🔥 khai báo grid

           const workbook = new ExcelJS.Workbook();
           const companyName = localStorage.getItem("CompanyName") || "Tên công ty chưa xác định";
           const worksheet = workbook.addWorksheet("Sheet 1");

           // === Dòng 1: Tên công ty (merge theo 4 cột) ===
           worksheet.addRow([companyName]);
           worksheet.mergeCells('A1:D1');
           worksheet.getRow(1).font = { bold: true };
           worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'left' };

           // === Dòng 2: Ngày giờ xuất (bên phải) ===
           const now = new Date();
           const exportDate = now.toLocaleString("vi-VN");
           worksheet.addRow(['', '', '', exportDate]);
           worksheet.mergeCells('D2:D2');  // cột D thôi
           worksheet.getRow(2).alignment = { vertical: 'middle', horizontal: 'right' };

           // === Dòng 3–4: trống
           worksheet.addRow([]);
           worksheet.addRow([]);

           // === Dòng 5: Tiêu đề báo cáo (ở giữa) ===
           const reportRow = worksheet.addRow([' Cashier Report ']);
           worksheet.mergeCells('A5:D5');
           reportRow.font = { bold: true, size: 14 };
           reportRow.alignment = { vertical: 'middle', horizontal: 'center' };

           // === Dòng 6: trống
           worksheet.addRow([]);

           // === Xuất dữ liệu grid bắt đầu từ dòng 7 ===
           DevExpress.excelExporter.exportDataGrid({
               component: grid,
               worksheet: worksheet,
               autoFilterEnabled: true,
               topLeftCell: { row: 7, column: 1 }
           }).then(function () {
               // Footer (sau cùng)
               const lastRow = worksheet.lastRow.number + 2;
               worksheet.mergeCells(`A${lastRow}:D${lastRow}`);
               worksheet.getCell(`A${lastRow}`).alignment = { horizontal: 'center' };
               worksheet.getCell(`A${lastRow}`).font = { italic: true };

               // Ghi file
               let fileName = "Cashier Report.xlsx";
               workbook.xlsx.writeBuffer().then(function (buffer) {
                   saveAs(new Blob([buffer], { type: "application/octet-stream" }), fileName);
               });
           });
       });


</script>