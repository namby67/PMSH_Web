<style>
    /* Container for the entire interface */
    .nightaudit-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        width: 100%;
        background: #f5f5f5; /* Dark neon gradient */
        padding: 10px 20px;
        overflow-x: auto;
        position: relative; /* For overlay positioning */
    }

        /* Header styling */
        .nightaudit-container h1 {
            font-size: 3.2rem;
            font-weight: 700;
            color: #0055b8; /* Neon cyan */
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
            animation: neonGlow 1.5s ease-in-out infinite alternate;
        }

    /* Business date styling */
    .nightaudit-business-date2 {
        font-size: 1.3rem;
        color: #000000;
        padding: 10px 30px;
        border-radius: 30px;
        margin-bottom: 10px;
        animation: fadeIn 1.2s ease-out;
    }

    /* Table styling */
    .nightaudit-table_nightaudit {
        width: 100%;
        max-width: 1400px;
        border-collapse: separate;
        border-spacing: 0 12px;
        background: transparent;
        margin-bottom: 30px;
    }

        /* Table header */
        .nightaudit-table_nightaudit th {
            background: #0055b8;
            color: #ffffff;
            padding: 8px 20px;
            text-align: left;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.95rem;
        }

        /* Table rows */
        .nightaudit-table_nightaudit tr {
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* Table cells */
        .nightaudit-table_nightaudit td {
            padding: 8px 20px;
            font-size: 14px;
            color: #000000;
            border: none;
        }

        /* Status text styling */
        .nightaudit-table_nightaudit .status-success {
            color: #6aa84f;
            font-weight: bold;
        }

        .nightaudit-table_nightaudit .status-fail {
            color: #990000;
            font-weight: bold;
        }

        /* Process icon styling */
        .nightaudit-table_nightaudit .fa-spinner {
            color: #0055b8; /* Blue for in-progress */
        }

        .nightaudit-table_nightaudit .fa-circle-check {
            color: #6aa84f; /* Green for success */
        }

        .nightaudit-table_nightaudit .fa-circle-xmark {
            color: #990000; /* Red for fail */
        }

    /* Buttons container */
    .nightaudit-buttons {
        display: flex;
        gap: 20px;
    }

        /* Button styling */
        .nightaudit-buttons button {
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            color: #0055b8;
            cursor: pointer;
            border: none;
        }

        /* Start button */
        .nightaudit-buttons #start {
            background: #0055b8;
            color: #FFFFFF;
        }

        /* Close button */
        .nightaudit-buttons #close {
            background: #ECECEC;
            color: #000000;
        }

        /* Disabled button state */
        .nightaudit-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

    /* Progress bar container */
    .progress-bar-container {
        width: 50%;
        max-width: 600px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    /* Progress bar */
    .progress-bar {
        width: 0%;
        height: 30px;
        background: #0055b8;
        transition: width 0.3s ease;
        text-align: center;
        line-height: 30px;
        color: #FFFFFF;
        font-weight: bold;
    }

    /* Progress text */
    .progress-text {
        color: #000000;
        font-size: 1.5rem;
    }
</style>
<div class="nightaudit-container">
    <h1>END OF DAY</h1>
    <div class="nightaudit-business-date2">Business Date: <span id="value"></span></div>
    <div class="nightaudit-buttons">
        <button id="start" onclick="RunNightAudit();">Start Night Audit</button>
        <button id="close" onclick="window.location.href='/Home/Index'">Close</button>
    </div>
    <table class="nightaudit-table_nightaudit">
        <tr>
            <th>Seq</th>
            <th>Task</th>
            <th>Begin</th>
            <th>End</th>
            <th>Process</th>
            <th>Status</th>
        </tr>
        <tr>
            <td>1</td>
            <td>System Checking</td>
            <td id="timeBegin1">...</td>
            <td id="timeEnd1">...</td>
            <td id="process1">...</td>
            <td id="status1">...</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Arrivals Not Yet Checked In</td>
            <td id="timeBegin2">...</td>
            <td id="timeEnd2">...</td>
            <td id="process2">...</td>
            <td id="status2">...</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Departures Not Yet Checked Out</td>
            <td id="timeBegin3">...</td>
            <td id="timeEnd3">...</td>
            <td id="process3">...</td>
            <td id="status3">...</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Preprocessing</td>
            <td id="timeBegin4">...</td>
            <td id="timeEnd4">...</td>
            <td id="process4">...</td>
            <td id="status4">...</td>
        </tr>
        <tr>
            <td>5</td>
            <td>Automatic Closure of Open Cashiers</td>
            <td id="timeBegin5">...</td>
            <td id="timeEnd5">...</td>
            <td id="process5">...</td>
            <td id="status5">...</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Posting Room Charge</td>
            <td id="timeBegin6">...</td>
            <td id="timeEnd6">...</td>
            <td id="process6">...</td>
            <td id="status6">...</td>
        </tr>
        <tr>
            <td>7</td>
            <td>Posting Fixed Charge</td>
            <td id="timeBegin7">...</td>
            <td id="timeEnd7">...</td>
            <td id="process7">...</td>
            <td id="status7">...</td>
        </tr>
        <tr>
            <td>8</td>
            <td>Posting Packages</td>
            <td id="timeBegin8">...</td>
            <td id="timeEnd8">...</td>
            <td id="process8">...</td>
            <td id="status8">...</td>
        </tr>
        <tr>
            <td>9</td>
            <td>Change Room Status</td>
            <td id="timeBegin9">...</td>
            <td id="timeEnd9">...</td>
            <td id="process9">...</td>
            <td id="status9">...</td>
        </tr>
        <tr>
            <td>10</td>
            <td>Update Information System</td>
            <td id="timeBegin10">...</td>
            <td id="timeEnd10">...</td>
            <td id="process10">...</td>
            <td id="status10">...</td>
        </tr>
        <tr>
            <td>11</td>
            <td>Change Business Date</td>
            <td id="timeBegin11">...</td>
            <td id="timeEnd11">...</td>
            <td id="process11">...</td>
            <td id="status11">...</td>
        </tr>
        <tr>
            <td>12</td>
            <td>Rechecking System & Completed</td>
            <td id="timeBegin12">...</td>
            <td id="timeEnd12">...</td>
            <td id="process12">...</td>
            <td id="status12">...</td>
        </tr>
    </table>

    <!-- Bootstrap Modal for Progress -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar">0%</div>
                    </div>
                    <div class="progress-text" id="progressText">Starting Night Audit...</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        getBusinessDate();
    });

    var formattedNextDate;
    function getBusinessDate() {
        return $.ajax({
            url: '/Reservation/GetBusinessDate',
            type: 'get',
            dataType: 'json',
            crossDomain: false,
            headers: { "X-CSRF-TOKEN-HEADERNAME": jQuery("input[name='__RequestVerificationToken']").val() },
            success: function (result) {
                const businessDate = new Date(result);
                const [year, month, day] = result.split('T')[0].split('-');
                $('#value').text(`${day}/${month}/${year}`);
                var businessDateNext = new Date(businessDate);
                businessDateNext.setDate(businessDate.getDate() + 1);
                const nextYear = businessDateNext.getFullYear();
                const nextMonth = String(businessDateNext.getMonth() + 1).padStart(2, '0');
                const nextDay = String(businessDateNext.getDate()).padStart(2, '0');
                formattedNextDate = `${nextDay}/${nextMonth}/${nextYear}`;
            },
            error: function (xhr, statusText, err) {
                if (xhr.status == 401) {
                    sessionTimeout();
                }
            }
        });
    }

    let currentTask = 0;
    const totalTasks = 12;

    function updateProgress(taskNumber, taskName) {
        currentTask = taskNumber;
        const progress = Math.round((currentTask / totalTasks) * 100);
        $('#progressBar').css('width', `${progress}%`).text(`${progress}%`);
        $('#progressText').text(`Processing: ${taskName}`);
    }

    function showProgressOverlay() {
        $('#progressModal').modal('show');
        $('#start, #close').prop('disabled', true);
    }

    function hideProgressOverlay() {
        $('#progressModal').modal('hide');
        $('#start, #close').prop('disabled', false);
    }

    function setProcess(id, icon) {
        $('#' + id).empty();
        $('#' + id).append(icon);
    }

    function setStatus(id, status) {
        $('#' + id).empty();
        $('#' + id).text(status);
        $('#' + id).addClass(status === 'Success' ? 'status-success' : 'status-fail');
    }

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('en-US', { hour12: false });
    }

    function RunNightAudit() {
        showProgressOverlay();
        updateProgress(1, 'System Checking');
        const startTime1 = getCurrentTime();
        $('#timeBegin1').text(startTime1);
        setProcess('process1', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/RunNightAuditProcess',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime1 = getCurrentTime();
                $('#timeEnd1').text(endTime1);
                if (data.code == 0) {
                    setProcess('process1', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status1', 'Success');
                    CheckInNotCI();
                } else {
                    setProcess('process1', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status1', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime1 = getCurrentTime();
                $('#timeEnd1').text(endTime1);
                setProcess('process1', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status1', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function CheckInNotCI() {
        updateProgress(2, 'Arrivals Not Yet Checked In');
        const startTime2 = getCurrentTime();
        $('#timeBegin2').text(startTime2);
        setProcess('process2', '<i class="fa-solid fa-spinner"></i>');

        $.ajax({
            url: '/NightAudit/CheckInNotCI',
            type: 'POST',
            processData: false,
            contentType: false,
            success: function (data) {
                const endTime2 = getCurrentTime();
                $('#timeEnd2').text(endTime2);
                if (data.code == 0) {
                    setProcess('process2', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status2', 'Success');
                    CheckOutNotCO();
                } else {
                    setProcess('process2', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status2', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime2 = getCurrentTime();
                $('#timeEnd2').text(endTime2);
                setProcess('process2', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status2', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function CheckOutNotCO() {
        updateProgress(3, 'Departures Not Yet Checked Out');
        const startTime3 = getCurrentTime();
        $('#timeBegin3').text(startTime3);
        setProcess('process3', '<i class="fa-solid fa-spinner"></i>');

        $.ajax({
            url: '/NightAudit/CheckOutNotCO',
            type: 'POST',
            processData: false,
            contentType: false,
            success: function (data) {
                const endTime3 = getCurrentTime();
                $('#timeEnd3').text(endTime3);
                if (data.code == 0) {
                    setProcess('process3', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status3', 'Success');
                    Preprocess();
                } else {
                    setProcess('process3', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status3', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime3 = getCurrentTime();
                $('#timeEnd3').text(endTime3);
                setProcess('process3', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status3', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function Preprocess() {
        updateProgress(4, 'Preprocessing');
        const startTime4 = getCurrentTime();
        $('#timeBegin4').text(startTime4);
        setProcess('process4', '<i class="fa-solid fa-spinner"></i>');

        $.ajax({
            url: '/NightAudit/Preprocess',
            type: 'POST',
            processData: false,
            contentType: false,
            success: function (data) {
                const endTime4 = getCurrentTime();
                $('#timeEnd4').text(endTime4);
                if (data.code == 0) {
                    setProcess('process4', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status4', 'Success');
                    CloseShift();
                } else {
                    setProcess('process4', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status4', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime4 = getCurrentTime();
                $('#timeEnd4').text(endTime4);
                setProcess('process4', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status4', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function CloseShift() {
        updateProgress(5, 'Automatic Closure of Open Cashiers');
        const startTime5 = getCurrentTime();
        $('#timeBegin5').text(startTime5);
        setProcess('process5', '<i class="fa-solid fa-spinner"></i>');

        $.ajax({
            url: '/NightAudit/CloseShift',
            type: 'POST',
            processData: false,
            contentType: false,
            success: function (data) {
                const endTime5 = getCurrentTime();
                $('#timeEnd5').text(endTime5);
                if (data.code == 0) {
                    setProcess('process5', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status5', 'Success');
                    PostingRoomCharge();
                } else {
                    setProcess('process5', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status5', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime5 = getCurrentTime();
                $('#timeEnd5').text(endTime5);
                setProcess('process5', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status5', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function PostingRoomCharge() {
        updateProgress(6, 'Posting Room Charge, Fixed Charge, and Packages');
        const startTime = getCurrentTime();
        $('#timeBegin6').text(startTime);
        $('#timeBegin7').text(startTime);
        $('#timeBegin8').text(startTime);
        setProcess('process6', '<i class="fa-solid fa-spinner"></i>');
        setProcess('process7', '<i class="fa-solid fa-spinner"></i>');
        setProcess('process8', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/PostingRoomCharge',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime = getCurrentTime();
                $('#timeEnd6').text(endTime);
                $('#timeEnd7').text(endTime);
                $('#timeEnd8').text(endTime);
                if (data.code == 0) {
                    setProcess('process6', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status6', 'Success');
                    setProcess('process7', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status7', 'Success');
                    setProcess('process8', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status8', 'Success');
                    ChangeRoomStatus();
                } else {
                    setProcess('process6', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status6', 'Fail');
                    setProcess('process7', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status7', 'Fail');
                    setProcess('process8', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status8', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime = getCurrentTime();
                $('#timeEnd6').text(endTime);
                $('#timeEnd7').text(endTime);
                $('#timeEnd8').text(endTime);
                setProcess('process6', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status6', 'Fail');
                setProcess('process7', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status7', 'Fail');
                setProcess('process8', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status8', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function ChangeRoomStatus() {
        updateProgress(9, 'Change Room Status');
        const startTime9 = getCurrentTime();
        $('#timeBegin9').text(startTime9);
        setProcess('process9', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/ChangeRoomStatus',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime9 = getCurrentTime();
                $('#timeEnd9').text(endTime9);
                if (data.code == 0) {
                    setProcess('process9', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status9', 'Success');
                    UpdateInformationSystem();
                } else {
                    setProcess('process9', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status9', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime9 = getCurrentTime();
                $('#timeEnd9').text(endTime9);
                setProcess('process9', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status9', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function UpdateInformationSystem() {
        updateProgress(10, 'Update Information System');
        const startTime10 = getCurrentTime();
        $('#timeBegin10').text(startTime10);
        setProcess('process10', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/UpdateInformationSystem',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime10 = getCurrentTime();
                $('#timeEnd10').text(endTime10);
                if (data.code == 0) {
                    setProcess('process10', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status10', 'Success');
                    ChangeBusinessDate();
                } else {
                    setProcess('process10', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status10', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime10 = getCurrentTime();
                $('#timeEnd10').text(endTime10);
                setProcess('process10', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status10', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function ChangeBusinessDate() {
        updateProgress(11, 'Change Business Date');
        const startTime11 = getCurrentTime();
        $('#timeBegin11').text(startTime11);
        setProcess('process11', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/ChangeBusinessDate',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime11 = getCurrentTime();
                $('#timeEnd11').text(endTime11);
                if (data.code == 0) {
                    setProcess('process11', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status11', 'Success');
                    RecheckingSystem();
                } else {
                    setProcess('process11', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status11', 'Fail');
                    hideProgressOverlay();
                }
            },
            error: function (xhr, statusText, err) {
                const endTime11 = getCurrentTime();
                $('#timeEnd11').text(endTime11);
                setProcess('process11', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status11', 'Fail');
                hideProgressOverlay();
            }
        });
    }

    function RecheckingSystem() {
        updateProgress(12, 'Rechecking System & Completed');
        const startTime12 = getCurrentTime();
        $('#timeBegin12').text(startTime12);
        setProcess('process12', '<i class="fa-solid fa-spinner"></i>');

        const userName = JSON.parse(localStorage.getItem("Loginname"));
        const userID = JSON.parse(localStorage.getItem("userID"));

        var formData = new FormData();
        formData.append('userName', userName);
        formData.append('userID', userID);

        $.ajax({
            url: '/NightAudit/RecheckingSystem',
            type: 'POST',
            processData: false,
            contentType: false,
            data: formData,
            success: function (data) {
                const endTime12 = getCurrentTime();
                $('#timeEnd12').text(endTime12);
                if (data.code == 0) {
                    setProcess('process12', '<i class="fa-solid fa-circle-check"></i>');
                    setStatus('status12', 'Success');
                    localStorage.setItem("businessDate", JSON.stringify(formattedNextDate));
                    const businessDateF = JSON.parse(localStorage.getItem("businessDate"));
                            $("#businessDate").text(`Business Date : ${businessDateF}`);
                } else {
                    setProcess('process12', '<i class="fa-solid fa-circle-xmark"></i>');
                    setStatus('status12', 'Fail');
                }
                hideProgressOverlay();
            },
            error: function (xhr, statusText, err) {
                const endTime12 = getCurrentTime();
                $('#timeEnd12').text(endTime12);
                setProcess('process12', '<i class="fa-solid fa-circle-xmark"></i>');
                setStatus('status12', 'Fail');
                hideProgressOverlay();
            }
        });
    }
</script>